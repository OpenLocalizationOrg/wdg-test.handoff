{"nodes":[{"content":"Configure Windows Defender ATP endpoint proxy and Internet connection settings","pos":[11,89]},{"content":"Configure the Windows Defender ATP proxy and internet settings to enable communication with the cloud service.","pos":[103,213]},{"content":"Configure endpoint proxy and Internet connectivity settings","pos":[499,558]},{"content":"Applies to:","pos":[562,573]},{"content":"Windows 10 Insider Preview Build 14332 or later","pos":[579,626]},{"content":"Windows Defender Advanced Threat Protection (Windows Defender ATP)","pos":[629,695]},{"content":"[Some information relates to pre-released product which may be substantially modified before it's commercially released.","pos":[726,846]},{"content":"Microsoft makes no warranties, express or implied, with respect to the information provided here.]","pos":[847,945]},{"content":"The Window Defender ATP sensor requires Microsoft Windows HTTP (WinHTTP) to report telemetry and communicate with the Windows Defender ATP service.","pos":[954,1101]},{"content":"The embedded Windows Defender ATP sensor runs in system context using the LocalSystem account.","pos":[1103,1197]},{"content":"The sensor uses Microsoft Windows HTTP Services (WinHTTP) to enable communication with the Windows Defender ATP cloud service.","pos":[1198,1324]},{"content":"The WinHTTP configuration setting is independent of the Windows Internet (WinINet) internet browsing proxy settings and can only discover a proxy server by using the following discovery methods:","pos":[1326,1520]},{"content":"Configure Web Proxy Auto Detect (WPAD) settings and configure Windows to automatically detect the proxy server","pos":[1524,1634]},{"content":"Configure the proxy server manually using Netsh","pos":[1638,1685]},{"content":"Configure Web Proxy Auto Detect (WPAD) settings and proxy server","pos":[1690,1754]},{"content":"Configure WPAD in the environment and configure Windows to automatically detect the proxy server through Policy or the local Windows settings.","pos":[1756,1898]},{"pos":[1900,2048],"content":"Enable the <bpt id=\"p1\">**</bpt>Automatically detect settings<ept id=\"p1\">**</ept> option in the Windows Proxy settings so that WinHTTP can use the WPAD feature to locate a proxy server."},{"pos":[2053,2093],"content":"Click <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> and select <bpt id=\"p2\">**</bpt>Settings<ept id=\"p2\">**</ept>."},{"pos":[2098,2127],"content":"Click <bpt id=\"p1\">**</bpt>Network &amp; Internet<ept id=\"p1\">**</ept>."},{"pos":[2132,2149],"content":"Select <bpt id=\"p1\">**</bpt>Proxy<ept id=\"p1\">**</ept>."},{"pos":[2154,2224],"content":"Verify that the <bpt id=\"p1\">**</bpt>Automatically detect settings<ept id=\"p1\">**</ept> option is set to On."},{"content":"Image showing the proxy settings configuration page","pos":[2232,2283]},{"pos":[2316,2583],"content":"If the <bpt id=\"p1\">**</bpt>Use setup script<ept id=\"p1\">**</ept> or <bpt id=\"p2\">**</bpt>Manual proxy setup<ept id=\"p2\">**</ept> options are enabled then you will need to <bpt id=\"p3\">[</bpt>configure proxy settings manually by using Netsh<ept id=\"p3\">](#configure-proxy-server-manually-using-netsh)</ept> method for WinHTTP to discover the appropriate proxy settings and connect."},{"content":"Configure the proxy server manually using Netsh","pos":[2588,2635]},{"content":"If <bpt id=\"p1\">**</bpt>Use setup script<ept id=\"p1\">**</ept> or <bpt id=\"p2\">**</bpt>Manual proxy setup<ept id=\"p2\">**</ept> settings are configured in the Windows Proxy setting, then endpoints will not be discovered by WinHTTP.","pos":[2637,2790]},{"content":"Use Netsh to configure the proxy settings to enable connectivity.","pos":[2791,2856]},{"content":"You can configure the endpoint by using any of these methods:","pos":[2858,2919]},{"content":"Importing the configured proxy settings to WinHTTP","pos":[2923,2973]},{"content":"Configuring the proxy settings manually to WinHTTP","pos":[2976,3026]},{"content":"After configuring the endpoints, you'll need to verify that the correct proxy settings were applied.","pos":[3028,3128]},{"content":"Import the configured proxy settings to WinHTTP","pos":[3132,3179]},{"content":"Open an elevated command-line prompt on the endpoint:","pos":[3187,3240]},{"content":"a.","pos":[3246,3248]},{"content":"Click <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> and type <bpt id=\"p2\">**</bpt>cmd<ept id=\"p2\">**</ept>.","pos":[3250,3283]},{"content":"b.","pos":[3289,3291]},{"content":"Right-click <bpt id=\"p1\">**</bpt>Command prompt<ept id=\"p1\">**</ept> and select <bpt id=\"p2\">**</bpt>Run as administrator<ept id=\"p2\">**</ept>.","pos":[3293,3360]},{"pos":[3365,3413],"content":"Enter the following command and press <bpt id=\"p1\">**</bpt>Enter<ept id=\"p1\">**</ept>:"},{"content":"An output showing the applied WinHTTP proxy settings is displayed.","pos":[3468,3534]},{"content":"Configure the proxy settings manually to WinHTTP","pos":[3540,3588]},{"content":"Open an elevated command-line prompt on the endpoint:","pos":[3597,3650]},{"content":"a.","pos":[3656,3658]},{"content":"Click <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> and type <bpt id=\"p2\">**</bpt>cmd<ept id=\"p2\">**</ept>.","pos":[3660,3693]},{"content":"b.","pos":[3699,3701]},{"content":"Right-click <bpt id=\"p1\">**</bpt>Command prompt<ept id=\"p1\">**</ept> and select <bpt id=\"p2\">**</bpt>Run as administrator<ept id=\"p2\">**</ept>.","pos":[3703,3770]},{"pos":[3776,3824],"content":"Enter the following command and press <bpt id=\"p1\">**</bpt>Enter<ept id=\"p1\">**</ept>:"},{"pos":[3894,3977],"content":"Replace <bpt id=\"p1\">*</bpt>ProxyServerName<ept id=\"p1\">*</ept> with the fully qualified domain name of the proxy server."},{"pos":[3983,4074],"content":"Replace <bpt id=\"p1\">*</bpt>PortNumber<ept id=\"p1\">*</ept> with the port number that you want to configure the proxy server with."},{"content":"An output showing the applied WinHTTP proxy settings is displayed.","pos":[4077,4143]},{"content":"Verify that the correct proxy settings were applied","pos":[4148,4199]},{"content":"Open an elevated command-line prompt on the endpoint:","pos":[4207,4260]},{"content":"a.","pos":[4266,4268]},{"content":"Click <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> and type <bpt id=\"p2\">**</bpt>cmd<ept id=\"p2\">**</ept>.","pos":[4270,4303]},{"content":"b.","pos":[4309,4311]},{"content":"Right-click <bpt id=\"p1\">**</bpt>Command prompt<ept id=\"p1\">**</ept> and select <bpt id=\"p2\">**</bpt>Run as administrator<ept id=\"p2\">**</ept>.","pos":[4313,4380]},{"pos":[4385,4433],"content":"Enter the following command and press <bpt id=\"p1\">**</bpt>Enter<ept id=\"p1\">**</ept>:"},{"pos":[4469,4649],"content":"For more information on how to use Netsh see, <bpt id=\"p1\">[</bpt>Netsh Commands for Windows Hypertext Transfer Protocol (WINHTTP)<ept id=\"p1\">](https://technet.microsoft.com/en-us/library/cc731131(v=ws.10).aspx)</ept>"},{"content":"Enable access to Windows Defender ATP service URLs in the proxy server","pos":[4659,4729]},{"content":"If a proxy or firewall is blocking all traffic by default and allowing only specific domains through, make sure that the following URLs are white-listed to permit communication with Windows Defender ATP service in port 80 and 443:","pos":[4731,4961]},{"content":"us.vortex-win.data.microsoft.com","pos":[4965,4997]},{"content":"eu.vortex-win.data.microsoft.com","pos":[5002,5034]},{"content":"sevillegwcus.microsoft.com","pos":[5037,5063]},{"content":"sevillegweus.microsoft.com","pos":[5066,5092]},{"content":"sevillegwweu.microsoft.com","pos":[5095,5121]},{"content":"sevillegwneu.microsoft.com","pos":[5124,5150]},{"content":"www.microsoft.com","pos":[5153,5170]},{"content":"crl.microsoft.com","pos":[5173,5190]},{"content":".blob.core.windows.net","pos":[5195,5217]},{"content":"If a proxy or firewall is blocking anonymous traffic, as Windows Defender ATP  sensor is connecting from system context, make sure anonymous traffic is permitted to the above listed URLs.","pos":[5219,5406]},{"content":"Verify client connectivity to Windows Defender ATP service URLs","pos":[5411,5474]},{"content":"Verify the proxy configuration completed successfully, that WinHTTP can discover and communicate through the proxy server in your environment, and that the proxy server allows traffic to the Windows Defender ATP service URLs.","pos":[5476,5701]},{"content":"Download the connectivity verification tools to the PC where Windows Defender ATP sensor is running on:","pos":[5706,5809]},{"content":"Download PsTools Suite","pos":[5818,5840]},{"content":"Download PortQry Command Line Port Scanner Version 2.0 utility","pos":[5908,5970]},{"pos":[6040,6134],"content":"Extract the contents of <bpt id=\"p1\">**</bpt>PsTools<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>PortQry<ept id=\"p2\">**</ept> to a directory on the computer hard drive."},{"content":"Open an elevated command-line:","pos":[6140,6170]},{"content":"a.","pos":[6176,6178]},{"content":"Click <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> and type <bpt id=\"p2\">**</bpt>cmd<ept id=\"p2\">**</ept>.","pos":[6179,6212]},{"content":"b.","pos":[6218,6220]},{"content":"Right-click <bpt id=\"p1\">**</bpt>Command prompt<ept id=\"p1\">**</ept> and select <bpt id=\"p2\">**</bpt>Run as administrator<ept id=\"p2\">**</ept>.","pos":[6222,6289]},{"pos":[6294,6342],"content":"Enter the following command and press <bpt id=\"p1\">**</bpt>Enter<ept id=\"p1\">**</ept>:"},{"pos":[6404,6544],"content":"Replace <bpt id=\"p1\">*</bpt>HardDrivePath<ept id=\"p1\">*</ept> with the path where the PsTools Suite was extracted to: <ph id=\"ph1\"> ![</ph>Image showing the command line<ph id=\"ph2\">](images/psexec-cmd.png)</ph>","leadings":["","   "]},{"pos":[6549,6597],"content":"Enter the following command and press <bpt id=\"p1\">**</bpt>Enter<ept id=\"p1\">**</ept>:"},{"pos":[6699,6838],"content":"Replace <bpt id=\"p1\">*</bpt>HardDrivePath<ept id=\"p1\">*</ept> with the path where the PortQry utility was extracted to: <ph id=\"ph1\"> ![</ph>Image showing the command line<ph id=\"ph2\">](images/portqry.png)</ph>","leadings":["","   "]},{"pos":[6844,6942],"content":"Verify that the output shows that the name is <bpt id=\"p1\">**</bpt>resolved<ept id=\"p1\">**</ept> and connection status is <bpt id=\"p2\">**</bpt>listening<ept id=\"p2\">**</ept>."},{"content":"Repeat the same steps for the remaining URLs with the following arguments:","pos":[6947,7021]},{"content":"portqry.exe -n eu.vortex-win.data.microsoft.com -e 443 -p tcp","pos":[7029,7090]},{"content":"portqry.exe -n sevillegwcus.microsoft.com -e 443 -p tcp","pos":[7097,7152]},{"content":"portqry.exe -n sevillegweus.microsoft.com -e 443 -p tcp","pos":[7159,7214]},{"content":"portqry.exe -n sevillegwweu.microsoft.com -e 443 -p tcp","pos":[7221,7276]},{"content":"portqry.exe -n sevillegwneu.microsoft.com -e 443 -p tcp","pos":[7283,7338]},{"content":"portqry.exe -n www.microsoft.com -e 80 -p tcp","pos":[7345,7390]},{"content":"portqry.exe -n crl.microsoft.com -e 80 -p tcp","pos":[7397,7442]},{"pos":[7447,7547],"content":"Verify that each URL shows that the name is <bpt id=\"p1\">**</bpt>resolved<ept id=\"p1\">**</ept> and the connection status is <bpt id=\"p2\">**</bpt>listening<ept id=\"p2\">**</ept>."},{"content":"If the any of the verification steps indicate a fail, then verify that you have performed the proxy configuration steps to enable server discovery and access to the service URLs.","pos":[7549,7727]},{"content":"Related topics","pos":[7732,7746]},{"content":"Configure Windows Defender ATP endpoints","pos":[7868,7908]},{"content":"Additional Windows Defender ATP configuration settings","pos":[7981,8035]},{"content":"Monitor the Windows Defender ATP onboarding","pos":[8113,8156]},{"content":"Troubleshoot Windows Defender Advanced Threat Protection onboarding issues","pos":[8228,8302]}],"content":"---\ntitle: Configure Windows Defender ATP endpoint proxy and Internet connection settings\ndescription: Configure the Windows Defender ATP proxy and internet settings to enable communication with the cloud service.\nkeywords: configure, proxy, internet, internet connectivity, settings, proxy settings, web proxy auto detect, wpad, netsh, winhttp, proxy server\nsearch.product: eADQiWindows 10XVcnh\nms.prod: w10\nms.mktglfcycl: deploy\nms.sitesec: library\nms.pagetype: security\nauthor: mjcaparas\n---\n\n\n# Configure endpoint proxy and Internet connectivity settings\n\n**Applies to:**\n\n- Windows 10 Insider Preview Build 14332 or later\n- Windows Defender Advanced Threat Protection (Windows Defender ATP)\n\n<span style=\"color:#ED1C24;\">[Some information relates to pre-released product which may be substantially modified before it's commercially released. Microsoft makes no warranties, express or implied, with respect to the information provided here.]</span>\n\nThe Window Defender ATP sensor requires Microsoft Windows HTTP (WinHTTP) to report telemetry and communicate with the Windows Defender ATP service.\n\nThe embedded Windows Defender ATP sensor runs in system context using the LocalSystem account. The sensor uses Microsoft Windows HTTP Services (WinHTTP) to enable communication with the Windows Defender ATP cloud service.\n\nThe WinHTTP configuration setting is independent of the Windows Internet (WinINet) internet browsing proxy settings and can only discover a proxy server by using the following discovery methods:\n\n- Configure Web Proxy Auto Detect (WPAD) settings and configure Windows to automatically detect the proxy server\n\n- Configure the proxy server manually using Netsh\n\n## Configure Web Proxy Auto Detect (WPAD) settings and proxy server\n\nConfigure WPAD in the environment and configure Windows to automatically detect the proxy server through Policy or the local Windows settings.\n\nEnable the **Automatically detect settings** option in the Windows Proxy settings so that WinHTTP can use the WPAD feature to locate a proxy server.\n\n1. Click **Start** and select **Settings**.\n\n2. Click **Network & Internet**.\n\n3. Select **Proxy**.\n\n4. Verify that the **Automatically detect settings** option is set to On.\n\n    ![Image showing the proxy settings configuration page](images/proxy-settings.png)\n\n5. If the **Use setup script** or **Manual proxy setup** options are enabled then you will need to [configure proxy settings manually by using Netsh](#configure-proxy-server-manually-using-netsh) method for WinHTTP to discover the appropriate proxy settings and connect.\n\n## Configure the proxy server manually using Netsh\n\nIf **Use setup script** or **Manual proxy setup** settings are configured in the Windows Proxy setting, then endpoints will not be discovered by WinHTTP.\nUse Netsh to configure the proxy settings to enable connectivity.\n\nYou can configure the endpoint by using any of these methods:\n\n- Importing the configured proxy settings to WinHTTP\n- Configuring the proxy settings manually to WinHTTP\n\nAfter configuring the endpoints, you'll need to verify that the correct proxy settings were applied.\n\n**Import the configured proxy settings to WinHTTP**\n\n1.  Open an elevated command-line prompt on the endpoint:\n\n    a.  Click **Start** and type **cmd**.\n\n    b.  Right-click **Command prompt** and select **Run as administrator**.\n\n2. Enter the following command and press **Enter**:\n\n ```text\n netsh winhttp import proxy source=ie\n ```\n An output showing the applied WinHTTP proxy settings is displayed.\n\n\n **Configure the proxy settings manually to WinHTTP**\n\n 1.  Open an elevated command-line prompt on the endpoint:\n\n    a.  Click **Start** and type **cmd**.\n\n    b.  Right-click **Command prompt** and select **Run as administrator**.\n\n 2. Enter the following command and press **Enter**:\n\n ```text\n proxy [proxy-server=] ProxyServerName:PortNumber\n ```\n    Replace *ProxyServerName* with the fully qualified domain name of the proxy server.\n\n    Replace *PortNumber* with the port number that you want to configure the proxy server with.\n\n An output showing the applied WinHTTP proxy settings is displayed.\n\n\n**Verify that the correct proxy settings were applied**\n\n1.  Open an elevated command-line prompt on the endpoint:\n\n    a.  Click **Start** and type **cmd**.\n\n    b.  Right-click **Command prompt** and select **Run as administrator**.\n\n2. Enter the following command and press **Enter**:\n\n```\nnetsh winhttp show proxy\n```\n\nFor more information on how to use Netsh see, [Netsh Commands for Windows Hypertext Transfer Protocol (WINHTTP)](https://technet.microsoft.com/en-us/library/cc731131(v=ws.10).aspx)     \n\n## Enable access to Windows Defender ATP service URLs in the proxy server\n\nIf a proxy or firewall is blocking all traffic by default and allowing only specific domains through, make sure that the following URLs are white-listed to permit communication with Windows Defender ATP service in port 80 and 443:\n\n- us.vortex-win.data.microsoft.com  \n- eu.vortex-win.data.microsoft.com\n- sevillegwcus.microsoft.com\n- sevillegweus.microsoft.com\n- sevillegwweu.microsoft.com\n- sevillegwneu.microsoft.com\n- www.microsoft.com\n- crl.microsoft.com\n- \\*.blob.core.windows.net\n\nIf a proxy or firewall is blocking anonymous traffic, as Windows Defender ATP  sensor is connecting from system context, make sure anonymous traffic is permitted to the above listed URLs.\n\n## Verify client connectivity to Windows Defender ATP service URLs\n\nVerify the proxy configuration completed successfully, that WinHTTP can discover and communicate through the proxy server in your environment, and that the proxy server allows traffic to the Windows Defender ATP service URLs.\n\n1. Download the connectivity verification tools to the PC where Windows Defender ATP sensor is running on:\n\n    - [Download PsTools Suite](https://technet.microsoft.com/en-us/sysinternals/bb896649)\n    - [Download PortQry Command Line Port Scanner Version 2.0 utility](https://www.microsoft.com/en-us/download/details.aspx?id=17148)\n\n2. Extract the contents of **PsTools** and **PortQry** to a directory on the computer hard drive.\n\n3.  Open an elevated command-line:\n\n    a. Click **Start** and type **cmd**.\n\n    b.  Right-click **Command prompt** and select **Run as administrator**.\n\n4. Enter the following command and press **Enter**:\n\n    ```\n    HardDrivePath\\PsExec.exe -s cmd.exe\n    ```\n    Replace *HardDrivePath* with the path where the PsTools Suite was extracted to:\n    ![Image showing the command line](images/psexec-cmd.png)\n\n5. Enter the following command and press **Enter**:\n\n    ```\n    HardDrivePath\\portqry.exe -n us.vortex-win.data.microsoft.com -e 443 -p tcp\n    ```\n    Replace *HardDrivePath* with the path where the PortQry utility was extracted to:\n    ![Image showing the command line](images/portqry.png)\n\n6.  Verify that the output shows that the name is **resolved** and connection status is **listening**.\n\n7. Repeat the same steps for the remaining URLs with the following arguments:\n\n    - portqry.exe -n eu.vortex-win.data.microsoft.com -e 443 -p tcp\n    - portqry.exe -n sevillegwcus.microsoft.com -e 443 -p tcp\n    - portqry.exe -n sevillegweus.microsoft.com -e 443 -p tcp\n    - portqry.exe -n sevillegwweu.microsoft.com -e 443 -p tcp\n    - portqry.exe -n sevillegwneu.microsoft.com -e 443 -p tcp\n    - portqry.exe -n www.microsoft.com -e 80 -p tcp\n    - portqry.exe -n crl.microsoft.com -e 80 -p tcp\n\n8. Verify that each URL shows that the name is **resolved** and the connection status is **listening**.\n\nIf the any of the verification steps indicate a fail, then verify that you have performed the proxy configuration steps to enable server discovery and access to the service URLs.\n\n## Related topics\n<!--- [Windows Defender ATP service onboarding](service-onboarding-windows-defender-advanced-threat-protection.md)-->\n- [Configure Windows Defender ATP endpoints](configure-endpoints-windows-defender-advanced-threat-protection.md)\n- [Additional Windows Defender ATP configuration settings](additional-configuration-windows-defender-advanced-threat-protection.md)\n- [Monitor the Windows Defender ATP onboarding](monitor-onboarding-windows-defender-advanced-threat-protection.md)\n- [Troubleshoot Windows Defender Advanced Threat Protection onboarding issues](troubleshoot-onboarding-windows-defender-advanced-threat-protection.md)\n"}
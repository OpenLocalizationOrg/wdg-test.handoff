{"nodes":[{"content":"Securing End-to-End IPsec Connections by Using IKEv2 in Windows Server 2012 (Windows 10)","pos":[11,99]},{"content":"Securing End-to-End IPsec Connections by Using IKEv2 in Windows Server 2012","pos":[113,188]},{"content":"Securing End-to-End IPsec connections by using IKEv2","pos":[295,347]},{"content":"Applies to","pos":[351,361]},{"content":"Windows 10","pos":[368,378]},{"content":"Windows Server 2016 Technical Preview","pos":[383,420]},{"content":"IKEv2 offers the following:","pos":[422,449]},{"content":"Supports IPsec end-to-end transport mode connections","pos":[455,507]},{"content":"Provides interoperability for Windows with other operating systems that use IKEv2 for end-to-end security","pos":[513,618]},{"content":"Supports Suite B (RFC 4869) requirements","pos":[624,664]},{"content":"Coexists with existing policies that deploy AuthIP/IKEv1","pos":[670,726]},{"content":"Uses the Windows PowerShell interface exclusively for configuration.","pos":[732,800]},{"content":"You cannot configure IKEv2 through the user interface.","pos":[801,855]},{"content":"Uses certificates for the authentication mechanism","pos":[861,911]},{"content":"You can use IKEv2 as a virtual private network (VPN) tunneling protocol that supports automatic VPN reconnection.","pos":[913,1026]},{"content":"IKEv2 allows the security association to remain unchanged despite changes in the underlying connection.","pos":[1027,1130]},{"content":"In this document","pos":[1134,1150]},{"content":"Prerequisites","pos":[1159,1172]},{"content":"Devices joined to a domain","pos":[1196,1222]},{"content":"Device not joined to a domain","pos":[1259,1288]},{"content":"Troubleshooting","pos":[1329,1344]},{"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  This topic includes sample Windows PowerShell cmdlets.","pos":[1366,1431]},{"content":"For more info, see <bpt id=\"p1\">[</bpt>How to Run a Windows PowerShell Cmdlet<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=230693)</ept>.","pos":[1432,1541]},{"content":"Prerequisites","pos":[1546,1559]},{"content":"These procedures assume that you already have a public key infrastructure (PKI) in place for device authentication.","pos":[1561,1676]},{"content":"Devices joined to a domain","pos":[1681,1707]},{"content":"The following Windows PowerShell script establishes a connection security rule that uses IKEv2 for communication between two computers (CLIENT1 and SERVER1) that are joined to the corp.contoso.com domain as shown in Figure 1.","pos":[1709,1934]},{"content":"the contoso corporate network","pos":[1938,1967]},{"pos":[1990,2032],"content":"<bpt id=\"p1\">**</bpt>Figure 1<ept id=\"p1\">**</ept> The Contoso corporate network"},{"content":"This script does the following:","pos":[2034,2065]},{"pos":[2071,2172],"content":"Creates a security group called <bpt id=\"p1\">**</bpt>IPsec client and servers<ept id=\"p1\">**</ept> and adds CLIENT1 and SERVER1 as members."},{"pos":[2178,2294],"content":"Creates a Group Policy Object (GPO) called <bpt id=\"p1\">**</bpt>IPsecRequireInRequestOut<ept id=\"p1\">**</ept> and links it to the corp.contoso.com domain."},{"pos":[2300,2440],"content":"Sets the permissions to the GPO so that they apply only to the computers in <bpt id=\"p1\">**</bpt>IPsec client and servers<ept id=\"p1\">**</ept> and not to <bpt id=\"p2\">**</bpt>Authenticated Users<ept id=\"p2\">**</ept>."},{"content":"Indicates the certificate to use for authentication.","pos":[2446,2498]},{"content":"<bpt id=\"p1\">**</bpt>Important:<ept id=\"p1\">**</ept>  The certificate parameters that you specify for the certificate are case sensitive, so make sure that you type them exactly as specified in the certificate, and place the parameters in the exact order that you see in the following example.","pos":[2505,2760]},{"content":"Failure to do so will result in connection errors.","pos":[2761,2811]},{"pos":[2817,2885],"content":"Creates the IKEv2 connection security rule called <bpt id=\"p1\">**</bpt>My IKEv2 Rule<ept id=\"p1\">**</ept>."},{"pos":[2889,2968],"content":"powershell logo<bpt id=\"p1\">](images/powershelllogosmall.gif)**</bpt>Windows PowerShell commands<ept id=\"p1\">**</ept>"},{"content":"Type each cmdlet on a single line, even though they may appear to wrap across several lines because of formatting constraints.","pos":[2970,3096]},{"content":"Devices not joined to a domain","pos":[4681,4711]},{"content":"Use a Windows PowerShell script similar to the following to create a local IPsec policy on the devices that you want to include in the secure connection.","pos":[4713,4866]},{"content":"<bpt id=\"p1\">**</bpt>Important:<ept id=\"p1\">**</ept>  The certificate parameters that you specify for the certificate are case sensitive, so make sure that you type them exactly as specified in the certificate, and place the parameters in the exact order that you see in the following example.","pos":[4869,5124]},{"content":"Failure to do so will result in connection errors.","pos":[5125,5175]},{"pos":[5179,5258],"content":"powershell logo<bpt id=\"p1\">](images/powershelllogosmall.gif)**</bpt>Windows PowerShell commands<ept id=\"p1\">**</ept>"},{"content":"Type each cmdlet on a single line, even though they may appear to wrap across several lines because of formatting constraints.","pos":[5260,5386]},{"content":"Make sure that you install the required certificates on the participating computers.","pos":[5846,5930]},{"content":"Note:","pos":[5935,5940]},{"content":"For local devices, you can import the certificates manually if you have administrator access to the computer.","pos":[5949,6058]},{"content":"For more info, see <bpt id=\"p1\">[</bpt>Import or export certificates and private keys<ept id=\"p1\">](http://windows.microsoft.com/windows-vista/Import-or-export-certificates-and-private-keys)</ept>.","pos":[6059,6218]},{"content":"You need a root certificate and a computer certificate on all devices that participate in the secure connection.","pos":[6223,6335]},{"content":"Save the computer certificate in the <bpt id=\"p1\">**</bpt>Personal/Certificates<ept id=\"p1\">**</ept> folder.","pos":[6336,6406]},{"content":"For remote devices, you can create a secure website to facilitate access to the script and certificates.","pos":[6411,6515]},{"content":"Troubleshooting","pos":[6520,6535]},{"content":"Follow these procedures to verify and troubleshoot your IKEv2 IPsec connections:","pos":[6537,6617]},{"content":"Use the Windows Firewall with Advanced Security snap-in to verify that a connection security rule is enabled.","pos":[6621,6730]},{"content":"Open the Windows Firewall with Advanced Security console.","pos":[6738,6795]},{"pos":[6801,6977],"content":"In the left pane of the Windows Firewall with Advanced Security snap-in, click <bpt id=\"p1\">**</bpt>Connection Security Rules<ept id=\"p1\">**</ept>, and then verify that there is an enabled connection security rule."},{"pos":[6983,7126],"content":"Expand <bpt id=\"p1\">**</bpt>Monitoring<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Connection Security Rules<ept id=\"p2\">**</ept> to verify that your IKEv2 rule is active for your currently active profile."},{"content":"Use Windows PowerShell cmdlets to display the security associations.","pos":[7130,7198]},{"content":"Open a Windows PowerShell command prompt.","pos":[7206,7247]},{"pos":[7253,7334],"content":"Type <bpt id=\"p1\">**</bpt>get-NetIPsecQuickModeSA<ept id=\"p1\">**</ept> to display the Quick Mode security associations."},{"pos":[7340,7419],"content":"Type <bpt id=\"p1\">**</bpt>get-NetIPsecMainModeSA<ept id=\"p1\">**</ept> to display the Main Mode security associations."},{"content":"Use netsh to capture IPsec events.","pos":[7423,7457]},{"content":"Open an elevated command prompt.","pos":[7465,7497]},{"pos":[7503,7559],"content":"At the command prompt, type <bpt id=\"p1\">**</bpt>netsh wfp capture start<ept id=\"p1\">**</ept>."},{"content":"Reproduce the error event so that it can be captured.","pos":[7565,7618]},{"pos":[7624,7679],"content":"At the command prompt, type <bpt id=\"p1\">**</bpt>netsh wfp capture stop<ept id=\"p1\">**</ept>."},{"content":"A wfpdiag.cab file is created in the current folder.","pos":[7685,7737]},{"content":"Open the cab file, and then extract the wfpdiag.xml file.","pos":[7743,7800]},{"content":"Open the wfpdiag.xml file with your an XML viewer program or Notepad, and then examine the contents.","pos":[7806,7906]},{"content":"There will be a lot of data in this file.","pos":[7907,7948]},{"content":"One way to narrow down where to start looking is to search the last “errorFrequencyTable” at the end of the file.","pos":[7949,8062]},{"content":"There might be many instances of this table, so make sure that you look at the last table in the file.","pos":[8063,8165]},{"content":"For example, if you have a certificate problem, you might see the following entry in the last table at the end of the file:","pos":[8166,8289]},{"content":"In this example, there are 32 instances of the <bpt id=\"p1\">**</bpt>ERROR<ph id=\"ph1\">\\_</ph>IPSEC<ph id=\"ph2\">\\_</ph>IKE<ph id=\"ph3\">\\_</ph>NO<ph id=\"ph4\">\\_</ph>CERT<ept id=\"p1\">**</ept> error.","pos":[8418,8503]},{"content":"So now you can search for <bpt id=\"p1\">**</bpt>ERROR<ph id=\"ph1\">\\_</ph>IPSEC<ph id=\"ph2\">\\_</ph>IKE<ph id=\"ph3\">\\_</ph>NO<ph id=\"ph4\">\\_</ph>CERT<ept id=\"p1\">**</ept> to get more details regarding this error.","pos":[8504,8603]},{"content":"You might not find the exact answer for the issue, but you can find good hints.","pos":[8605,8684]},{"content":"For example, you might find that there seems to be an issue with the certificates, so you can look at your certificates and the related cmdlets for possible issues.","pos":[8685,8849]},{"content":"See also","pos":[8854,8862]},{"content":"Windows Firewall with Advanced Security","pos":[8869,8908]}],"content":"---\ntitle: Securing End-to-End IPsec Connections by Using IKEv2 in Windows Server 2012 (Windows 10)\ndescription: Securing End-to-End IPsec Connections by Using IKEv2 in Windows Server 2012\nms.prod: w10\nms.mktglfcycl: deploy\nms.sitesec: library\nms.pagetype: security\nauthor: brianlic-msft\n---\n\n# Securing End-to-End IPsec connections by using IKEv2\n\n**Applies to**\n-   Windows 10\n-   Windows Server 2016 Technical Preview\n\nIKEv2 offers the following:\n\n-   Supports IPsec end-to-end transport mode connections\n\n-   Provides interoperability for Windows with other operating systems that use IKEv2 for end-to-end security\n\n-   Supports Suite B (RFC 4869) requirements\n\n-   Coexists with existing policies that deploy AuthIP/IKEv1\n\n-   Uses the Windows PowerShell interface exclusively for configuration. You cannot configure IKEv2 through the user interface.\n\n-   Uses certificates for the authentication mechanism\n\nYou can use IKEv2 as a virtual private network (VPN) tunneling protocol that supports automatic VPN reconnection. IKEv2 allows the security association to remain unchanged despite changes in the underlying connection.\n\n**In this document**\n\n-   [Prerequisites](#prerequisites)\n\n-   [Devices joined to a domain](#devices-joined-to-a-domain)\n\n-   [Device not joined to a domain](#devices-not-joined-to-a-domain)\n\n-   [Troubleshooting](#troubleshooting)\n\n>**Note:**  This topic includes sample Windows PowerShell cmdlets. For more info, see [How to Run a Windows PowerShell Cmdlet](http://go.microsoft.com/fwlink/p/?linkid=230693).\n\n## Prerequisites\n\nThese procedures assume that you already have a public key infrastructure (PKI) in place for device authentication.\n\n## Devices joined to a domain\n\nThe following Windows PowerShell script establishes a connection security rule that uses IKEv2 for communication between two computers (CLIENT1 and SERVER1) that are joined to the corp.contoso.com domain as shown in Figure 1.\n\n![the contoso corporate network](images/corpnet.gif)\n\n**Figure 1** The Contoso corporate network\n\nThis script does the following:\n\n-   Creates a security group called **IPsec client and servers** and adds CLIENT1 and SERVER1 as members.\n\n-   Creates a Group Policy Object (GPO) called **IPsecRequireInRequestOut** and links it to the corp.contoso.com domain.\n\n-   Sets the permissions to the GPO so that they apply only to the computers in **IPsec client and servers** and not to **Authenticated Users**.\n\n-   Indicates the certificate to use for authentication.\n\n    >**Important:**  The certificate parameters that you specify for the certificate are case sensitive, so make sure that you type them exactly as specified in the certificate, and place the parameters in the exact order that you see in the following example. Failure to do so will result in connection errors.\n\n-   Creates the IKEv2 connection security rule called **My IKEv2 Rule**.\n\n![powershell logo](images/powershelllogosmall.gif)**Windows PowerShell commands**\n\nType each cmdlet on a single line, even though they may appear to wrap across several lines because of formatting constraints.\n\n``` syntax\n# Create a Security Group for the computers that will get the policy\n$pathname = (Get-ADDomain).distinguishedname\nNew-ADGroup -name \"IPsec client and servers\" -SamAccountName \"IPsec client and servers\" `\n-GroupCategory security -GroupScope Global -path $pathname\n\n# Add test computers to the Security Group\n$computer = Get-ADComputer -LDAPFilter \"(name=client1)\"\nAdd-ADGroupMember -Identity \"IPsec client and servers\" -Members $computer\n$computer = Get-ADComputer -LDAPFilter \"(name=server1)\"\nAdd-ADGroupMember -Identity \"IPsec client and servers\" -Members $computer\n\n# Create and link the GPO to the domain \n$gpo = New-gpo IPsecRequireInRequestOut\n$gpo | new-gplink -target \"dc=corp,dc=contoso,dc=com\" -LinkEnabled Yes\n\n# Set permissions to security group for the GPO\n$gpo | Set-GPPermissions -TargetName \"IPsec client and servers\" -TargetType Group -PermissionLevel GpoApply -Replace\n$gpo | Set-GPPermissions -TargetName \"Authenticated Users\" -TargetType Group -PermissionLevel None -Replace\n\n#Set up the certificate for authentication\n$gponame = \"corp.contoso.com\\IPsecRequireInRequestOut\" \n$certprop = New-NetIPsecAuthProposal -machine -cert -Authority \"DC=com, DC=contoso, DC=corp, CN=corp-APP1-CA\"\n$myauth = New-NetIPsecPhase1AuthSet -DisplayName \"IKEv2TestPhase1AuthSet\" -proposal $certprop –PolicyStore GPO:$gponame\n\n#Create the IKEv2 Connection Security rule\nNew-NetIPsecRule  -DisplayName \"My IKEv2 Rule\" -RemoteAddress any -Phase1AuthSet $myauth.InstanceID `\n-InboundSecurity Require -OutboundSecurity Request -KeyModule IKEv2 -PolicyStore GPO:$gponame\n```\n\n## Devices not joined to a domain\n\nUse a Windows PowerShell script similar to the following to create a local IPsec policy on the devices that you want to include in the secure connection.\n\n>**Important:**  The certificate parameters that you specify for the certificate are case sensitive, so make sure that you type them exactly as specified in the certificate, and place the parameters in the exact order that you see in the following example. Failure to do so will result in connection errors.\n\n![powershell logo](images/powershelllogosmall.gif)**Windows PowerShell commands**\n\nType each cmdlet on a single line, even though they may appear to wrap across several lines because of formatting constraints.\n\n``` syntax\n#Set up the certificate\n$certprop = New-NetIPsecAuthProposal -machine -cert -Authority \"DC=com, DC=contoso, DC=corp, CN=corp-APP1-CA\"\n$myauth = New-NetIPsecPhase1AuthSet -DisplayName \"IKEv2TestPhase1AuthSet\" -proposal $certprop\n\n#Create the IKEv2 Connection Security rule\nNew-NetIPsecRule  -DisplayName \"My IKEv2 Rule\" -RemoteAddress any -Phase1AuthSet $myauth.InstanceID `\n-InboundSecurity Require -OutboundSecurity Request -KeyModule IKEv2\n```\n\nMake sure that you install the required certificates on the participating computers.\n\n>**Note:**  \n-   For local devices, you can import the certificates manually if you have administrator access to the computer. For more info, see [Import or export certificates and private keys](http://windows.microsoft.com/windows-vista/Import-or-export-certificates-and-private-keys).\n-   You need a root certificate and a computer certificate on all devices that participate in the secure connection. Save the computer certificate in the **Personal/Certificates** folder.\n-   For remote devices, you can create a secure website to facilitate access to the script and certificates.\n\n## Troubleshooting\n\nFollow these procedures to verify and troubleshoot your IKEv2 IPsec connections:\n\n**Use the Windows Firewall with Advanced Security snap-in to verify that a connection security rule is enabled.**\n\n1.  Open the Windows Firewall with Advanced Security console.\n\n2.  In the left pane of the Windows Firewall with Advanced Security snap-in, click **Connection Security Rules**, and then verify that there is an enabled connection security rule.\n\n3.  Expand **Monitoring**, and then click **Connection Security Rules** to verify that your IKEv2 rule is active for your currently active profile.\n\n**Use Windows PowerShell cmdlets to display the security associations.**\n\n1.  Open a Windows PowerShell command prompt.\n\n2.  Type **get-NetIPsecQuickModeSA** to display the Quick Mode security associations.\n\n3.  Type **get-NetIPsecMainModeSA** to display the Main Mode security associations.\n\n**Use netsh to capture IPsec events.**\n\n1.  Open an elevated command prompt.\n\n2.  At the command prompt, type **netsh wfp capture start**.\n\n3.  Reproduce the error event so that it can be captured.\n\n4.  At the command prompt, type **netsh wfp capture stop**.\n\n    A wfpdiag.cab file is created in the current folder.\n\n5.  Open the cab file, and then extract the wfpdiag.xml file.\n\n6.  Open the wfpdiag.xml file with your an XML viewer program or Notepad, and then examine the contents. There will be a lot of data in this file. One way to narrow down where to start looking is to search the last “errorFrequencyTable” at the end of the file. There might be many instances of this table, so make sure that you look at the last table in the file. For example, if you have a certificate problem, you might see the following entry in the last table at the end of the file:\n\n    ``` syntax\n    <item>\n      <error>ERROR_IPSEC_IKE_NO_CERT</error>\n      <frequency>32</frequency>\n    </item>\n    ```\n    In this example, there are 32 instances of the **ERROR\\_IPSEC\\_IKE\\_NO\\_CERT** error. So now you can search for **ERROR\\_IPSEC\\_IKE\\_NO\\_CERT** to get more details regarding this error.\n\nYou might not find the exact answer for the issue, but you can find good hints. For example, you might find that there seems to be an issue with the certificates, so you can look at your certificates and the related cmdlets for possible issues.\n\n## See also\n\n-   [Windows Firewall with Advanced Security](windows-firewall-with-advanced-security.md)\n\n \n\n \n\n\n\n\n\n"}
{"nodes":[{"content":"BitLocker recovery guide (Windows 10)","pos":[11,48]},{"content":"This topic for IT professionals describes how to recover BitLocker keys from AD DS.","pos":[62,145]},{"content":"BitLocker recovery guide","pos":[302,326]},{"content":"Applies to","pos":[330,340]},{"content":"Windows 10","pos":[347,357]},{"content":"This topic for IT professionals describes how to recover BitLocker keys from AD DS.","pos":[359,442]},{"content":"Organizations can use BitLocker recovery information saved in Active Directory Domain Services (AD DS) to access BitLocker-protected data.","pos":[444,582]},{"content":"Creating a recovery model for BitLocker while you are planning your BitLocker deployment is recommended.","pos":[583,687]},{"content":"This article assumes that you understand how to set up AD DS to back up BitLocker recovery information automatically, and what types of recovery information are saved to AD DS.","pos":[689,865]},{"content":"This article does not detail how to configure AD DS to store the BitLocker recovery information.","pos":[867,963]},{"content":"This article contains the following topics:","pos":[965,1008]},{"content":"What Is BitLocker Recovery?","pos":[1015,1042]},{"content":"Testing Recovery","pos":[1071,1087]},{"content":"Planning Your Recovery Process","pos":[1117,1147]},{"content":"Using Additional Recovery Information","pos":[1178,1215]},{"content":"Resetting Recovery Passwords","pos":[1246,1274]},{"content":"Retrieving the BitLocker Key Package","pos":[1298,1334]},{"pos":[1397,1424],"content":"What is BitLocker recovery?"},{"content":"BitLocker recovery is the process by which you can restore access to a BitLocker-protected drive in the event that you cannot unlock the drive normally.","pos":[1426,1578]},{"content":"In a recovery scenario you have the following options to restore access to the drive:","pos":[1579,1664]},{"content":"The user can supply the recovery password.","pos":[1670,1712]},{"content":"If your organization allows users to print or store recovery passwords, the user can type in the 48-digit recovery password that they printed or stored on a USB drive or with your Microsoft Account online.","pos":[1713,1918]},{"content":"(Saving a recovery password with your Microsoft Account online is only allowed when BitLocker is used on a PC that is not a member of a domain).","pos":[1919,2063]},{"content":"A data recovery agent can use their credentials to unlock the drive.","pos":[2068,2136]},{"content":"If the drive is an operating system drive, the drive must be mounted as a data drive on another computer for the data recovery agent to unlock it.","pos":[2137,2283]},{"content":"A domain administrator can obtain the recovery password from AD DS and use it to unlock the drive.","pos":[2288,2386]},{"content":"Storing recovery passwords in AD DS is recommended to provide a way for IT professionals to be able to obtain recovery passwords for drives in their organization if needed.","pos":[2387,2559]},{"content":"This method requires that you have enabled this recovery method in the BitLocker Group Policy setting <bpt id=\"p1\">**</bpt>Choose how BitLocker-protected operating system drives can be recovered<ept id=\"p1\">**</ept> located at <bpt id=\"p2\">**</bpt>Computer Configuration<ph id=\"ph1\">\\\\</ph>Administrative Templates<ph id=\"ph2\">\\\\</ph>Windows Components<ph id=\"ph3\">\\\\</ph>BitLocker Drive Encryption<ph id=\"ph4\">\\\\</ph>Operating System Drives<ept id=\"p2\">**</ept> in the Local Group Policy Editor.","pos":[2560,2908]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>BitLocker Group Policy settings<ept id=\"p1\">](bitlocker-group-policy-settings.md)</ept>.","pos":[2909,3005]},{"content":"What causes BitLocker recovery?","pos":[3011,3042]},{"content":"The following list provides examples of specific events that will cause BitLocker to enter recovery mode when attempting to start the operating system drive:","pos":[3044,3201]},{"content":"On PCs that use either BitLocker or Device Encryption when an attack is detected the device will immediately reboot and enter into BitLocker recovery mode.","pos":[3207,3362]},{"content":"To take advantage of this functionality Administrators can set the <bpt id=\"p1\">**</bpt>Interactive logon: Machine account lockout threshold<ept id=\"p1\">**</ept> Group Policy setting located in <bpt id=\"p2\">**</bpt><ph id=\"ph1\">\\\\</ph>Computer Configuration<ph id=\"ph2\">\\\\</ph>Windows Settings<ph id=\"ph3\">\\\\</ph>Security Settings<ph id=\"ph4\">\\\\</ph>Local Policies<ph id=\"ph5\">\\\\</ph>Security Options<ept id=\"p2\">**</ept> in the Local Group Policy Editor, or use the <bpt id=\"p3\">**</bpt>MaxFailedPasswordAttempts<ept id=\"p3\">**</ept> policy of <bpt id=\"p4\">[</bpt>Exchange ActiveSync<ept id=\"p4\">](http://technet.microsoft.com/library/aa998357.aspx)</ept> (also configurable through <bpt id=\"p5\">[</bpt>Windows Intune<ept id=\"p5\">](http://technet.microsoft.com/library/jj733621.aspx)</ept>), to limit the number of failed password attempts before the device goes into Device Lockout.","pos":[3363,3967]},{"content":"Changing the boot order to boot another drive in advance of the hard drive.","pos":[3972,4047]},{"content":"Having the CD or DVD drive before the hard drive in the BIOS boot order and then inserting or removing a CD or DVD.","pos":[4052,4167]},{"content":"Failing to boot from a network drive before booting from the hard drive.","pos":[4172,4244]},{"content":"Docking or undocking a portable computer.","pos":[4249,4290]},{"content":"In some instances (depending on the computer manufacturer and the BIOS), the docking condition of the portable computer is part of the system measurement and must be consistent to validate the system status and unlock BitLocker.","pos":[4291,4519]},{"content":"This means that if a portable computer is connected to its docking station when BitLocker is turned on, then it might also need to be connected to the docking station when it is unlocked.","pos":[4520,4707]},{"content":"Conversely, if a portable computer is not connected to its docking station when BitLocker is turned on, then it might need to be disconnected from the docking station when it is unlocked.","pos":[4708,4895]},{"content":"Changes to the NTFS partition table on the disk including creating, deleting, or resizing a primary partition.","pos":[4900,5010]},{"content":"Entering the personal identification number (PIN) incorrectly too many times so that the anti-hammering logic of the TPM is activated.","pos":[5015,5149]},{"content":"Anti-hammering logic is software or hardware methods that increase the difficulty and cost of a brute force attack on a PIN by not accepting PIN entries until after a certain amount of time has passed.","pos":[5150,5351]},{"content":"Turning off the support for reading the USB device in the pre-boot environment from the BIOS or UEFI firmware if you are using USB-based keys instead of a TPM.","pos":[5356,5515]},{"content":"Turning off, disabling, deactivating, or clearing the TPM.","pos":[5520,5578]},{"content":"Upgrading critical early startup components, such as a BIOS or UEFI firmware upgrade, causing the related boot measurements to change.","pos":[5583,5717]},{"content":"Forgetting the PIN when PIN authentication has been enabled.","pos":[5722,5782]},{"content":"Updating option ROM firmware.","pos":[5787,5816]},{"content":"Upgrading TPM firmware.","pos":[5821,5844]},{"content":"Adding or removing hardware; for example, inserting a new card in the computer, including some PCMIA wireless cards.","pos":[5849,5965]},{"content":"Removing, inserting, or completely depleting the charge on a smart battery on a portable computer.","pos":[5970,6068]},{"content":"Changes to the master boot record on the disk.","pos":[6073,6119]},{"content":"Changes to the boot manager on the disk.","pos":[6124,6164]},{"content":"Hiding the TPM from the operating system.","pos":[6169,6210]},{"content":"Some BIOS or UEFI settings can be used to prevent the enumeration of the TPM to the operating system.","pos":[6211,6312]},{"content":"When implemented, this option can make the TPM hidden from the operating system.","pos":[6313,6393]},{"content":"When the TPM is hidden, BIOS and UEFI secure startup are disabled, and the TPM does not respond to commands from any software.","pos":[6394,6520]},{"content":"Using a different keyboard that does not correctly enter the PIN or whose keyboard map does not match the keyboard map assumed by the pre-boot environment.","pos":[6525,6680]},{"content":"This can prevent the entry of enhanced PINs.","pos":[6681,6725]},{"content":"Modifying the Platform Configuration Registers (PCRs) used by the TPM validation profile.","pos":[6730,6819]},{"content":"For example, including <bpt id=\"p1\">**</bpt>PCR<ph id=\"ph1\">\\[</ph>1<ph id=\"ph2\">\\]</ph><ept id=\"p1\">**</ept> would result in BitLocker measuring most changes to BIOS settings, causing BitLocker to enter recovery mode even when non-boot critical BIOS settings change.","pos":[6820,7013]},{"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  Some computers have BIOS settings that skip measurements to certain PCRs, such as <bpt id=\"p2\">**</bpt>PCR<ph id=\"ph1\">\\[</ph>2<ph id=\"ph2\">\\]</ph><ept id=\"p2\">**</ept>.","pos":[7020,7126]},{"content":"Changing this setting in the BIOS would cause BitLocker to enter recovery mode because the PCR measurement will be different.","pos":[7127,7252]},{"content":"Moving the BitLocker-protected drive into a new computer.","pos":[7263,7320]},{"content":"Upgrading the motherboard to a new one with a new TPM.","pos":[7325,7379]},{"content":"Losing the USB flash drive containing the startup key when startup key authentication has been enabled.","pos":[7384,7487]},{"content":"Failing the TPM self-test.","pos":[7492,7518]},{"content":"Having a BIOS, UEFI firmware, or an option ROM component that is not compliant with the relevant Trusted Computing Group standards for a client computer.","pos":[7523,7676]},{"content":"For example, a non-compliant implementation may record volatile data (such as time) in the TPM measurements, causing different measurements on each startup and causing BitLocker to start in recovery mode.","pos":[7677,7881]},{"content":"Changing the usage authorization for the storage root key of the TPM to a non-zero value.","pos":[7886,7975]},{"pos":[7982,8145],"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  The BitLocker TPM initialization process sets the usage authorization value to zero, so another user or process must explicitly have changed this value."},{"content":"Disabling the code integrity check or enabling test signing on Windows Boot Manager (Bootmgr).","pos":[8156,8250]},{"content":"Pressing the F8 or F10 key during the boot process.","pos":[8255,8306]},{"content":"Adding or removing add-in cards (such as video or network cards), or upgrading firmware on add-in cards.","pos":[8311,8415]},{"content":"Using a BIOS hot key during the boot process to change the boot order to something other than the hard drive.","pos":[8420,8529]},{"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  Before you begin recovery, we recommend that you determine what caused recovery.","pos":[8532,8623]},{"content":"This might help prevent the problem from occurring again in the future.","pos":[8624,8695]},{"content":"For instance, if you determine that an attacker has modified your computer by obtaining physical access, you can create new security policies for tracking who has physical presence.","pos":[8696,8877]},{"content":"After the recovery password has been used to recover access to the PC, BitLocker will reseal the encryption key to the current values of the measured components.","pos":[8878,9039]},{"content":"For planned scenarios, such as a known hardware or firmware upgrades, you can avoid initiating recovery by temporarily suspending BitLocker protection.","pos":[9042,9193]},{"content":"Because suspending BitLocker leaves the drive fully encrypted, the administrator can quickly resume BitLocker protection after the planned task has been completed.","pos":[9194,9357]},{"content":"Using suspend and resume also reseals the encryption key without requiring the entry of the recovery key.","pos":[9358,9463]},{"pos":[9466,9636],"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  If suspended BitLocker will automatically resume protection when the PC is rebooted, unless a reboot count is specified using the manage-bde command line tool."},{"content":"If software maintenance requires the computer be restarted and you are using two-factor authentication, you can enable BitLocker Network Unlock to provide the secondary authentication factor when the computers do not have an on-premise user to provide the additional authentication method.","pos":[9638,9927]},{"content":"Recovery has been described within the context of unplanned or undesired behavior, but you can also cause recovery as an intended production scenario, in order to manage access control.","pos":[9930,10115]},{"content":"For example, when you redeploy desktop or laptop computers to other departments or employees in your enterprise, you can force BitLocker into recovery before the computer is given to a new user.","pos":[10116,10310]},{"pos":[10356,10372],"content":"Testing recovery"},{"content":"Before you create a thorough BitLocker recovery process, we recommend that you test how the recovery process works for both end users (people who call your helpdesk for the recovery password) and administrators (people who help the end user get the recovery password).","pos":[10374,10642]},{"content":"The –forcerecovery command of manage-bde is an easy way for you to step through the recovery process before your users encounter a recovery situation.","pos":[10643,10793]},{"content":"To force a recovery for the local computer","pos":[10797,10839]},{"pos":[10847,10982],"content":"Click the <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> button, type <bpt id=\"p2\">**</bpt>cmd<ept id=\"p2\">**</ept> in the <bpt id=\"p3\">**</bpt>Start Search<ept id=\"p3\">**</ept> box, right-click <bpt id=\"p4\">**</bpt>cmd.exe<ept id=\"p4\">**</ept>, and then click <bpt id=\"p5\">**</bpt>Run as administrator<ept id=\"p5\">**</ept>."},{"pos":[10987,11099],"content":"At the command prompt, type the following command and then press ENTER: <ph id=\"ph1\">`manage-bde -forcerecovery &lt;Volume&gt;`</ph>","leadings":["","    "]},{"content":"To force recovery for a remote computer","pos":[11107,11146]},{"pos":[11154,11233],"content":"On the Start screen, type <bpt id=\"p1\">**</bpt>cmd.exe<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Run as administrator<ept id=\"p2\">**</ept>."},{"pos":[11238,11380],"content":"At the command prompt, type the following command and then press ENTER: <ph id=\"ph1\">`manage-bde. -ComputerName &lt;ComputerName&gt; -forcerecovery &lt;Volume&gt;`</ph>","leadings":["","    "]},{"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  <bpt id=\"p2\">*</bpt>ComputerName<ept id=\"p2\">*</ept> represents the name of the remote computer.","pos":[11384,11453]},{"content":"<bpt id=\"p1\">*</bpt>Volume<ept id=\"p1\">*</ept> represents the volume on the remote computer that is protected with BitLocker.","pos":[11454,11541]},{"pos":[11589,11619],"content":"Planning your recovery process"},{"content":"When planning the BitLocker recovery process, first consult your organization's current best practices for recovering sensitive information.","pos":[11621,11761]},{"content":"For example: How does your enterprise handle lost Windows passwords?","pos":[11762,11830]},{"content":"How does your organization perform smart card PIN resets?","pos":[11831,11888]},{"content":"You can use these best practices and related resources (people and tools) to help formulate a BitLocker recovery model.","pos":[11889,12008]},{"content":"Organizations that rely on BitLocker Drive Encryption and BitLocker To Go to protect data on a large number of computers and removable drives running the Windows 10, Windows 8, or Windows 7 operating systems and Windows to Go should consider using the Microsoft BitLocker Administration and Monitoring (MBAM) Tool version 2.0, which is included in the Microsoft Desktop Optimization Pack (MDOP) for Microsoft Software Assurance.","pos":[12010,12438]},{"content":"MBAM makes BitLocker implementations easier to deploy and manage and allows administrators to provision and monitor encryption for operating system and fixed drives.","pos":[12439,12604]},{"content":"MBAM prompts the user before encrypting fixed drives.","pos":[12605,12658]},{"content":"MBAM also manages recovery keys for fixed and removable drives, making recovery easier to manage.","pos":[12659,12756]},{"content":"MBAM can be used as part of a Microsoft System Center deployment or as a stand-alone solution.","pos":[12757,12851]},{"content":"For more info, see <bpt id=\"p1\">[</bpt>Microsoft BitLocker Administration and Monitoring<ept id=\"p1\">](http://technet.microsoft.com/windows/hh826072.aspx)</ept>.","pos":[12852,12976]},{"content":"After a BitLocker recovery has been initiated, users can use a recovery password to unlock access to encrypted data.","pos":[12978,13094]},{"content":"You must consider both self-recovery and recovery password retrieval methods for your organization.","pos":[13095,13194]},{"content":"When you determine your recovery process, you should:","pos":[13196,13249]},{"content":"Become familiar with how you can retrieve the recovery password.","pos":[13255,13319]},{"content":"See:","pos":[13320,13324]},{"content":"Self-recovery","pos":[13335,13348]},{"content":"Recovery password retrieval","pos":[13379,13406]},{"content":"Determine a series of steps for post-recovery, including analyzing why the recovery occurred and resetting the recovery password.","pos":[13438,13567]},{"content":"See:","pos":[13568,13572]},{"content":"Post-recovery analysis","pos":[13583,13605]},{"pos":[13678,13691],"content":"Self-recovery"},{"content":"In some cases, users might have the recovery password in a printout or a USB flash drive and can perform self-recovery.","pos":[13693,13812]},{"content":"We recommend that your organization create a policy for self-recovery.","pos":[13813,13883]},{"content":"If self-recovery includes using a password or recovery key stored on a USB flash drive, the users should be warned not to store the USB flash drive in the same place as the PC, especially during travel, for example if both the PC and the recovery items are in the same bag it would be very easy for access to be gained to the PC by an unauthorized user.","pos":[13884,14237]},{"content":"Another policy to consider is having users contact the Helpdesk before or after performing self-recovery so that the root cause can be identified.","pos":[14238,14384]},{"pos":[14433,14460],"content":"Recovery password retrieval"},{"content":"If the user does not have a recovery password in a printout or on a USB flash drive, the user will need to be able to retrieve the recovery password from an online source.","pos":[14462,14633]},{"content":"If the PC is a member of a domain the recovery password can be backed up to AD DS.","pos":[14634,14716]},{"content":"However, this does not happen by default, you must have configured the appropriate Group Policy settings before BitLocker was enabled on the PC.","pos":[14717,14861]},{"content":"BitLocker Group Policy settings can be found in the Local Group Policy Editor or the Group Policy Management Console (GPMC) under <bpt id=\"p1\">**</bpt>Computer Configuration<ph id=\"ph1\">\\\\</ph>Administrative Templates<ph id=\"ph2\">\\\\</ph>Windows Components<ph id=\"ph3\">\\\\</ph>BitLocker Drive Encryption<ept id=\"p1\">**</ept>.","pos":[14862,15093]},{"content":"The following policy settings define the recovery methods that can be used to restore access to a BitLocker-protected drive if an authentication method fails or is unable to be used.","pos":[15094,15276]},{"content":"Choose how BitLocker-protected operating system drives can be recovered","pos":[15284,15355]},{"content":"Choose how BitLocker-protected fixed drives can be recovered","pos":[15364,15424]},{"content":"<bpt id=\"p1\">**</bpt>Choose how BitLocker-protected removable drives can be recovered<ept id=\"p1\">**</ept> In each of these policies, select <bpt id=\"p2\">**</bpt>Save BitLocker recovery information to Active Directory Domain Services<ept id=\"p2\">**</ept> and then choose which BitLocker recovery information to store in Active Directory Domain Services (AD DS).","pos":[15431,15716]},{"content":"Select the <bpt id=\"p1\">**</bpt>Do not enable BitLocker until recovery information is stored in AD DS<ept id=\"p1\">**</ept> check box if you want to prevent users from enabling BitLocker unless the computer is connected to the domain and the backup of BitLocker recovery information for the drive to AD DS succeeds.","pos":[15717,15994]},{"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  If the PCs are part of a workgroup, users should be advised to save their BitLocker recovery password with their Microsoft Account online.","pos":[15997,16146]},{"content":"Having an online copy of your BitLocker recovery password is recommended to help ensure that you do not lose access to your data in the event that recovery is required.","pos":[16147,16315]},{"content":"The BitLocker Recovery Password Viewer for Active Directory Users and Computers tool allows domain administrators to view BitLocker recovery passwords for specific computer objects in Active Directory.","pos":[16318,16519]},{"content":"You can use the following list as a template for creating your own recovery process for recovery password retrieval.","pos":[16521,16637]},{"content":"This sample process uses the BitLocker Recovery Password Viewer for Active Directory Users and Computers tool.","pos":[16638,16748]},{"content":"Record the name of the user's computer","pos":[16755,16793]},{"content":"Verify the user's identity","pos":[16826,16852]},{"content":"Locate the recovery password in AD DS","pos":[16881,16918]},{"content":"Gather information to determine why recovery occurred","pos":[16947,17000]},{"content":"Give the user the recovery password","pos":[17025,17060]},{"pos":[17131,17169],"content":"Record the name of the user's computer"},{"content":"You can use the name of the user's computer to locate the recovery password in AD DS.","pos":[17171,17256]},{"content":"If the user does not know the name of the computer, ask the user to read the first word of the <bpt id=\"p1\">**</bpt>Drive Label<ept id=\"p1\">**</ept> in the <bpt id=\"p2\">**</bpt>BitLocker Drive Encryption Password Entry<ept id=\"p2\">**</ept> user interface.","pos":[17257,17436]},{"content":"This is the computer name when BitLocker was enabled and is probably the current name of the computer.","pos":[17437,17539]},{"pos":[17585,17611],"content":"Verify the user's identity"},{"content":"You should verify that the person that is asking for the recovery password is truly the authorized user of that computer.","pos":[17613,17734]},{"content":"You may also wish to verify that the computer with the name the user provided belongs to the user.","pos":[17735,17833]},{"pos":[17879,17916],"content":"Locate the recovery password in AD DS"},{"content":"Locate the Computer object with the matching name in AD DS.","pos":[17918,17977]},{"content":"Because Computer object names are listed in the AD DS global catalog, you should be able to locate the object even if you have a multi-domain forest.","pos":[17978,18127]},{"content":"Multiple recovery passwords","pos":[18133,18160]},{"content":"If multiple recovery passwords are stored under a computer object in AD DS, the name of the BitLocker recovery information object includes the date that the password was created.","pos":[18162,18340]},{"content":"If at any time you are unsure what password to provide, or if you think you might be providing the incorrect password, ask the user to read the eight character password ID that is displayed in the recovery console.","pos":[18342,18556]},{"content":"Since the password ID is a unique value that is associated with each recovery password stored in AD DS, running a query using this ID will find the correct password to unlock the encrypted volume.","pos":[18558,18754]},{"pos":[18796,18849],"content":"Gather information to determine why recovery occurred"},{"content":"Before you give the user the recovery password, you should gather any information that will help determine why the recovery was needed, in order to analyze the root cause during the post-recovery analysis.","pos":[18851,19056]},{"content":"For more info about post-recovery analysis, see <bpt id=\"p1\">[</bpt>Post-recovery analysis<ept id=\"p1\">](#bkmk-planningpostrecovery)</ept>.","pos":[19057,19158]},{"pos":[19202,19237],"content":"Give the user the recovery password"},{"content":"Because the recovery password is 48 digits long the user may need to record the password by writing it down or typing it on a different computer.","pos":[19239,19384]},{"content":"If you are using MBAM, the recovery password will be regenerated after it is recovered from the MBAM database to avoid the security risks associated with an uncontrolled password.","pos":[19385,19564]},{"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  Because the 48-digit recovery password is long and contains a combination of digits, the user might mishear or mistype the password.","pos":[19567,19710]},{"content":"The boot-time recovery console uses built-in checksum numbers to detect input errors in each 6-digit block of the 48-digit recovery password, and offers the user the opportunity to correct such errors.","pos":[19711,19912]},{"pos":[19965,19987],"content":"Post-recovery analysis"},{"content":"When a volume is unlocked using a recovery password, an event is written to the event log and the platform validation measurements are reset in the TPM to match the current configuration.","pos":[19989,20176]},{"content":"Unlocking the volume means that the encryption key has been released and is ready for on-the-fly encryption when data is written to the volume, and on-the-fly decryption when data is read from the volume.","pos":[20177,20382]},{"content":"After the volume is unlocked, BitLocker behaves the same way, regardless of how the access was granted.","pos":[20383,20486]},{"content":"If you notice that a computer is having repeated recovery password unlocks, you might want to have an administrator can perform post-recovery analysis to determine the root cause of the recovery and refresh BitLocker platform validation so that the user no longer needs to enter a recovery password each time that the computer starts up.","pos":[20488,20825]},{"content":"See:","pos":[20826,20830]},{"content":"Determine the root cause of the recovery","pos":[20837,20877]},{"content":"Refresh BitLocker protection","pos":[20906,20934]},{"pos":[21006,21046],"content":"Determine the root cause of the recovery"},{"content":"If a user needed to recover the drive, it is important to determine the root cause that initiated the recovery as soon as possible.","pos":[21048,21179]},{"content":"Properly analyzing the state of the computer and detecting tampering may reveal threats that have broader implications for enterprise security.","pos":[21180,21323]},{"content":"While an administrator can remotely investigate the cause of recovery in some cases, the end user might need to bring the computer that contains the recovered drive on site to analyze the root cause further.","pos":[21325,21532]},{"content":"Review and answer the following questions for your organization:","pos":[21534,21598]},{"content":"What BitLocker protection mode is in effect (TPM, TPM + PIN, TPM + startup key, startup key only)?","pos":[21604,21702]},{"content":"Which PCR profile is in use on the PC?","pos":[21703,21741]},{"content":"Did the user merely forget the PIN or lose the startup key?","pos":[21746,21805]},{"content":"If a token was lost, where might the token be?","pos":[21806,21852]},{"content":"If TPM mode was in effect, was recovery caused by a boot file change?","pos":[21857,21926]},{"content":"If recovery was caused by a boot file change, is this due to an intended user action (for example, BIOS upgrade), or to malicious software?","pos":[21931,22070]},{"content":"When was the user last able to start the computer successfully, and what might have happened to the computer since then?","pos":[22075,22195]},{"content":"Might the user have encountered malicious software or left the computer unattended since the last successful startup?","pos":[22200,22317]},{"content":"To help you answer these questions, use the BitLocker command-line tool to view the current configuration and protection mode (for example, <bpt id=\"p1\">**</bpt>manage-bde -status<ept id=\"p1\">**</ept>).","pos":[22319,22483]},{"content":"Scan the event log to find events that help indicate why recovery was initiated (for example, if boot file change occurred).","pos":[22484,22608]},{"content":"Both of these capabilities can be performed remotely.","pos":[22609,22662]},{"pos":[22711,22733],"content":"Resolve the root cause"},{"content":"After you have identified what caused recovery, you can reset BitLocker protection and avoid recovery on every startup.","pos":[22735,22854]},{"content":"The details of this reset can vary according to the root cause of the recovery.","pos":[22856,22935]},{"content":"If you cannot determine the root cause, or if malicious software or a rootkit might have infected the computer, Helpdesk should apply best-practice virus policies to react appropriately.","pos":[22936,23122]},{"pos":[23125,23226],"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  You can perform a BitLocker validation profile reset by suspending and resuming BitLocker."},{"content":"Unknown PIN","pos":[23234,23245]},{"content":"Lost startup key","pos":[23270,23286]},{"content":"Changes to boot files","pos":[23312,23333]},{"pos":[23398,23409],"content":"Unknown PIN"},{"content":"If a user has forgotten the PIN, you must reset the PIN while you are logged on to the computer in order to prevent BitLocker from initiating recovery each time the computer is restarted.","pos":[23411,23598]},{"content":"To prevent continued recovery due to an unknown PIN","pos":[23602,23653]},{"content":"Unlock the computer using the recovery password.","pos":[23661,23709]},{"content":"Reset the PIN:","pos":[23714,23728]},{"pos":[23739,23790],"content":"Right-click the drive and then click <bpt id=\"p1\">**</bpt>Change PIN<ept id=\"p1\">**</ept>"},{"content":"In the BitLocker Drive Encryption dialog, click <bpt id=\"p1\">**</bpt>Reset a forgotten PIN<ept id=\"p1\">**</ept>.","pos":[23799,23873]},{"content":"If you are not logged in with an administrator account you must provide administrative credentials at this time.","pos":[23874,23986]},{"pos":[23995,24085],"content":"In the PIN reset dialog, provide and confirm the new PIN to use and then click <bpt id=\"p1\">**</bpt>Finish<ept id=\"p1\">**</ept>."},{"content":"You will use the new PIN the next time you unlock the drive.","pos":[24090,24150]},{"pos":[24193,24209],"content":"Lost startup key"},{"content":"If you have lost the USB flash drive that contains the startup key, then you must unlock the drive by using the recovery key and then create a new startup key.","pos":[24211,24370]},{"content":"To prevent continued recovery due to a lost startup key","pos":[24374,24429]},{"content":"Log on as an administrator to the computer that has the lost startup key.","pos":[24437,24510]},{"content":"Open Manage BitLocker.","pos":[24515,24537]},{"pos":[24542,24667],"content":"Click <bpt id=\"p1\">**</bpt>Duplicate start up key<ept id=\"p1\">**</ept>, insert the clean USB drive on which you are going to write the key and then click <bpt id=\"p2\">**</bpt>Save<ept id=\"p2\">**</ept>."},{"pos":[24714,24735],"content":"Changes to boot files"},{"content":"This error might occur if you updated the firmware.","pos":[24737,24788]},{"content":"As a best practice you should suspend BitLocker before making changes the firmware and then resume protection after the update has completed.","pos":[24789,24930]},{"content":"This prevents the computer from going into recovery mode.","pos":[24931,24988]},{"content":"However if changes were made when BitLocker protection was on you can simply log on to the computer using the recovery password and the platform validation profile will be updated so that recovery will not occur the next time.","pos":[24989,25215]},{"content":"Windows RE and BitLocker","pos":[25220,25244]},{"content":"Windows Recovery Environment (RE) can be used to recover access to a drive protected by BitLocker or by Device Encryption.","pos":[25246,25368]},{"content":"If a PC is unable to boot after two failures, Startup Repair will automatically start.","pos":[25369,25455]},{"content":"When Startup Repair is launched automatically due to boot failures, it will only execute operating system and driver file repairs, provided that the boot logs or any available crash dump point to a specific corrupted file.","pos":[25456,25678]},{"content":"In Windows 8.1 and later, devices that include firmware to support specific TPM measurements for PCR<ph id=\"ph1\">\\[</ph>7<ph id=\"ph2\">\\]</ph> the TPM can validate that Windows RE is a trusted operating environment and will unlock any BitLocker-protected drives if Windows RE has not been modified.","pos":[25679,25940]},{"content":"If the Windows RE environment has been modified, for example the TPM has been disabled, the drives will stay locked until the BitLocker recovery key is provided.","pos":[25941,26102]},{"content":"If Startup Repair is not able to be run automatically from the PC and instead Windows RE is manually started from a repair disk, the BitLocker recovery key must be provided to unlock the BitLocker–protected drives.","pos":[26103,26317]},{"pos":[26364,26401],"content":"Using additional recovery information"},{"content":"Besides the 48-digit BitLocker recovery password, other types of recovery information are stored in Active Directory.","pos":[26403,26520]},{"content":"This section describes how this additional information can be used.","pos":[26521,26588]},{"content":"BitLocker key package","pos":[26594,26615]},{"content":"If the recovery methods discussed earlier in this document do not unlock the volume, you can use the BitLocker Repair tool to decrypt the volume at the block level.","pos":[26617,26781]},{"content":"The tool uses the BitLocker key package to help recover encrypted data from severely damaged drives.","pos":[26782,26882]},{"content":"You can then use this recovered data to salvage encrypted data, even after the correct recovery password has failed to unlock the damaged volume.","pos":[26883,27028]},{"content":"We recommend that you still save the recovery password.","pos":[27029,27084]},{"content":"A key package cannot be used without the corresponding recovery password.","pos":[27085,27158]},{"pos":[27161,27259],"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  You must use the BitLocker Repair tool <bpt id=\"p2\">**</bpt>repair-bde<ept id=\"p2\">**</ept> to use the BitLocker key package."},{"content":"The BitLocker key package is not saved by default.","pos":[27262,27312]},{"content":"To save the package along with the recovery password in AD DS you must select the <bpt id=\"p1\">**</bpt>Backup recovery password and key package<ept id=\"p1\">**</ept> option in the Group Policy settings that control the recovery method.","pos":[27313,27509]},{"content":"You can also export the key package from a working volume.","pos":[27510,27568]},{"content":"For more details on how to export key packages, see <bpt id=\"p1\">[</bpt>Retrieving the BitLocker Key Package<ept id=\"p1\">](#bkmk-appendixc)</ept>.","pos":[27569,27677]},{"pos":[27717,27745],"content":"Resetting recovery passwords"},{"content":"You should invalidate a recovery password after it has been provided and used.","pos":[27747,27825]},{"content":"It should also be done when you intentionally want to invalidate an existing recovery password for any reason.","pos":[27826,27936]},{"content":"You can reset the recovery password in two ways:","pos":[27938,27986]},{"content":"<bpt id=\"p1\">**</bpt>Use manage-bde<ept id=\"p1\">**</ept> You can use manage-bde to remove the old recovery password and add a new recovery password.","pos":[27992,28102]},{"content":"The procedure identifies the command and the syntax for this method.","pos":[28103,28171]},{"content":"<bpt id=\"p1\">**</bpt>Run a script<ept id=\"p1\">**</ept> You can run a script to reset the password without decrypting the volume.","pos":[28176,28266]},{"content":"The sample script in the procedure illustrates this functionality.","pos":[28267,28333]},{"content":"The sample script creates a new recovery password and invalidates all other passwords.","pos":[28334,28420]},{"content":"To reset a recovery password using manage-bde","pos":[28424,28469]},{"content":"Remove the previous recovery password","pos":[28477,28514]},{"content":"Add the new recovery password","pos":[28605,28634]},{"content":"Get the ID of the new recovery password.","pos":[28718,28758]},{"content":"From the screen copy the ID of the recovery password.","pos":[28759,28812]},{"content":"Backup the new recovery password to AD DS","pos":[28900,28941]},{"pos":[29054,29113],"content":"<bpt id=\"p1\">**</bpt>Warning:<ept id=\"p1\">**</ept>  You must include the braces in the ID string."},{"content":"To run the sample recovery password script","pos":[29122,29164]},{"content":"Save the following sample script in a VBScript file.","pos":[29172,29224]},{"content":"For example: ResetPassword.vbs.","pos":[29225,29256]},{"content":"At the command prompt, type a command similar to the following:","pos":[29261,29324]},{"content":"cscript ResetPassword.vbs","pos":[29332,29357]},{"content":"<bpt id=\"p1\">**</bpt>Important:<ept id=\"p1\">**</ept>  This sample script is configured to work only for the C volume.","pos":[29362,29441]},{"content":"You must customize the script to match the volume where you want to test password reset.","pos":[29442,29530]},{"pos":[29535,29652],"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  To manage a remote computer, you can specify the remote computer name rather than the local computer name."},{"content":"You can use the following sample script to create a VBScript file to reset the recovery passwords.","pos":[29655,29753]},{"pos":[33050,33086],"content":"Retrieving the BitLocker key package"},{"pos":[33088,33221],"content":"You can use two methods to retrieve the key package, as described in <bpt id=\"p1\">[</bpt>Using Additional Recovery Information<ept id=\"p1\">](#bkmk-usingaddrecovery)</ept>:"},{"content":"Export a previously-saved key package from AD DS.","pos":[33229,33278]},{"content":"You must have Read access to BitLocker recovery passwords that are stored in AD DS.","pos":[33281,33364]},{"content":"Export a new key package from an unlocked, BitLocker-protected volume.","pos":[33371,33441]},{"content":"You must have local administrator access to the working volume, before any damage has occurred.","pos":[33444,33539]},{"content":"The following sample script exports all previously-saved key packages from AD DS.","pos":[33541,33622]},{"content":"To run the sample key package retrieval script","pos":[33626,33672]},{"content":"Save the following sample script in a VBScript file.","pos":[33680,33732]},{"content":"For example: GetBitLockerKeyPackageADDS.vbs.","pos":[33733,33777]},{"content":"At the command prompt, type a command similar to the following:","pos":[33782,33845]},{"content":"cscript GetBitLockerKeyPackageADDS.vbs -?","pos":[33853,33894]},{"content":"You can use the following sample script to create a VBScript file to retrieve the BitLocker key package from AD DS.","pos":[33898,34013]},{"content":"See also","pos":[48334,48342]},{"content":"BitLocker overview","pos":[48349,48367]}],"content":"---\ntitle: BitLocker recovery guide (Windows 10)\ndescription: This topic for IT professionals describes how to recover BitLocker keys from AD DS.\nms.assetid: d0f722e9-1773-40bf-8456-63ee7a95ea14\nms.prod: w10\nms.mktglfcycl: deploy\nms.sitesec: library\nms.pagetype: security\nauthor: brianlic-msft\n\n---\n\n# BitLocker recovery guide\n\n**Applies to**\n-   Windows 10\n\nThis topic for IT professionals describes how to recover BitLocker keys from AD DS.\n\nOrganizations can use BitLocker recovery information saved in Active Directory Domain Services (AD DS) to access BitLocker-protected data. Creating a recovery model for BitLocker while you are planning your BitLocker deployment is recommended.\n\nThis article assumes that you understand how to set up AD DS to back up BitLocker recovery information automatically, and what types of recovery information are saved to AD DS.\n\nThis article does not detail how to configure AD DS to store the BitLocker recovery information.\n\nThis article contains the following topics:\n\n-   [What Is BitLocker Recovery?](#bkmk-whatisrecovery)\n-   [Testing Recovery](#bkmk-testingrecovery)\n-   [Planning Your Recovery Process](#bkmk-planningrecovery)\n-   [Using Additional Recovery Information](#bkmk-usingaddrecovery)\n-   [Resetting Recovery Passwords](#bkmk-appendixb)\n-   [Retrieving the BitLocker Key Package](#bkmk-appendixc)\n\n## <a href=\"\" id=\"bkmk-whatisrecovery\"></a>What is BitLocker recovery?\n\nBitLocker recovery is the process by which you can restore access to a BitLocker-protected drive in the event that you cannot unlock the drive normally. In a recovery scenario you have the following options to restore access to the drive:\n\n-   The user can supply the recovery password. If your organization allows users to print or store recovery passwords, the user can type in the 48-digit recovery password that they printed or stored on a USB drive or with your Microsoft Account online. (Saving a recovery password with your Microsoft Account online is only allowed when BitLocker is used on a PC that is not a member of a domain).\n-   A data recovery agent can use their credentials to unlock the drive. If the drive is an operating system drive, the drive must be mounted as a data drive on another computer for the data recovery agent to unlock it.\n-   A domain administrator can obtain the recovery password from AD DS and use it to unlock the drive. Storing recovery passwords in AD DS is recommended to provide a way for IT professionals to be able to obtain recovery passwords for drives in their organization if needed. This method requires that you have enabled this recovery method in the BitLocker Group Policy setting **Choose how BitLocker-protected operating system drives can be recovered** located at **Computer Configuration\\\\Administrative Templates\\\\Windows Components\\\\BitLocker Drive Encryption\\\\Operating System Drives** in the Local Group Policy Editor. For more information, see [BitLocker Group Policy settings](bitlocker-group-policy-settings.md).\n\n### What causes BitLocker recovery?\n\nThe following list provides examples of specific events that will cause BitLocker to enter recovery mode when attempting to start the operating system drive:\n\n-   On PCs that use either BitLocker or Device Encryption when an attack is detected the device will immediately reboot and enter into BitLocker recovery mode. To take advantage of this functionality Administrators can set the **Interactive logon: Machine account lockout threshold** Group Policy setting located in **\\\\Computer Configuration\\\\Windows Settings\\\\Security Settings\\\\Local Policies\\\\Security Options** in the Local Group Policy Editor, or use the **MaxFailedPasswordAttempts** policy of [Exchange ActiveSync](http://technet.microsoft.com/library/aa998357.aspx) (also configurable through [Windows Intune](http://technet.microsoft.com/library/jj733621.aspx)), to limit the number of failed password attempts before the device goes into Device Lockout.\n-   Changing the boot order to boot another drive in advance of the hard drive.\n-   Having the CD or DVD drive before the hard drive in the BIOS boot order and then inserting or removing a CD or DVD.\n-   Failing to boot from a network drive before booting from the hard drive.\n-   Docking or undocking a portable computer. In some instances (depending on the computer manufacturer and the BIOS), the docking condition of the portable computer is part of the system measurement and must be consistent to validate the system status and unlock BitLocker. This means that if a portable computer is connected to its docking station when BitLocker is turned on, then it might also need to be connected to the docking station when it is unlocked. Conversely, if a portable computer is not connected to its docking station when BitLocker is turned on, then it might need to be disconnected from the docking station when it is unlocked.\n-   Changes to the NTFS partition table on the disk including creating, deleting, or resizing a primary partition.\n-   Entering the personal identification number (PIN) incorrectly too many times so that the anti-hammering logic of the TPM is activated. Anti-hammering logic is software or hardware methods that increase the difficulty and cost of a brute force attack on a PIN by not accepting PIN entries until after a certain amount of time has passed.\n-   Turning off the support for reading the USB device in the pre-boot environment from the BIOS or UEFI firmware if you are using USB-based keys instead of a TPM.\n-   Turning off, disabling, deactivating, or clearing the TPM.\n-   Upgrading critical early startup components, such as a BIOS or UEFI firmware upgrade, causing the related boot measurements to change.\n-   Forgetting the PIN when PIN authentication has been enabled.\n-   Updating option ROM firmware.\n-   Upgrading TPM firmware.\n-   Adding or removing hardware; for example, inserting a new card in the computer, including some PCMIA wireless cards.\n-   Removing, inserting, or completely depleting the charge on a smart battery on a portable computer.\n-   Changes to the master boot record on the disk.\n-   Changes to the boot manager on the disk.\n-   Hiding the TPM from the operating system. Some BIOS or UEFI settings can be used to prevent the enumeration of the TPM to the operating system. When implemented, this option can make the TPM hidden from the operating system. When the TPM is hidden, BIOS and UEFI secure startup are disabled, and the TPM does not respond to commands from any software.\n-   Using a different keyboard that does not correctly enter the PIN or whose keyboard map does not match the keyboard map assumed by the pre-boot environment. This can prevent the entry of enhanced PINs.\n-   Modifying the Platform Configuration Registers (PCRs) used by the TPM validation profile. For example, including **PCR\\[1\\]** would result in BitLocker measuring most changes to BIOS settings, causing BitLocker to enter recovery mode even when non-boot critical BIOS settings change.\n\n    >**Note:**  Some computers have BIOS settings that skip measurements to certain PCRs, such as **PCR\\[2\\]**. Changing this setting in the BIOS would cause BitLocker to enter recovery mode because the PCR measurement will be different.\n     \n-   Moving the BitLocker-protected drive into a new computer.\n-   Upgrading the motherboard to a new one with a new TPM.\n-   Losing the USB flash drive containing the startup key when startup key authentication has been enabled.\n-   Failing the TPM self-test.\n-   Having a BIOS, UEFI firmware, or an option ROM component that is not compliant with the relevant Trusted Computing Group standards for a client computer. For example, a non-compliant implementation may record volatile data (such as time) in the TPM measurements, causing different measurements on each startup and causing BitLocker to start in recovery mode.\n-   Changing the usage authorization for the storage root key of the TPM to a non-zero value.\n\n    >**Note:**  The BitLocker TPM initialization process sets the usage authorization value to zero, so another user or process must explicitly have changed this value.\n     \n-   Disabling the code integrity check or enabling test signing on Windows Boot Manager (Bootmgr).\n-   Pressing the F8 or F10 key during the boot process.\n-   Adding or removing add-in cards (such as video or network cards), or upgrading firmware on add-in cards.\n-   Using a BIOS hot key during the boot process to change the boot order to something other than the hard drive.\n\n>**Note:**  Before you begin recovery, we recommend that you determine what caused recovery. This might help prevent the problem from occurring again in the future. For instance, if you determine that an attacker has modified your computer by obtaining physical access, you can create new security policies for tracking who has physical presence. After the recovery password has been used to recover access to the PC, BitLocker will reseal the encryption key to the current values of the measured components.\n \nFor planned scenarios, such as a known hardware or firmware upgrades, you can avoid initiating recovery by temporarily suspending BitLocker protection. Because suspending BitLocker leaves the drive fully encrypted, the administrator can quickly resume BitLocker protection after the planned task has been completed. Using suspend and resume also reseals the encryption key without requiring the entry of the recovery key.\n\n>**Note:**  If suspended BitLocker will automatically resume protection when the PC is rebooted, unless a reboot count is specified using the manage-bde command line tool.\n\nIf software maintenance requires the computer be restarted and you are using two-factor authentication, you can enable BitLocker Network Unlock to provide the secondary authentication factor when the computers do not have an on-premise user to provide the additional authentication method.\n \nRecovery has been described within the context of unplanned or undesired behavior, but you can also cause recovery as an intended production scenario, in order to manage access control. For example, when you redeploy desktop or laptop computers to other departments or employees in your enterprise, you can force BitLocker into recovery before the computer is given to a new user.\n\n## <a href=\"\" id=\"bkmk-testingrecovery\"></a>Testing recovery\n\nBefore you create a thorough BitLocker recovery process, we recommend that you test how the recovery process works for both end users (people who call your helpdesk for the recovery password) and administrators (people who help the end user get the recovery password). The –forcerecovery command of manage-bde is an easy way for you to step through the recovery process before your users encounter a recovery situation.\n\n**To force a recovery for the local computer**\n\n1.  Click the **Start** button, type **cmd** in the **Start Search** box, right-click **cmd.exe**, and then click **Run as administrator**.\n2.  At the command prompt, type the following command and then press ENTER:\n    `manage-bde -forcerecovery <Volume>`\n    \n**To force recovery for a remote computer**\n\n1.  On the Start screen, type **cmd.exe**, and then click **Run as administrator**.\n2.  At the command prompt, type the following command and then press ENTER:\n    `manage-bde. -ComputerName <ComputerName> -forcerecovery <Volume>`\n\n> **Note:**  *ComputerName* represents the name of the remote computer. *Volume* represents the volume on the remote computer that is protected with BitLocker.\n \n## <a href=\"\" id=\"bkmk-planningrecovery\"></a>Planning your recovery process\n\nWhen planning the BitLocker recovery process, first consult your organization's current best practices for recovering sensitive information. For example: How does your enterprise handle lost Windows passwords? How does your organization perform smart card PIN resets? You can use these best practices and related resources (people and tools) to help formulate a BitLocker recovery model.\n\nOrganizations that rely on BitLocker Drive Encryption and BitLocker To Go to protect data on a large number of computers and removable drives running the Windows 10, Windows 8, or Windows 7 operating systems and Windows to Go should consider using the Microsoft BitLocker Administration and Monitoring (MBAM) Tool version 2.0, which is included in the Microsoft Desktop Optimization Pack (MDOP) for Microsoft Software Assurance. MBAM makes BitLocker implementations easier to deploy and manage and allows administrators to provision and monitor encryption for operating system and fixed drives. MBAM prompts the user before encrypting fixed drives. MBAM also manages recovery keys for fixed and removable drives, making recovery easier to manage. MBAM can be used as part of a Microsoft System Center deployment or as a stand-alone solution. For more info, see [Microsoft BitLocker \nAdministration and Monitoring](http://technet.microsoft.com/windows/hh826072.aspx).\n\nAfter a BitLocker recovery has been initiated, users can use a recovery password to unlock access to encrypted data. You must consider both self-recovery and recovery password retrieval methods for your organization.\n\nWhen you determine your recovery process, you should:\n\n-   Become familiar with how you can retrieve the recovery password. See:\n\n    -   [Self-recovery](#bkmk-selfrecovery)\n    -   [Recovery password retrieval](#bkmk-recoveryretrieval)\n\n-   Determine a series of steps for post-recovery, including analyzing why the recovery occurred and resetting the recovery password. See:\n\n    -   [Post-recovery analysis](#bkmk-planningpostrecovery)\n\n### <a href=\"\" id=\"bkmk-selfrecovery\"></a>Self-recovery\n\nIn some cases, users might have the recovery password in a printout or a USB flash drive and can perform self-recovery. We recommend that your organization create a policy for self-recovery. If self-recovery includes using a password or recovery key stored on a USB flash drive, the users should be warned not to store the USB flash drive in the same place as the PC, especially during travel, for example if both the PC and the recovery items are in the same bag it would be very easy for access to be gained to the PC by an unauthorized user. Another policy to consider is having users contact the Helpdesk before or after performing self-recovery so that the root cause can be identified.\n\n### <a href=\"\" id=\"bkmk-recoveryretrieval\"></a>Recovery password retrieval\n\nIf the user does not have a recovery password in a printout or on a USB flash drive, the user will need to be able to retrieve the recovery password from an online source. If the PC is a member of a domain the recovery password can be backed up to AD DS. However, this does not happen by default, you must have configured the appropriate Group Policy settings before BitLocker was enabled on the PC. BitLocker Group Policy settings can be found in the Local Group Policy Editor or the Group Policy Management Console (GPMC) under **Computer Configuration\\\\Administrative Templates\\\\Windows Components\\\\BitLocker Drive Encryption**. The following policy settings define the recovery methods that can be used to restore access to a BitLocker-protected drive if an authentication method fails or is unable to be used.\n\n-   **Choose how BitLocker-protected operating system drives can be recovered**\n-   **Choose how BitLocker-protected fixed drives can be recovered**\n-   **Choose how BitLocker-protected removable drives can be recovered**\nIn each of these policies, select **Save BitLocker recovery information to Active Directory Domain Services** and then choose which BitLocker recovery information to store in Active Directory Domain Services (AD DS). Select the **Do not enable BitLocker until recovery information is stored in AD \nDS** check box if you want to prevent users from enabling BitLocker unless the computer is connected to the domain and the backup of BitLocker recovery information for the drive to AD DS succeeds.\n\n>**Note:**  If the PCs are part of a workgroup, users should be advised to save their BitLocker recovery password with their Microsoft Account online. Having an online copy of your BitLocker recovery password is recommended to help ensure that you do not lose access to your data in the event that recovery is required.\n \nThe BitLocker Recovery Password Viewer for Active Directory Users and Computers tool allows domain administrators to view BitLocker recovery passwords for specific computer objects in Active Directory.\n\nYou can use the following list as a template for creating your own recovery process for recovery password retrieval. This sample process uses the BitLocker Recovery Password Viewer for Active Directory Users and Computers tool.\n\n-   [Record the name of the user's computer](#bkmk-recordcomputername)\n-   [Verify the user's identity](#bkmk-verifyidentity)\n-   [Locate the recovery password in AD DS](#bkmk-locatepassword)\n-   [Gather information to determine why recovery occurred](#bkmk-gatherinfo)\n-   [Give the user the recovery password](#bkmk-givepassword)\n\n### <a href=\"\" id=\"bkmk-recordcomputername\"></a>Record the name of the user's computer\n\nYou can use the name of the user's computer to locate the recovery password in AD DS. If the user does not know the name of the computer, ask the user to read the first word of the **Drive Label** in the **BitLocker Drive Encryption Password Entry** user interface. This is the computer name when BitLocker was enabled and is probably the current name of the computer.\n\n### <a href=\"\" id=\"bkmk-verifyidentity\"></a>Verify the user's identity\n\nYou should verify that the person that is asking for the recovery password is truly the authorized user of that computer. You may also wish to verify that the computer with the name the user provided belongs to the user.\n\n### <a href=\"\" id=\"bkmk-locatepassword\"></a>Locate the recovery password in AD DS\n\nLocate the Computer object with the matching name in AD DS. Because Computer object names are listed in the AD DS global catalog, you should be able to locate the object even if you have a multi-domain forest.\n\n### Multiple recovery passwords\n\nIf multiple recovery passwords are stored under a computer object in AD DS, the name of the BitLocker recovery information object includes the date that the password was created.\n\nIf at any time you are unsure what password to provide, or if you think you might be providing the incorrect password, ask the user to read the eight character password ID that is displayed in the recovery console.\n\nSince the password ID is a unique value that is associated with each recovery password stored in AD DS, running a query using this ID will find the correct password to unlock the encrypted volume.\n\n### <a href=\"\" id=\"bkmk-gatherinfo\"></a>Gather information to determine why recovery occurred\n\nBefore you give the user the recovery password, you should gather any information that will help determine why the recovery was needed, in order to analyze the root cause during the post-recovery analysis. For more info about post-recovery analysis, see [Post-recovery analysis](#bkmk-planningpostrecovery).\n\n### <a href=\"\" id=\"bkmk-givepassword\"></a>Give the user the recovery password\n\nBecause the recovery password is 48 digits long the user may need to record the password by writing it down or typing it on a different computer. If you are using MBAM, the recovery password will be regenerated after it is recovered from the MBAM database to avoid the security risks associated with an uncontrolled password.\n\n>**Note:**  Because the 48-digit recovery password is long and contains a combination of digits, the user might mishear or mistype the password. The boot-time recovery console uses built-in checksum numbers to detect input errors in each 6-digit block of the 48-digit recovery password, and offers the user the opportunity to correct such errors.\n \n### <a href=\"\" id=\"bkmk-planningpostrecovery\"></a>Post-recovery analysis\n\nWhen a volume is unlocked using a recovery password, an event is written to the event log and the platform validation measurements are reset in the TPM to match the current configuration. Unlocking the volume means that the encryption key has been released and is ready for on-the-fly encryption \nwhen data is written to the volume, and on-the-fly decryption when data is read from the volume. After the volume is unlocked, BitLocker behaves the same way, regardless of how the access was granted.\n\nIf you notice that a computer is having repeated recovery password unlocks, you might want to have an administrator can perform post-recovery analysis to determine the root cause of the recovery and refresh BitLocker platform validation so that the user no longer needs to enter a recovery password each time that the computer starts up. See:\n\n-   [Determine the root cause of the recovery](#bkmk-determinecause)\n-   [Refresh BitLocker protection](#bkmk-refreshprotection)\n\n### <a href=\"\" id=\"bkmk-determinecause\"></a>Determine the root cause of the recovery\n\nIf a user needed to recover the drive, it is important to determine the root cause that initiated the recovery as soon as possible. Properly analyzing the state of the computer and detecting tampering may reveal threats that have broader implications for enterprise security.\n\nWhile an administrator can remotely investigate the cause of recovery in some cases, the end user might need to bring the computer that contains the recovered drive on site to analyze the root cause further.\n\nReview and answer the following questions for your organization:\n\n1.  What BitLocker protection mode is in effect (TPM, TPM + PIN, TPM + startup key, startup key only)? Which PCR profile is in use on the PC?\n2.  Did the user merely forget the PIN or lose the startup key? If a token was lost, where might the token be?\n3.  If TPM mode was in effect, was recovery caused by a boot file change?\n4.  If recovery was caused by a boot file change, is this due to an intended user action (for example, BIOS upgrade), or to malicious software?\n5.  When was the user last able to start the computer successfully, and what might have happened to the computer since then?\n6.  Might the user have encountered malicious software or left the computer unattended since the last successful startup?\n\nTo help you answer these questions, use the BitLocker command-line tool to view the current configuration and protection mode (for example, **manage-bde -status**). Scan the event log to find events that help indicate why recovery was initiated (for example, if boot file change occurred). Both of these capabilities can be performed remotely.\n\n### <a href=\"\" id=\"bkmk-refreshprotection\"></a>Resolve the root cause\n\nAfter you have identified what caused recovery, you can reset BitLocker protection and avoid recovery on every startup.\n\nThe details of this reset can vary according to the root cause of the recovery. If you cannot determine the root cause, or if malicious software or a rootkit might have infected the computer, Helpdesk should apply best-practice virus policies to react appropriately.\n\n>**Note:**  You can perform a BitLocker validation profile reset by suspending and resuming BitLocker.\n \n-   [Unknown PIN](#bkmk-unknownpin)\n-   [Lost startup key](#bkmk-loststartup)\n-   [Changes to boot files](#bkmk-changebootknown)\n### <a href=\"\" id=\"bkmk-unknownpin\"></a>Unknown PIN\n\nIf a user has forgotten the PIN, you must reset the PIN while you are logged on to the computer in order to prevent BitLocker from initiating recovery each time the computer is restarted.\n\n**To prevent continued recovery due to an unknown PIN**\n\n1.  Unlock the computer using the recovery password.\n2.  Reset the PIN:  \n    1.  Right-click the drive and then click **Change PIN**\n    2.  In the BitLocker Drive Encryption dialog, click **Reset a forgotten PIN**. If you are not logged in with an administrator account you must provide administrative credentials at this time.\n    3.  In the PIN reset dialog, provide and confirm the new PIN to use and then click **Finish**.\n3.  You will use the new PIN the next time you unlock the drive.\n\n### <a href=\"\" id=\"bkmk-loststartup\"></a>Lost startup key\n\nIf you have lost the USB flash drive that contains the startup key, then you must unlock the drive by using the recovery key and then create a new startup key.\n\n**To prevent continued recovery due to a lost startup key**\n\n1.  Log on as an administrator to the computer that has the lost startup key.\n2.  Open Manage BitLocker.\n3.  Click **Duplicate start up key**, insert the clean USB drive on which you are going to write the key and then click **Save**.\n\n### <a href=\"\" id=\"bkmk-changebootknown\"></a>Changes to boot files\n\nThis error might occur if you updated the firmware. As a best practice you should suspend BitLocker before making changes the firmware and then resume protection after the update has completed. This prevents the computer from going into recovery mode. However if changes were made when BitLocker protection was on you can simply log on to the computer using the recovery password and the platform validation profile will be updated so that recovery will not occur the next time.\n\n## Windows RE and BitLocker\n\nWindows Recovery Environment (RE) can be used to recover access to a drive protected by BitLocker or by Device Encryption. If a PC is unable to boot after two failures, Startup Repair will automatically start. When Startup Repair is launched automatically due to boot failures, it will only execute operating system and driver file repairs, provided that the boot logs or any available crash dump point to a specific corrupted file. In Windows 8.1 and later, devices that include firmware to support specific TPM measurements for PCR\\[7\\] the TPM can validate that Windows RE is a trusted operating environment and will unlock any BitLocker-protected drives if Windows RE has not been modified. If the Windows RE environment has been modified, for example the TPM has been disabled, the drives will stay locked until the BitLocker recovery key is provided. If Startup Repair is not able to be run automatically from the PC and instead Windows RE is manually started from a repair disk, the BitLocker recovery key must be provided to unlock the BitLocker–protected drives.\n\n## <a href=\"\" id=\"bkmk-usingaddrecovery\"></a>Using additional recovery information\n\nBesides the 48-digit BitLocker recovery password, other types of recovery information are stored in Active Directory. This section describes how this additional information can be used.\n\n### BitLocker key package\n\nIf the recovery methods discussed earlier in this document do not unlock the volume, you can use the BitLocker Repair tool to decrypt the volume at the block level. The tool uses the BitLocker key package to help recover encrypted data from severely damaged drives. You can then use this recovered data to salvage encrypted data, even after the correct recovery password has failed to unlock the damaged volume. We recommend that you still save the recovery password. A key package cannot be used without the corresponding recovery password.\n\n>**Note:**  You must use the BitLocker Repair tool **repair-bde** to use the BitLocker key package.\n \nThe BitLocker key package is not saved by default. To save the package along with the recovery password in AD DS you must select the **Backup recovery password and key package** option in the Group Policy settings that control the recovery method. You can also export the key package from a working volume. For more details on how to export key packages, see [Retrieving the BitLocker Key Package](#bkmk-appendixc).\n\n## <a href=\"\" id=\"bkmk-appendixb\"></a>Resetting recovery passwords\n\nYou should invalidate a recovery password after it has been provided and used. It should also be done when you intentionally want to invalidate an existing recovery password for any reason.\n\nYou can reset the recovery password in two ways:\n\n-   **Use manage-bde** You can use manage-bde to remove the old recovery password and add a new recovery password. The procedure identifies the command and the syntax for this method.\n-   **Run a script** You can run a script to reset the password without decrypting the volume. The sample script in the procedure illustrates this functionality. The sample script creates a new recovery password and invalidates all other passwords.\n\n**To reset a recovery password using manage-bde**\n\n1.  Remove the previous recovery password\n\n    ``` syntax\n    Manage-bde –protectors –delete C: –type RecoveryPassword\n    ```\n\n2.  Add the new recovery password\n\n    ``` syntax\n    Manage-bde –protectors –add C: -RecoveryPassword\n\n    ```\n\n3.  Get the ID of the new recovery password. From the screen copy the ID of the recovery password.\n\n    ``` syntax\n    Manage-bde –protectors –get C: -Type RecoveryPassword\n\n    ```\n4.  Backup the new recovery password to AD DS\n\n    ``` syntax\n    Manage-bde –protectors –adbackup C: -id {EXAMPLE6-5507-4924-AA9E-AFB2EB003692}\n    ```\n    >**Warning:**  You must include the braces in the ID string.\n     \n**To run the sample recovery password script**\n\n1.  Save the following sample script in a VBScript file. For example: ResetPassword.vbs.\n2.  At the command prompt, type a command similar to the following:\n\n    **cscript ResetPassword.vbs**\n\n>**Important:**  This sample script is configured to work only for the C volume. You must customize the script to match the volume where you want to test password reset.\n \n> **Note:**  To manage a remote computer, you can specify the remote computer name rather than the local computer name.\n \nYou can use the following sample script to create a VBScript file to reset the recovery passwords.\n\n``` syntax\n' Target drive letter\nstrDriveLetter = \"c:\"\n' Target computer name\n' Use \".\" to connect to the local computer\nstrComputerName = \".\" \n' --------------------------------------------------------------------------------\n' Connect to the BitLocker WMI provider class\n' --------------------------------------------------------------------------------\nstrConnectionStr = \"winmgmts:\" _\n                 & \"{impersonationLevel=impersonate,authenticationLevel=pktPrivacy}!\\\\\" _\n                 & strComputerName _\n                 & \"\\root\\cimv2\\Security\\MicrosoftVolumeEncryption\"\n                 \n                 \nOn Error Resume Next 'handle permission errors\nSet objWMIService = GetObject(strConnectionStr)\nIf Err.Number <> 0 Then\n     WScript.Echo \"Failed to connect to the BitLocker interface (Error 0x\" & Hex(Err.Number) & \").\"\n     Wscript.Echo \"Ensure that you are running with administrative privileges.\"\n     WScript.Quit -1\nEnd If\nOn Error GoTo 0\nstrQuery = \"Select * from Win32_EncryptableVolume where DriveLetter='\" & strDriveLetter & \"'\"\nSet colTargetVolumes = objWMIService.ExecQuery(strQuery)\nIf colTargetVolumes.Count = 0 Then\n    WScript.Echo \"FAILURE: Unable to find BitLocker-capable drive \" &  strDriveLetter & \" on computer \" & strComputerName & \".\"\n    WScript.Quit -1\nEnd If\n' there should only be one volume found\nFor Each objFoundVolume in colTargetVolumes\n    set objVolume = objFoundVolume\nNext\n' objVolume is now our found BitLocker-capable disk volume\n' --------------------------------------------------------------------------------\n' Perform BitLocker WMI provider functionality\n' --------------------------------------------------------------------------------\n' Add a new recovery password, keeping the ID around so it doesn't get deleted later\n' ----------------------------------------------------------------------------------\nnRC = objVolume.ProtectKeyWithNumericalPassword(\"Recovery Password Refreshed By Script\", , sNewKeyProtectorID)\nIf nRC <> 0 Then\nWScript.Echo \"FAILURE: ProtectKeyWithNumericalPassword failed with return code 0x\" & Hex(nRC)\nWScript.Quit -1\nEnd If\n' Removes the other, \"stale\", recovery passwords \n' ----------------------------------------------------------------------------------\nnKeyProtectorTypeIn = 3 ' type associated with \"Numerical Password\" protector\nnRC = objVolume.GetKeyProtectors(nKeyProtectorTypeIn, aKeyProtectorIDs)\nIf nRC <> 0 Then\nWScript.Echo \"FAILURE: GetKeyProtectors failed with return code 0x\" & Hex(nRC)\nWScript.Quit -1\nEnd If\n' Delete those key protectors other than the one we just added. \nFor Each sKeyProtectorID In aKeyProtectorIDs\nIf sKeyProtectorID <> sNewKeyProtectorID Then\nnRC = objVolume.DeleteKeyProtector(sKeyProtectorID)\nIf nRC <> 0 Then\nWScript.Echo \"FAILURE: DeleteKeyProtector on ID \" & sKeyProtectorID & \" failed with return code 0x\" & Hex(nRC)\nWScript.Quit -1\nElse\n' no output\n'WScript.Echo \"SUCCESS: Key protector with ID \" & sKeyProtectorID & \" deleted\"\nEnd If\nEnd If\nNext\nWScript.Echo \"A new recovery password has been added. Old passwords have been removed.\"\n' - some advanced output (hidden)\n'WScript.Echo \"\"\n'WScript.Echo \"Type \"\"manage-bde -protectors -get \" & strDriveLetter & \" -type recoverypassword\"\" to view existing passwords.\"\n```\n\n## <a href=\"\" id=\"bkmk-appendixc\"></a>Retrieving the BitLocker key package\n\nYou can use two methods to retrieve the key package, as described in [Using Additional Recovery Information](#bkmk-usingaddrecovery):\n\n-   **Export a previously-saved key package from AD DS.** You must have Read access to BitLocker recovery passwords that are stored in AD DS.\n-   **Export a new key package from an unlocked, BitLocker-protected volume.** You must have local administrator access to the working volume, before any damage has occurred.\n\nThe following sample script exports all previously-saved key packages from AD DS.\n\n**To run the sample key package retrieval script**\n\n1.  Save the following sample script in a VBScript file. For example: GetBitLockerKeyPackageADDS.vbs.\n2.  At the command prompt, type a command similar to the following:\n\n    **cscript GetBitLockerKeyPackageADDS.vbs -?**\n\nYou can use the following sample script to create a VBScript file to retrieve the BitLocker key package from AD DS.\n\n``` syntax\n' --------------------------------------------------------------------------------\n' Usage\n' --------------------------------------------------------------------------------\nSub ShowUsage\n   Wscript.Echo \"USAGE: GetBitLockerKeyPackageAD [Path To Saved Key Package] [Optional Computer Name]\"\n   Wscript.Echo \"If no computer name is specified, the local computer is assumed.\"\n   Wscript.Echo \n   Wscript.Echo \"Example: GetBitLockerKeyPackageAD E:\\bitlocker-ad-key-package mycomputer\"\n   WScript.Quit\nEnd Sub\n' --------------------------------------------------------------------------------\n' Parse Arguments\n' --------------------------------------------------------------------------------\nSet args = WScript.Arguments\nSelect Case args.Count\n  Case 1\n    If args(0) = \"/?\" Or args(0) = \"-?\" Then\n    ShowUsage\n    Else \n      strFilePath = args(0)\n      ' Get the name of the local computer      \n      Set objNetwork = CreateObject(\"WScript.Network\")\n      strComputerName = objNetwork.ComputerName      \n    End If    \n      \n  Case 2\n    If args(0) = \"/?\" Or args(0) = \"-?\" Then\n      ShowUsage\n    Else \n      strFilePath = args(0)\n      strComputerName = args(1)\n    End If\n  Case Else\n    ShowUsage\nEnd Select\n' --------------------------------------------------------------------------------\n' Get path to Active Directory computer object associated with the computer name\n' --------------------------------------------------------------------------------\nFunction GetStrPathToComputer(strComputerName) \n    ' Uses the global catalog to find the computer in the forest\n    ' Search also includes deleted computers in the tombstone\n    Set objRootLDAP = GetObject(\"LDAP://rootDSE\")\n    namingContext = objRootLDAP.Get(\"defaultNamingContext\") ' e.g. string dc=fabrikam,dc=com    \n    strBase = \"<GC://\" & namingContext & \">\"\n \n    Set objConnection = CreateObject(\"ADODB.Connection\") \n    Set objCommand = CreateObject(\"ADODB.Command\") \n    objConnection.Provider = \"ADsDSOOBject\" \n    objConnection.Open \"Active Directory Provider\" \n    Set objCommand.ActiveConnection = objConnection \n    strFilter = \"(&(objectCategory=Computer)(cn=\" &  strComputerName & \"))\"\n    strQuery = strBase & \";\" & strFilter  & \";distinguishedName;subtree\" \n    objCommand.CommandText = strQuery \n    objCommand.Properties(\"Page Size\") = 100 \n    objCommand.Properties(\"Timeout\") = 100\n    objCommand.Properties(\"Cache Results\") = False \n    ' Enumerate all objects found. \n    Set objRecordSet = objCommand.Execute \n    If objRecordSet.EOF Then\n      WScript.echo \"The computer name '\" &  strComputerName & \"' cannot be found.\"\n      WScript.Quit 1\n    End If\n    ' Found object matching name\n    Do Until objRecordSet.EOF \n      dnFound = objRecordSet.Fields(\"distinguishedName\")\n      GetStrPathToComputer = \"LDAP://\" & dnFound\n      objRecordSet.MoveNext \n    Loop \n    ' Clean up. \n    Set objConnection = Nothing \n    Set objCommand = Nothing \n    Set objRecordSet = Nothing \nEnd Function\n' --------------------------------------------------------------------------------\n' Securely access the Active Directory computer object using Kerberos\n' --------------------------------------------------------------------------------\nSet objDSO = GetObject(\"LDAP:\")\nstrPathToComputer = GetStrPathToComputer(strComputerName)\nWScript.Echo \"Accessing object: \" + strPathToComputer\nConst ADS_SECURE_AUTHENTICATION = 1\nConst ADS_USE_SEALING = 64 '0x40\nConst ADS_USE_SIGNING = 128 '0x80\n' --------------------------------------------------------------------------------\n' Get all BitLocker recovery information from the Active Directory computer object\n' --------------------------------------------------------------------------------\n' Get all the recovery information child objects of the computer object\nSet objFveInfos = objDSO.OpenDSObject(strPathToComputer, vbNullString, vbNullString, _\n                                   ADS_SECURE_AUTHENTICATION + ADS_USE_SEALING + ADS_USE_SIGNING)\nobjFveInfos.Filter = Array(\"msFVE-RecoveryInformation\")\n' Iterate through each recovery information object and saves any existing key packages\nnCount = 1\nstrFilePathCurrent = strFilePath & nCount\nFor Each objFveInfo in objFveInfos\n   strName = objFveInfo.Get(\"name\")\n   strRecoveryPassword = objFveInfo.Get(\"msFVE-RecoveryPassword\")\n   strKeyPackage = objFveInfo.Get(\"msFVE-KeyPackage\")\n   WScript.echo \n   WScript.echo \"Recovery Object Name: \" + strName \n   WScript.echo \"Recovery Password: \" + strRecoveryPassword\n   ' Validate file path\n   Set fso = CreateObject(\"Scripting.FileSystemObject\")\n   If (fso.FileExists(strFilePathCurrent)) Then\n WScript.Echo \"The file \" & strFilePathCurrent & \" already exists. Please use a different path.\"\nWScript.Quit -1\n   End If\n   ' Save binary data to the file\n   SaveBinaryDataText strFilePathCurrent, strKeyPackage\n   \n   WScript.echo \"Related key package successfully saved to \" + strFilePathCurrent\n   ' Update next file path using base name\n   nCount = nCount + 1\n   strFilePathCurrent = strFilePath & nCount\nNext\n'----------------------------------------------------------------------------------------\n' Utility functions to save binary data \n'----------------------------------------------------------------------------------------\nFunction SaveBinaryDataText(FileName, ByteArray)\n  'Create FileSystemObject object\n  Dim FS: Set FS = CreateObject(\"Scripting.FileSystemObject\")\n  \n  'Create text stream object\n  Dim TextStream\n  Set TextStream = FS.CreateTextFile(FileName)\n  \n  'Convert binary data To text And write them To the file\n  TextStream.Write BinaryToString(ByteArray)\nEnd Function\nFunction BinaryToString(Binary)\n  Dim I, S\n  For I = 1 To LenB(Binary)\n    S = S & Chr(AscB(MidB(Binary, I, 1)))\n  Next\n  BinaryToString = S\nEnd Function\nWScript.Quit\nThe following sample script exports a new key package from an unlocked, encrypted volume.\nTo run this script, start by saving the code into a VBS file (for example, GetBitLockerKeyPackage.vbs). Then, open an administrator command prompt and use “cscript” to run the saved file (for example, type \"cscript GetBitLockerKeyPackage.vbs  -?\").\n' --------------------------------------------------------------------------------\n' Usage\n' --------------------------------------------------------------------------------\nSub ShowUsage\n   Wscript.Echo \"USAGE: GetBitLockerKeyPackage [VolumeLetter/DriveLetter:] [Path To Saved Key Package]\"\n   Wscript.Echo \n   Wscript.Echo \"Example: GetBitLockerKeyPackage C: E:\\bitlocker-backup-key-package\"\n   WScript.Quit\nEnd Sub\n' --------------------------------------------------------------------------------\n' Parse Arguments\n' --------------------------------------------------------------------------------\nSet args = WScript.Arguments\nSelect Case args.Count\n  Case 2\n    If args(0) = \"/?\" Or args(0) = \"-?\" Then\n      ShowUsage\n    Else \n      strDriveLetter = args(0)\n      strFilePath = args(1)\n    End If\n  Case Else\n    ShowUsage\nEnd Select\n' --------------------------------------------------------------------------------\n' Other Inputs\n' --------------------------------------------------------------------------------\n' Target computer name\n' Use \".\" to connect to the local computer\nstrComputerName = \".\" \n' Default key protector ID to use. Specify \"\" to let the script choose.\nstrDefaultKeyProtectorID = \"\"\n' strDefaultKeyProtectorID = \"{001298E0-870E-4BA0-A2FF-FC74758D5720}\"  ' sample \n' --------------------------------------------------------------------------------\n' Connect to the BitLocker WMI provider class\n' --------------------------------------------------------------------------------\nstrConnectionStr = \"winmgmts:\" _\n                 & \"{impersonationLevel=impersonate,authenticationLevel=pktPrivacy}!\\\\\" _\n                 & strComputerName _\n                 & \"\\root\\cimv2\\Security\\MicrosoftVolumeEncryption\"\n                 \n                 \nOn Error Resume Next 'handle permission errors\nSet objWMIService = GetObject(strConnectionStr)\nIf Err.Number <> 0 Then\n     WScript.Echo \"Failed to connect to the BitLocker interface (Error 0x\" & Hex(Err.Number) & \").\"\n     Wscript.Echo \"Ensure that you are running with administrative privileges.\"\n     WScript.Quit -1\nEnd If\nOn Error GoTo 0\nstrQuery = \"Select * from Win32_EncryptableVolume where DriveLetter='\" & strDriveLetter & \"'\"\nSet colTargetVolumes = objWMIService.ExecQuery(strQuery)\nIf colTargetVolumes.Count = 0 Then\n    WScript.Echo \"FAILURE: Unable to find BitLocker-capable drive \" &  strDriveLetter & \" on computer \" & strComputerName & \".\"\n    WScript.Quit -1\nEnd If\n' there should only be one volume found\nFor Each objFoundVolume in colTargetVolumes\n    set objVolume = objFoundVolume\nNext\n' objVolume is now our found BitLocker-capable disk volume\n' --------------------------------------------------------------------------------\n' Perform BitLocker WMI provider functionality\n' --------------------------------------------------------------------------------\n' Collect all possible valid key protector ID's that can be used to get the package\n' ----------------------------------------------------------------------------------\nnNumericalKeyProtectorType = 3 ' type associated with \"Numerical Password\" protector\nnRC = objVolume.GetKeyProtectors(nNumericalKeyProtectorType, aNumericalKeyProtectorIDs)\nIf nRC <> 0 Then\nWScript.Echo \"FAILURE: GetKeyProtectors failed with return code 0x\" & Hex(nRC)\nWScript.Quit -1\nEnd If\nnExternalKeyProtectorType = 2 ' type associated with \"External Key\" protector\nnRC = objVolume.GetKeyProtectors(nExternalKeyProtectorType, aExternalKeyProtectorIDs)\nIf nRC <> 0 Then\nWScript.Echo \"FAILURE: GetKeyProtectors failed with return code 0x\" & Hex(nRC)\nWScript.Quit -1\nEnd If\n' Get first key protector of the type \"Numerical Password\" or \"External Key\", if any\n' ----------------------------------------------------------------------------------\nif strDefaultKeyProtectorID = \"\" Then\n' Save first numerical password, if exists\nIf UBound(aNumericalKeyProtectorIDs) <> -1 Then\nstrDefaultKeyProtectorID = aNumericalKeyProtectorIDs(0)\nEnd If\n' No numerical passwords exist, save the first external key\nIf strDefaultKeyProtectorID = \"\" and UBound(aExternalKeyProtectorIDs) <> -1 Then\nstrDefaultKeyProtectorID = aExternalKeyProtectorIDs(0)\nEnd If \n' Fail case: no recovery key protectors exist. \nIf strDefaultKeyProtectorID = \"\" Then\nWScript.Echo \"FAILURE: Cannot create backup key package because no recovery passwords or recovery keys exist. Check that BitLocker protection is on for this drive.\"\nWScript.Echo \"For help adding recovery passwords or recovery keys, type \"\"manage-bde -protectors -add -?\"\".\"\nWScript.Quit -1\nEnd If\nEnd If\n' Get some information about the chosen key protector ID\n' ----------------------------------------------------------------------------------\n' is the type valid?\nnRC = objVolume.GetKeyProtectorType(strDefaultKeyProtectorID, nDefaultKeyProtectorType)\nIf Hex(nRC) = \"80070057\" Then\nWScript.Echo \"The key protector ID \" & strDefaultKeyProtectorID & \" is not valid.\"\nWScript.Echo \"This ID value may have been provided by the script writer.\"\nElseIf nRC <> 0 Then\nWScript.Echo \"FAILURE: GetKeyProtectorType failed with return code 0x\" & Hex(nRC)\nWScript.Quit -1\nEnd If\n' what's a string that can be used to describe it?\nstrDefaultKeyProtectorType = \"\"\nSelect Case nDefaultKeyProtectorType \n  Case nNumericalKeyProtectorType\n      strDefaultKeyProtectorType = \"recovery password\"\n  Case nExternalKeyProtectorType\n      strDefaultKeyProtectorType = \"recovery key\"\n  Case Else\n      WScript.Echo \"The key protector ID \" & strDefaultKeyProtectorID & \" does not refer to a valid recovery password or recovery key.\"\n      WScript.Echo \"This ID value may have been provided by the script writer.\"\nEnd Select\n' Save the backup key package using the chosen key protector ID\n' ----------------------------------------------------------------------------------\nnRC = objVolume.GetKeyPackage(strDefaultKeyProtectorID, oKeyPackage)\nIf nRC <> 0 Then\nWScript.Echo \"FAILURE: GetKeyPackage failed with return code 0x\" & Hex(nRC)\nWScript.Quit -1\nEnd If\n' Validate file path\nSet fso = CreateObject(\"Scripting.FileSystemObject\")\nIf (fso.FileExists(strFilePath)) Then\nWScript.Echo \"The file \" & strFilePath & \" already exists. Please use a different path.\"\nWScript.Quit -1\nEnd If\nDim oKeyPackageByte, bKeyPackage\nFor Each oKeyPackageByte in oKeyPackage\n  'WScript.echo \"key package byte: \" & oKeyPackageByte\n  bKeyPackage = bKeyPackage & ChrB(oKeyPackageByte)\nNext\n' Save binary data to the file\nSaveBinaryDataText strFilePath, bKeyPackage\n' Display helpful information\n' ----------------------------------------------------------------------------------\nWScript.Echo \"The backup key package has been saved to \" & strFilePath & \".\"\nWScript.Echo \"IMPORTANT: To use this key package, the \" & strDefaultKeyProtectorType & \" must also be saved.\"\n' Display the recovery password or a note about saving the recovery key file\nIf nDefaultKeyProtectorType = nNumericalKeyProtectorType Then\nnRC = objVolume.GetKeyProtectorNumericalPassword(strDefaultKeyProtectorID, sNumericalPassword)\nIf nRC <> 0 Then\nWScript.Echo \"FAILURE: GetKeyProtectorNumericalPassword failed with return code 0x\" & Hex(nRC)\nWScript.Quit -1\nEnd If\nWScript.Echo \"Save this recovery password: \" & sNumericalPassword\nElseIf nDefaultKeyProtectorType = nExternalKeyProtectorType Then\nWScript.Echo \"The saved key file is named \" & strDefaultKeyProtectorID & \".BEK\"\nWScript.Echo \"For help re-saving this external key file, type \"\"manage-bde -protectors -get -?\"\"\"\nEnd If\n'----------------------------------------------------------------------------------------\n' Utility functions to save binary data \n'----------------------------------------------------------------------------------------\nFunction SaveBinaryDataText(FileName, ByteArray)\n  'Create FileSystemObject object\n  Dim FS: Set FS = CreateObject(\"Scripting.FileSystemObject\")\n  \n  'Create text stream object\n  Dim TextStream\n  Set TextStream = FS.CreateTextFile(FileName)\n  \n  'Convert binary data To text And write them To the file\n  TextStream.Write BinaryToString(ByteArray)\nEnd Function\nFunction BinaryToString(Binary)\n  Dim I, S\n  For I = 1 To LenB(Binary)\n    S = S & Chr(AscB(MidB(Binary, I, 1)))\n  Next\n  BinaryToString = S\nEnd Function\n```\n\n## See also\n\n-   [BitLocker overview](bitlocker-overview.md)\n \n \n"}
{"nodes":[{"content":"5158(S) The Windows Filtering Platform has permitted a bind to a local port.","pos":[11,87]},{"content":"(Windows 10)","pos":[88,100]},{"content":"Describes security event 5158(S) The Windows Filtering Platform has permitted a bind to a local port.","pos":[114,215]},{"content":"5158(S): The Windows Filtering Platform has permitted a bind to a local port.","pos":[315,392]},{"content":"Applies to","pos":[396,406]},{"content":"Windows 10","pos":[413,423]},{"content":"Windows Server 2016","pos":[428,447]},{"pos":[567,668],"content":"<bpt id=\"p1\">***</bpt>Subcategory:<ept id=\"p1\">***</ept><ph id=\"ph1\">&amp;nbsp;</ph><bpt id=\"p2\">[</bpt>Audit Filtering Platform Connection<ept id=\"p2\">](audit-filtering-platform-connection.md)</ept>"},{"content":"Event Description:","pos":[673,691]},{"pos":[696,896],"content":"This event generates every time <bpt id=\"p1\">[</bpt>Windows Filtering Platform<ept id=\"p1\">](https://msdn.microsoft.com/en-us/library/windows/desktop/aa366510(v=vs.85).aspx)</ept> permits an application or service to bind to a local port."},{"pos":[900,1036],"content":"<bpt id=\"p1\">**</bpt>Note<ept id=\"p1\">**</ept><ph id=\"ph1\">&amp;nbsp;&amp;nbsp;</ph>For recommendations, see <bpt id=\"p2\">[</bpt>Security Monitoring Recommendations<ept id=\"p2\">](#security-monitoring-recommendations)</ept> for this event."},{"content":"Event XML:","pos":[1059,1069]},{"pos":[2071,2105],"content":"<bpt id=\"p1\">***</bpt>Required Server Roles:<ept id=\"p1\">***</ept> None."},{"pos":[2107,2168],"content":"<bpt id=\"p1\">***</bpt>Minimum OS Version:<ept id=\"p1\">***</ept> Windows Server 2008, Windows Vista."},{"pos":[2170,2194],"content":"<bpt id=\"p1\">***</bpt>Event Versions:<ept id=\"p1\">***</ept> 0."},{"content":"Field Descriptions:","pos":[2199,2218]},{"pos":[2223,2251],"content":"<bpt id=\"p1\">**</bpt>Application Information<ept id=\"p1\">**</ept>:"},{"content":"<bpt id=\"p1\">**</bpt>Process ID<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = Pointer<ph id=\"ph2\">\\]</ph>: hexadecimal Process ID of the process which was permitted to bind to the local port.","pos":[2257,2376]},{"content":"Process ID (PID) is a number used by the operating system to uniquely identify an active process.","pos":[2377,2474]},{"content":"To see the PID for a specific process you can, for example, use Task Manager (Details tab, PID column):","pos":[2475,2578]},{"content":"If you convert the hexadecimal value to decimal, you can compare it to the values in Task Manager.","pos":[2684,2782]},{"pos":[2788,2971],"content":"You can also correlate this process ID with a process ID in other events, for example, “<bpt id=\"p1\">[</bpt>4688<ept id=\"p1\">](event-4688.md)</ept>: A new process has been created” <bpt id=\"p2\">**</bpt>Process Information<ph id=\"ph1\">\\\\</ph>New Process ID<ept id=\"p2\">**</ept>."},{"pos":[2987,3095],"content":"<bpt id=\"p1\">**</bpt>Application Name<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UnicodeString<ph id=\"ph2\">\\]</ph><bpt id=\"p2\">**</bpt>:<ept id=\"p2\">**</ept> full path and the name of the executable for the process."},{"content":"Logical disk is displayed in format <ph id=\"ph1\">\\\\</ph>device<ph id=\"ph2\">\\\\</ph>harddiskvolume<ph id=\"ph3\">\\#</ph>.","pos":[3101,3164]},{"content":"You can get all local volume numbers by using <bpt id=\"p1\">**</bpt>diskpart<ept id=\"p1\">**</ept> utility.","pos":[3165,3232]},{"content":"The command to get volume numbers using diskpart is “<bpt id=\"p1\">**</bpt>list volume”<ept id=\"p1\">**</ept>:","pos":[3233,3303]},{"content":"Network Information:","pos":[3395,3415]},{"pos":[3423,3528],"content":"<bpt id=\"p1\">**</bpt>Source Address<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UnicodeString<ph id=\"ph2\">\\]</ph><bpt id=\"p2\">**</bpt>:<ept id=\"p2\">**</ept> local IP address on which application was bind the port."},{"content":"IPv4 Address","pos":[3538,3550]},{"content":"IPv6 Address","pos":[3560,3572]},{"content":":: - all IP addresses in IPv6 format","pos":[3582,3618]},{"content":"0.0.0.0 - all IP addresses in IPv4 format","pos":[3628,3669]},{"content":"127.0.0.1 , ::1 - localhost","pos":[3679,3706]},{"pos":[3712,3797],"content":"<bpt id=\"p1\">**</bpt>Source Port<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UnicodeString<ph id=\"ph2\">\\]</ph><bpt id=\"p2\">**</bpt>:<ept id=\"p2\">**</ept> port number which application was bind."},{"pos":[3803,3869],"content":"<bpt id=\"p1\">**</bpt>Protocol<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UInt32<ph id=\"ph2\">\\]</ph>: number of protocol which was used."},{"content":"Service","pos":[3873,3880]},{"content":"Protocol Number","pos":[3926,3941]},{"content":"Internet Control Message Protocol (ICMP)","pos":[4019,4059]},{"content":"1","pos":[4072,4073]},{"content":"Transmission Control Protocol (TCP)","pos":[4092,4127]},{"content":"6","pos":[4145,4146]},{"content":"User Datagram Protocol (UDP)","pos":[4165,4193]},{"content":"17","pos":[4218,4220]},{"content":"General Routing Encapsulation (PPTP data over GRE)","pos":[4238,4288]},{"content":"47","pos":[4291,4293]},{"content":"Authentication Header (AH) IPSec","pos":[4311,4343]},{"content":"51","pos":[4364,4366]},{"content":"Encapsulation Security Payload (ESP) IPSec","pos":[4384,4426]},{"content":"50","pos":[4437,4439]},{"content":"Exterior Gateway Protocol (EGP)","pos":[4457,4488]},{"content":"8","pos":[4510,4511]},{"content":"Gateway-Gateway Protocol (GGP)","pos":[4530,4560]},{"content":"3","pos":[4583,4584]},{"content":"Host Monitoring Protocol (HMP)","pos":[4603,4633]},{"content":"20","pos":[4656,4658]},{"content":"Internet Group Management Protocol (IGMP)","pos":[4676,4717]},{"content":"88","pos":[4729,4731]},{"content":"MIT Remote Virtual Disk (RVD)","pos":[4749,4778]},{"content":"66","pos":[4802,4804]},{"content":"OSPF Open Shortest Path First","pos":[4822,4851]},{"content":"89","pos":[4875,4877]},{"content":"PARC Universal Packet Protocol (PUP)","pos":[4895,4931]},{"content":"12","pos":[4948,4950]},{"content":"Reliable Datagram Protocol (RDP)","pos":[4968,5000]},{"content":"27","pos":[5021,5023]},{"content":"Reservation Protocol (RSVP) QoS","pos":[5041,5072]},{"content":"46","pos":[5094,5096]},{"content":"Filter Information:","pos":[5115,5134]},{"content":"<bpt id=\"p1\">**</bpt>Filter Run-Time ID<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UInt64<ph id=\"ph2\">\\]</ph>: unique filter ID which allows application to bind the port.","pos":[5142,5243]},{"content":"By default Windows firewall won't prevent a port from being binded by an application and if this application doesn’t match any filters you will get value 0 in this field.","pos":[5244,5414]},{"content":"To find specific Windows Filtering Platform filter by ID you need to execute the following command: <bpt id=\"p1\">**</bpt>netsh wfp show filters<ept id=\"p1\">**</ept>.","pos":[5420,5547]},{"content":"As result of this command <bpt id=\"p1\">**</bpt>filters.xml<ept id=\"p1\">**</ept> file will be generated.","pos":[5548,5613]},{"content":"You need to open this file and find specific substring with required filter ID (<bpt id=\"p1\">**</bpt><ph id=\"ph1\">&amp;lt;</ph>filterId<ph id=\"ph2\">&amp;gt;</ph><ept id=\"p1\">**</ept>)<bpt id=\"p2\">**</bpt>,<ept id=\"p2\">**</ept> for example:","pos":[5614,5733]},{"pos":[5847,6012],"content":"<bpt id=\"p1\">**</bpt>Layer Name<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UnicodeString<ph id=\"ph2\">\\]</ph>: <bpt id=\"p2\">[</bpt>Application Layer Enforcement<ept id=\"p2\">](https://msdn.microsoft.com/en-us/library/windows/desktop/aa363971(v=vs.85).aspx)</ept> layer name."},{"content":"<bpt id=\"p1\">**</bpt>Layer Run-Time ID<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UInt64<ph id=\"ph2\">\\]</ph>: Windows Filtering Platform layer identifier.","pos":[6018,6103]},{"content":"To find specific Windows Filtering Platform layer ID you need to execute the following command: <bpt id=\"p1\">**</bpt>netsh wfp show state<ept id=\"p1\">**</ept>.","pos":[6104,6225]},{"content":"As result of this command <bpt id=\"p1\">**</bpt>wfpstate.xml<ept id=\"p1\">**</ept> file will be generated.","pos":[6226,6292]},{"content":"You need to open this file and find specific substring with required layer ID (<bpt id=\"p1\">**</bpt><ph id=\"ph1\">&amp;lt;</ph>layerId<ph id=\"ph2\">&amp;gt;</ph><ept id=\"p1\">**</ept>)<bpt id=\"p2\">**</bpt>,<ept id=\"p2\">**</ept> for example:","pos":[6293,6410]},{"content":"Security Monitoring Recommendations","pos":[6512,6547]},{"content":"For 5158(S): The Windows Filtering Platform has permitted a bind to a local port.","pos":[6549,6630]},{"pos":[6636,6829],"content":"If you have a pre-defined application which should be used to perform the operation that was reported by this event, monitor events with “<bpt id=\"p1\">**</bpt>Application<ept id=\"p1\">**</ept>” not equal to your defined application."},{"pos":[6835,7036],"content":"You can monitor to see if “<bpt id=\"p1\">**</bpt>Application<ept id=\"p1\">**</ept>” is not in a standard folder (for example, not in <bpt id=\"p2\">**</bpt>System32<ept id=\"p2\">**</ept> or <bpt id=\"p3\">**</bpt>Program Files<ept id=\"p3\">**</ept>) or is in a restricted folder (for example, <bpt id=\"p4\">**</bpt>Temporary Internet Files<ept id=\"p4\">**</ept>)."},{"pos":[7042,7225],"content":"If you have a pre-defined list of restricted substrings or words in application names (for example, “<bpt id=\"p1\">**</bpt>mimikatz<ept id=\"p1\">**</ept>” or “<bpt id=\"p2\">**</bpt>cain.exe<ept id=\"p2\">**</ept>”), check for these substrings in “<bpt id=\"p3\">**</bpt>Application<ept id=\"p3\">**</ept>.”"},{"pos":[7231,7312],"content":"Check that “<bpt id=\"p1\">**</bpt>Source Address”<ept id=\"p1\">**</ept> is one of the addresses assigned to the computer."},{"pos":[7318,7450],"content":"If you need to monitor all actions with a specific local port, monitor for <bpt id=\"p1\">[</bpt>5158<ept id=\"p1\">](event-5158.md)</ept> events with that “<bpt id=\"p2\">**</bpt>Source Port.”<ept id=\"p2\">**</ept>"},{"pos":[7456,7602],"content":"Monitor for all connections with a “<bpt id=\"p1\">**</bpt>Protocol Number”<ept id=\"p1\">**</ept> that is not typical for this device or compter, for example, anything other than 6 or 17."},{"pos":[7608,7773],"content":"If the computer’s communication with “<bpt id=\"p1\">**</bpt>Destination Address”<ept id=\"p1\">**</ept> should always use a specific “<bpt id=\"p2\">**</bpt>Destination Port<ept id=\"p2\">**</ept>,<bpt id=\"p3\">**</bpt>”<ept id=\"p3\">**</ept> monitor for any other “<bpt id=\"p4\">**</bpt>Destination Port<ept id=\"p4\">**</ept>.”"}],"content":"---\ntitle: 5158(S) The Windows Filtering Platform has permitted a bind to a local port. (Windows 10)\ndescription: Describes security event 5158(S) The Windows Filtering Platform has permitted a bind to a local port.\nms.pagetype: security\nms.prod: w10\nms.mktglfcycl: deploy\nms.sitesec: library\nauthor: Mir0sh\n---\n\n# 5158(S): The Windows Filtering Platform has permitted a bind to a local port.\n\n**Applies to**\n-   Windows 10\n-   Windows Server 2016\n\n\n<img src=\"images/event-5158.png\" alt=\"Event 5158 illustration\" width=\"491\" height=\"466\" hspace=\"10\" align=\"left\" />\n\n***Subcategory:***&nbsp;[Audit Filtering Platform Connection](audit-filtering-platform-connection.md)\n\n***Event Description:***\n\nThis event generates every time [Windows Filtering Platform](https://msdn.microsoft.com/en-us/library/windows/desktop/aa366510(v=vs.85).aspx) permits an application or service to bind to a local port.\n\n> **Note**&nbsp;&nbsp;For recommendations, see [Security Monitoring Recommendations](#security-monitoring-recommendations) for this event.\n\n<br clear=\"all\">\n\n***Event XML:***\n```\n- <Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\n- <System>\n <Provider Name=\"Microsoft-Windows-Security-Auditing\" Guid=\"{54849625-5478-4994-A5BA-3E3B0328C30D}\" /> \n <EventID>5158</EventID> \n <Version>0</Version> \n <Level>0</Level> \n <Task>12810</Task> \n <Opcode>0</Opcode> \n <Keywords>0x8020000000000000</Keywords> \n <TimeCreated SystemTime=\"2015-09-22T05:24:03.376171200Z\" /> \n <EventRecordID>308122</EventRecordID> \n <Correlation /> \n <Execution ProcessID=\"4\" ThreadID=\"3712\" /> \n <Channel>Security</Channel> \n <Computer>DC01.contoso.local</Computer> \n <Security /> \n </System>\n- <EventData>\n <Data Name=\"ProcessId\">4556</Data> \n <Data Name=\"Application\">\\\\device\\\\harddiskvolume2\\\\documents\\\\listener.exe</Data> \n <Data Name=\"SourceAddress\">0.0.0.0</Data> \n <Data Name=\"SourcePort\">3333</Data> \n <Data Name=\"Protocol\">6</Data> \n <Data Name=\"FilterRTID\">0</Data> \n <Data Name=\"LayerName\">%%14608</Data> \n <Data Name=\"LayerRTID\">36</Data> \n </EventData>\n </Event>\n\n```\n\n***Required Server Roles:*** None.\n\n***Minimum OS Version:*** Windows Server 2008, Windows Vista.\n\n***Event Versions:*** 0.\n\n***Field Descriptions:***\n\n**Application Information**:\n\n-   **Process ID** \\[Type = Pointer\\]: hexadecimal Process ID of the process which was permitted to bind to the local port. Process ID (PID) is a number used by the operating system to uniquely identify an active process. To see the PID for a specific process you can, for example, use Task Manager (Details tab, PID column):\n\n    <img src=\"images/task-manager.png\" alt=\"Task manager illustration\" width=\"585\" height=\"375\" />\n\n    If you convert the hexadecimal value to decimal, you can compare it to the values in Task Manager.\n\n    You can also correlate this process ID with a process ID in other events, for example, “[4688](event-4688.md): A new process has been created” **Process Information\\\\New Process ID**.\n\n<!-- -->\n\n-   **Application Name** \\[Type = UnicodeString\\]**:** full path and the name of the executable for the process.\n\n    Logical disk is displayed in format \\\\device\\\\harddiskvolume\\#. You can get all local volume numbers by using **diskpart** utility. The command to get volume numbers using diskpart is “**list volume”**:\n\n<img src=\"images/diskpart.png\" alt=\"DiskPart illustration\" width=\"786\" height=\"246\" />\n\n**Network Information:**\n\n-   **Source Address** \\[Type = UnicodeString\\]**:** local IP address on which application was bind the port.\n\n    -   IPv4 Address\n\n    -   IPv6 Address\n\n    -   :: - all IP addresses in IPv6 format\n\n    -   0.0.0.0 - all IP addresses in IPv4 format\n\n    -   127.0.0.1 , ::1 - localhost\n\n-   **Source Port** \\[Type = UnicodeString\\]**:** port number which application was bind.\n\n-   **Protocol** \\[Type = UInt32\\]: number of protocol which was used.\n\n| Service                                            | Protocol Number |\n|----------------------------------------------------|-----------------|\n| Internet Control Message Protocol (ICMP)           | 1               |\n| Transmission Control Protocol (TCP)                | 6               |\n| User Datagram Protocol (UDP)                       | 17              |\n| General Routing Encapsulation (PPTP data over GRE) | 47              |\n| Authentication Header (AH) IPSec                   | 51              |\n| Encapsulation Security Payload (ESP) IPSec         | 50              |\n| Exterior Gateway Protocol (EGP)                    | 8               |\n| Gateway-Gateway Protocol (GGP)                     | 3               |\n| Host Monitoring Protocol (HMP)                     | 20              |\n| Internet Group Management Protocol (IGMP)          | 88              |\n| MIT Remote Virtual Disk (RVD)                      | 66              |\n| OSPF Open Shortest Path First                      | 89              |\n| PARC Universal Packet Protocol (PUP)               | 12              |\n| Reliable Datagram Protocol (RDP)                   | 27              |\n| Reservation Protocol (RSVP) QoS                    | 46              |\n\n**Filter Information:**\n\n-   **Filter Run-Time ID** \\[Type = UInt64\\]: unique filter ID which allows application to bind the port. By default Windows firewall won't prevent a port from being binded by an application and if this application doesn’t match any filters you will get value 0 in this field.\n\n    To find specific Windows Filtering Platform filter by ID you need to execute the following command: **netsh wfp show filters**. As result of this command **filters.xml** file will be generated. You need to open this file and find specific substring with required filter ID (**&lt;filterId&gt;**)**,** for example:\n\n    <img src=\"images/filters-xml-file.png\" alt=\"Filters.xml file illustration\" width=\"840\" height=\"176\" />\n\n-   **Layer Name** \\[Type = UnicodeString\\]: [Application Layer Enforcement](https://msdn.microsoft.com/en-us/library/windows/desktop/aa363971(v=vs.85).aspx) layer name.\n\n-   **Layer Run-Time ID** \\[Type = UInt64\\]: Windows Filtering Platform layer identifier. To find specific Windows Filtering Platform layer ID you need to execute the following command: **netsh wfp show state**. As result of this command **wfpstate.xml** file will be generated. You need to open this file and find specific substring with required layer ID (**&lt;layerId&gt;**)**,** for example:\n\n<img src=\"images/wfpstate-xml.png\" alt=\"Wfpstate xml illustration\" width=\"1563\" height=\"780\" />\n\n## Security Monitoring Recommendations\n\nFor 5158(S): The Windows Filtering Platform has permitted a bind to a local port.\n\n-   If you have a pre-defined application which should be used to perform the operation that was reported by this event, monitor events with “**Application**” not equal to your defined application.\n\n-   You can monitor to see if “**Application**” is not in a standard folder (for example, not in **System32** or **Program Files**) or is in a restricted folder (for example, **Temporary Internet Files**).\n\n-   If you have a pre-defined list of restricted substrings or words in application names (for example, “**mimikatz**” or “**cain.exe**”), check for these substrings in “**Application**.”\n\n-   Check that “**Source Address”** is one of the addresses assigned to the computer.\n\n-   If you need to monitor all actions with a specific local port, monitor for [5158](event-5158.md) events with that “**Source Port.”**\n\n-   Monitor for all connections with a “**Protocol Number”** that is not typical for this device or compter, for example, anything other than 6 or 17.\n\n-   If the computer’s communication with “**Destination Address”** should always use a specific “**Destination Port**,**”** monitor for any other “**Destination Port**.”\n\n"}
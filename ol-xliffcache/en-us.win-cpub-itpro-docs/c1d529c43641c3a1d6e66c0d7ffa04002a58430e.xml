{"nodes":[{"content":"5154(S) The Windows Filtering Platform has permitted an application or service to listen on a port for incoming connections.","pos":[11,135]},{"content":"(Windows 10)","pos":[136,148]},{"content":"Describes security event 5154(S) The Windows Filtering Platform has permitted an application or service to listen on a port for incoming connections.","pos":[162,311]},{"content":"5154(S): The Windows Filtering Platform has permitted an application or service to listen on a port for incoming connections.","pos":[411,536]},{"content":"Applies to","pos":[540,550]},{"content":"Windows 10","pos":[557,567]},{"content":"Windows Server 2016","pos":[572,591]},{"pos":[711,812],"content":"<bpt id=\"p1\">***</bpt>Subcategory:<ept id=\"p1\">***</ept><ph id=\"ph1\">&amp;nbsp;</ph><bpt id=\"p2\">[</bpt>Audit Filtering Platform Connection<ept id=\"p2\">](audit-filtering-platform-connection.md)</ept>"},{"content":"Event Description:","pos":[817,835]},{"pos":[840,1036],"content":"This event generates every time <bpt id=\"p1\">[</bpt>Windows Filtering Platform<ept id=\"p1\">](https://msdn.microsoft.com/en-us/library/windows/desktop/aa366510(v=vs.85).aspx)</ept> permits an application or service to listen on a port."},{"pos":[1040,1176],"content":"<bpt id=\"p1\">**</bpt>Note<ept id=\"p1\">**</ept><ph id=\"ph1\">&amp;nbsp;&amp;nbsp;</ph>For recommendations, see <bpt id=\"p2\">[</bpt>Security Monitoring Recommendations<ept id=\"p2\">](#security-monitoring-recommendations)</ept> for this event."},{"content":"Event XML:","pos":[1199,1209]},{"pos":[2211,2245],"content":"<bpt id=\"p1\">***</bpt>Required Server Roles:<ept id=\"p1\">***</ept> None."},{"pos":[2247,2308],"content":"<bpt id=\"p1\">***</bpt>Minimum OS Version:<ept id=\"p1\">***</ept> Windows Server 2008, Windows Vista."},{"pos":[2310,2334],"content":"<bpt id=\"p1\">***</bpt>Event Versions:<ept id=\"p1\">***</ept> 0."},{"content":"Field Descriptions:","pos":[2339,2358]},{"pos":[2363,2391],"content":"<bpt id=\"p1\">**</bpt>Application Information<ept id=\"p1\">**</ept>:"},{"content":"<bpt id=\"p1\">**</bpt>Process ID<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = Pointer<ph id=\"ph2\">\\]</ph>: hexadecimal Process ID of the process which was permitted to listen on the port.","pos":[2397,2512]},{"content":"Process ID (PID) is a number used by the operating system to uniquely identify an active process.","pos":[2513,2610]},{"content":"To see the PID for a specific process you can, for example, use Task Manager (Details tab, PID column):","pos":[2611,2714]},{"content":"If you convert the hexadecimal value to decimal, you can compare it to the values in Task Manager.","pos":[2820,2918]},{"pos":[2924,3107],"content":"You can also correlate this process ID with a process ID in other events, for example, “<bpt id=\"p1\">[</bpt>4688<ept id=\"p1\">](event-4688.md)</ept>: A new process has been created” <bpt id=\"p2\">**</bpt>Process Information<ph id=\"ph1\">\\\\</ph>New Process ID<ept id=\"p2\">**</ept>."},{"pos":[3113,3221],"content":"<bpt id=\"p1\">**</bpt>Application Name<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UnicodeString<ph id=\"ph2\">\\]</ph><bpt id=\"p2\">**</bpt>:<ept id=\"p2\">**</ept> full path and the name of the executable for the process."},{"content":"Logical disk is displayed in format <ph id=\"ph1\">\\\\</ph>device<ph id=\"ph2\">\\\\</ph>harddiskvolume<ph id=\"ph3\">\\#</ph>.","pos":[3227,3290]},{"content":"You can get all local volume numbers by using <bpt id=\"p1\">**</bpt>diskpart<ept id=\"p1\">**</ept> utility.","pos":[3291,3358]},{"content":"The command to get volume numbers using diskpart is “<bpt id=\"p1\">**</bpt>list volume”<ept id=\"p1\">**</ept>:","pos":[3359,3429]},{"content":"Network Information:","pos":[3521,3541]},{"pos":[3549,3668],"content":"<bpt id=\"p1\">**</bpt>Source Address<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UnicodeString<ph id=\"ph2\">\\]</ph><bpt id=\"p2\">**</bpt>:<ept id=\"p2\">**</ept> local IP address on which application requested to listen on the port."},{"content":"IPv4 Address","pos":[3678,3690]},{"content":"IPv6 Address","pos":[3700,3712]},{"content":":: - all IP addresses in IPv6 format","pos":[3722,3758]},{"content":"0.0.0.0 - all IP addresses in IPv4 format","pos":[3768,3809]},{"content":"127.0.0.1 , ::1 - localhost","pos":[3819,3846]},{"pos":[3852,3971],"content":"<bpt id=\"p1\">**</bpt>Source Port<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UnicodeString<ph id=\"ph2\">\\]</ph>: source TCP<ph id=\"ph3\">\\\\</ph>UDP port number which was requested for listening by application."},{"content":"<bpt id=\"p1\">**</bpt>Protocol<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UInt32<ph id=\"ph2\">\\]</ph>: protocol number.","pos":[3977,4025]},{"content":"For example:","pos":[4026,4038]},{"content":"6 – TCP.","pos":[4048,4056]},{"content":"17 – UDP.","pos":[4066,4075]},{"pos":[4085,4200],"content":"More information about possible values for this field: <bpt id=\"p1\">&lt;</bpt>https://technet.microsoft.com/en-us/library/cc959827.aspx<ept id=\"p1\">&gt;</ept>."},{"content":"Filter Information:","pos":[4204,4223]},{"content":"<bpt id=\"p1\">**</bpt>Filter Run-Time ID<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UInt64<ph id=\"ph2\">\\]</ph>: unique filter ID which allows application to listen on the specific port.","pos":[4231,4346]},{"content":"By default Windows firewall won't prevent a port from being listened by an application and if this application doesn’t match any filters you will get value <bpt id=\"p1\">**</bpt>0<ept id=\"p1\">**</ept> in this field.","pos":[4347,4523]},{"content":"To find specific Windows Filtering Platform filter by ID you need to execute the following command: <bpt id=\"p1\">**</bpt>netsh wfp show filters<ept id=\"p1\">**</ept>.","pos":[4529,4656]},{"content":"As result of this command <bpt id=\"p1\">**</bpt>filters.xml<ept id=\"p1\">**</ept> file will be generated.","pos":[4657,4722]},{"content":"You need to open this file and find specific substring with required filter ID (<bpt id=\"p1\">**</bpt><ph id=\"ph1\">&amp;lt;</ph>filterId<ph id=\"ph2\">&amp;gt;</ph><ept id=\"p1\">**</ept>)<bpt id=\"p2\">**</bpt>,<ept id=\"p2\">**</ept> for example:","pos":[4723,4842]},{"pos":[4952,5117],"content":"<bpt id=\"p1\">**</bpt>Layer Name<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UnicodeString<ph id=\"ph2\">\\]</ph>: <bpt id=\"p2\">[</bpt>Application Layer Enforcement<ept id=\"p2\">](https://msdn.microsoft.com/en-us/library/windows/desktop/aa363971(v=vs.85).aspx)</ept> layer name."},{"content":"<bpt id=\"p1\">**</bpt>Layer Run-Time ID<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UInt64<ph id=\"ph2\">\\]</ph>: Windows Filtering Platform layer identifier.","pos":[5123,5208]},{"content":"To find specific Windows Filtering Platform layer ID you need to execute the following command: <bpt id=\"p1\">**</bpt>netsh wfp show state<ept id=\"p1\">**</ept>.","pos":[5209,5330]},{"content":"As result of this command <bpt id=\"p1\">**</bpt>wfpstate.xml<ept id=\"p1\">**</ept> file will be generated.","pos":[5331,5397]},{"content":"You need to open this file and find specific substring with required layer ID (<bpt id=\"p1\">**</bpt><ph id=\"ph1\">&amp;lt;</ph>layerId<ph id=\"ph2\">&amp;gt;</ph><ept id=\"p1\">**</ept>)<bpt id=\"p2\">**</bpt>,<ept id=\"p2\">**</ept> for example:","pos":[5398,5515]},{"content":"Security Monitoring Recommendations","pos":[5617,5652]},{"content":"For 5154(S): The Windows Filtering Platform has permitted an application or service to listen on a port for incoming connections.","pos":[5654,5783]},{"pos":[5789,6027],"content":"If you have a “whitelist” of applications that are associated with certain operating systems or server roles, and that are expected to listen on specific ports, monitor this event for <bpt id=\"p1\">**</bpt>“Application Name”<ept id=\"p1\">**</ept> and other relevant information."},{"pos":[6033,6203],"content":"If a certain application is allowed to listen only on specific port numbers, monitor this event for <bpt id=\"p1\">**</bpt>“Application Name”<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>“Network Information<ph id=\"ph1\">\\\\</ph>Source Port<ept id=\"p2\">**</ept>.<bpt id=\"p3\">**</bpt>”<ept id=\"p3\">**</ept>"},{"pos":[6209,6382],"content":"If a certain application is allowed to listen only on a specific IP address, monitor this event for <bpt id=\"p1\">**</bpt>“Application Name”<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>“Network Information<ph id=\"ph1\">\\\\</ph>Source Address<ept id=\"p2\">**</ept>.<bpt id=\"p3\">**</bpt>”<ept id=\"p3\">**</ept>"},{"pos":[6388,6571],"content":"If a certain application is allowed to use only TCP or UDP protocols, monitor this event for <bpt id=\"p1\">**</bpt>“Application Name”<ept id=\"p1\">**</ept> and the protocol number in <bpt id=\"p2\">**</bpt>“Network Information<ph id=\"ph1\">\\\\</ph>Protocol<ept id=\"p2\">**</ept>.<bpt id=\"p3\">**</bpt>”<ept id=\"p3\">**</ept>"},{"pos":[6577,6770],"content":"If you have a pre-defined application which should be used to perform the operation that was reported by this event, monitor events with “<bpt id=\"p1\">**</bpt>Application<ept id=\"p1\">**</ept>” not equal to your defined application."},{"pos":[6776,6977],"content":"You can monitor to see if “<bpt id=\"p1\">**</bpt>Application<ept id=\"p1\">**</ept>” is not in a standard folder (for example, not in <bpt id=\"p2\">**</bpt>System32<ept id=\"p2\">**</ept> or <bpt id=\"p3\">**</bpt>Program Files<ept id=\"p3\">**</ept>) or is in a restricted folder (for example, <bpt id=\"p4\">**</bpt>Temporary Internet Files<ept id=\"p4\">**</ept>)."},{"pos":[6983,7166],"content":"If you have a pre-defined list of restricted substrings or words in application names (for example, “<bpt id=\"p1\">**</bpt>mimikatz<ept id=\"p1\">**</ept>” or “<bpt id=\"p2\">**</bpt>cain.exe<ept id=\"p2\">**</ept>”), check for these substrings in “<bpt id=\"p3\">**</bpt>Application<ept id=\"p3\">**</ept>.”"},{"content":"Typically this event has an informational purpose.","pos":[7172,7222]}],"content":"---\ntitle: 5154(S) The Windows Filtering Platform has permitted an application or service to listen on a port for incoming connections. (Windows 10)\ndescription: Describes security event 5154(S) The Windows Filtering Platform has permitted an application or service to listen on a port for incoming connections.\nms.pagetype: security\nms.prod: w10\nms.mktglfcycl: deploy\nms.sitesec: library\nauthor: Mir0sh\n---\n\n# 5154(S): The Windows Filtering Platform has permitted an application or service to listen on a port for incoming connections.\n\n**Applies to**\n-   Windows 10\n-   Windows Server 2016\n\n\n<img src=\"images/event-5154.png\" alt=\"Event 5154 illustration\" width=\"490\" height=\"474\" hspace=\"10\" align=\"left\" />\n\n***Subcategory:***&nbsp;[Audit Filtering Platform Connection](audit-filtering-platform-connection.md)\n\n***Event Description:***\n\nThis event generates every time [Windows Filtering Platform](https://msdn.microsoft.com/en-us/library/windows/desktop/aa366510(v=vs.85).aspx) permits an application or service to listen on a port.\n\n> **Note**&nbsp;&nbsp;For recommendations, see [Security Monitoring Recommendations](#security-monitoring-recommendations) for this event.\n\n<br clear=\"all\">\n\n***Event XML:***\n```\n- <Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\n- <System>\n <Provider Name=\"Microsoft-Windows-Security-Auditing\" Guid=\"{54849625-5478-4994-A5BA-3E3B0328C30D}\" /> \n <EventID>5154</EventID> \n <Version>0</Version> \n <Level>0</Level> \n <Task>12810</Task> \n <Opcode>0</Opcode> \n <Keywords>0x8020000000000000</Keywords> \n <TimeCreated SystemTime=\"2015-09-22T02:04:25.757462900Z\" /> \n <EventRecordID>287929</EventRecordID> \n <Correlation /> \n <Execution ProcessID=\"4\" ThreadID=\"3968\" /> \n <Channel>Security</Channel> \n <Computer>DC01.contoso.local</Computer> \n <Security /> \n </System>\n- <EventData>\n <Data Name=\"ProcessId\">4152</Data> \n <Data Name=\"Application\">\\\\device\\\\harddiskvolume2\\\\documents\\\\listener.exe</Data> \n <Data Name=\"SourceAddress\">0.0.0.0</Data> \n <Data Name=\"SourcePort\">4444</Data> \n <Data Name=\"Protocol\">6</Data> \n <Data Name=\"FilterRTID\">0</Data> \n <Data Name=\"LayerName\">%%14609</Data> \n <Data Name=\"LayerRTID\">40</Data> \n </EventData>\n </Event>\n\n```\n\n***Required Server Roles:*** None.\n\n***Minimum OS Version:*** Windows Server 2008, Windows Vista.\n\n***Event Versions:*** 0.\n\n***Field Descriptions:***\n\n**Application Information**:\n\n-   **Process ID** \\[Type = Pointer\\]: hexadecimal Process ID of the process which was permitted to listen on the port. Process ID (PID) is a number used by the operating system to uniquely identify an active process. To see the PID for a specific process you can, for example, use Task Manager (Details tab, PID column):\n\n    <img src=\"images/task-manager.png\" alt=\"Task manager illustration\" width=\"585\" height=\"375\" />\n\n    If you convert the hexadecimal value to decimal, you can compare it to the values in Task Manager.\n\n    You can also correlate this process ID with a process ID in other events, for example, “[4688](event-4688.md): A new process has been created” **Process Information\\\\New Process ID**.\n\n-   **Application Name** \\[Type = UnicodeString\\]**:** full path and the name of the executable for the process.\n\n    Logical disk is displayed in format \\\\device\\\\harddiskvolume\\#. You can get all local volume numbers by using **diskpart** utility. The command to get volume numbers using diskpart is “**list volume”**:\n\n<img src=\"images/diskpart.png\" alt=\"DiskPart illustration\" width=\"786\" height=\"246\" />\n\n**Network Information:**\n\n-   **Source Address** \\[Type = UnicodeString\\]**:** local IP address on which application requested to listen on the port.\n\n    -   IPv4 Address\n\n    -   IPv6 Address\n\n    -   :: - all IP addresses in IPv6 format\n\n    -   0.0.0.0 - all IP addresses in IPv4 format\n\n    -   127.0.0.1 , ::1 - localhost\n\n-   **Source Port** \\[Type = UnicodeString\\]: source TCP\\\\UDP port number which was requested for listening by application.\n\n-   **Protocol** \\[Type = UInt32\\]: protocol number. For example:\n\n    -   6 – TCP.\n\n    -   17 – UDP.\n\n        More information about possible values for this field: <https://technet.microsoft.com/en-us/library/cc959827.aspx>.\n\n**Filter Information:**\n\n-   **Filter Run-Time ID** \\[Type = UInt64\\]: unique filter ID which allows application to listen on the specific port. By default Windows firewall won't prevent a port from being listened by an application and if this application doesn’t match any filters you will get value **0** in this field.\n\n    To find specific Windows Filtering Platform filter by ID you need to execute the following command: **netsh wfp show filters**. As result of this command **filters.xml** file will be generated. You need to open this file and find specific substring with required filter ID (**&lt;filterId&gt;**)**,** for example:\n\n<img src=\"images/filters-xml-file.png\" alt=\"Filters.xml file illustration\" width=\"840\" height=\"176\" />\n\n-   **Layer Name** \\[Type = UnicodeString\\]: [Application Layer Enforcement](https://msdn.microsoft.com/en-us/library/windows/desktop/aa363971(v=vs.85).aspx) layer name.\n\n-   **Layer Run-Time ID** \\[Type = UInt64\\]: Windows Filtering Platform layer identifier. To find specific Windows Filtering Platform layer ID you need to execute the following command: **netsh wfp show state**. As result of this command **wfpstate.xml** file will be generated. You need to open this file and find specific substring with required layer ID (**&lt;layerId&gt;**)**,** for example:\n\n<img src=\"images/wfpstate-xml.png\" alt=\"Wfpstate xml illustration\" width=\"1563\" height=\"780\" />\n\n## Security Monitoring Recommendations\n\nFor 5154(S): The Windows Filtering Platform has permitted an application or service to listen on a port for incoming connections.\n\n-   If you have a “whitelist” of applications that are associated with certain operating systems or server roles, and that are expected to listen on specific ports, monitor this event for **“Application Name”** and other relevant information.\n\n-   If a certain application is allowed to listen only on specific port numbers, monitor this event for **“Application Name”** and **“Network Information\\\\Source Port**.**”**\n\n-   If a certain application is allowed to listen only on a specific IP address, monitor this event for **“Application Name”** and **“Network Information\\\\Source Address**.**”**\n\n-   If a certain application is allowed to use only TCP or UDP protocols, monitor this event for **“Application Name”** and the protocol number in **“Network Information\\\\Protocol**.**”**\n\n-   If you have a pre-defined application which should be used to perform the operation that was reported by this event, monitor events with “**Application**” not equal to your defined application.\n\n-   You can monitor to see if “**Application**” is not in a standard folder (for example, not in **System32** or **Program Files**) or is in a restricted folder (for example, **Temporary Internet Files**).\n\n-   If you have a pre-defined list of restricted substrings or words in application names (for example, “**mimikatz**” or “**cain.exe**”), check for these substrings in “**Application**.”\n\n-   Typically this event has an informational purpose.\n\n"}
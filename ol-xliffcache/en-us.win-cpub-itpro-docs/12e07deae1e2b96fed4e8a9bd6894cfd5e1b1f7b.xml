{"nodes":[{"content":"BitLocker How to enable Network Unlock (Windows 10)","pos":[11,62]},{"content":"This topic for the IT professional describes how BitLocker Network Unlock works and how to configure it.","pos":[76,180]},{"content":"BitLocker: How to enable Network Unlock","pos":[336,375]},{"content":"Applies to","pos":[379,389]},{"content":"Windows 10","pos":[396,406]},{"content":"This topic for the IT professional describes how BitLocker Network Unlock works and how to configure it.","pos":[408,512]},{"content":"Network Unlock was introduced in Windows 8 and Windows Server 2012 as a BitLocker protector option for operating system volumes.","pos":[514,642]},{"content":"Network Unlock enables easier management for BitLocker enabled desktops and servers in a domain environment by providing automatic unlock of operating system volumes at system reboot when connected to a wired corporate network.","pos":[643,870]},{"content":"This feature requires the client hardware to have a DHCP driver implemented in its UEFI firmware.","pos":[871,968]},{"content":"Without Network Unlock, operating system volumes protected by TPM+PIN protectors require a PIN to be entered when a computer reboots or resumes from hibernation (for example, by Wake on LAN).","pos":[969,1160]},{"content":"This can make it difficult to enterprises to roll out software patches to unattended desktops and remotely administered servers.","pos":[1161,1289]},{"content":"Network Unlock allows BitLocker-enabled systems with TPM+PIN and that meet the hardware requirements to boot into Windows without user intervention.","pos":[1291,1439]},{"content":"Network Unlock works in a similar fashion to the TPM+StartupKey at boot.","pos":[1440,1512]},{"content":"Rather than needing to read the StartupKey from USB media, however, the key for Network Unlock is composed from a key stored in the TPM and an encrypted network key that is sent to the server, decrypted and returned to the client in a secure session.","pos":[1513,1763]},{"content":"This topic contains:","pos":[1765,1785]},{"content":"Network Unlock core requirements","pos":[1792,1824]},{"content":"Network Unlock sequence","pos":[1854,1877]},{"content":"Configure Network Unlock","pos":[1908,1932]},{"content":"Create the certificate template for Network Unlock","pos":[1971,2021]},{"content":"Turning off Network Unlock","pos":[2050,2076]},{"content":"Update Network Unlock certificates","pos":[2111,2145]},{"content":"Troubleshoot Network Unlock","pos":[2171,2198]},{"content":"Configure Network Unlock on unsupported systems","pos":[2225,2272]},{"pos":[2345,2377],"content":"Network Unlock core requirements"},{"content":"Network Unlock must meet mandatory hardware and software requirements before the feature can automatically unlock domain joined systems.","pos":[2379,2515]},{"content":"These requirements include:","pos":[2516,2543]},{"content":"You must be running at least Windows 8 or Windows Server 2012.","pos":[2549,2611]},{"content":"Any supported operating system with UEFI DHCP drivers can be Network Unlock clients.","pos":[2616,2700]},{"content":"A server running the Windows Deployment Services (WDS) role on any supported server operating system.","pos":[2705,2806]},{"content":"BitLocker Network Unlock optional feature installed on any supported server operating system.","pos":[2811,2904]},{"content":"A DHCP server, separate from the WDS server.","pos":[2909,2953]},{"content":"Properly configured public/private key pairing.","pos":[2958,3005]},{"content":"Network Unlock Group Policy settings configured.","pos":[3010,3058]},{"content":"The network stack must be enabled to use the Network Unlock feature.","pos":[3060,3128]},{"content":"Equipment manufacturers deliver their products in various states and with different BIOS menus, so you need to confirm that the network stack has been enabled in the BIOS before starting the computer.","pos":[3129,3329]},{"pos":[3332,3481],"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  To properly support DHCP within UEFI, the UEFI-based system should be in native mode without a compatibility support module (CSM) enabled."},{"content":"For Network Unlock to work reliably on computers running Windows 8 and later, the first network adapter on the computer, usually the onboard adapter, must be configured to support DHCP and used for Network Unlock.","pos":[3483,3696]},{"content":"This is especially worth noting when you have multiple adapters, and you wish to configure one without DHCP, such as for a lights-out management protocol.","pos":[3697,3851]},{"content":"This configuration is necessary because Network Unlock will stop enumerating adapters when it reaches one with a DHCP port failure for any reason.","pos":[3852,3998]},{"content":"Thus, if the first enumerated adapter does not support DHCP, is not plugged into the network, or fails to report availability of the DHCP port for any reason, then Network Unlock will fail.","pos":[3999,4188]},{"content":"The Network Unlock server component installs on supported versions of Windows Server 2012 and later as a Windows feature using Server Manager or Windows PowerShell cmdlets.","pos":[4191,4363]},{"content":"The feature name is BitLocker Network Unlock in Server Manager and BitLocker-NetworkUnlock in Windows PowerShell.","pos":[4364,4477]},{"content":"This feature is a core requirement.","pos":[4478,4513]},{"content":"Network Unlock requires Windows Deployment Services (WDS) in the environment where the feature will be utilized.","pos":[4515,4627]},{"content":"Configuration of the WDS installation is not required; however, the WDS service needs to be running on the server.","pos":[4628,4742]},{"content":"The network key is stored on the system drive along with an AES 256 session key, and encrypted with the 2048-bit RSA public key of the unlock server's certificate.","pos":[4744,4907]},{"content":"The network key is decrypted with the help of a provider on a supported version of Windows Server running WDS, and returned encrypted with its corresponding session key.","pos":[4908,5077]},{"pos":[5124,5147],"content":"Network Unlock sequence"},{"content":"The unlock sequence starts on the client side, when the Windows boot manager detects the existence of Network Unlock protector.","pos":[5149,5276]},{"content":"It leverages the DHCP driver in UEFI to obtain an IP address for IPv4 and then broadcasts a vendor-specific DHCP request that contains the network key and a session key for the reply, all encrypted by the server's Network Unlock certificate, as described above.","pos":[5277,5538]},{"content":"The Network Unlock provider on the supported WDS server recognizes the vendor-specific request, decrypts it with the RSA private key, and returns the network key encrypted with the session key via its own vendor-specific DHCP reply.","pos":[5539,5771]},{"content":"On the server side, the WDS server role has an optional plugin component, like a PXE provider, which is what handles the incoming Network Unlock requests.","pos":[5773,5927]},{"content":"The provider can also be configured with subnet restrictions, which would require that the IP address provided by the client in the Network Unlock request belong to a permitted subnet in order to release the network key to the client.","pos":[5928,6162]},{"content":"In instances where the Network Unlock provider is unavailable, BitLocker fails over to the next available protector to unlock the drive.","pos":[6163,6299]},{"content":"In a typical configuration, this means the standard TPM+PIN unlock screen is presented to unlock the drive.","pos":[6300,6407]},{"content":"The server side configuration to enable Network Unlock also requires provisioning a 2048-bit RSA public/private key pair in the form of an X.509 certificate, and for the public key certificate to be distributed to the clients.","pos":[6409,6635]},{"content":"This certificate must be managed and deployed through the Group Policy editor directly on a domain controller with at least a Domain Functional Level of Windows Server 2012.","pos":[6636,6809]},{"content":"This certificate is the public key that encrypts the intermediate network key (which is one of the two secrets required to unlock the drive; the other secret is stored in the TPM).","pos":[6810,6990]},{"content":"bitlocker network unlock sequence","pos":[6994,7027]},{"content":"Phases in the Network Unlock process","pos":[7075,7111]},{"content":"The Windows boot manager detects that a Network Unlock protector exists in the BitLocker configuration.","pos":[7119,7222]},{"content":"The client computer uses its DHCP driver in the UEFI to obtain a valid IPv4 IP address.","pos":[7227,7314]},{"content":"The client computer broadcasts a vendor-specific DHCP request that contains the Network Key (a 256-bit intermediate key) and an AES-256 session key for the reply.","pos":[7319,7481]},{"content":"Both of these keys are encrypted using the 2048-bit RSA Public Key of the Network Unlock certificate from the WDS server.","pos":[7482,7603]},{"content":"The Network Unlock provider on the WDS server recognizes the vendor-specific request.","pos":[7608,7693]},{"content":"The provider decrypts it with the WDS server’s BitLocker Network Unlock certificate RSA private key.","pos":[7698,7798]},{"content":"The WDS provider then returns the network key encrypted with the session key using its own vendor-specific DHCP reply to the client computer.","pos":[7803,7944]},{"content":"This forms an intermediate key.","pos":[7945,7976]},{"content":"The returned intermediate key is then combined with another local 256-bit intermediate key that can only be decrypted by the TPM.","pos":[7981,8110]},{"content":"This combined key is used to create an AES-256 key that unlocks the volume.","pos":[8115,8190]},{"content":"Windows continues the boot sequence.","pos":[8195,8231]},{"pos":[8286,8310],"content":"Configure Network Unlock"},{"content":"The following steps allow an administrator to configure Network Unlock in a domain where the Domain Functional Level is at least Windows Server 2012.","pos":[8312,8461]},{"pos":[8500,8537],"content":"Step One: Install the WDS Server role"},{"content":"The BitLocker Network Unlock feature will install the WDS role if it is not already installed.","pos":[8539,8633]},{"content":"If you want to install it separately before you install BitLocker Network Unlock you can use Server Manager or Windows PowerShell.","pos":[8634,8764]},{"content":"To install the role using Server Manager, select the <bpt id=\"p1\">**</bpt>Windows Deployment Services<ept id=\"p1\">**</ept> role in Server Manager.","pos":[8765,8873]},{"content":"To install the role using Windows PowerShell, use the following command:","pos":[8875,8947]},{"content":"You must configure the WDS server so that it can communicate with DHCP (and optionally Active Directory Doman Services) and the client computer.","pos":[9003,9147]},{"content":"You can do using the WDS management tool, wdsmgmt.msc, which starts the Windows Deployment Services Configuration Wizard.","pos":[9148,9269]},{"pos":[9308,9352],"content":"Step Two: Confirm the WDS Service is running"},{"content":"To confirm the WDS service is running, use the Services Management Console or Windows PowerShell.","pos":[9354,9451]},{"content":"To confirm the service is running in Services Management Console, open the console using <bpt id=\"p1\">**</bpt>services.msc<ept id=\"p1\">**</ept> and check the status of the Windows Deployment Services service.","pos":[9452,9622]},{"content":"To confirm the service is running using Windows PowerShell, use the following command:","pos":[9624,9710]},{"pos":[9788,9834],"content":"Step Three: Install the Network Unlock feature"},{"content":"To install the Network Unlock feature, use Server Manager or Windows PowerShell.","pos":[9836,9916]},{"content":"To install the feature using Server Manager, select the <bpt id=\"p1\">**</bpt>BitLocker Network Unlock<ept id=\"p1\">**</ept> feature in the Server Manager console.","pos":[9917,10040]},{"content":"To install the feature using Windows PowerShell, use the following command:","pos":[10042,10117]},{"pos":[10219,10267],"content":"Step Four: Create the Network Unlock certificate"},{"content":"Network Unlock can use imported certificates from an existing PKI infrastructure, or you can use a self-signed certificate.","pos":[10269,10392]},{"content":"To enroll a certificate from an existing certification authority (CA), do the following:","pos":[10394,10482]},{"pos":[10488,10552],"content":"Open Certificate Manager on the WDS server using <bpt id=\"p1\">**</bpt>certmgr.msc<ept id=\"p1\">**</ept>"},{"content":"Under the Certificates - Current User item, right-click Personal","pos":[10557,10621]},{"pos":[10626,10676],"content":"Select All Tasks, then <bpt id=\"p1\">**</bpt>Request New Certificate<ept id=\"p1\">**</ept>"},{"pos":[10681,10741],"content":"Select <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept> when the Certificate Enrollment wizard opens"},{"content":"Select Active Directory Enrollment Policy","pos":[10746,10787]},{"content":"Choose the certificate template created for Network Unlock on the Domain controller and select <bpt id=\"p1\">**</bpt>Enroll<ept id=\"p1\">**</ept>.","pos":[10792,10898]},{"content":"When prompted for more information, add the following attribute to the certificate:","pos":[10899,10982]},{"content":"Select the <bpt id=\"p1\">**</bpt>Subject Name<ept id=\"p1\">**</ept> pane and provide a friendly name value.","pos":[10992,11059]},{"content":"It is suggested that this friendly name include information for the domain or organizational unit for the certificate.","pos":[11060,11178]},{"content":"For example \"BitLocker Network Unlock Certificate for Contoso domain\"","pos":[11179,11248]},{"content":"Create the certificate.","pos":[11254,11277]},{"content":"Ensure the certificate appears in the Personal folder.","pos":[11278,11332]},{"content":"Export the public key certificate for Network Unlock","pos":[11337,11389]},{"pos":[11399,11512],"content":"Create a .cer file by right-clicking the previously created certificate, choosing <bpt id=\"p1\">**</bpt>All Tasks<ept id=\"p1\">**</ept>, then <bpt id=\"p2\">**</bpt>Export<ept id=\"p2\">**</ept>."},{"pos":[11521,11566],"content":"Select <bpt id=\"p1\">**</bpt>No, do not export the private key<ept id=\"p1\">**</ept>."},{"pos":[11575,11660],"content":"Select <bpt id=\"p1\">**</bpt>DER encoded binary X.509<ept id=\"p1\">**</ept> and complete exporting the certificate to a file."},{"content":"Give the file a name such as BitLocker-NetworkUnlock.cer.","pos":[11669,11726]},{"content":"Export the public key with a private key for Network Unlock","pos":[11732,11791]},{"pos":[11801,11914],"content":"Create a .pfx file by right-clicking the previously created certificate, choosing <bpt id=\"p1\">**</bpt>All Tasks<ept id=\"p1\">**</ept>, then <bpt id=\"p2\">**</bpt>Export<ept id=\"p2\">**</ept>."},{"pos":[11923,11962],"content":"Select <bpt id=\"p1\">**</bpt>Yes, export the private key<ept id=\"p1\">**</ept>."},{"content":"Complete the wizard to create the .pfx file.","pos":[11971,12015]},{"content":"To create a self-signed certificate, do the following:","pos":[12017,12071]},{"content":"Create a text file with an .inf extension.","pos":[12077,12119]},{"content":"For example, notepad.exe BitLocker-NetworkUnlock.inf","pos":[12120,12172]},{"content":"Add the following contents to the previously created file:","pos":[12177,12235]},{"content":"Open an elevated command prompt and use the certreq tool to create a new certificate using the following command, specifying the full path to the file created previously, along with the file name:","pos":[12729,12925]},{"content":"Verify the previous command properly created the certificate by confirming the .cer file exists","pos":[13028,13123]},{"pos":[13128,13185],"content":"Launch the Certificate Manager by running <bpt id=\"p1\">**</bpt>certmgr.msc<ept id=\"p1\">**</ept>"},{"content":"Create a .pfx file by opening the <bpt id=\"p1\">**</bpt>Certificates – Current User<ph id=\"ph1\">\\\\</ph>Personal<ph id=\"ph2\">\\\\</ph>Certificates<ept id=\"p1\">**</ept> path in the navigation pane, right-clicking the previously imported certificate, selecting <bpt id=\"p2\">**</bpt>All Tasks<ept id=\"p2\">**</ept>, then <bpt id=\"p3\">**</bpt>Export<ept id=\"p3\">**</ept>.","pos":[13190,13402]},{"content":"Follow through the wizard to create the .pfx file.","pos":[13403,13453]},{"pos":[13493,13560],"content":"Step Five: Deploy the private key and certificate to the WDS server"},{"content":"With the certificate and key created, deploy them to the infrastructure to properly unlock systems.","pos":[13562,13661]},{"content":"To deploy the certificates, do the following:","pos":[13662,13707]},{"content":"On the WDS server, open a new MMC and add the certificates snap-in.","pos":[13713,13780]},{"content":"Select the computer account and local computer when given the options.","pos":[13781,13851]},{"pos":[13856,13985],"content":"Right-click the Certificates (Local Computer) - BitLocker Drive Encryption Network Unlock item, choose All Tasks, then <bpt id=\"p1\">**</bpt>Import<ept id=\"p1\">**</ept>"},{"pos":[13990,14064],"content":"In the <bpt id=\"p1\">**</bpt>File to Import<ept id=\"p1\">**</ept> dialog, choose the .pfx file created previously."},{"content":"Enter the password used to create the .pfx and complete the wizard.","pos":[14069,14136]},{"content":"Step Six: Configure Group Policy settings for Network Unlock","pos":[14142,14202]},{"content":"With certificate and key deployed to the WDS server for Network Unlock, the final step is to use Group Policy settings to deploy the public key certificate to computers that you want to be able to unlock using the Network Unlock key.","pos":[14204,14437]},{"content":"Group Policy settings for BitLocker can be found under <bpt id=\"p1\">**</bpt><ph id=\"ph1\">\\\\</ph>Computer Configuration<ph id=\"ph2\">\\\\</ph>Administrative Templates<ph id=\"ph3\">\\\\</ph>Windows Components<ph id=\"ph4\">\\\\</ph>BitLocker Drive Encryption<ept id=\"p1\">**</ept> using the Local Group Policy Editor or the Microsoft Management Console.","pos":[14438,14668]},{"content":"The following steps describe how to enable the Group Policy setting that is a requirement for configuring Network Unlock.","pos":[14670,14791]},{"content":"Open Group Policy Management Console (gpmc.msc)","pos":[14797,14844]},{"pos":[14849,14970],"content":"Enable the policy <bpt id=\"p1\">**</bpt>Require additional authentication at startup<ept id=\"p1\">**</ept> and select the <bpt id=\"p2\">**</bpt>Require startup PIN with TPM<ept id=\"p2\">**</ept> option"},{"content":"Turn on BitLocker with TPM+PIN protectors on all domain-joined computers","pos":[14975,15047]},{"content":"The following steps describe how to deploy the required Group Policy setting:","pos":[15049,15126]},{"pos":[15129,15280],"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  The Group Policy settings <bpt id=\"p2\">**</bpt>Allow network unlock at startup<ept id=\"p2\">**</ept> and <bpt id=\"p3\">**</bpt>Add Network Unlock Certificate<ept id=\"p3\">**</ept> were introduced in Windows Server 2012."},{"content":"Copy the .cer file created for Network Unlock to the domain controller","pos":[15287,15357]},{"content":"On the domain controller, launch Group Policy Management Console (gpmc.msc)","pos":[15362,15437]},{"pos":[15442,15562],"content":"Create a new Group Policy Object or modify an existing object to enable the <bpt id=\"p1\">**</bpt>Allow network unlock at startup<ept id=\"p1\">**</ept> setting."},{"content":"Deploy the public certificate to clients","pos":[15567,15607]},{"pos":[15617,15842],"content":"Within Group Policy Management Console, navigate to the following location: <bpt id=\"p1\">**</bpt>Computer Configuration<ph id=\"ph1\">\\\\</ph>Policies<ph id=\"ph2\">\\\\</ph>Windows Settings<ph id=\"ph3\">\\\\</ph>Security Settings<ph id=\"ph4\">\\\\</ph>Public Key Policies<ph id=\"ph5\">\\\\</ph>BitLocker Drive Encryption Network Unlock Certificate<ept id=\"p1\">**</ept>"},{"pos":[15851,15919],"content":"Right-click the folder and choose <bpt id=\"p1\">**</bpt>Add Network Unlock Certificate<ept id=\"p1\">**</ept>"},{"content":"Follow the wizard steps and import the .cer file that was copied earlier.","pos":[15928,16001]},{"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  Only one network unlock certificate can be available at a time.","pos":[16004,16078]},{"content":"If a new certificate is required, delete the current certificate before deploying a new one.","pos":[16079,16171]},{"content":"The Network Unlock certificate is located in the <bpt id=\"p1\">**</bpt>HKEY<ph id=\"ph1\">\\_</ph>LOCAL<ph id=\"ph2\">\\_</ph>MACHINE<ph id=\"ph3\">\\\\</ph>Software<ph id=\"ph4\">\\\\</ph>Policies<ph id=\"ph5\">\\\\</ph>Microsoft<ph id=\"ph6\">\\\\</ph>SystemCertificates<ph id=\"ph7\">\\\\</ph>FVE<ph id=\"ph8\">\\_</ph>NKP<ept id=\"p1\">**</ept> key on the client computer.","pos":[16172,16334]},{"pos":[16376,16425],"content":"Step Seven: Require TPM+PIN protectors at startup"},{"content":"An additional step is for enterprises to use TPM+PIN protectors for an extra level of security.","pos":[16427,16522]},{"content":"To require TPM+PIN protectors in an environment, do the following:","pos":[16523,16589]},{"content":"Open Group Policy Management Console (gpmc.msc)","pos":[16595,16642]},{"pos":[16647,16768],"content":"Enable the policy <bpt id=\"p1\">**</bpt>Require additional authentication at startup<ept id=\"p1\">**</ept> and select the <bpt id=\"p2\">**</bpt>Require startup PIN with TPM<ept id=\"p2\">**</ept> option"},{"content":"Turn on BitLocker with TPM+PIN protectors on all domain-joined computers","pos":[16773,16845]},{"pos":[16891,16941],"content":"Create the certificate template for Network Unlock"},{"content":"The following steps detail how to create a certificate template for use with BitLocker Network Unlock.","pos":[16943,17045]},{"content":"A properly configured Active Directory Services Certification Authority can use this certificate to create and issue Network Unlock certificates.","pos":[17046,17191]},{"content":"Open the Certificates Template snap-in (certtmpl.msc).","pos":[17197,17251]},{"content":"Locate the User template.","pos":[17256,17281]},{"content":"Right-click the template name and select <bpt id=\"p1\">**</bpt>Duplicate Template<ept id=\"p1\">**</ept>","pos":[17282,17345]},{"content":"On the <bpt id=\"p1\">**</bpt>Compatibility<ept id=\"p1\">**</ept> tab, change the <bpt id=\"p2\">**</bpt>Certification Authority<ept id=\"p2\">**</ept> and <bpt id=\"p3\">**</bpt>Certificate recipient<ept id=\"p3\">**</ept> fields to Windows Server 2012 and Windows 8respectively.","pos":[17350,17505]},{"content":"Ensure the <bpt id=\"p1\">**</bpt>Show resulting changes<ept id=\"p1\">**</ept> dialog box is selected.","pos":[17506,17567]},{"content":"Select the <bpt id=\"p1\">**</bpt>General<ept id=\"p1\">**</ept> tab of the template.","pos":[17572,17615]},{"content":"The <bpt id=\"p1\">**</bpt>Template display name<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>Template name<ept id=\"p2\">**</ept> should clearly identify that the template will be used for Network Unlock.","pos":[17616,17742]},{"content":"Clear the checkbox for the <bpt id=\"p1\">**</bpt>Publish certificate in Active Directory<ept id=\"p1\">**</ept> option.","pos":[17743,17821]},{"content":"Select the <bpt id=\"p1\">**</bpt>Request Handling<ept id=\"p1\">**</ept> tab.","pos":[17826,17862]},{"content":"Select <bpt id=\"p1\">**</bpt>Encryption<ept id=\"p1\">**</ept> from the <bpt id=\"p2\">**</bpt>Purpose<ept id=\"p2\">**</ept> drop down menu.","pos":[17863,17921]},{"content":"Ensure the <bpt id=\"p1\">**</bpt>Allow private key to be exported<ept id=\"p1\">**</ept> option is selected.","pos":[17922,17989]},{"content":"Select the <bpt id=\"p1\">**</bpt>Cryptography<ept id=\"p1\">**</ept> tab.","pos":[17994,18026]},{"content":"Set the <bpt id=\"p1\">**</bpt>Minimum key size<ept id=\"p1\">**</ept> to 2048.","pos":[18027,18064]},{"content":"(Any Microsoft cryptographic provider that supports RSA can be used for this template, but for simplicity and forward compatibility we recommend using the <bpt id=\"p1\">**</bpt>Microsoft Software Key Storage Provider<ept id=\"p1\">**</ept>.)","pos":[18065,18265]},{"pos":[18270,18470],"content":"Select the <bpt id=\"p1\">**</bpt>Requests must use one of the following providers<ept id=\"p1\">**</ept> option and clear all options except for the cryptography provider you selected, such as the <bpt id=\"p2\">**</bpt>Microsoft Software Key Storage Provider<ept id=\"p2\">**</ept>."},{"content":"Select the <bpt id=\"p1\">**</bpt>Subject Name<ept id=\"p1\">**</ept> tab.","pos":[18475,18507]},{"content":"Select <bpt id=\"p1\">**</bpt>Supply in the request<ept id=\"p1\">**</ept>.","pos":[18508,18541]},{"content":"Select <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept> if the certificate templates pop-up dialog appears.","pos":[18542,18607]},{"content":"Select the <bpt id=\"p1\">**</bpt>Issuance Requirements<ept id=\"p1\">**</ept> tab.","pos":[18612,18653]},{"content":"Select both <bpt id=\"p1\">**</bpt>CA certificate manager approval<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>Valid existing certificate<ept id=\"p2\">**</ept> options.","pos":[18654,18745]},{"content":"Select the <bpt id=\"p1\">**</bpt>Extensions<ept id=\"p1\">**</ept> tab.","pos":[18750,18780]},{"content":"Select <bpt id=\"p1\">**</bpt>Application Policies<ept id=\"p1\">**</ept> and choose <bpt id=\"p2\">**</bpt>Edit…<ept id=\"p2\">**</ept>.","pos":[18781,18834]},{"pos":[18839,19011],"content":"In the <bpt id=\"p1\">**</bpt>Edit Application Policies Extension<ept id=\"p1\">**</ept> options dialog box, select <bpt id=\"p2\">**</bpt>Client Authentication<ept id=\"p2\">**</ept>, <bpt id=\"p3\">**</bpt>Encrypting File System<ept id=\"p3\">**</ept>, <bpt id=\"p4\">**</bpt>and Secure Email<ept id=\"p4\">**</ept> and choose <bpt id=\"p5\">**</bpt>Remove<ept id=\"p5\">**</ept>."},{"pos":[19016,19090],"content":"On the <bpt id=\"p1\">**</bpt>Edit Application Policies Extension<ept id=\"p1\">**</ept> dialog box, select <bpt id=\"p2\">**</bpt>Add<ept id=\"p2\">**</ept>."},{"content":"On the <bpt id=\"p1\">**</bpt>Add Application Policy<ept id=\"p1\">**</ept> dialog box, select <bpt id=\"p2\">**</bpt>New<ept id=\"p2\">**</ept>.","pos":[19095,19156]},{"content":"In the <bpt id=\"p1\">**</bpt>New Application Policy<ept id=\"p1\">**</ept> dialog box enter the following information in the space provided and then click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept> to create the BitLocker Network Unlock application policy:","pos":[19157,19336]},{"pos":[19346,19384],"content":"<bpt id=\"p1\">**</bpt>Name:<ept id=\"p1\">**</ept> <bpt id=\"p2\">**</bpt>BitLocker Network Unlock<ept id=\"p2\">**</ept>"},{"pos":[19393,19442],"content":"<bpt id=\"p1\">**</bpt>Object Identifier:<ept id=\"p1\">**</ept> <bpt id=\"p2\">**</bpt>1.3.6.1.4.1.311.67.1.1<ept id=\"p2\">**</ept>"},{"pos":[19448,19538],"content":"Select the newly created <bpt id=\"p1\">**</bpt>BitLocker Network Unlock<ept id=\"p1\">**</ept> application policy and select <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>"},{"content":"With the <bpt id=\"p1\">**</bpt>Extensions<ept id=\"p1\">**</ept> tab still open, select the <bpt id=\"p2\">**</bpt>Edit Key Usage Extension<ept id=\"p2\">**</ept> dialog, select the <bpt id=\"p3\">**</bpt>Allow key exchange only with key encryption (key encipherment)<ept id=\"p3\">**</ept> option.","pos":[19543,19716]},{"content":"Select the <bpt id=\"p1\">**</bpt>Make this extension critical<ept id=\"p1\">**</ept> option.","pos":[19717,19768]},{"content":"Select the <bpt id=\"p1\">**</bpt>Security<ept id=\"p1\">**</ept> tab.","pos":[19773,19801]},{"content":"Confirm that the <bpt id=\"p1\">**</bpt>Domain Admins<ept id=\"p1\">**</ept> group has been granted <bpt id=\"p2\">**</bpt>Enroll<ept id=\"p2\">**</ept> permission","pos":[19802,19881]},{"pos":[19886,19942],"content":"Select <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept> to complete configuration of the template."},{"content":"To add the Network Unlock template to the Certification Authority, open the Certification Authority snap-in (certsrv.msc).","pos":[19944,20066]},{"content":"Right-click the <bpt id=\"p1\">**</bpt>Certificate Templates<ept id=\"p1\">**</ept> item and choose <bpt id=\"p2\">**</bpt>New, Certificate Template to issue<ept id=\"p2\">**</ept>.","pos":[20067,20164]},{"content":"Select the previously created BitLocker Network Unlock certificate.","pos":[20165,20232]},{"content":"After adding the Network Unlock template to the Certification Authority, this certificate can be used to configure BitLocker Network Unlock.","pos":[20234,20374]},{"content":"Subnet policy configuration files on WDS Server (Optional)","pos":[20380,20438]},{"content":"By default, all clients with the correct Network Unlock Certificate and valid Network Unlock protectors that have wired access to a Network Unlock-enabled WDS server via DHCP are unlocked by the server.","pos":[20440,20642]},{"content":"A subnet policy configuration file on the WDS server can be created to limit which subnet(s) Network Unlock clients can use to unlock.","pos":[20643,20777]},{"content":"The configuration file, called bde-network-unlock.ini, must be located in the same directory as the Network Unlock provider DLL and it applies to both IPv6 and IPv4 DHCP implementations.","pos":[20779,20965]},{"content":"If the subnet configuration policy becomes corrupted, the provider will fail and stop responding to requests.","pos":[20966,21075]},{"content":"The subnet policy configuration file must use a “<ph id=\"ph1\">\\[</ph>SUBNETS<ph id=\"ph2\">\\]</ph>” section to identify the specific subnets.","pos":[21077,21180]},{"content":"The named subnets may then be used to specify restrictions in certificate subsections.","pos":[21181,21267]},{"content":"Subnets are defined as simple name-value pairs, in the common INI format, where each subnet has its own line, with the name on the left of the equals sign, and the subnet identified on the right of the equal sign as a Classless Inter-Domain Routing (CIDR) address or range.","pos":[21268,21541]},{"content":"The key word “ENABLED” is disallowed for subnet names.","pos":[21542,21596]},{"content":"To disallow the use of a certificate altogether, its subnet list may contain the line “DISABLED\".","pos":[23834,23931]},{"pos":[23983,24009],"content":"Turning off Network Unlock"},{"content":"To turn off the unlock server, the PXE provider can be unregistered from the WDS server or uninstalled altogether.","pos":[24011,24125]},{"content":"However, to stop clients from creating Network Unlock protectors the <bpt id=\"p1\">**</bpt>Allow Network Unlock at startup<ept id=\"p1\">**</ept> Group Policy setting should be disabled.","pos":[24126,24271]},{"content":"When this policy setting is updated to disabled on client computers any Network Unlock key protectors on the computer will be deleted.","pos":[24272,24406]},{"content":"Alternatively, the BitLocker Network Unlock certificate policy can be deleted on the domain controller to accomplish the same task for an entire domain.","pos":[24407,24559]},{"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  Removing the FVENKP certificate store that contains the Network Unlock certificate and key on the WDS server will also effectively disable the server’s ability to respond to unlock requests for that certificate.","pos":[24562,24784]},{"content":"However, this is seen as an error condition and is not a supported or recommended method for turning off the Network Unlock server.","pos":[24785,24916]},{"pos":[24960,24994],"content":"Update Network Unlock certificates"},{"content":"To update the certificates used by Network Unlock, administrators need to import or generate the new certificate for the server and then update the Network Unlock certificate Group Policy setting on the domain controller.","pos":[24996,25217]},{"pos":[25260,25287],"content":"Troubleshoot Network Unlock"},{"content":"Troubleshooting Network Unlock issues begins by verifying the environment.","pos":[25289,25363]},{"content":"Many times, a small configuration issue will be the root cause of the failure.","pos":[25364,25442]},{"content":"Items to verify include:","pos":[25443,25467]},{"content":"Verify client hardware is UEFI-based and is on firmware version is 2.3.1 and that the UEFI firmware is in native mode without a Compatibility Support Module (CSM) for BIOS mode enabled.","pos":[25473,25658]},{"content":"Do this by checking that the firmware does not have an option enabled such as \"Legacy mode\" or \"Compatibility mode\" or that the firmware does not appear to be in a BIOS-like mode.","pos":[25659,25838]},{"content":"All required roles and services are installed and started","pos":[25843,25900]},{"content":"Public and private certificates have been published and are in the proper certificate containers.","pos":[25905,26002]},{"content":"The presence of the Network Unlock certificate can be verified in the Microsoft Management Console (MMC.exe) on the WDS server with the certificate snap-ins for the local computer enabled.","pos":[26003,26191]},{"content":"The client certificate can be verified by checking the registry key <bpt id=\"p1\">**</bpt>HKEY<ph id=\"ph1\">\\_</ph>LOCAL<ph id=\"ph2\">\\_</ph>MACHINE<ph id=\"ph3\">\\\\</ph>Software<ph id=\"ph4\">\\\\</ph>Policies<ph id=\"ph5\">\\\\</ph>Microsoft<ph id=\"ph6\">\\\\</ph>SystemCertificates<ph id=\"ph7\">\\\\</ph>FVE<ph id=\"ph8\">\\_</ph>NKP<ept id=\"p1\">**</ept> on the client computer.","pos":[26192,26369]},{"content":"Group policy for Network Unlock is enabled and linked to the appropriate domains","pos":[26374,26454]},{"content":"Verify group policy is reaching the clients properly.","pos":[26459,26512]},{"content":"This can be done using the GPRESULT.exe or RSOP.msc utilities.","pos":[26513,26575]},{"content":"Verify the <bpt id=\"p1\">**</bpt>Network (Certificate Based)<ept id=\"p1\">**</ept> protector is listed on the client.","pos":[26580,26657]},{"content":"This can be done using either manage-bde or Windows PowerShell cmdlets.","pos":[26658,26729]},{"content":"For example the following command will list the key protectors currently configured on the C: drive of the lcoal computer:","pos":[26730,26852]},{"pos":[26913,27064],"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  Use the output of manage-bde along with the WDS debug log to determine if the proper certificate thumbprint is being used for Network Unlock"},{"content":"Files to gather when troubleshooting BitLocker Network Unlock include:","pos":[27067,27137]},{"content":"The Windows event logs.","pos":[27143,27166]},{"content":"Specifically the BitLocker event logs and the Microsoft-Windows-Deployment-Services-Diagnostics-Debug log","pos":[27167,27272]},{"content":"Debug logging is turned off by default for the WDS server role, so you will need to enable it first.","pos":[27278,27378]},{"content":"You can use either of the following two methods to turn on WDS debug logging.","pos":[27379,27456]},{"content":"Start an elevated command prompt and run the following command:","pos":[27466,27529]},{"content":"Open Event Viewer on the WDS server.","pos":[27654,27690]},{"pos":[27700,27868],"content":"In the left pane, click <bpt id=\"p1\">**</bpt>Applications and Services Logs<ept id=\"p1\">**</ept>, click <bpt id=\"p2\">**</bpt>Microsoft<ept id=\"p2\">**</ept>, click <bpt id=\"p3\">**</bpt>Windows<ept id=\"p3\">**</ept>, click <bpt id=\"p4\">**</bpt>Deployment-Services-Diagnostics<ept id=\"p4\">**</ept>, and then click <bpt id=\"p5\">**</bpt>Debug<ept id=\"p5\">**</ept>."},{"pos":[27878,27918],"content":"In the right pane, click <bpt id=\"p1\">**</bpt>Enable Log<ept id=\"p1\">**</ept>."},{"content":"The DHCP subnet configuration file (if one exists).","pos":[27924,27975]},{"pos":[27980,28145],"content":"The output of the BitLocker status on the volume, this can be gathered into a text file using <bpt id=\"p1\">**</bpt>manage-bde -status<ept id=\"p1\">**</ept> or <bpt id=\"p2\">**</bpt>Get-BitLockerVolume<ept id=\"p2\">**</ept> in Windows PowerShell"},{"content":"Network Monitor capture on the server hosting the WDS role, filtered by client IP address","pos":[28150,28239]},{"pos":[28288,28354],"content":"Configure Network Unlock Group Policy settings on earlier versions"},{"content":"Network Unlock and the accompanying Group Policy settings were introduced in Windows Server 2012 but can be deployed using operating systems running Windows Server 2008 R2 and Windows Server 2008.","pos":[28356,28552]},{"content":"Requirements","pos":[28555,28567]},{"pos":[28575,28719],"content":"The server hosting WDS must be running any of the server operating systems designated in the <bpt id=\"p1\">**</bpt>Applies To<ept id=\"p1\">**</ept> list at the beginning of this topic."},{"pos":[28724,28862],"content":"Client computers must be running any of the client operating systems designated in the <bpt id=\"p1\">**</bpt>Applies To<ept id=\"p1\">**</ept> list at the beginning of this topic."},{"content":"The following steps can be used to configure Network Unlock on these older systems.","pos":[28864,28947]},{"content":"Step One: Install the WDS Server role","pos":[28954,28991]},{"content":"Step Two: Confirm the WDS Service is running","pos":[29013,29057]},{"content":"Step Three: Install the Network Unlock feature","pos":[29079,29125]},{"content":"Step Four: Create the Network Unlock certificate","pos":[29149,29197]},{"content":"Step Five: Deploy the private key and certificate to the WDS server","pos":[29220,29287]},{"content":"Step Six: Configure registry settings for Network Unlock","pos":[29311,29367]},{"pos":[29375,30284],"content":"Apply the registry settings by running the following certutil script on each computer running any of the client operating systems designated in the **Applies To** list at the beginning of this topic.\n    certutil -f -grouppolicy -addstore FVE_NKP BitLocker-NetworkUnlock.cer\n    reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v OSManageNKP /t REG_DWORD /d 1 /f\n    reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UseAdvancedStartup /t REG_DWORD /d 1 /f\n    reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UsePIN /t REG_DWORD /d 2 /f\n    reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UseTPMPIN /t REG_DWORD /d 2 /f\n    reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UseTPM /t REG_DWORD /d 2 /f\n    reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UseTPMKey /t REG_DWORD /d 2 /f\n    reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UseTPMKeyPIN /t REG_DWORD /d 2 /f","leadings":["","    ","    ","    ","    ","    ","    ","    ","    "],"nodes":[{"content":"Apply the registry settings by running the following certutil script on each computer running any of the client operating systems designated in the <bpt id=\"p1\">**</bpt>Applies To<ept id=\"p1\">**</ept> list at the beginning of this topic.","pos":[0,199]},{"content":"certutil -f -grouppolicy -addstore FVE_NKP BitLocker-NetworkUnlock.cer reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v OSManageNKP /t REG_DWORD /d 1 /f reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UseAdvancedStartup /t REG_DWORD /d 1 /f reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UsePIN /t REG_DWORD /d 2 /f reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UseTPMPIN /t REG_DWORD /d 2 /f reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UseTPM /t REG_DWORD /d 2 /f reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UseTPMKey /t REG_DWORD /d 2 /f reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UseTPMKeyPIN /t REG_DWORD /d 2 /f","pos":[204,877]}]},{"content":"Create the Network Unlock certificate","pos":[30291,30328]},{"content":"Deploy the private key and certificate to the WDS server","pos":[30351,30407]},{"content":"Create the certificate template for Network Unlock","pos":[30430,30480]},{"content":"Require TPM+PIN protectors at startup","pos":[30509,30546]},{"content":"See also","pos":[30569,30577]},{"content":"BitLocker overview","pos":[30584,30602]},{"content":"BitLocker frequently asked questions (FAQ)","pos":[30632,30674]},{"content":"Prepare your organization for BitLocker: Planning and policies","pos":[30722,30784]}],"content":"---\ntitle: BitLocker How to enable Network Unlock (Windows 10)\ndescription: This topic for the IT professional describes how BitLocker Network Unlock works and how to configure it.\nms.assetid: be45bc28-47db-4931-bfec-3c348151d2e9\nms.prod: w10\nms.mktglfcycl: deploy\nms.sitesec: library\nms.pagetype: security\nauthor: brianlic-msft\n---\n\n# BitLocker: How to enable Network Unlock\n\n**Applies to**\n-   Windows 10\n\nThis topic for the IT professional describes how BitLocker Network Unlock works and how to configure it.\n\nNetwork Unlock was introduced in Windows 8 and Windows Server 2012 as a BitLocker protector option for operating system volumes. Network Unlock enables easier management for BitLocker enabled desktops and servers in a domain environment by providing automatic unlock of operating system volumes at system reboot when connected to a wired corporate network. This feature requires the client hardware to have a DHCP driver implemented in its UEFI firmware.\nWithout Network Unlock, operating system volumes protected by TPM+PIN protectors require a PIN to be entered when a computer reboots or resumes from hibernation (for example, by Wake on LAN). This can make it difficult to enterprises to roll out software patches to unattended desktops and remotely administered servers.\n\nNetwork Unlock allows BitLocker-enabled systems with TPM+PIN and that meet the hardware requirements to boot into Windows without user intervention. Network Unlock works in a similar fashion to the TPM+StartupKey at boot. Rather than needing to read the StartupKey from USB media, however, the key for Network Unlock is composed from a key stored in the TPM and an encrypted network key that is sent to the server, decrypted and returned to the client in a secure session.\n\nThis topic contains:\n\n-   [Network Unlock core requirements](#bkmk-nunlockcorereqs)\n-   [Network Unlock sequence](#bkmk-networkunlockseq)\n-   [Configure Network Unlock](#bkmk-configuringnetworkunlock)\n-   [Create the certificate template for Network Unlock](#bkmk-createcerttmpl)\n-   [Turning off Network Unlock](#bkmk-turnoffnetworkunlock)\n-   [Update Network Unlock certificates](#bkmk-updatecerts)\n-   [Troubleshoot Network Unlock](#bkmk-troubleshoot)\n-   [Configure Network Unlock on unsupported systems](#bkmk-unsupportedsystems)\n\n## <a href=\"\" id=\"bkmk-nunlockcorereqs\"></a>Network Unlock core requirements\n\nNetwork Unlock must meet mandatory hardware and software requirements before the feature can automatically unlock domain joined systems. These requirements include:\n\n-   You must be running at least Windows 8 or Windows Server 2012.\n-   Any supported operating system with UEFI DHCP drivers can be Network Unlock clients.\n-   A server running the Windows Deployment Services (WDS) role on any supported server operating system.\n-   BitLocker Network Unlock optional feature installed on any supported server operating system.\n-   A DHCP server, separate from the WDS server.\n-   Properly configured public/private key pairing.\n-   Network Unlock Group Policy settings configured.\n\nThe network stack must be enabled to use the Network Unlock feature. Equipment manufacturers deliver their products in various states and with different BIOS menus, so you need to confirm that the network stack has been enabled in the BIOS before starting the computer.\n\n>**Note:**  To properly support DHCP within UEFI, the UEFI-based system should be in native mode without a compatibility support module (CSM) enabled.\n\nFor Network Unlock to work reliably on computers running Windows 8 and later, the first network adapter on the computer, usually the onboard adapter, must be configured to support DHCP and used for Network Unlock. This is especially worth noting when you have multiple adapters, and you wish to configure one without DHCP, such as for a lights-out management protocol. This configuration is necessary because Network Unlock will stop enumerating adapters when it reaches one with a DHCP port failure for any reason. Thus, if the first enumerated adapter does not support DHCP, is not plugged into the network, or fails to report availability of the DHCP port for any reason, then Network Unlock will fail.\n \nThe Network Unlock server component installs on supported versions of Windows Server 2012 and later as a Windows feature using Server Manager or Windows PowerShell cmdlets. The feature name is BitLocker Network Unlock in Server Manager and BitLocker-NetworkUnlock in Windows PowerShell. This feature is a core requirement.\n\nNetwork Unlock requires Windows Deployment Services (WDS) in the environment where the feature will be utilized. Configuration of the WDS installation is not required; however, the WDS service needs to be running on the server.\n\nThe network key is stored on the system drive along with an AES 256 session key, and encrypted with the 2048-bit RSA public key of the unlock server's certificate. The network key is decrypted with the help of a provider on a supported version of Windows Server running WDS, and returned encrypted with its corresponding session key.\n\n## <a href=\"\" id=\"bkmk-networkunlockseq\"></a>Network Unlock sequence\n\nThe unlock sequence starts on the client side, when the Windows boot manager detects the existence of Network Unlock protector. It leverages the DHCP driver in UEFI to obtain an IP address for IPv4 and then broadcasts a vendor-specific DHCP request that contains the network key and a session key for the reply, all encrypted by the server's Network Unlock certificate, as described above. The Network Unlock provider on the supported WDS server recognizes the vendor-specific request, decrypts it with the RSA private key, and returns the network key encrypted with the session key via its own vendor-specific DHCP reply.\n\nOn the server side, the WDS server role has an optional plugin component, like a PXE provider, which is what handles the incoming Network Unlock requests. The provider can also be configured with subnet restrictions, which would require that the IP address provided by the client in the Network Unlock request belong to a permitted subnet in order to release the network key to the client. In instances where the Network Unlock provider is unavailable, BitLocker fails over to the next available protector to unlock the drive. In a typical configuration, this means the standard TPM+PIN unlock screen is presented to unlock the drive.\n\nThe server side configuration to enable Network Unlock also requires provisioning a 2048-bit RSA public/private key pair in the form of an X.509 certificate, and for the public key certificate to be distributed to the clients. This certificate must be managed and deployed through the Group Policy editor directly on a domain controller with at least a Domain Functional Level of Windows Server 2012. This certificate is the public key that encrypts the intermediate network key (which is one of the two secrets required to unlock the drive; the other secret is stored in the TPM).\n\n![bitlocker network unlock sequence](images/bitlockernetworkunlocksequence.png)\n\n**Phases in the Network Unlock process**\n\n1.  The Windows boot manager detects that a Network Unlock protector exists in the BitLocker configuration.\n2.  The client computer uses its DHCP driver in the UEFI to obtain a valid IPv4 IP address.\n3.  The client computer broadcasts a vendor-specific DHCP request that contains the Network Key (a 256-bit intermediate key) and an AES-256 session key for the reply. Both of these keys are encrypted using the 2048-bit RSA Public Key of the Network Unlock certificate from the WDS server.\n4.  The Network Unlock provider on the WDS server recognizes the vendor-specific request.\n5.  The provider decrypts it with the WDS server’s BitLocker Network Unlock certificate RSA private key.\n6.  The WDS provider then returns the network key encrypted with the session key using its own vendor-specific DHCP reply to the client computer. This forms an intermediate key.\n7.  The returned intermediate key is then combined with another local 256-bit intermediate key that can only be decrypted by the TPM.\n8.  This combined key is used to create an AES-256 key that unlocks the volume.\n9.  Windows continues the boot sequence.\n\n## <a href=\"\" id=\"bkmk-configuringnetworkunlock\"></a>Configure Network Unlock\n\nThe following steps allow an administrator to configure Network Unlock in a domain where the Domain Functional Level is at least Windows Server 2012.\n\n### <a href=\"\" id=\"bkmk-stepone\"></a>Step One: Install the WDS Server role\n\nThe BitLocker Network Unlock feature will install the WDS role if it is not already installed. If you want to install it separately before you install BitLocker Network Unlock you can use Server Manager or Windows PowerShell. To install the role using Server Manager, select the **Windows Deployment Services** role in Server Manager.\n\nTo install the role using Windows PowerShell, use the following command:\n\n``` syntax\nInstall-WindowsFeature WDS-Deployment\n```\n\nYou must configure the WDS server so that it can communicate with DHCP (and optionally Active Directory Doman Services) and the client computer. You can do using the WDS management tool, wdsmgmt.msc, which starts the Windows Deployment Services Configuration Wizard.\n\n### <a href=\"\" id=\"bkmk-steptwo\"></a>Step Two: Confirm the WDS Service is running\n\nTo confirm the WDS service is running, use the Services Management Console or Windows PowerShell. To confirm the service is running in Services Management Console, open the console using **services.msc** and check the status of the Windows Deployment Services service.\n\nTo confirm the service is running using Windows PowerShell, use the following command:\n\n``` syntax\nGet-Service WDSServer\n```\n### <a href=\"\" id=\"bkmk-stepthree\"></a>Step Three: Install the Network Unlock feature\n\nTo install the Network Unlock feature, use Server Manager or Windows PowerShell. To install the feature using Server Manager, select the **BitLocker Network Unlock** feature in the Server Manager console.\n\nTo install the feature using Windows PowerShell, use the following command:\n\n``` syntax\nInstall-WindowsFeature BitLocker-NetworkUnlock\n```\n### <a href=\"\" id=\"bkmk-stepfour\"></a>Step Four: Create the Network Unlock certificate\n\nNetwork Unlock can use imported certificates from an existing PKI infrastructure, or you can use a self-signed certificate.\n\nTo enroll a certificate from an existing certification authority (CA), do the following:\n\n1.  Open Certificate Manager on the WDS server using **certmgr.msc**\n2.  Under the Certificates - Current User item, right-click Personal\n3.  Select All Tasks, then **Request New Certificate**\n4.  Select **Next** when the Certificate Enrollment wizard opens\n5.  Select Active Directory Enrollment Policy\n6.  Choose the certificate template created for Network Unlock on the Domain controller and select **Enroll**. When prompted for more information, add the following attribute to the certificate:\n\n    -   Select the **Subject Name** pane and provide a friendly name value. It is suggested that this friendly name include information for the domain or organizational unit for the certificate. For example \"BitLocker Network Unlock Certificate for Contoso domain\"\n\n7.  Create the certificate. Ensure the certificate appears in the Personal folder.\n8.  Export the public key certificate for Network Unlock\n\n    1.  Create a .cer file by right-clicking the previously created certificate, choosing **All Tasks**, then **Export**.\n    2.  Select **No, do not export the private key**.\n    3.  Select **DER encoded binary X.509** and complete exporting the certificate to a file.\n    4.  Give the file a name such as BitLocker-NetworkUnlock.cer.\n\n9.  Export the public key with a private key for Network Unlock\n\n    1.  Create a .pfx file by right-clicking the previously created certificate, choosing **All Tasks**, then **Export**.\n    2.  Select **Yes, export the private key**.\n    3.  Complete the wizard to create the .pfx file.\n\nTo create a self-signed certificate, do the following:\n\n1.  Create a text file with an .inf extension. For example, notepad.exe BitLocker-NetworkUnlock.inf\n2.  Add the following contents to the previously created file:\n\n    ``` syntax\n    [NewRequest]\n    Subject=\"CN=BitLocker Network Unlock certificate\"\n    Exportable=true\n    RequestType=Cert\n    KeyUsage=\"CERT_KEY_ENCIPHERMENT_KEY_USAGE\"\n    KeyUsageProperty=\"NCRYPT_ALLOW_DECRYPT_FLAG\"\n    KeyLength=2048\n    Keyspec=\"AT_KEYEXCHANGE\"\n    SMIME=FALSE\n    HashAlgorithm=sha512\n    [Extensions]\n    1.3.6.1.4.1.311.21.10 = \"{text}\"\n    _continue_ = \"OID=1.3.6.1.4.1.311.67.1.1\"\n    2.5.29.37 = \"{text}\"\n    _continue_ = \"1.3.6.1.4.1.311.67.1.1\"\n    ```\n\n3.  Open an elevated command prompt and use the certreq tool to create a new certificate using the following command, specifying the full path to the file created previously, along with the file name:\n\n    ``` syntax\n    certreq -new BitLocker-NetworkUnlock.inf BitLocker-NetworkUnlock.cer\n    ```\n\n4.  Verify the previous command properly created the certificate by confirming the .cer file exists\n5.  Launch the Certificate Manager by running **certmgr.msc**\n6.  Create a .pfx file by opening the **Certificates – Current User\\\\Personal\\\\Certificates** path in the navigation pane, right-clicking the previously imported certificate, selecting **All Tasks**, then **Export**. Follow through the wizard to create the .pfx file.\n\n### <a href=\"\" id=\"bkmk-stepfive\"></a>Step Five: Deploy the private key and certificate to the WDS server\n\nWith the certificate and key created, deploy them to the infrastructure to properly unlock systems. To deploy the certificates, do the following:\n\n1.  On the WDS server, open a new MMC and add the certificates snap-in. Select the computer account and local computer when given the options.\n2.  Right-click the Certificates (Local Computer) - BitLocker Drive Encryption Network Unlock item, choose All Tasks, then **Import**\n3.  In the **File to Import** dialog, choose the .pfx file created previously.\n4.  Enter the password used to create the .pfx and complete the wizard.\n\n### Step Six: Configure Group Policy settings for Network Unlock\n\nWith certificate and key deployed to the WDS server for Network Unlock, the final step is to use Group Policy settings to deploy the public key certificate to computers that you want to be able to unlock using the Network Unlock key. Group Policy settings for BitLocker can be found under **\\\\Computer Configuration\\\\Administrative Templates\\\\Windows Components\\\\BitLocker Drive Encryption** using the Local Group Policy Editor or the Microsoft Management Console.\n\nThe following steps describe how to enable the Group Policy setting that is a requirement for configuring Network Unlock.\n\n1.  Open Group Policy Management Console (gpmc.msc)\n2.  Enable the policy **Require additional authentication at startup** and select the **Require startup PIN with TPM** option\n3.  Turn on BitLocker with TPM+PIN protectors on all domain-joined computers\n\nThe following steps describe how to deploy the required Group Policy setting:\n\n>**Note:**  The Group Policy settings **Allow network unlock at startup** and **Add Network Unlock Certificate** were introduced in Windows Server 2012.\n \n1.  Copy the .cer file created for Network Unlock to the domain controller\n2.  On the domain controller, launch Group Policy Management Console (gpmc.msc)\n3.  Create a new Group Policy Object or modify an existing object to enable the **Allow network unlock at startup** setting.\n4.  Deploy the public certificate to clients\n\n    1.  Within Group Policy Management Console, navigate to the following location: **Computer Configuration\\\\Policies\\\\Windows Settings\\\\Security Settings\\\\Public Key Policies\\\\BitLocker Drive Encryption Network Unlock Certificate**\n    2.  Right-click the folder and choose **Add Network Unlock Certificate**\n    3.  Follow the wizard steps and import the .cer file that was copied earlier.\n\n>**Note:**  Only one network unlock certificate can be available at a time. If a new certificate is required, delete the current certificate before deploying a new one. The Network Unlock certificate is located in the **HKEY\\_LOCAL\\_MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\FVE\\_NKP** key on the client computer.\n \n### <a href=\"\" id=\"bkmk-stepseven\"></a>Step Seven: Require TPM+PIN protectors at startup\n\nAn additional step is for enterprises to use TPM+PIN protectors for an extra level of security. To require TPM+PIN protectors in an environment, do the following:\n\n1.  Open Group Policy Management Console (gpmc.msc)\n2.  Enable the policy **Require additional authentication at startup** and select the **Require startup PIN with TPM** option\n3.  Turn on BitLocker with TPM+PIN protectors on all domain-joined computers\n\n### <a href=\"\" id=\"bkmk-createcerttmpl\"></a>Create the certificate template for Network Unlock\n\nThe following steps detail how to create a certificate template for use with BitLocker Network Unlock. A properly configured Active Directory Services Certification Authority can use this certificate to create and issue Network Unlock certificates.\n\n1.  Open the Certificates Template snap-in (certtmpl.msc).\n2.  Locate the User template. Right-click the template name and select **Duplicate Template**\n3.  On the **Compatibility** tab, change the **Certification Authority** and **Certificate recipient** fields to Windows Server 2012 and Windows 8respectively. Ensure the **Show resulting changes** dialog box is selected.\n4.  Select the **General** tab of the template. The **Template display name** and **Template name** should clearly identify that the template will be used for Network Unlock. Clear the checkbox for the **Publish certificate in Active Directory** option.\n5.  Select the **Request Handling** tab. Select **Encryption** from the **Purpose** drop down menu. Ensure the **Allow private key to be exported** option is selected.\n6.  Select the **Cryptography** tab. Set the **Minimum key size** to 2048. (Any Microsoft cryptographic provider that supports RSA can be used for this template, but for simplicity and forward compatibility we recommend using the **Microsoft Software Key Storage Provider**.)\n7.  Select the **Requests must use one of the following providers** option and clear all options except for the cryptography provider you selected, such as the **Microsoft Software Key Storage Provider**.\n8.  Select the **Subject Name** tab. Select **Supply in the request**. Select **OK** if the certificate templates pop-up dialog appears.\n9.  Select the **Issuance Requirements** tab. Select both **CA certificate manager approval** and **Valid existing certificate** options.\n10. Select the **Extensions** tab. Select **Application Policies** and choose **Edit…**.\n11. In the **Edit Application Policies Extension** options dialog box, select **Client Authentication**, **Encrypting File System**, **and Secure Email** and choose **Remove**.\n12. On the **Edit Application Policies Extension** dialog box, select **Add**.\n13. On the **Add Application Policy** dialog box, select **New**. In the **New Application Policy** dialog box enter the following information in the space provided and then click **OK** to create the BitLocker Network Unlock application policy:\n\n    -   **Name:** **BitLocker Network Unlock**\n    -   **Object Identifier:** **1.3.6.1.4.1.311.67.1.1**\n\n14. Select the newly created **BitLocker Network Unlock** application policy and select **OK**\n15. With the **Extensions** tab still open, select the **Edit Key Usage Extension** dialog, select the **Allow key exchange only with key encryption (key encipherment)** option. Select the **Make this extension critical** option.\n16. Select the **Security** tab. Confirm that the **Domain Admins** group has been granted **Enroll** permission\n17. Select **OK** to complete configuration of the template.\n\nTo add the Network Unlock template to the Certification Authority, open the Certification Authority snap-in (certsrv.msc). Right-click the **Certificate Templates** item and choose **New, Certificate Template to issue**. Select the previously created BitLocker Network Unlock certificate.\n\nAfter adding the Network Unlock template to the Certification Authority, this certificate can be used to configure BitLocker Network Unlock.\n\n### Subnet policy configuration files on WDS Server (Optional)\n\nBy default, all clients with the correct Network Unlock Certificate and valid Network Unlock protectors that have wired access to a Network Unlock-enabled WDS server via DHCP are unlocked by the server. A subnet policy configuration file on the WDS server can be created to limit which subnet(s) Network Unlock clients can use to unlock.\n\nThe configuration file, called bde-network-unlock.ini, must be located in the same directory as the Network Unlock provider DLL and it applies to both IPv6 and IPv4 DHCP implementations. If the subnet configuration policy becomes corrupted, the provider will fail and stop responding to requests.\n\nThe subnet policy configuration file must use a “\\[SUBNETS\\]” section to identify the specific subnets. The named subnets may then be used to specify restrictions in certificate subsections. Subnets are defined as simple name-value pairs, in the common INI format, where each subnet has its own line, with the name on the left of the equals sign, and the subnet identified on the right of the equal sign as a Classless Inter-Domain Routing (CIDR) address or range. The key word “ENABLED” is disallowed for subnet names.\n\n    [SUBNETS]\n    SUBNET1=10.185.250.0/24 ; comment about this subrange could be here, after the semi-colon\n    SUBNET2=10.185.252.200/28 \n    SUBNET3= 2001:4898:a:2::/64 ; an IPv6 subnet\n    SUBNET4=2001:4898:a:3::/64; in production, the admin would likely give more useful names, like BUILDING9-EXCEPT-RECEP.\n    ```\n    Following the \\[SUBNETS\\] section, there can be sections for each Network Unlock certificate, identified by the certificate thumbprint formatted without any spaces, which define subnets clients can be unlocked from with that certificate.\n\n    >**Note:**  When specifying the certificate thumbprint, do not include any spaces. If spaces are included in the thumbprint the subnet configuration will fail because the thumbprint will not be recognized as valid.\n     \n    Subnet restrictions are defined within each certificate section by denoting the allowed list of permitted subnets. If any subnet is listed in a certificate section, then only those subnets listed are permitted for that certificate. If no subnet is listed in a certificate section, then all subnets are permitted for that certificate. If a certificate does not have a section in the subnet policy configuration file, then no subnet restrictions are applied for unlocking with that certificate. This means for restrictions to apply to every certificate, there must be a certificate section for every Network Unlock certificate on the server, and an explicit allowed list set for each certificate section.\n    Subnet lists are created by putting the name of a subnet from the \\[SUBNETS\\] section on its own line below the certificate section header. Then, the server will only unlock clients with this certificate on the subnet(s) specified as in the list. For troubleshooting, a subnet can be quickly excluded without deleting it from the section by simply commenting it out with a prepended semi-colon.\n    [‎2158a767e1c14e88e27a4c0aee111d2de2eafe60]\n    ;Comments could be added here to indicate when the cert was issued, which Group Policy should get it, and so on.\n    ;This list shows this cert is only allowed to unlock clients on SUBNET1 and SUBNET3 subnets. In this example, SUBNET2 is commented out.\n    SUBNET1\n    ;SUBNET2\n    SUBNET3\n\nTo disallow the use of a certificate altogether, its subnet list may contain the line “DISABLED\".\n\n### <a href=\"\" id=\"bkmk-turnoffnetworkunlock\"></a>Turning off Network Unlock\n\nTo turn off the unlock server, the PXE provider can be unregistered from the WDS server or uninstalled altogether. However, to stop clients from creating Network Unlock protectors the **Allow Network Unlock at startup** Group Policy setting should be disabled. When this policy setting is updated to disabled on client computers any Network Unlock key protectors on the computer will be deleted. Alternatively, the BitLocker Network Unlock certificate policy can be deleted on the domain controller to accomplish the same task for an entire domain.\n\n>**Note:**  Removing the FVENKP certificate store that contains the Network Unlock certificate and key on the WDS server will also effectively disable the server’s ability to respond to unlock requests for that certificate. However, this is seen as an error condition and is not a supported or recommended method for turning off the Network Unlock server.\n \n### <a href=\"\" id=\"bkmk-updatecerts\"></a>Update Network Unlock certificates\n\nTo update the certificates used by Network Unlock, administrators need to import or generate the new certificate for the server and then update the Network Unlock certificate Group Policy setting on the domain controller.\n\n## <a href=\"\" id=\"bkmk-troubleshoot\"></a>Troubleshoot Network Unlock\n\nTroubleshooting Network Unlock issues begins by verifying the environment. Many times, a small configuration issue will be the root cause of the failure. Items to verify include:\n\n-   Verify client hardware is UEFI-based and is on firmware version is 2.3.1 and that the UEFI firmware is in native mode without a Compatibility Support Module (CSM) for BIOS mode enabled. Do this by checking that the firmware does not have an option enabled such as \"Legacy mode\" or \"Compatibility mode\" or that the firmware does not appear to be in a BIOS-like mode.\n-   All required roles and services are installed and started\n-   Public and private certificates have been published and are in the proper certificate containers. The presence of the Network Unlock certificate can be verified in the Microsoft Management Console (MMC.exe) on the WDS server with the certificate snap-ins for the local computer enabled. The client certificate can be verified by checking the registry key **HKEY\\_LOCAL\\_MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\FVE\\_NKP** on the client computer.\n-   Group policy for Network Unlock is enabled and linked to the appropriate domains\n-   Verify group policy is reaching the clients properly. This can be done using the GPRESULT.exe or RSOP.msc utilities.\n-   Verify the **Network (Certificate Based)** protector is listed on the client. This can be done using either manage-bde or Windows PowerShell cmdlets. For example the following command will list the key protectors currently configured on the C: drive of the lcoal computer:\n\n    ``` syntax\n    Manage-bde –protectors –get C:\n    ```\n>**Note:**  Use the output of manage-bde along with the WDS debug log to determine if the proper certificate thumbprint is being used for Network Unlock\n \nFiles to gather when troubleshooting BitLocker Network Unlock include:\n\n1.  The Windows event logs. Specifically the BitLocker event logs and the Microsoft-Windows-Deployment-Services-Diagnostics-Debug log\n\n    Debug logging is turned off by default for the WDS server role, so you will need to enable it first. You can use either of the following two methods to turn on WDS debug logging.\n\n    1.  Start an elevated command prompt and run the following command:\n\n        ``` syntax\n        wevtutil sl Microsoft-Windows-Deployment-Services-Diagnostics/Debug /e:true\n        ```\n    2.  Open Event Viewer on the WDS server.\n\n        In the left pane, click **Applications and Services Logs**, click **Microsoft**, click **Windows**, click **Deployment-Services-Diagnostics**, and then click **Debug**.\n\n        In the right pane, click **Enable Log**.\n\n2.  The DHCP subnet configuration file (if one exists).\n3.  The output of the BitLocker status on the volume, this can be gathered into a text file using **manage-bde -status** or **Get-BitLockerVolume** in Windows PowerShell\n4.  Network Monitor capture on the server hosting the WDS role, filtered by client IP address\n\n## <a href=\"\" id=\"bkmk-unsupportedsystems\"></a>Configure Network Unlock Group Policy settings on earlier versions\n\nNetwork Unlock and the accompanying Group Policy settings were introduced in Windows Server 2012 but can be deployed using operating systems running Windows Server 2008 R2 and Windows Server 2008.\n**Requirements**\n\n-   The server hosting WDS must be running any of the server operating systems designated in the **Applies To** list at the beginning of this topic.\n-   Client computers must be running any of the client operating systems designated in the **Applies To** list at the beginning of this topic.\n\nThe following steps can be used to configure Network Unlock on these older systems.\n\n1.  [Step One: Install the WDS Server role](#bkmk-stepone)\n2.  [Step Two: Confirm the WDS Service is running](#bkmk-steptwo)\n3.  [Step Three: Install the Network Unlock feature](#bkmk-stepthree)\n4.  [Step Four: Create the Network Unlock certificate](#bkmk-stepfour)\n5.  [Step Five: Deploy the private key and certificate to the WDS server](#bkmk-stepfive)\n6.  **Step Six: Configure registry settings for Network Unlock**\n\n    Apply the registry settings by running the following certutil script on each computer running any of the client operating systems designated in the **Applies To** list at the beginning of this topic.\n        certutil -f -grouppolicy -addstore FVE_NKP BitLocker-NetworkUnlock.cer\n        reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v OSManageNKP /t REG_DWORD /d 1 /f\n        reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UseAdvancedStartup /t REG_DWORD /d 1 /f\n        reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UsePIN /t REG_DWORD /d 2 /f\n        reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UseTPMPIN /t REG_DWORD /d 2 /f\n        reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UseTPM /t REG_DWORD /d 2 /f\n        reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UseTPMKey /t REG_DWORD /d 2 /f\n        reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v UseTPMKeyPIN /t REG_DWORD /d 2 /f\n\n7.  [Create the Network Unlock certificate](#bkmk-stepfour)\n8.  [Deploy the private key and certificate to the WDS server](#bkmk-stepfive)\n9.  [Create the certificate template for Network Unlock](#bkmk-createcerttmpl)\n10. [Require TPM+PIN protectors at startup](#bkmk-stepseven)\n\n## See also\n\n-   [BitLocker overview](bitlocker-overview.md)\n-   [BitLocker frequently asked questions (FAQ)](bitlocker-frequently-asked-questions.md)\n-   [Prepare your organization for BitLocker: Planning and policies](prepare-your-organization-for-bitlocker-planning-and-policies.md)\n"}
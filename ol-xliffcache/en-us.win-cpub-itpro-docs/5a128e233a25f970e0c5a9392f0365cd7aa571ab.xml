{"nodes":[{"content":"Backup the TPM recovery Information to AD DS (Windows 10)","pos":[11,68]},{"content":"This topic for the IT professional describes how to back up a computer’s Trusted Platform Module (TPM) information to Active Directory Domain Services (AD DS) so that you can use AD DS to administer the TPM from a remote computer.","pos":[82,312]},{"content":"Backup the TPM recovery Information to AD DS","pos":[468,512]},{"content":"Applies to","pos":[516,526]},{"content":"Windows 10","pos":[533,543]},{"content":"This topic for the IT professional describes how to back up a computer’s Trusted Platform Module (TPM) information to Active Directory Domain Services (AD DS) so that you can use AD DS to administer the TPM from a remote computer.","pos":[545,775]},{"content":"About administering TPM remotely","pos":[780,812]},{"content":"Backing up the TPM owner information for a computer allows administrators in a domain to remotely configure the TPM security hardware on the local computer.","pos":[814,970]},{"content":"For example, administrators might want to reset the TPM to the manufacturer’s defaults when they decommission or repurpose computers, without having to be present at the computer.","pos":[971,1150]},{"content":"You can use AD DS to store TPM owner information for use in recovery situations where the TPM owner has forgotten the password or where you must take control of the TPM.","pos":[1152,1321]},{"content":"There is only one TPM owner password per computer; therefore, the hash of the TPM owner password can be stored as an attribute of the computer object in AD DS.","pos":[1322,1481]},{"content":"The attribute has the common name (CN) of <bpt id=\"p1\">**</bpt>ms-TPM-OwnerInformation<ept id=\"p1\">**</ept>.","pos":[1482,1552]},{"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  The TPM owner authorization value is stored in AD DS, and it is present in a TPM owner password file as a SHA-1 hash of the TPM owner password, which is base 64–encoded.","pos":[1556,1736]},{"content":"The actual owner password is not stored.","pos":[1737,1777]},{"content":"Domain controllers running Windows Server 2012 R2 or Windows Server 2012 include the required AD DS schema objects by default.","pos":[1780,1906]},{"content":"However, if your domain controller is running Windows Server 2008 R2, you need to update the schema as described in <bpt id=\"p1\">[</bpt>AD DS schema extensions to support TPM backup<ept id=\"p1\">](ad-ds-schema-extensions-to-support-tpm-backup.md)</ept>.","pos":[1907,2121]},{"content":"This topic contains procedures, some of which are dependent on Visual Basic scripts, to recover TPM information and decommission TPM on remote computers.","pos":[2123,2276]},{"content":"Sample scripts are available, which you can customize to meet the requirements of your environment.","pos":[2277,2376]},{"content":"In this topic:","pos":[2378,2392]},{"content":"Check status of prerequisites","pos":[2399,2428]},{"content":"Set permissions to back up password information","pos":[2450,2497]},{"content":"Configure Group Policy to back up TPM recovery information in AD DS","pos":[2520,2587]},{"content":"Use AD DS to recover TPM information","pos":[2613,2649]},{"content":"Sample scripts","pos":[2669,2683]},{"pos":[2746,2775],"content":"Check status of prerequisites"},{"content":"Before you begin your backup, ensure that the following prerequisites are met:","pos":[2777,2855]},{"content":"All domain controllers that are accessible by client computers that will be using TPM services are running Windows Server 2012 R2, Windows Server 2012, or Windows Server 2008 R2 with the updated schema.","pos":[2861,3063]},{"pos":[3075,3333],"content":"<bpt id=\"p1\">**</bpt>Tip:<ept id=\"p1\">**</ept>  For more info about the schema extensions that are required for a TPM backup in Active Directory domains that are running Windows Server 2008 R2, see <bpt id=\"p2\">[</bpt>AD DS schema extensions to support TPM backup<ept id=\"p2\">](ad-ds-schema-extensions-to-support-tpm-backup.md)</ept>."},{"content":"You have domain administrator rights in the target forest, or you are using an account that has been granted appropriate permissions to extend the schema for the target forest.","pos":[3344,3520]},{"content":"Members of the Enterprise Admins or Schema Admins groups are examples of accounts that have the appropriate permissions.","pos":[3521,3641]},{"pos":[3680,3727],"content":"Set permissions to back up password information"},{"content":"This procedure uses the sample script <bpt id=\"p1\">[</bpt>Add-TPMSelfWriteACE.vbs<ept id=\"p1\">](#bkmk-add-tpmselfwriteace)</ept> to add an access control entry (ACE) so that backing up TPM recovery information is possible.","pos":[3729,3913]},{"content":"A client computer cannot back up TPM owner information until this ACE is added.","pos":[3914,3993]},{"content":"This script is run on the domain controller that you will use to administer the TPM recovery information, and it operates under the following assumptions:","pos":[3995,4149]},{"content":"You have domain administrator credentials to set permissions for the top-level domain object.","pos":[4155,4248]},{"content":"Your target domain is the same as the domain for the user account that is running the script.","pos":[4253,4346]},{"content":"For example, running the script as TESTDOMAIN<ph id=\"ph1\">\\\\</ph>admin will extend permissions for TESTDOMAIN.","pos":[4347,4439]},{"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  You might need to modify the sample script if you want to set permissions for multiple domains, but you do not have domain administrator accounts for each of those domains.","pos":[4447,4630]},{"content":"Find the variable <bpt id=\"p1\">**</bpt>strPathToDomain<ept id=\"p1\">**</ept> in the script, and modify it for your target domain, for example:","pos":[4631,4734]},{"content":"Your domain is configured so that permissions are inherited from the top-level domain object to targeted computer objects.","pos":[4802,4924]},{"pos":[4930,5494],"content":"Permissions will not take effect if any container in the hierarchy does not allow inherited permissions. By default, permissions inheritance is set in AD DS. If you are not sure whether your configuration differs from this default, you can continue with the setup steps to set the permissions. \nYou can then verify your configuration as described later in this topic. Or you can click the **Effective Permissions** button while viewing the properties of a computer object, then check that **Self** is approved to write the **msTPM-OwnerInformation** attribute.","leadings":["","    "],"nodes":[{"content":"Permissions will not take effect if any container in the hierarchy does not allow inherited permissions.","pos":[0,104]},{"content":"By default, permissions inheritance is set in AD DS.","pos":[105,157]},{"content":"If you are not sure whether your configuration differs from this default, you can continue with the setup steps to set the permissions.","pos":[158,293]},{"content":"You can then verify your configuration as described later in this topic.","pos":[295,367]},{"content":"Or you can click the <bpt id=\"p1\">**</bpt>Effective Permissions<ept id=\"p1\">**</ept> button while viewing the properties of a computer object, then check that <bpt id=\"p2\">**</bpt>Self<ept id=\"p2\">**</ept> is approved to write the <bpt id=\"p3\">**</bpt>msTPM-OwnerInformation<ept id=\"p3\">**</ept> attribute.","pos":[368,560]}]},{"content":"To add an ACE to allow TPM recovery information backup","pos":[5498,5552]},{"pos":[5560,5611],"content":"Open the sample script <bpt id=\"p1\">**</bpt>Add-TPMSelfWriteACE.vbs<ept id=\"p1\">**</ept>."},{"pos":[5617,5740],"content":"The script contains a permission extension, and you must modify the value of <bpt id=\"p1\">**</bpt>strPathToDomain<ept id=\"p1\">**</ept> by using your domain name."},{"content":"Save your modifications to the script.","pos":[5746,5784]},{"content":"Type the following at a command prompt, and then press ENTER:","pos":[5789,5850]},{"content":"cscript Add-TPMSelfWriteACE.vbs","pos":[5858,5889]},{"content":"This script adds a single ACE to the top-level domain object.","pos":[5893,5954]},{"content":"The ACE is an inheritable permission that allows the computer (SELF) to write to the <bpt id=\"p1\">**</bpt>ms-TPM-OwnerInformation<ept id=\"p1\">**</ept> attribute for computer objects in the domain.","pos":[5955,6113]},{"content":"Complete the following procedure to check that the correct permissions are set and to remove TPM and BitLocker ACEs from the top-level domain, if necessary.","pos":[6114,6270]},{"content":"Manage ACEs configured on TPM schema objects","pos":[6274,6318]},{"pos":[6326,6367],"content":"Open the sample script <bpt id=\"p1\">**</bpt>List-ACEs.vbs<ept id=\"p1\">**</ept>."},{"pos":[6372,6397],"content":"Modify <bpt id=\"p1\">**</bpt>List-ACEs.vbs<ept id=\"p1\">**</ept>."},{"content":"You must modify:","pos":[6403,6419]},{"pos":[6428,6479],"content":"Value of <bpt id=\"p1\">**</bpt>strPathToDomain<ept id=\"p1\">**</ept>: Use your domain name."},{"pos":[6488,6669],"content":"Filter options: The script sets a filter to address BitLocker and TPM schema objects, so you must modify <bpt id=\"p1\">**</bpt>If IsFilterActive ()<ept id=\"p1\">**</ept> if you want to list or remove other schema objects."},{"content":"Save your modifications to the script.","pos":[6675,6713]},{"content":"Type the following at a command prompt, and then press ENTER:","pos":[6718,6779]},{"content":"cscript List-ACEs.vbs","pos":[6787,6808]},{"content":"With this script you can optionally remove ACEs from BitLocker and TPM schema objects on the top-level domain.","pos":[6816,6926]},{"pos":[6968,7035],"content":"Configure Group Policy to back up TPM recovery information in AD DS"},{"content":"Use these procedures to configure the <bpt id=\"p1\">[</bpt>TPM Group Policy settings<ept id=\"p1\">](trusted-platform-module-services-group-policy-settings.md#bkmk-tpmgp-addsbu)</ept> policy setting on a local computer.","pos":[7037,7215]},{"content":"In a production environment, an efficient way to do this is to create or edit a Group Policy Object (GPO) that can target client computers in the domain.","pos":[7216,7369]},{"content":"To enable local policy setting to back up TPM recovery information to AD DS","pos":[7373,7448]},{"content":"Sign in to a domain-joined computer by using a domain account that is a member of the local Administrators group.","pos":[7456,7569]},{"pos":[7574,7721],"content":"Open the Local Group Policy Editor (gpedit.msc), and in the console tree, navigate to <bpt id=\"p1\">**</bpt>Computer Configuration<ph id=\"ph1\">\\\\</ph>Administrative Templates<ph id=\"ph2\">\\\\</ph>System<ept id=\"p1\">**</ept>."},{"pos":[7726,7769],"content":"Click <bpt id=\"p1\">**</bpt>Trusted Platform Module Services<ept id=\"p1\">**</ept>."},{"pos":[7774,7846],"content":"Double-click <bpt id=\"p1\">**</bpt>Turn on TPM backup to Active Directory Domain Services<ept id=\"p1\">**</ept>."},{"pos":[7851,7892],"content":"Click <bpt id=\"p1\">**</bpt>Enabled<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>."},{"pos":[7895,8094],"content":"<bpt id=\"p1\">**</bpt>Important:<ept id=\"p1\">**</ept>  When this setting is enabled, the TPM owner password cannot be set or changed unless the computer is connected to the domain and AD DS backup of the TPM recovery information succeeds."},{"pos":[8131,8167],"content":"Use AD DS to recover TPM information"},{"pos":[8169,8448],"content":"When you need to recover the TPM owner information from AD DS and use it to manage the TPM, you need to read the <bpt id=\"p1\">**</bpt>ms-TPM-OwnerInformation<ept id=\"p1\">**</ept> object from AD DS, and then manually create a TPM owner password backup file that can be supplied when TPM owner credentials are required."},{"content":"To obtain TPM owner backup information from AD DS and create a password file","pos":[8452,8528]},{"content":"Sign in to a domain controller by using domain administrator credentials.","pos":[8536,8609]},{"pos":[8614,8724],"content":"Copy the sample script file, <bpt id=\"p1\">[</bpt>Get-TPMOwnerInfo.vbs<ept id=\"p1\">](#ms-tpm-ownerinformation)</ept>, to a location on your computer."},{"content":"Open a Command Prompt window, and change the default location to the location of the sample script files you saved in the previous step.","pos":[8729,8865]},{"pos":[8870,8931],"content":"At the command prompt, type <bpt id=\"p1\">**</bpt>cscript Get-TPMOwnerInfo.vbs<ept id=\"p1\">**</ept>."},{"content":"The expected output is a string that is the hash of the password that you created earlier.","pos":[8937,9027]},{"pos":[9034,9278],"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  If you receive the error message, \"Active Directory: The directory property cannot be found in the cache,\" verify that you are using a domain administrator account, which is required to read the <bpt id=\"p2\">**</bpt>ms-TPM-OwnerInformation<ept id=\"p2\">**</ept> attribute."},{"content":"The only exception to this requirement is that if users are the Creator Owner of computer objects that they join to the domain, they can possibly read the TPM owner information for their computer objects.","pos":[9288,9492]},{"pos":[9503,9680],"content":"Open Notepad or another text editor, and copy the following code sample into the file, and replace <bpt id=\"p1\">*</bpt>TpmOwnerPasswordHash<ept id=\"p1\">*</ept> with the string that you recorded in the previous step."},{"content":"Save this file with a .tpm extension on a removable storage device, such as a USB flash drive.","pos":[10395,10489]},{"content":"When you access the TPM, and you are required to provide the TPM owner password, choose the option for reading the password from a file and provide the path to this file.","pos":[10490,10660]},{"pos":[10707,10721],"content":"Sample scripts"},{"content":"You can use all or portions of the following sample scripts, which are used in the preceding procedures, to configure AD DS for backing up TPM recovery information.","pos":[10723,10887]},{"content":"Customization is required depending on how your environment is configured.","pos":[10888,10962]},{"content":"Add-TPMSelfWriteACE.vbs: Use to add the access control entry (ACE) for the TPM to AD DS","pos":[10969,11056]},{"content":"List-ACEs.vbs: Use to list or remove the ACEs that are configured on BitLocker and TPM schema objects","pos":[11090,11191]},{"content":"Get-TPMOwnerInfo.vbs: Use to retrieve the TPM recovery information from AD DS for a particular computer","pos":[11215,11318]},{"pos":[11394,11417],"content":"Add-TPMSelfWriteACE.vbs"},{"content":"This script adds the access control entry (ACE) for the TPM to AD DS so that the computer can back up TPM recovery information in AD DS.","pos":[11419,11555]},{"pos":[16854,16867],"content":"List-ACEs.vbs"},{"content":"This script lists or removes the ACEs that are configured on BitLocker and TPM schema objects for the top-level domain.","pos":[16869,16988]},{"content":"This enables you to verify that the expected ACEs have been added appropriately or to remove any ACEs that are related to BitLocker or the TPM, if necessary.","pos":[16989,17146]},{"pos":[24489,24509],"content":"Get-TPMOwnerInfo.vbs"},{"content":"This script retrieves TPM recovery information from AD DS for a particular computer so that you can verify that only domain administrators (or delegated roles) can read backed up TPM recovery information and verify that the information is being backed up correctly.","pos":[24511,24776]},{"content":"Additional resources","pos":[30122,30142]},{"content":"Trusted Platform Module technology overview","pos":[30147,30190]},{"content":"TPM fundamentals","pos":[30232,30248]},{"content":"TPM Group Policy settings","pos":[30274,30299]},{"content":"TPM Cmdlets in Windows PowerShell","pos":[30363,30396]},{"content":"AD DS schema extensions to support TPM backup","pos":[30453,30498]},{"pos":[30552,30692],"content":"<bpt id=\"p1\">[</bpt>Prepare your organization for BitLocker: Planning and Policies<ept id=\"p1\">](http://technet.microsoft.com/library/jj592683.aspx)</ept>, see TPM considerations"}],"content":"---\ntitle: Backup the TPM recovery Information to AD DS (Windows 10)\ndescription: This topic for the IT professional describes how to back up a computer’s Trusted Platform Module (TPM) information to Active Directory Domain Services (AD DS) so that you can use AD DS to administer the TPM from a remote computer.\nms.assetid: 62bcec80-96a1-464e-8b3f-d177a7565ac5\nms.prod: w10\nms.mktglfcycl: deploy\nms.sitesec: library\nms.pagetype: security\nauthor: brianlic-msft\n---\n\n# Backup the TPM recovery Information to AD DS\n\n**Applies to**\n-   Windows 10\n\nThis topic for the IT professional describes how to back up a computer’s Trusted Platform Module (TPM) information to Active Directory Domain Services (AD DS) so that you can use AD DS to administer the TPM from a remote computer.\n\n## About administering TPM remotely\n\nBacking up the TPM owner information for a computer allows administrators in a domain to remotely configure the TPM security hardware on the local computer. For example, administrators might want to reset the TPM to the manufacturer’s defaults when they decommission or repurpose computers, without having to be present at the computer.\n\nYou can use AD DS to store TPM owner information for use in recovery situations where the TPM owner has forgotten the password or where you must take control of the TPM. There is only one TPM owner password per computer; therefore, the hash of the TPM owner password can be stored as an attribute of the computer object in AD DS. The attribute has the common name (CN) of **ms-TPM-OwnerInformation**.\n\n> **Note:**  The TPM owner authorization value is stored in AD DS, and it is present in a TPM owner password file as a SHA-1 hash of the TPM owner password, which is base 64–encoded. The actual owner password is not stored.\n \nDomain controllers running Windows Server 2012 R2 or Windows Server 2012 include the required AD DS schema objects by default. However, if your domain controller is running Windows Server 2008 R2, you need to update the schema as described in [AD DS schema extensions to support TPM backup](ad-ds-schema-extensions-to-support-tpm-backup.md).\n\nThis topic contains procedures, some of which are dependent on Visual Basic scripts, to recover TPM information and decommission TPM on remote computers. Sample scripts are available, which you can customize to meet the requirements of your environment.\n\nIn this topic:\n\n1.  [Check status of prerequisites](#bkmk-prereqs)\n2.  [Set permissions to back up password information](#bkmk-setperms)\n3.  [Configure Group Policy to back up TPM recovery information in AD DS](#bkmk-configuregp)\n4.  [Use AD DS to recover TPM information](#bkmk-useit)\n5.  [Sample scripts](#bkmk-adds-tpm-scripts)\n\n## <a href=\"\" id=\"bkmk-prereqs\"></a>Check status of prerequisites\n\nBefore you begin your backup, ensure that the following prerequisites are met:\n\n1.  All domain controllers that are accessible by client computers that will be using TPM services are running Windows Server 2012 R2, Windows Server 2012, or Windows Server 2008 R2 with the updated schema.\n    \n    > **Tip:**  For more info about the schema extensions that are required for a TPM backup in Active Directory domains that are running Windows Server 2008 R2, see [AD DS schema extensions to support TPM backup](ad-ds-schema-extensions-to-support-tpm-backup.md).\n     \n2.  You have domain administrator rights in the target forest, or you are using an account that has been granted appropriate permissions to extend the schema for the target forest. Members of the Enterprise Admins or Schema Admins groups are examples of accounts that have the appropriate permissions.\n\n## <a href=\"\" id=\"bkmk-setperms\"></a>Set permissions to back up password information\n\nThis procedure uses the sample script [Add-TPMSelfWriteACE.vbs](#bkmk-add-tpmselfwriteace) to add an access control entry (ACE) so that backing up TPM recovery information is possible. A client computer cannot back up TPM owner information until this ACE is added.\n\nThis script is run on the domain controller that you will use to administer the TPM recovery information, and it operates under the following assumptions:\n\n-   You have domain administrator credentials to set permissions for the top-level domain object.\n-   Your target domain is the same as the domain for the user account that is running the script. For example, running the script as TESTDOMAIN\\\\admin will extend permissions for TESTDOMAIN.\n\n    > **Note:**  You might need to modify the sample script if you want to set permissions for multiple domains, but you do not have domain administrator accounts for each of those domains. Find the variable **strPathToDomain** in the script, and modify it for your target domain, for example:\n    `LDAP://DC=testdomain,DC=nttest,DC=microsoft,DC=com`\n     \n-   Your domain is configured so that permissions are inherited from the top-level domain object to targeted computer objects.\n\n    Permissions will not take effect if any container in the hierarchy does not allow inherited permissions. By default, permissions inheritance is set in AD DS. If you are not sure whether your configuration differs from this default, you can continue with the setup steps to set the permissions. \n    You can then verify your configuration as described later in this topic. Or you can click the **Effective Permissions** button while viewing the properties of a computer object, then check that **Self** is approved to write the **msTPM-OwnerInformation** attribute.\n\n**To add an ACE to allow TPM recovery information backup**\n\n1.  Open the sample script **Add-TPMSelfWriteACE.vbs**.\n\n    The script contains a permission extension, and you must modify the value of **strPathToDomain** by using your domain name.\n\n2.  Save your modifications to the script.\n3.  Type the following at a command prompt, and then press ENTER:\n\n    **cscript Add-TPMSelfWriteACE.vbs**\n\nThis script adds a single ACE to the top-level domain object. The ACE is an inheritable permission that allows the computer (SELF) to write to the **ms-TPM-OwnerInformation** attribute for computer objects in the domain.\nComplete the following procedure to check that the correct permissions are set and to remove TPM and BitLocker ACEs from the top-level domain, if necessary.\n\n**Manage ACEs configured on TPM schema objects**\n\n1.  Open the sample script **List-ACEs.vbs**.\n2.  Modify **List-ACEs.vbs**.\n\n    You must modify:\n    -   Value of **strPathToDomain**: Use your domain name.\n    -   Filter options: The script sets a filter to address BitLocker and TPM schema objects, so you must modify **If IsFilterActive ()** if you want to list or remove other schema objects.\n\n3.  Save your modifications to the script.\n4.  Type the following at a command prompt, and then press ENTER:\n\n    **cscript List-ACEs.vbs**\n\n    With this script you can optionally remove ACEs from BitLocker and TPM schema objects on the top-level domain.\n\n## <a href=\"\" id=\"bkmk-configuregp\"></a>Configure Group Policy to back up TPM recovery information in AD DS\n\nUse these procedures to configure the [TPM Group Policy settings](trusted-platform-module-services-group-policy-settings.md#bkmk-tpmgp-addsbu) policy setting on a local computer. In a production environment, an efficient way to do this is to create or edit a Group Policy Object (GPO) that can target client computers in the domain.\n\n**To enable local policy setting to back up TPM recovery information to AD DS**\n\n1.  Sign in to a domain-joined computer by using a domain account that is a member of the local Administrators group.\n2.  Open the Local Group Policy Editor (gpedit.msc), and in the console tree, navigate to **Computer Configuration\\\\Administrative Templates\\\\System**.\n3.  Click **Trusted Platform Module Services**.\n4.  Double-click **Turn on TPM backup to Active Directory Domain Services**.\n5.  Click **Enabled**, and then click **OK**.\n> **Important:**  When this setting is enabled, the TPM owner password cannot be set or changed unless the computer is connected to the domain and AD DS backup of the TPM recovery information succeeds.\n \n## <a href=\"\" id=\"bkmk-useit\"></a>Use AD DS to recover TPM information\n\nWhen you need to recover the TPM owner information from AD DS and use it to manage the TPM, you need to read the **ms-TPM-OwnerInformation** object from AD DS, and then manually create a TPM owner password backup file that can be supplied when TPM owner credentials are required.\n\n**To obtain TPM owner backup information from AD DS and create a password file**\n\n1.  Sign in to a domain controller by using domain administrator credentials.\n2.  Copy the sample script file, [Get-TPMOwnerInfo.vbs](#ms-tpm-ownerinformation), to a location on your computer.\n3.  Open a Command Prompt window, and change the default location to the location of the sample script files you saved in the previous step.\n4.  At the command prompt, type **cscript Get-TPMOwnerInfo.vbs**.\n\n    The expected output is a string that is the hash of the password that you created earlier.\n    > **Note:**  If you receive the error message, \"Active Directory: The directory property cannot be found in the cache,\" verify that you are using a domain administrator account, which is required to read the **ms-TPM-OwnerInformation** attribute.\n    \n    The only exception to this requirement is that if users are the Creator Owner of computer objects that they join to the domain, they can possibly read the TPM owner information for their computer objects.\n     \n5.  Open Notepad or another text editor, and copy the following code sample into the file, and replace *TpmOwnerPasswordHash* with the string that you recorded in the previous step.\n    \n    ``` syntax\n    <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n    <!--\n    This page is a backup of Trusted Platform Module (TPM) owner\n    authorization information. Upon request, use the authorization information to\n    prove ownership of the computer's TPM.\n    IMPORTANT: Please keep this file in a secure location away from your computer's\n    local hard drive.\n    -->\n    <tpmOwnerData version=\"1.0\" softwareAuthor=\"Microsoft Windows [Version 6.1.7600]\" creationDate=\"2009-11-11T14:39:29-08:00\" creationUser=\"DOMAIN\\username\" machineName=\"mymachine\">\n                    <tpmInfo manufacturerId=\"1096043852\"/>\n                    <ownerAuth>TpmOwnerPasswordHash</ownerAuth>\n    </tpmOwnerData>\n    ```\n6.  Save this file with a .tpm extension on a removable storage device, such as a USB flash drive. When you access the TPM, and you are required to provide the TPM owner password, choose the option for reading the password from a file and provide the path to this file.\n\n## <a href=\"\" id=\"bkmk-adds-tpm-scripts\"></a>Sample scripts\n\nYou can use all or portions of the following sample scripts, which are used in the preceding procedures, to configure AD DS for backing up TPM recovery information. Customization is required depending on how your environment is configured.\n\n-   [Add-TPMSelfWriteACE.vbs: Use to add the access control entry (ACE) for the TPM to AD DS](#bkmk-add-tpmselfwriteace)\n-   [List-ACEs.vbs: Use to list or remove the ACEs that are configured on BitLocker and TPM schema objects](#bkmk-list-aces)\n-   [Get-TPMOwnerInfo.vbs: Use to retrieve the TPM recovery information from AD DS for a particular computer](#bkmk-get-tpmownerinfo)\n\n### <a href=\"\" id=\"bkmk-add-tpmselfwriteace\"></a>Add-TPMSelfWriteACE.vbs\n\nThis script adds the access control entry (ACE) for the TPM to AD DS so that the computer can back up TPM recovery information in AD DS.\n\n``` syntax\n'===============================================================================\n'\n' This script demonstrates the addition of an Access Control Entry (ACE)\n' to allow computers to write Trusted Platform Module (TPM) \n' recovery information to Active Directory.\n'\n' This script creates a SELF ACE on the top-level domain object, and\n' assumes that inheritance of ACL's from the top-level domain object to \n' down-level computer objects are enabled.\n'\n' \n'\n' Last Updated: 12/05/2012\n' Last Reviewed: 12/05/2012\n' Microsoft Corporation\n'\n' Disclaimer\n' \n' The sample scripts are not supported under any Microsoft standard support program\n' or service. The sample scripts are provided AS IS without warranty of any kind. \n' Microsoft further disclaims all implied warranties including, without limitation, \n' any implied warranties of merchantability or of fitness for a particular purpose. \n' The entire risk arising out of the use or performance of the sample scripts and \n' documentation remains with you. In no event shall Microsoft, its authors, or \n' anyone else involved in the creation, production, or delivery of the scripts be \n' liable for any damages whatsoever (including, without limitation, damages for loss \n' of business profits, business interruption, loss of business information, or \n' other pecuniary loss) arising out of the use of or inability to use the sample \n' scripts or documentation, even if Microsoft has been advised of the possibility \n' of such damages.\n'\n' Version 1.0.2 - Tested and re-released for Windows 8 and Windows Server 2012 \n' \n'===============================================================================\n' --------------------------------------------------------------------------------\n' Access Control Entry (ACE) constants \n' --------------------------------------------------------------------------------\n'- From the ADS_ACETYPE_ENUM enumeration\nConst ADS_ACETYPE_ACCESS_ALLOWED_OBJECT      = &H5   'Allows an object to do something\n'- From the ADS_ACEFLAG_ENUM enumeration\nConst ADS_ACEFLAG_INHERIT_ACE                = &H2   'ACE can be inherited to child objects\nConst ADS_ACEFLAG_INHERIT_ONLY_ACE           = &H8   'ACE does NOT apply to target (parent) object\n'- From the ADS_RIGHTS_ENUM enumeration\nConst ADS_RIGHT_DS_WRITE_PROP                = &H20  'The right to write object properties\nConst ADS_RIGHT_DS_CREATE_CHILD              = &H1   'The right to create child objects\n'- From the ADS_FLAGTYPE_ENUM enumeration\nConst ADS_FLAG_OBJECT_TYPE_PRESENT           = &H1   'Target object type is present in the ACE \nConst ADS_FLAG_INHERITED_OBJECT_TYPE_PRESENT = &H2   'Target inherited object type is present in the ACE \n' --------------------------------------------------------------------------------\n' TPM and FVE schema object GUID's \n' --------------------------------------------------------------------------------\n'- ms-TPM-OwnerInformation attribute\nSCHEMA_GUID_MS_TPM_OWNERINFORMATION = \"{AA4E1A6D-550D-4E05-8C35-4AFCB917A9FE}\"\n'- ms-FVE-RecoveryInformation object\nSCHEMA_GUID_MS_FVE_RECOVERYINFORMATION = \"{EA715D30-8F53-40D0-BD1E-6109186D782C}\"\n'- Computer object\nSCHEMA_GUID_COMPUTER = \"{BF967A86-0DE6-11D0-A285-00AA003049E2}\"\n'Reference: \"Platform SDK: Active Directory Schema\"\n' --------------------------------------------------------------------------------\n' Set up the ACE to allow write of TPM owner information\n' --------------------------------------------------------------------------------\nSet objAce1 = createObject(\"AccessControlEntry\")\nobjAce1.AceFlags = ADS_ACEFLAG_INHERIT_ACE + ADS_ACEFLAG_INHERIT_ONLY_ACE\nobjAce1.AceType = ADS_ACETYPE_ACCESS_ALLOWED_OBJECT\nobjAce1.Flags = ADS_FLAG_OBJECT_TYPE_PRESENT + ADS_FLAG_INHERITED_OBJECT_TYPE_PRESENT\nobjAce1.Trustee = \"SELF\"\nobjAce1.AccessMask = ADS_RIGHT_DS_WRITE_PROP \nobjAce1.ObjectType = SCHEMA_GUID_MS_TPM_OWNERINFORMATION\nobjAce1.InheritedObjectType = SCHEMA_GUID_COMPUTER\n' --------------------------------------------------------------------------------\n' NOTE: BY default, the \"SELF\" computer account can create \n' BitLocker recovery information objects and write BitLocker recovery properties\n'\n' No additional ACE's are needed.\n' --------------------------------------------------------------------------------\n' --------------------------------------------------------------------------------\n' Connect to Discretional ACL (DACL) for domain object\n' --------------------------------------------------------------------------------\nSet objRootLDAP = GetObject(\"LDAP://rootDSE\")\nstrPathToDomain = \"LDAP://\" & objRootLDAP.Get(\"defaultNamingContext\") ' e.g. string dc=fabrikam,dc=com\nSet objDomain = GetObject(strPathToDomain)\nWScript.Echo \"Accessing object: \" + objDomain.Get(\"distinguishedName\")\nSet objDescriptor = objDomain.Get(\"ntSecurityDescriptor\")\nSet objDacl = objDescriptor.DiscretionaryAcl\n \n' --------------------------------------------------------------------------------\n' Add the ACEs to the Discretionary ACL (DACL) and set the DACL\n' --------------------------------------------------------------------------------\nobjDacl.AddAce objAce1\nobjDescriptor.DiscretionaryAcl = objDacl\nobjDomain.Put \"ntSecurityDescriptor\", Array(objDescriptor)\nobjDomain.SetInfo\nWScript.Echo \"SUCCESS!\"\n```\n\n### <a href=\"\" id=\"bkmk-list-aces\"></a>List-ACEs.vbs\n\nThis script lists or removes the ACEs that are configured on BitLocker and TPM schema objects for the top-level domain. This enables you to verify that the expected ACEs have been added appropriately or to remove any ACEs that are related to BitLocker or the TPM, if necessary.\n\n``` syntax\n'===============================================================================\n'\n' This script lists the access control entries (ACE's) configured on \n' Trusted Platform Module (TPM) and BitLocker Drive Encryption (BDE) schema objects \n' for the top-level domain.\n'\n' You can use this script to check that the correct permissions have been set and\n' to remove TPM and BitLocker ACE's from the top-level domain.\n'\n' \n' Last Updated: 12/05/2012\n' Last Reviewed: 12/02/2012\n'\n' Microsoft Corporation\n'\n' Disclaimer\n' \n' The sample scripts are not supported under any Microsoft standard support program\n' or service. The sample scripts are provided AS IS without warranty of any kind. \n' Microsoft further disclaims all implied warranties including, without limitation, \n' any implied warranties of merchantability or of fitness for a particular purpose. \n' The entire risk arising out of the use or performance of the sample scripts and \n' documentation remains with you. In no event shall Microsoft, its authors, or \n' anyone else involved in the creation, production, or delivery of the scripts be \n' liable for any damages whatsoever (including, without limitation, damages for loss \n' of business profits, business interruption, loss of business information, or \n' other pecuniary loss) arising out of the use of or inability to use the sample \n' scripts or documentation, even if Microsoft has been advised of the possibility \n' of such damages.\n'\n' Version 1.0.2 - Tested and re-released for Windows 8 and Windows Server 2012\n' \n'===============================================================================\n' --------------------------------------------------------------------------------\n' Usage\n' --------------------------------------------------------------------------------\nSub ShowUsage\n   Wscript.Echo \"USAGE: List-ACEs\"\n   Wscript.Echo \"List access permissions for BitLocker and TPM schema objects\"\n   Wscript.Echo \"\"\n   Wscript.Echo \"USAGE: List-ACEs -remove\"\n   Wscript.Echo \"Removes access permissions for BitLocker and TPM schema objects\"\n   WScript.Quit\nEnd Sub\n' --------------------------------------------------------------------------------\n' Parse Arguments\n' --------------------------------------------------------------------------------\nSet args = WScript.Arguments\nSelect Case args.Count\n  \n  Case 0\n      ' do nothing - checks for ACE's \n      removeACE = False\n      \n  Case 1\n    If args(0) = \"/?\" Or args(0) = \"-?\" Then\n      ShowUsage\n    Else \n      If UCase(args(0)) = \"-REMOVE\" Then\n            removeACE = True\n      End If\n    End If\n  Case Else\n    ShowUsage\nEnd Select\n' --------------------------------------------------------------------------------\n' Configuration of the filter to show/remove only ACE's for BDE and TPM objects\n' --------------------------------------------------------------------------------\n'- ms-TPM-OwnerInformation attribute\nSCHEMA_GUID_MS_TPM_OWNERINFORMATION = \"{AA4E1A6D-550D-4E05-8C35-4AFCB917A9FE}\"\n'- ms-FVE-RecoveryInformation object\nSCHEMA_GUID_MS_FVE_RECOVERYINFORMATION = \"{EA715D30-8F53-40D0-BD1E-6109186D782C}\"\n' Use this filter to list/remove only ACEs related to TPM and BitLocker\naceGuidFilter = Array(SCHEMA_GUID_MS_TPM_OWNERINFORMATION, _\n                      SCHEMA_GUID_MS_FVE_RECOVERYINFORMATION)\n' Note to script source reader:\n' Uncomment the following line to turn off the filter and list all ACEs\n'aceGuidFilter = Array()\n' --------------------------------------------------------------------------------\n' Helper functions related to the list filter for listing or removing ACE's\n' --------------------------------------------------------------------------------\nFunction IsFilterActive()\n    If Join(aceGuidFilter) = \"\" Then\n       IsFilterActive = False\n    Else \n       IsFilterActive = True\n    End If\nEnd Function\nFunction isAceWithinFilter(ace) \n    aceWithinFilter = False  ' assume first not pass the filter\n    For Each guid In aceGuidFilter \n        If ace.ObjectType = guid Or ace.InheritedObjectType = guid Then\n           isAceWithinFilter = True           \n        End If\n    Next\nEnd Function\nSub displayFilter\n    For Each guid In aceGuidFilter\n       WScript.echo guid\n    Next\nEnd Sub\n' --------------------------------------------------------------------------------\n' Connect to Discretional ACL (DACL) for domain object\n' --------------------------------------------------------------------------------\nSet objRootLDAP = GetObject(\"LDAP://rootDSE\")\nstrPathToDomain = \"LDAP://\" & objRootLDAP.Get(\"defaultNamingContext\") ' e.g. dc=fabrikam,dc=com\nSet domain = GetObject(strPathToDomain)\nWScript.Echo \"Accessing object: \" + domain.Get(\"distinguishedName\")\nWScript.Echo \"\"\nSet descriptor = domain.Get(\"ntSecurityDescriptor\")\nSet dacl = descriptor.DiscretionaryAcl\n' --------------------------------------------------------------------------------\n' Show Access Control Entries (ACE's)\n' --------------------------------------------------------------------------------\n' Loop through the existing ACEs, including all ACEs if the filter is not active\ni = 1 ' global index\nc = 0 ' found count - relevant if filter is active\nFor Each ace In dacl\n If IsFilterActive() = False or isAceWithinFilter(ace) = True Then\n    ' note to script source reader:\n    ' echo i to show the index of the ACE\n    \n    WScript.echo \">            AceFlags: \" & ace.AceFlags\n    WScript.echo \">             AceType: \" & ace.AceType\n    WScript.echo \">               Flags: \" & ace.Flags\n    WScript.echo \">          AccessMask: \" & ace.AccessMask\n    WScript.echo \">          ObjectType: \" & ace.ObjectType\n    WScript.echo \"> InheritedObjectType: \" & ace.InheritedObjectType\n    WScript.echo \">             Trustee: \" & ace.Trustee\n    WScript.echo \"\"\n    if IsFilterActive() = True Then\n      c = c + 1\n      ' optionally include this ACE in removal list if configured\n      ' note that the filter being active is a requirement since we don't\n      ' want to accidentally remove all ACEs\n      If removeACE = True Then\n        dacl.RemoveAce ace  \n      End If\n    end if\n  End If \n  i = i + 1\nNext\n' Display number of ACEs found\nIf IsFilterActive() = True Then\n  WScript.echo c & \" ACE(s) found in \" & domain.Get(\"distinguishedName\") _\n                 & \" related to BitLocker and TPM\" 'note to script source reader: change this line if you configure your own \nfilter\n  ' note to script source reader: \n  ' uncomment the following lines if you configure your own filter\n  'WScript.echo \"\"\n  'WScript.echo \"The following filter was active: \"\n  'displayFilter\n  'Wscript.echo \"\"\nElse\n  i = i - 1\n  WScript.echo i & \" total ACE(s) found in \" & domain.Get(\"distinguishedName\")\n  \nEnd If\n' --------------------------------------------------------------------------------\n' Optionally remove ACE's on a filtered list\n' --------------------------------------------------------------------------------\nif removeACE = True and IsFilterActive() = True then\n  descriptor.DiscretionaryAcl =  dacl\n  domain.Put \"ntSecurityDescriptor\", Array(descriptor)\n  domain.setInfo\n  WScript.echo c & \" ACE(s) removed from \" & domain.Get(\"distinguishedName\")\nelse \n  if removeACE = True then\n    WScript.echo \"You must specify a filter to remove ACEs from \" & domain.Get(\"distinguishedName\") \n \n end if\nend if\n```\n\n### <a href=\"\" id=\"bkmk-get-tpmownerinfo\"></a>Get-TPMOwnerInfo.vbs\n\nThis script retrieves TPM recovery information from AD DS for a particular computer so that you can verify that only domain administrators (or delegated roles) can read backed up TPM recovery information and verify that the information is being backed up correctly.\n\n``` syntax\n'=================================================================================\n'\n' This script demonstrates the retrieval of Trusted Platform Module (TPM) \n' recovery information from Active Directory for a particular computer.\n'\n' It returns the TPM owner information stored as an attribute of a \n' computer object.\n'\n' Last Updated: 12/05/2012\n' Last Reviewed: 12/05/2012\n'\n' Microsoft Corporation\n'\n' Disclaimer\n' \n' The sample scripts are not supported under any Microsoft standard support program\n' or service. The sample scripts are provided AS IS without warranty of any kind. \n' Microsoft further disclaims all implied warranties including, without limitation, \n' any implied warranties of merchantability or of fitness for a particular purpose. \n' The entire risk arising out of the use or performance of the sample scripts and \n' documentation remains with you. In no event shall Microsoft, its authors, or \n' anyone else involved in the creation, production, or delivery of the scripts be \n' liable for any damages whatsoever (including, without limitation, damages for loss \n' of business profits, business interruption, loss of business information, or \n' other pecuniary loss) arising out of the use of or inability to use the sample \n' scripts or documentation, even if Microsoft has been advised of the possibility \n' of such damages.\n'\n' Version 1.0 - Initial release\n' Version 1.1 - Updated GetStrPathToComputer to search the global catalog.\n' Version 1.1.2 - Tested and re-released for Windows 8 and Windows Server 2012\n' \n'=================================================================================\n' --------------------------------------------------------------------------------\n' Usage\n' --------------------------------------------------------------------------------\nSub ShowUsage\n   Wscript.Echo \"USAGE: Get-TpmOwnerInfo [Optional Computer Name]\"\n   Wscript.Echo \"If no computer name is specified, the local computer is assumed.\"\n   WScript.Quit\nEnd Sub\n' --------------------------------------------------------------------------------\n' Parse Arguments\n' --------------------------------------------------------------------------------\nSet args = WScript.Arguments\nSelect Case args.Count\n  \n  Case 0\n      ' Get the name of the local computer      \n      Set objNetwork = CreateObject(\"WScript.Network\")\n      strComputerName = objNetwork.ComputerName\n    \n  Case 1\n    If args(0) = \"/?\" Or args(0) = \"-?\" Then\n      ShowUsage\n    Else\n      strComputerName = args(0)\n    End If\n  \n  Case Else\n    ShowUsage\nEnd Select\n' --------------------------------------------------------------------------------\n' Get path to Active Directory computer object associated with the computer name\n' --------------------------------------------------------------------------------\nFunction GetStrPathToComputer(strComputerName) \n    ' Uses the global catalog to find the computer in the forest\n    ' Search also includes deleted computers in the tombstone\n    Set objRootLDAP = GetObject(\"LDAP://rootDSE\")\n    namingContext = objRootLDAP.Get(\"defaultNamingContext\") ' e.g. string dc=fabrikam,dc=com    \n    strBase = \"<GC://\" & namingContext & \">\"\n \n    Set objConnection = CreateObject(\"ADODB.Connection\") \n    Set objCommand = CreateObject(\"ADODB.Command\") \n    objConnection.Provider = \"ADsDSOOBject\" \n    objConnection.Open \"Active Directory Provider\" \n    Set objCommand.ActiveConnection = objConnection \n    strFilter = \"(&(objectCategory=Computer)(cn=\" &  strComputerName & \"))\"\n    strQuery = strBase & \";\" & strFilter  & \";distinguishedName;subtree\" \n    objCommand.CommandText = strQuery \n    objCommand.Properties(\"Page Size\") = 100 \n    objCommand.Properties(\"Timeout\") = 100\n    objCommand.Properties(\"Cache Results\") = False \n    ' Enumerate all objects found. \n    Set objRecordSet = objCommand.Execute \n    If objRecordSet.EOF Then\n      WScript.echo \"The computer name '\" &  strComputerName & \"' cannot be found.\"\n      WScript.Quit 1\n    End If\n    ' Found object matching name\n    Do Until objRecordSet.EOF \n      dnFound = objRecordSet.Fields(\"distinguishedName\")\n      GetStrPathToComputer = \"LDAP://\" & dnFound\n      objRecordSet.MoveNext \n    Loop \n    ' Clean up. \n    Set objConnection = Nothing \n    Set objCommand = Nothing \n    Set objRecordSet = Nothing \nEnd Function\n' --------------------------------------------------------------------------------\n' Securely access the Active Directory computer object using Kerberos\n' --------------------------------------------------------------------------------\nSet objDSO = GetObject(\"LDAP:\")\nstrPath = GetStrPathToComputer(strComputerName)\nWScript.Echo \"Accessing object: \" + strPath\nConst ADS_SECURE_AUTHENTICATION = 1\nConst ADS_USE_SEALING = 64 '0x40\nConst ADS_USE_SIGNING = 128 '0x80\nSet objComputer = objDSO.OpenDSObject(strPath, vbNullString, vbNullString, _\n                                   ADS_SECURE_AUTHENTICATION + ADS_USE_SEALING + ADS_USE_SIGNING)\n' --------------------------------------------------------------------------------\n' Get the TPM owner information from the Active Directory computer object\n' --------------------------------------------------------------------------------\nstrOwnerInformation = objComputer.Get(\"msTPM-OwnerInformation\")\nWScript.echo \"msTPM-OwnerInformation: \" + strOwnerInformation\n```\n\n## Additional resources\n\n- [Trusted Platform Module technology overview](trusted-platform-module-overview.md)\n- [TPM fundamentals](tpm-fundamentals.md)\n- [TPM Group Policy settings](trusted-platform-module-services-group-policy-settings.md)\n- [TPM Cmdlets in Windows PowerShell](http://technet.microsoft.com/library/jj603116.aspx)\n- [AD DS schema extensions to support TPM backup](ad-ds-schema-extensions-to-support-tpm-backup.md)\n- [Prepare your organization for BitLocker: Planning and Policies](http://technet.microsoft.com/library/jj592683.aspx), see TPM considerations\n"}
{"nodes":[{"content":"Gathering Other Relevant Information (Windows 10)","pos":[11,60]},{"content":"Gathering Other Relevant Information","pos":[74,110]},{"content":"Gathering Other Relevant Information","pos":[266,302]},{"content":"Applies to","pos":[306,316]},{"content":"Windows 10","pos":[323,333]},{"content":"Windows Server 2016 Technical Preview","pos":[338,375]},{"content":"This topic discusses several other things that you should examine to see whether they will cause any complications in your ability to deploy Windows Firewall with Advanced Security policies in your organization.","pos":[377,588]},{"content":"Capacity considerations","pos":[593,616]},{"content":"Because IPsec uses mathematically intensive cryptographic techniques, it can consume significant overhead on a device.","pos":[618,736]},{"content":"Areas to watch:","pos":[737,752]},{"content":"Encryption.","pos":[760,771]},{"content":"You might use 256-bit Advanced Encryption Standard (AES-256) and 384-bit Secure Hash Algorithm (SHA-384) to check integrity in situations that require the strongest available encryption and key exchange protection.","pos":[774,988]},{"content":"If you have NICs that support IPsec Task Offload, you can reduce the effect that encryption has on network throughput.","pos":[989,1107]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>IPsec Task Offload<ept id=\"p1\">](http://technet.microsoft.com/network/dd277647.aspx)</ept>.","pos":[1108,1207]},{"content":"Security association (SA) negotiation.","pos":[1215,1253]},{"content":"You can use a shorter lifetime for the main mode SA, such as three hours, but then you might need to make tradeoffs.","pos":[1256,1372]},{"content":"Because each main mode SA occupies approximately 5  KB of RAM, situations in which a server brokers tens of thousands of concurrent connections can lead to overutilization.","pos":[1373,1545]},{"content":"NAT devices.","pos":[1553,1565]},{"content":"As discussed earlier, NAT does not allow Authentication Header (AH) conversations between hosts.","pos":[1568,1664]},{"content":"If NAT devices exist on the internal network, ESP must be selected instead of AH.","pos":[1665,1746]},{"content":"Switches and routers.","pos":[1754,1775]},{"content":"Proper capacity planning for the implementation of IPsec is more about thorough testing and expected traffic loads than exact calculations.","pos":[1778,1917]},{"content":"You might have to upgrade or reconfigure switches or routers that currently exceed 75 percent usage to allow for increased traffic on the device and still provide some extra usage for bursts of traffic.","pos":[1918,2120]},{"content":"Other factors.","pos":[2128,2142]},{"content":"These include CPU usage on network infrastructure servers, increased overhead on servers and workstations running IPsec (especially servers, because they usually contain more main mode SAs than clients), and increased network latency because of IPsec negotiation.","pos":[2145,2408]},{"pos":[2415,2578],"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept>  When Microsoft deployed its own domain isolation solution, it found a one to three percent increase in usage on the network as a direct result of IPsec."},{"content":"Group Policy deployment groups and WMI filters","pos":[2583,2629]},{"content":"You do not have to rearrange the organization unit (OU) hierarchy of your Active Directory domains to effectively deploy Windows Firewall with Advanced Security GPOs.","pos":[2631,2797]},{"content":"Instead, you can link your GPOs at the domain level (or another high level container), and then use security group filtering or WMI filtering to ensure that only the appropriate devices or users can apply the GPO settings.","pos":[2798,3020]},{"content":"We recommend that you use WMI filtering to dynamically ensure that GPOs apply only to devices that are running the correct operating system.","pos":[3021,3161]},{"content":"It is not necessary to use this technique if your network consists of devices.","pos":[3162,3240]},{"content":"Different Active Directory trust environments","pos":[3245,3290]},{"content":"When you design a domain isolation policy, consider any logical boundaries that might affect IPsec-secured communications.","pos":[3292,3414]},{"content":"For example, the trust relationships between your domains and forests are critical in determining an appropriate IKE authentication method.","pos":[3415,3554]},{"content":"Kerberos V5 authentication is recommended for use in a two-way (mutual) domain and forest trust environment.","pos":[3556,3664]},{"content":"You can use Kerberos V5 for IKE authentication across domains that have two-way trusts established, if the domains are in the same forest or different forests.","pos":[3665,3824]},{"content":"If the two domains are in different forests, you must configure two external trusts, one for each direction, between the domains.","pos":[3825,3954]},{"content":"The external trusts must use the fully qualified domain name (FQDN) of the domains, and IPsec policy must allow an IKE initiator in one domain to communicate with any domain controller in the forest domain hierarchy, so that the initiator can obtain a Kerberos V5 ticket from a domain controller in the responder’s domain.","pos":[3955,4277]},{"content":"If firewalls separate the domains then you must configure the firewall to allow Kerberos V5 traffic over UDP destination port 88, TCP destination port 88, and UDP destination port 389.","pos":[4278,4462]},{"content":"If the use of Kerberos V5 authentication is not possible because two-way trusts across forests cannot be established as in some large enterprise environments, you can use a public key infrastructure (PKI) and digital certificates to establish IPsec-trusted communication.","pos":[4464,4735]},{"content":"Creating firewall rules to permit IKE, AH, and ESP traffic","pos":[4740,4798]},{"content":"In some cases, IPsec-secured traffic might have to pass through a router, perimeter firewall, or other filtering device.","pos":[4801,4921]},{"content":"In the case of a router, unless the router filters TCP and UDP traffic or other upper-level protocol headers, no special configuration is required to allow the IPsec traffic to be forwarded.","pos":[4922,5112]},{"content":"In the case of a filtering router or a firewall, you must configure these devices to allow IPsec traffic to be forwarded.","pos":[5114,5235]},{"content":"Configure the firewall to allow IPsec traffic on UDP source and destination port 500 (IKE), UDP source and destination port 4500 (IPsec NAT-T), and IP Protocol 50 (ESP).","pos":[5236,5405]},{"content":"You might also have to configure the firewall to allow IPsec traffic on IP protocol 51 (AH) to allow troubleshooting by IPsec administrators and to allow the IPsec traffic to be inspected.","pos":[5406,5594]},{"pos":[5596,5710],"content":"For more info, see <bpt id=\"p1\">[</bpt>How to Enable IPsec Traffic Through a Firewall<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=45085)</ept>."},{"content":"Network load balancing and server clusters","pos":[5715,5757]},{"content":"There are challenges implementing connection security for network traffic going to and from network load balancing (NLB) clusters and server clusters.","pos":[5759,5909]},{"content":"NLB enables multiple servers to be clustered together to provide high availability for a service by providing automatic failover to other nodes in the cluster.","pos":[5910,6069]},{"content":"Because IPsec matches a security association to a specific device, it prevents different devices from handling the same client connection.","pos":[6070,6208]},{"content":"If a different node in the cluster responds to an IPsec connection that was originally established by another node, the traffic will be dropped by the client device as untrusted.","pos":[6209,6387]},{"content":"This means that NLB in \"no affinity\" mode is not supported by IPsec at all.","pos":[6389,6464]},{"content":"If you must use \"no affinity\" mode in the cluster then consider including the servers that make up the cluster in your IPsec exemption group, and allowing clients to communicate with the servers without IPsec.","pos":[6465,6674]},{"content":"When a TCP connection is dropped because of a cluster node failover, IPsec detects the TCP connection failure and removes the IPsec SAs for that connection.","pos":[6676,6832]},{"content":"When the new TCP connection is established to another node, IPsec can negotiate new SAs immediately without having to wait for the obsolete SAs to time out.","pos":[6833,6989]},{"content":"Network inspection technologies","pos":[6994,7025]},{"content":"Within a TCP/IP packet, IPsec without encryption changes the offsets for the destination ports and protocols.","pos":[7027,7136]},{"content":"These changes can adversely affect applications that are running on network devices such as routers that monitor and manage traffic on the network.","pos":[7137,7284]},{"content":"While some network applications have been updated to support IPsec, some are not yet compatible.","pos":[7285,7381]},{"content":"Check with the vendor of your device to see whether the changes in the protocol and port fields caused by IPsec are compatible with the device.","pos":[7382,7525]},{"content":"Any device designed to view network traffic, such as hardware protocol analyzers or Microsoft Network Monitor, cannot parse ESP-encrypted traffic.","pos":[7527,7673]},{"content":"Only the destination device, with which the originating device negotiated the connection, can decrypt the traffic.","pos":[7674,7788]},{"content":"In general, IPsec defeats network-based prioritization and port- or protocol-based traffic management.","pos":[7790,7892]},{"content":"For encrypted packets, there is no workaround; the host itself must handle any traffic management functions.","pos":[7893,8001]},{"content":"For unencrypted, authenticated-only packets, the devices and applications must be aware of how IPsec changes packets to be able to do anything with them other than route them to the correct host.","pos":[8002,8197]},{"content":"If you cannot upgrade monitoring or management devices to support IPsec, it is important that you record this information and figure it into your domain or server isolation design.","pos":[8198,8378]},{"content":"Network Monitor includes parsers for the ISAKMP (IKE), AH, and ESP protocols.","pos":[8380,8457]},{"content":"Network Monitor parsers for ESP can parse inside the ESP packet only if ESP null-encryption is being used.","pos":[8458,8564]},{"content":"Network Monitor cannot parse the encrypted parts of IPsec ESP traffic when encryption is performed in software.","pos":[8565,8676]},{"content":"However, if encryption is performed by an IPsec hardware offload network adapter, the ESP packets can be decrypted when Network Monitor captures them on either the source or the destination and, therefore, they can be parsed.","pos":[8677,8902]},{"content":"To diagnose ESP software-encrypted communication, you must disable ESP encryption and use ESP-null encryption by changing the IPsec policy or connection security rule on both devices.","pos":[8903,9086]},{"pos":[9088,9211],"content":"Message Analyzer is available on the <bpt id=\"p1\">[</bpt>Microsoft Download Center<ept id=\"p1\">](https://www.microsoft.com/download/details.aspx?id=44226)</ept>."},{"pos":[9213,9320],"content":"<bpt id=\"p1\">**</bpt>Next: <ept id=\"p1\">**</ept><bpt id=\"p2\">[</bpt>Determining the Trusted State of Your Devices<ept id=\"p2\">](determining-the-trusted-state-of-your-devices.md)</ept>"}],"content":"---\ntitle: Gathering Other Relevant Information (Windows 10)\ndescription: Gathering Other Relevant Information\nms.assetid: 87ccca07-4346-496b-876d-cdde57d0ce17\nms.prod: w10\nms.mktglfcycl: deploy\nms.sitesec: library\nms.pagetype: security\nauthor: brianlic-msft\n---\n\n# Gathering Other Relevant Information\n\n**Applies to**\n-   Windows 10\n-   Windows Server 2016 Technical Preview\n\nThis topic discusses several other things that you should examine to see whether they will cause any complications in your ability to deploy Windows Firewall with Advanced Security policies in your organization.\n\n## Capacity considerations\n\nBecause IPsec uses mathematically intensive cryptographic techniques, it can consume significant overhead on a device. Areas to watch:\n\n-   **Encryption.** You might use 256-bit Advanced Encryption Standard (AES-256) and 384-bit Secure Hash Algorithm (SHA-384) to check integrity in situations that require the strongest available encryption and key exchange protection. If you have NICs that support IPsec Task Offload, you can reduce the effect that encryption has on network throughput. For more information, see [IPsec Task Offload](http://technet.microsoft.com/network/dd277647.aspx).\n\n-   **Security association (SA) negotiation.** You can use a shorter lifetime for the main mode SA, such as three hours, but then you might need to make tradeoffs. Because each main mode SA occupies approximately 5  KB of RAM, situations in which a server brokers tens of thousands of concurrent connections can lead to overutilization.\n\n-   **NAT devices.** As discussed earlier, NAT does not allow Authentication Header (AH) conversations between hosts. If NAT devices exist on the internal network, ESP must be selected instead of AH.\n\n-   **Switches and routers.** Proper capacity planning for the implementation of IPsec is more about thorough testing and expected traffic loads than exact calculations. You might have to upgrade or reconfigure switches or routers that currently exceed 75 percent usage to allow for increased traffic on the device and still provide some extra usage for bursts of traffic.\n\n-   **Other factors.** These include CPU usage on network infrastructure servers, increased overhead on servers and workstations running IPsec (especially servers, because they usually contain more main mode SAs than clients), and increased network latency because of IPsec negotiation.\n\n    >**Note:**  When Microsoft deployed its own domain isolation solution, it found a one to three percent increase in usage on the network as a direct result of IPsec.\n\n## Group Policy deployment groups and WMI filters\n\nYou do not have to rearrange the organization unit (OU) hierarchy of your Active Directory domains to effectively deploy Windows Firewall with Advanced Security GPOs. Instead, you can link your GPOs at the domain level (or another high level container), and then use security group filtering or WMI filtering to ensure that only the appropriate devices or users can apply the GPO settings. We recommend that you use WMI filtering to dynamically ensure that GPOs apply only to devices that are running the correct operating system. It is not necessary to use this technique if your network consists of devices.\n\n## Different Active Directory trust environments\n\nWhen you design a domain isolation policy, consider any logical boundaries that might affect IPsec-secured communications. For example, the trust relationships between your domains and forests are critical in determining an appropriate IKE authentication method.\n\nKerberos V5 authentication is recommended for use in a two-way (mutual) domain and forest trust environment. You can use Kerberos V5 for IKE authentication across domains that have two-way trusts established, if the domains are in the same forest or different forests. If the two domains are in different forests, you must configure two external trusts, one for each direction, between the domains. The external trusts must use the fully qualified domain name (FQDN) of the domains, and IPsec policy must allow an IKE initiator in one domain to communicate with any domain controller in the forest domain hierarchy, so that the initiator can obtain a Kerberos V5 ticket from a domain controller in the responder’s domain. If firewalls separate the domains then you must configure the firewall to allow Kerberos V5 traffic over UDP destination port 88, TCP destination port 88, and UDP destination port 389.\n\nIf the use of Kerberos V5 authentication is not possible because two-way trusts across forests cannot be established as in some large enterprise environments, you can use a public key infrastructure (PKI) and digital certificates to establish IPsec-trusted communication.\n\n## Creating firewall rules to permit IKE, AH, and ESP traffic\n\n\nIn some cases, IPsec-secured traffic might have to pass through a router, perimeter firewall, or other filtering device. In the case of a router, unless the router filters TCP and UDP traffic or other upper-level protocol headers, no special configuration is required to allow the IPsec traffic to be forwarded.\n\nIn the case of a filtering router or a firewall, you must configure these devices to allow IPsec traffic to be forwarded. Configure the firewall to allow IPsec traffic on UDP source and destination port 500 (IKE), UDP source and destination port 4500 (IPsec NAT-T), and IP Protocol 50 (ESP). You might also have to configure the firewall to allow IPsec traffic on IP protocol 51 (AH) to allow troubleshooting by IPsec administrators and to allow the IPsec traffic to be inspected.\n\nFor more info, see [How to Enable IPsec Traffic Through a Firewall](http://go.microsoft.com/fwlink/?LinkId=45085).\n\n## Network load balancing and server clusters\n\nThere are challenges implementing connection security for network traffic going to and from network load balancing (NLB) clusters and server clusters. NLB enables multiple servers to be clustered together to provide high availability for a service by providing automatic failover to other nodes in the cluster. Because IPsec matches a security association to a specific device, it prevents different devices from handling the same client connection. If a different node in the cluster responds to an IPsec connection that was originally established by another node, the traffic will be dropped by the client device as untrusted.\n\nThis means that NLB in \"no affinity\" mode is not supported by IPsec at all. If you must use \"no affinity\" mode in the cluster then consider including the servers that make up the cluster in your IPsec exemption group, and allowing clients to communicate with the servers without IPsec.\n\nWhen a TCP connection is dropped because of a cluster node failover, IPsec detects the TCP connection failure and removes the IPsec SAs for that connection. When the new TCP connection is established to another node, IPsec can negotiate new SAs immediately without having to wait for the obsolete SAs to time out.\n\n## Network inspection technologies\n\nWithin a TCP/IP packet, IPsec without encryption changes the offsets for the destination ports and protocols. These changes can adversely affect applications that are running on network devices such as routers that monitor and manage traffic on the network. While some network applications have been updated to support IPsec, some are not yet compatible. Check with the vendor of your device to see whether the changes in the protocol and port fields caused by IPsec are compatible with the device.\n\nAny device designed to view network traffic, such as hardware protocol analyzers or Microsoft Network Monitor, cannot parse ESP-encrypted traffic. Only the destination device, with which the originating device negotiated the connection, can decrypt the traffic.\n\nIn general, IPsec defeats network-based prioritization and port- or protocol-based traffic management. For encrypted packets, there is no workaround; the host itself must handle any traffic management functions. For unencrypted, authenticated-only packets, the devices and applications must be aware of how IPsec changes packets to be able to do anything with them other than route them to the correct host. If you cannot upgrade monitoring or management devices to support IPsec, it is important that you record this information and figure it into your domain or server isolation design.\n\nNetwork Monitor includes parsers for the ISAKMP (IKE), AH, and ESP protocols. Network Monitor parsers for ESP can parse inside the ESP packet only if ESP null-encryption is being used. Network Monitor cannot parse the encrypted parts of IPsec ESP traffic when encryption is performed in software. However, if encryption is performed by an IPsec hardware offload network adapter, the ESP packets can be decrypted when Network Monitor captures them on either the source or the destination and, therefore, they can be parsed. To diagnose ESP software-encrypted communication, you must disable ESP encryption and use ESP-null encryption by changing the IPsec policy or connection security rule on both devices.\n\nMessage Analyzer is available on the [Microsoft Download Center](https://www.microsoft.com/download/details.aspx?id=44226).\n\n**Next: **[Determining the Trusted State of Your Devices](determining-the-trusted-state-of-your-devices.md)\n"}
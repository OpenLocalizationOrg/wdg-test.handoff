{"nodes":[{"content":"5156(S) The Windows Filtering Platform has permitted a connection.","pos":[11,77]},{"content":"(Windows 10)","pos":[78,90]},{"content":"Describes security event 5156(S) The Windows Filtering Platform has permitted a connection.","pos":[104,195]},{"content":"5156(S): The Windows Filtering Platform has permitted a connection.","pos":[295,362]},{"content":"Applies to","pos":[366,376]},{"content":"Windows 10","pos":[383,393]},{"content":"Windows Server 2016","pos":[398,417]},{"pos":[537,638],"content":"<bpt id=\"p1\">***</bpt>Subcategory:<ept id=\"p1\">***</ept><ph id=\"ph1\">&amp;nbsp;</ph><bpt id=\"p2\">[</bpt>Audit Filtering Platform Connection<ept id=\"p2\">](audit-filtering-platform-connection.md)</ept>"},{"content":"Event Description:","pos":[643,661]},{"pos":[666,827],"content":"This event generates when <bpt id=\"p1\">[</bpt>Windows Filtering Platform<ept id=\"p1\">](https://msdn.microsoft.com/en-us/library/windows/desktop/aa366510(v=vs.85).aspx)</ept> has allowed a connection."},{"pos":[831,967],"content":"<bpt id=\"p1\">**</bpt>Note<ept id=\"p1\">**</ept><ph id=\"ph1\">&amp;nbsp;&amp;nbsp;</ph>For recommendations, see <bpt id=\"p2\">[</bpt>Security Monitoring Recommendations<ept id=\"p2\">](#security-monitoring-recommendations)</ept> for this event."},{"content":"Event XML:","pos":[990,1000]},{"pos":[2219,2253],"content":"<bpt id=\"p1\">***</bpt>Required Server Roles:<ept id=\"p1\">***</ept> None."},{"pos":[2255,2316],"content":"<bpt id=\"p1\">***</bpt>Minimum OS Version:<ept id=\"p1\">***</ept> Windows Server 2008, Windows Vista."},{"pos":[2318,2342],"content":"<bpt id=\"p1\">***</bpt>Event Versions:<ept id=\"p1\">***</ept> 0."},{"content":"Field Descriptions:","pos":[2347,2366]},{"pos":[2371,2399],"content":"<bpt id=\"p1\">**</bpt>Application Information<ept id=\"p1\">**</ept>:"},{"content":"<bpt id=\"p1\">**</bpt>Process ID<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = Pointer<ph id=\"ph2\">\\]</ph>: hexadecimal Process ID of the process which received the connection.","pos":[2405,2508]},{"content":"Process ID (PID) is a number used by the operating system to uniquely identify an active process.","pos":[2509,2606]},{"content":"To see the PID for a specific process you can, for example, use Task Manager (Details tab, PID column):","pos":[2607,2710]},{"content":"If you convert the hexadecimal value to decimal, you can compare it to the values in Task Manager.","pos":[2816,2914]},{"pos":[2920,3103],"content":"You can also correlate this process ID with a process ID in other events, for example, “<bpt id=\"p1\">[</bpt>4688<ept id=\"p1\">](event-4688.md)</ept>: A new process has been created” <bpt id=\"p2\">**</bpt>Process Information<ph id=\"ph1\">\\\\</ph>New Process ID<ept id=\"p2\">**</ept>."},{"pos":[3109,3217],"content":"<bpt id=\"p1\">**</bpt>Application Name<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UnicodeString<ph id=\"ph2\">\\]</ph><bpt id=\"p2\">**</bpt>:<ept id=\"p2\">**</ept> full path and the name of the executable for the process."},{"content":"Logical disk is displayed in format <ph id=\"ph1\">\\\\</ph>device<ph id=\"ph2\">\\\\</ph>harddiskvolume<ph id=\"ph3\">\\#</ph>.","pos":[3223,3286]},{"content":"You can get all local volume numbers by using <bpt id=\"p1\">**</bpt>diskpart<ept id=\"p1\">**</ept> utility.","pos":[3287,3354]},{"content":"The command to get volume numbers using diskpart is “<bpt id=\"p1\">**</bpt>list volume”<ept id=\"p1\">**</ept>:","pos":[3355,3425]},{"content":"Network Information:","pos":[3517,3537]},{"pos":[3545,3617],"content":"<bpt id=\"p1\">**</bpt>Direction<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UnicodeString<ph id=\"ph2\">\\]</ph>: direction of allowed connection."},{"content":"Inbound – for inbound connections.","pos":[3627,3661]},{"content":"Outbound – for unbound connections.","pos":[3671,3706]},{"pos":[3712,3823],"content":"<bpt id=\"p1\">**</bpt>Source Address<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UnicodeString<ph id=\"ph2\">\\]</ph><bpt id=\"p2\">**</bpt>:<ept id=\"p2\">**</ept> local IP address on which application received the connection."},{"content":"IPv4 Address","pos":[3833,3845]},{"content":"IPv6 Address","pos":[3855,3867]},{"content":":: - all IP addresses in IPv6 format","pos":[3877,3913]},{"content":"0.0.0.0 - all IP addresses in IPv4 format","pos":[3923,3964]},{"content":"127.0.0.1 , ::1 - localhost","pos":[3974,4001]},{"pos":[4007,4110],"content":"<bpt id=\"p1\">**</bpt>Source Port<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UnicodeString<ph id=\"ph2\">\\]</ph><bpt id=\"p2\">**</bpt>:<ept id=\"p2\">**</ept> port number on which application received the connection."},{"pos":[4116,4235],"content":"<bpt id=\"p1\">**</bpt>Destination Address<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UnicodeString<ph id=\"ph2\">\\]</ph><bpt id=\"p2\">**</bpt>:<ept id=\"p2\">**</ept> IP address <bpt id=\"p3\">***</bpt>from<ept id=\"p3\">***</ept> which connection was received or initiated."},{"content":"IPv4 Address","pos":[4245,4257]},{"content":"IPv6 Address","pos":[4267,4279]},{"content":":: - all IP addresses in IPv6 format","pos":[4289,4325]},{"content":"0.0.0.0 - all IP addresses in IPv4 format","pos":[4335,4376]},{"content":"127.0.0.1 , ::1 - localhost","pos":[4386,4413]},{"pos":[4419,4540],"content":"<bpt id=\"p1\">**</bpt>Destination Port<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UnicodeString<ph id=\"ph2\">\\]</ph><bpt id=\"p2\">**</bpt>:<ept id=\"p2\">**</ept> port number which was used from remote machine to initiate connection."},{"pos":[4546,4612],"content":"<bpt id=\"p1\">**</bpt>Protocol<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UInt32<ph id=\"ph2\">\\]</ph>: number of protocol which was used."},{"content":"Service","pos":[4616,4623]},{"content":"Protocol Number","pos":[4669,4684]},{"content":"Internet Control Message Protocol (ICMP)","pos":[4762,4802]},{"content":"1","pos":[4815,4816]},{"content":"Transmission Control Protocol (TCP)","pos":[4835,4870]},{"content":"6","pos":[4888,4889]},{"content":"User Datagram Protocol (UDP)","pos":[4908,4936]},{"content":"17","pos":[4961,4963]},{"content":"General Routing Encapsulation (PPTP data over GRE)","pos":[4981,5031]},{"content":"47","pos":[5034,5036]},{"content":"Authentication Header (AH) IPSec","pos":[5054,5086]},{"content":"51","pos":[5107,5109]},{"content":"Encapsulation Security Payload (ESP) IPSec","pos":[5127,5169]},{"content":"50","pos":[5180,5182]},{"content":"Exterior Gateway Protocol (EGP)","pos":[5200,5231]},{"content":"8","pos":[5253,5254]},{"content":"Gateway-Gateway Protocol (GGP)","pos":[5273,5303]},{"content":"3","pos":[5326,5327]},{"content":"Host Monitoring Protocol (HMP)","pos":[5346,5376]},{"content":"20","pos":[5399,5401]},{"content":"Internet Group Management Protocol (IGMP)","pos":[5419,5460]},{"content":"88","pos":[5472,5474]},{"content":"MIT Remote Virtual Disk (RVD)","pos":[5492,5521]},{"content":"66","pos":[5545,5547]},{"content":"OSPF Open Shortest Path First","pos":[5565,5594]},{"content":"89","pos":[5618,5620]},{"content":"PARC Universal Packet Protocol (PUP)","pos":[5638,5674]},{"content":"12","pos":[5691,5693]},{"content":"Reliable Datagram Protocol (RDP)","pos":[5711,5743]},{"content":"27","pos":[5764,5766]},{"content":"Reservation Protocol (RSVP) QoS","pos":[5784,5815]},{"content":"46","pos":[5837,5839]},{"content":"Filter Information:","pos":[5858,5877]},{"pos":[5885,5973],"content":"<bpt id=\"p1\">**</bpt>Filter Run-Time ID<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UInt64<ph id=\"ph2\">\\]</ph>: unique filter ID which allowed the connection."},{"content":"To find specific Windows Filtering Platform filter by ID you need to execute the following command: <bpt id=\"p1\">**</bpt>netsh wfp show filters<ept id=\"p1\">**</ept>.","pos":[5979,6106]},{"content":"As result of this command <bpt id=\"p1\">**</bpt>filters.xml<ept id=\"p1\">**</ept> file will be generated.","pos":[6107,6172]},{"content":"You need to open this file and find specific substring with required filter ID (<bpt id=\"p1\">**</bpt><ph id=\"ph1\">&amp;lt;</ph>filterId<ph id=\"ph2\">&amp;gt;</ph><ept id=\"p1\">**</ept>)<bpt id=\"p2\">**</bpt>,<ept id=\"p2\">**</ept> for example:","pos":[6173,6292]},{"pos":[6402,6567],"content":"<bpt id=\"p1\">**</bpt>Layer Name<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UnicodeString<ph id=\"ph2\">\\]</ph>: <bpt id=\"p2\">[</bpt>Application Layer Enforcement<ept id=\"p2\">](https://msdn.microsoft.com/en-us/library/windows/desktop/aa363971(v=vs.85).aspx)</ept> layer name."},{"content":"<bpt id=\"p1\">**</bpt>Layer Run-Time ID<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\[</ph>Type = UInt64<ph id=\"ph2\">\\]</ph>: Windows Filtering Platform layer identifier.","pos":[6573,6658]},{"content":"To find specific Windows Filtering Platform layer ID you need to execute the following command: <bpt id=\"p1\">**</bpt>netsh wfp show state<ept id=\"p1\">**</ept>.","pos":[6659,6780]},{"content":"As result of this command <bpt id=\"p1\">**</bpt>wfpstate.xml<ept id=\"p1\">**</ept> file will be generated.","pos":[6781,6847]},{"content":"You need to open this file and find specific substring with required layer ID (<bpt id=\"p1\">**</bpt><ph id=\"ph1\">&amp;lt;</ph>layerId<ph id=\"ph2\">&amp;gt;</ph><ept id=\"p1\">**</ept>)<bpt id=\"p2\">**</bpt>,<ept id=\"p2\">**</ept> for example:","pos":[6848,6965]},{"content":"Security Monitoring Recommendations","pos":[7067,7102]},{"content":"For 5156(S): The Windows Filtering Platform has permitted a connection.","pos":[7104,7175]},{"pos":[7181,7374],"content":"If you have a pre-defined application which should be used to perform the operation that was reported by this event, monitor events with “<bpt id=\"p1\">**</bpt>Application<ept id=\"p1\">**</ept>” not equal to your defined application."},{"pos":[7380,7581],"content":"You can monitor to see if “<bpt id=\"p1\">**</bpt>Application<ept id=\"p1\">**</ept>” is not in a standard folder (for example, not in <bpt id=\"p2\">**</bpt>System32<ept id=\"p2\">**</ept> or <bpt id=\"p3\">**</bpt>Program Files<ept id=\"p3\">**</ept>) or is in a restricted folder (for example, <bpt id=\"p4\">**</bpt>Temporary Internet Files<ept id=\"p4\">**</ept>)."},{"pos":[7587,7770],"content":"If you have a pre-defined list of restricted substrings or words in application names (for example, “<bpt id=\"p1\">**</bpt>mimikatz<ept id=\"p1\">**</ept>” or “<bpt id=\"p2\">**</bpt>cain.exe<ept id=\"p2\">**</ept>”), check for these substrings in “<bpt id=\"p3\">**</bpt>Application<ept id=\"p3\">**</ept>.”"},{"pos":[7776,7857],"content":"Check that “<bpt id=\"p1\">**</bpt>Source Address”<ept id=\"p1\">**</ept> is one of the addresses assigned to the computer."},{"pos":[7863,8132],"content":"If the computer or device should not have access to the Internet, or contains only applications that don’t connect to the Internet, monitor for <bpt id=\"p1\">[</bpt>5156<ept id=\"p1\">](event-5156.md)</ept> events where “<bpt id=\"p2\">**</bpt>Destination Address”<ept id=\"p2\">**</ept> is an IP address from the Internet (not from private IP ranges)."},{"pos":[8138,8299],"content":"If you know that the computer should never contact or be contacted by certain network IP addresses, monitor for these addresses in “<bpt id=\"p1\">**</bpt>Destination Address<ept id=\"p1\">**</ept>.<bpt id=\"p2\">**</bpt>”<ept id=\"p2\">**</ept>"},{"pos":[8305,8502],"content":"If you have a “whitelist” of IP addresses that the computer or device is expected to contact or be contacted by, monitor for IP addresses in “<bpt id=\"p1\">**</bpt>Destination Address”<ept id=\"p1\">**</ept> that are not in the whitelist."},{"pos":[8508,8654],"content":"If you need to monitor all inbound connections to a specific local port, monitor for <bpt id=\"p1\">[</bpt>5156<ept id=\"p1\">](event-5156.md)</ept> events with that “<bpt id=\"p2\">**</bpt>Source Port<ept id=\"p2\">**</ept>.<bpt id=\"p3\">**</bpt>”<ept id=\"p3\">**</ept>"},{"pos":[8660,8810],"content":"Monitor for all connections with a “<bpt id=\"p1\">**</bpt>Protocol Number”<ept id=\"p1\">**</ept> that is not typical for this device or compter, for example, anything other than 1, 6, or 17."},{"pos":[8816,8981],"content":"If the computer’s communication with “<bpt id=\"p1\">**</bpt>Destination Address”<ept id=\"p1\">**</ept> should always use a specific “<bpt id=\"p2\">**</bpt>Destination Port<ept id=\"p2\">**</ept>,<bpt id=\"p3\">**</bpt>”<ept id=\"p3\">**</ept> monitor for any other “<bpt id=\"p4\">**</bpt>Destination Port<ept id=\"p4\">**</ept>.”"}],"content":"---\ntitle: 5156(S) The Windows Filtering Platform has permitted a connection. (Windows 10)\ndescription: Describes security event 5156(S) The Windows Filtering Platform has permitted a connection.\nms.pagetype: security\nms.prod: w10\nms.mktglfcycl: deploy\nms.sitesec: library\nauthor: Mir0sh\n---\n\n# 5156(S): The Windows Filtering Platform has permitted a connection.\n\n**Applies to**\n-   Windows 10\n-   Windows Server 2016\n\n\n<img src=\"images/event-5156.png\" alt=\"Event 5156 illustration\" width=\"491\" height=\"506\" hspace=\"10\" align=\"left\" />\n\n***Subcategory:***&nbsp;[Audit Filtering Platform Connection](audit-filtering-platform-connection.md)\n\n***Event Description:***\n\nThis event generates when [Windows Filtering Platform](https://msdn.microsoft.com/en-us/library/windows/desktop/aa366510(v=vs.85).aspx) has allowed a connection.\n\n> **Note**&nbsp;&nbsp;For recommendations, see [Security Monitoring Recommendations](#security-monitoring-recommendations) for this event.\n\n<br clear=\"all\">\n\n***Event XML:***\n```\n- <Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\n- <System>\n <Provider Name=\"Microsoft-Windows-Security-Auditing\" Guid=\"{54849625-5478-4994-A5BA-3E3B0328C30D}\" /> \n <EventID>5156</EventID> \n <Version>1</Version> \n <Level>0</Level> \n <Task>12810</Task> \n <Opcode>0</Opcode> \n <Keywords>0x8020000000000000</Keywords> \n <TimeCreated SystemTime=\"2015-09-22T05:24:22.622090200Z\" /> \n <EventRecordID>308129</EventRecordID> \n <Correlation /> \n <Execution ProcessID=\"4\" ThreadID=\"3712\" /> \n <Channel>Security</Channel> \n <Computer>DC01.contoso.local</Computer> \n <Security /> \n </System>\n- <EventData>\n <Data Name=\"ProcessID\">4556</Data> \n <Data Name=\"Application\">\\\\device\\\\harddiskvolume2\\\\documents\\\\listener.exe</Data> \n <Data Name=\"Direction\">%%14592</Data> \n <Data Name=\"SourceAddress\">10.0.0.10</Data> \n <Data Name=\"SourcePort\">3333</Data> \n <Data Name=\"DestAddress\">10.0.0.100</Data> \n <Data Name=\"DestPort\">49278</Data> \n <Data Name=\"Protocol\">6</Data> \n <Data Name=\"FilterRTID\">70201</Data> \n <Data Name=\"LayerName\">%%14610</Data> \n <Data Name=\"LayerRTID\">44</Data> \n <Data Name=\"RemoteUserID\">S-1-0-0</Data> \n <Data Name=\"RemoteMachineID\">S-1-0-0</Data> \n </EventData>\n </Event>\n\n```\n\n***Required Server Roles:*** None.\n\n***Minimum OS Version:*** Windows Server 2008, Windows Vista.\n\n***Event Versions:*** 0.\n\n***Field Descriptions:***\n\n**Application Information**:\n\n-   **Process ID** \\[Type = Pointer\\]: hexadecimal Process ID of the process which received the connection. Process ID (PID) is a number used by the operating system to uniquely identify an active process. To see the PID for a specific process you can, for example, use Task Manager (Details tab, PID column):\n\n    <img src=\"images/task-manager.png\" alt=\"Task manager illustration\" width=\"585\" height=\"375\" />\n\n    If you convert the hexadecimal value to decimal, you can compare it to the values in Task Manager.\n\n    You can also correlate this process ID with a process ID in other events, for example, “[4688](event-4688.md): A new process has been created” **Process Information\\\\New Process ID**.\n\n-   **Application Name** \\[Type = UnicodeString\\]**:** full path and the name of the executable for the process.\n\n    Logical disk is displayed in format \\\\device\\\\harddiskvolume\\#. You can get all local volume numbers by using **diskpart** utility. The command to get volume numbers using diskpart is “**list volume”**:\n\n<img src=\"images/diskpart.png\" alt=\"DiskPart illustration\" width=\"786\" height=\"246\" />\n\n**Network Information:**\n\n-   **Direction** \\[Type = UnicodeString\\]: direction of allowed connection.\n\n    -   Inbound – for inbound connections.\n\n    -   Outbound – for unbound connections.\n\n-   **Source Address** \\[Type = UnicodeString\\]**:** local IP address on which application received the connection.\n\n    -   IPv4 Address\n\n    -   IPv6 Address\n\n    -   :: - all IP addresses in IPv6 format\n\n    -   0.0.0.0 - all IP addresses in IPv4 format\n\n    -   127.0.0.1 , ::1 - localhost\n\n-   **Source Port** \\[Type = UnicodeString\\]**:** port number on which application received the connection.\n\n-   **Destination Address** \\[Type = UnicodeString\\]**:** IP address ***from*** which connection was received or initiated.\n\n    -   IPv4 Address\n\n    -   IPv6 Address\n\n    -   :: - all IP addresses in IPv6 format\n\n    -   0.0.0.0 - all IP addresses in IPv4 format\n\n    -   127.0.0.1 , ::1 - localhost\n\n-   **Destination Port** \\[Type = UnicodeString\\]**:** port number which was used from remote machine to initiate connection.\n\n-   **Protocol** \\[Type = UInt32\\]: number of protocol which was used.\n\n| Service                                            | Protocol Number |\n|----------------------------------------------------|-----------------|\n| Internet Control Message Protocol (ICMP)           | 1               |\n| Transmission Control Protocol (TCP)                | 6               |\n| User Datagram Protocol (UDP)                       | 17              |\n| General Routing Encapsulation (PPTP data over GRE) | 47              |\n| Authentication Header (AH) IPSec                   | 51              |\n| Encapsulation Security Payload (ESP) IPSec         | 50              |\n| Exterior Gateway Protocol (EGP)                    | 8               |\n| Gateway-Gateway Protocol (GGP)                     | 3               |\n| Host Monitoring Protocol (HMP)                     | 20              |\n| Internet Group Management Protocol (IGMP)          | 88              |\n| MIT Remote Virtual Disk (RVD)                      | 66              |\n| OSPF Open Shortest Path First                      | 89              |\n| PARC Universal Packet Protocol (PUP)               | 12              |\n| Reliable Datagram Protocol (RDP)                   | 27              |\n| Reservation Protocol (RSVP) QoS                    | 46              |\n\n**Filter Information:**\n\n-   **Filter Run-Time ID** \\[Type = UInt64\\]: unique filter ID which allowed the connection.\n\n    To find specific Windows Filtering Platform filter by ID you need to execute the following command: **netsh wfp show filters**. As result of this command **filters.xml** file will be generated. You need to open this file and find specific substring with required filter ID (**&lt;filterId&gt;**)**,** for example:\n\n<img src=\"images/filters-xml-file.png\" alt=\"Filters.xml file illustration\" width=\"840\" height=\"176\" />\n\n-   **Layer Name** \\[Type = UnicodeString\\]: [Application Layer Enforcement](https://msdn.microsoft.com/en-us/library/windows/desktop/aa363971(v=vs.85).aspx) layer name.\n\n-   **Layer Run-Time ID** \\[Type = UInt64\\]: Windows Filtering Platform layer identifier. To find specific Windows Filtering Platform layer ID you need to execute the following command: **netsh wfp show state**. As result of this command **wfpstate.xml** file will be generated. You need to open this file and find specific substring with required layer ID (**&lt;layerId&gt;**)**,** for example:\n\n<img src=\"images/wfpstate-xml.png\" alt=\"Wfpstate xml illustration\" width=\"1563\" height=\"780\" />\n\n## Security Monitoring Recommendations\n\nFor 5156(S): The Windows Filtering Platform has permitted a connection.\n\n-   If you have a pre-defined application which should be used to perform the operation that was reported by this event, monitor events with “**Application**” not equal to your defined application.\n\n-   You can monitor to see if “**Application**” is not in a standard folder (for example, not in **System32** or **Program Files**) or is in a restricted folder (for example, **Temporary Internet Files**).\n\n-   If you have a pre-defined list of restricted substrings or words in application names (for example, “**mimikatz**” or “**cain.exe**”), check for these substrings in “**Application**.”\n\n-   Check that “**Source Address”** is one of the addresses assigned to the computer.\n\n-   If the computer or device should not have access to the Internet, or contains only applications that don’t connect to the Internet, monitor for [5156](event-5156.md) events where “**Destination Address”** is an IP address from the Internet (not from private IP ranges).\n\n-   If you know that the computer should never contact or be contacted by certain network IP addresses, monitor for these addresses in “**Destination Address**.**”**\n\n-   If you have a “whitelist” of IP addresses that the computer or device is expected to contact or be contacted by, monitor for IP addresses in “**Destination Address”** that are not in the whitelist.\n\n-   If you need to monitor all inbound connections to a specific local port, monitor for [5156](event-5156.md) events with that “**Source Port**.**”**\n\n-   Monitor for all connections with a “**Protocol Number”** that is not typical for this device or compter, for example, anything other than 1, 6, or 17.\n\n-   If the computer’s communication with “**Destination Address”** should always use a specific “**Destination Port**,**”** monitor for any other “**Destination Port**.”\n\n"}
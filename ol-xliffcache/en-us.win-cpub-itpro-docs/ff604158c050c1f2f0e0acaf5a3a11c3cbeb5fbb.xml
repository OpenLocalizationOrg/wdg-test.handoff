{"nodes":[{"content":"AD DS schema extensions to support TPM backup (Windows 10)","pos":[11,69]},{"content":"This topic provides more details about this change and provides template schema extensions that you can incorporate into your organization.","pos":[83,222]},{"content":"AD DS schema extensions to support TPM backup","pos":[378,423]},{"content":"Applies to","pos":[427,437]},{"content":"Windows 10","pos":[444,454]},{"content":"This topic provides more details about this change and provides template schema extensions that you can incorporate into your organization.","pos":[456,595]},{"content":"Why a schema extension is needed","pos":[600,632]},{"content":"The TPM owner authorization value is now stored in a separate object which is linked to the Computer object.","pos":[634,742]},{"content":"This value was stored as a property in the Computer object itself for the default Windows Server 2008 R2 schemas.","pos":[743,856]},{"content":"Windows Server 2012 domain controllers have the default schema to backup TPM owner authorization information in the separate object.","pos":[857,989]},{"content":"If you are not upgrading your domain controller to Windows Server 2012 you need to extend the schema to support this change.","pos":[990,1114]},{"content":"If Active Directory backup of the TPM owner authorization value is enabled in a Windows Server 2008 R2 environment without extending the schema, the TPM provisioning will fail and the TPM will remain in a Not Ready state for computers running Windows 8.","pos":[1115,1368]},{"content":"The following are the two schema extensions that you can use to bring your Windows Server 2008 R2 domain to parity with Windows Server 2012:","pos":[1369,1509]},{"pos":[1559,1581],"content":"TpmSchemaExtension.ldf"},{"content":"This schema extension brings parity with the Windows Server 2012 schema and is required if you want to store the TPM owner authorization value for a computer running Windows 8 in a Windows Server 2008 R2 AD DS domain.","pos":[1583,1800]},{"content":"With this extension the TPM owner authorization information will be stored in a separate TPM object linked to the corresponding computer object.","pos":[1801,1945]},{"content":"You should be aware that only the Computer object that has created the TPM object can update it.","pos":[8524,8620]},{"content":"This means that any subsequent updates to the TPM objects will not succeed in dual boot scenarios or scenarios where the computer is reimaged resulting in a new AD computer object being created.","pos":[8621,8815]},{"content":"If you are planning to support such scenarios, you will need to update the schema further as shown in the schema extension example, TpmSchemaExtensionACLChanges.ldf.","pos":[8816,8981]},{"content":"TpmSchemaExtensionACLChanges.ldf","pos":[8987,9019]},{"content":"This schema update modifies the ACLs on the TPM object to be less restrictive so that any subsequent operating system which takes ownership of the computer object can update the owner authorization value in AD DS.","pos":[9021,9234]},{"content":"<bpt id=\"p1\">**</bpt>Important<ept id=\"p1\">**</ept>  After implementing this schema update, any computer in the domain can update the OwnerAuth of the TPM object (although it cannot read the OwnerAuth).","pos":[9237,9401]},{"content":"When using this extension, perform a regular backup of the TPM objects and enable auditing to track the changes for these objects.","pos":[9402,9532]}],"content":"---\ntitle: AD DS schema extensions to support TPM backup (Windows 10)\ndescription: This topic provides more details about this change and provides template schema extensions that you can incorporate into your organization.\nms.assetid: beb7097c-e674-4eab-b8e2-6f67c85d1f3f\nms.prod: w10\nms.mktglfcycl: deploy\nms.sitesec: library\nms.pagetype: security\nauthor: brianlic-msft\n---\n\n# AD DS schema extensions to support TPM backup\n\n**Applies to**\n-   Windows 10\n\nThis topic provides more details about this change and provides template schema extensions that you can incorporate into your organization.\n\n## Why a schema extension is needed\n\nThe TPM owner authorization value is now stored in a separate object which is linked to the Computer object. This value was stored as a property in the Computer object itself for the default Windows Server 2008 R2 schemas. Windows Server 2012 domain controllers have the default schema to backup TPM owner authorization information in the separate object. If you are not upgrading your domain controller to Windows Server 2012 you need to extend the schema to support this change. If Active Directory backup of the TPM owner authorization value is enabled in a Windows Server 2008 R2 environment without extending the schema, the TPM provisioning will fail and the TPM will remain in a Not Ready state for computers running Windows 8. The following are the two schema extensions that you can use to bring your Windows Server 2008 R2 domain to parity with Windows Server 2012:\n\n### <a href=\"\" id=\"tpmschemaextension-ldf-\"></a>TpmSchemaExtension.ldf\n\nThis schema extension brings parity with the Windows Server 2012 schema and is required if you want to store the TPM owner authorization value for a computer running Windows 8 in a Windows Server 2008 R2 AD DS domain. With this extension the TPM owner authorization information will be stored in a separate TPM object linked to the corresponding computer object.\n\n``` syntax\n#===============================================================================\n#\n# Active Directory Domain Services schema extension for \n# BitLocker Drive Encryption and Trusted Platform Module (TPM) recovery\n#\n# This file contains attributes and class objects that enable Windows Server\n# 2008 and Windows Server 2008 R2 domain controllers to store TPM recovery\n# information in a new, TPM-specific location.\n#\n# Change History: \n#   07/2010 - Created\n#\n# To extend the schema, use the LDIFDE tool on the schema master of the forest.\n#\n# Sample command:\n#   ldifde -i -v -f TPMSchemaExtension.ldf -c \"DC=X\" \"DC=nttest,dc=microsoft,dc=com\" -k -j .\n#\n# For more information on LDIFDE tool, see\n# http://support.microsoft.com/default.aspx?scid=kb;en-us;237677 \n#\n#===============================================================================\n#===============================================================================\n# New schema attributes\n#===============================================================================\n#\n# ms-TPM-Srk-Pub-Thumbprint\n# GUID: 19d706eb-4d76-44a2-85d6-1c342be3be37\n#\ndn: CN=ms-TPM-Srk-Pub-Thumbprint,CN=Schema,CN=Configuration,DC=X\nchangetype: add\nobjectClass: attributeSchema\nldapDisplayName: msTPM-SrkPubThumbprint\nadminDisplayName: TPM-SrkPubThumbprint\nadminDescription: This attribute contains the thumbprint of the SrkPub corresponding to a particular TPM. This helps to index the TPM devices in the directory.\nattributeId: 1.2.840.113556.1.4.2107\nattributeSyntax: 2.5.5.10\nomSyntax: 4\nisSingleValued: TRUE\nsearchFlags: 11\nschemaIdGuid:: 6wbXGXZNokSF1hw0K+O+Nw==\nshowInAdvancedViewOnly: TRUE\nisMemberOfPartialAttributeSet: FALSE\nrangeUpper: 20\n#\n# ms-TPM-Owner-Information-Temp\n# GUID: c894809d-b513-4ff8-8811-f4f43f5ac7bc\n#\ndn: CN=ms-TPM-Owner-Information-Temp,CN=Schema,CN=Configuration,DC=X\nchangetype: add\nobjectClass: attributeSchema\nldapDisplayName: msTPM-OwnerInformationTemp\nadminDisplayName: TPM-OwnerInformationTemp\nadminDescription: This attribute contains temporary owner information for a particular TPM.\nattributeId: 1.2.840.113556.1.4.2108\nattributeSyntax: 2.5.5.12\nomSyntax: 64\nisSingleValued: TRUE\nsearchFlags: 640\nrangeUpper: 128\nschemaIdGuid:: nYCUyBO1+E+IEfT0P1rHvA==\nshowInAdvancedViewOnly: TRUE\nisMemberOfPartialAttributeSet: FALSE\n#\n# ms-TPM-Tpm-Information-For-Computer\n# GUID: ea1b7b93-5e48-46d5-bc6c-4df4fda78a35\n#\ndn: CN=ms-TPM-Tpm-Information-For-Computer,CN=Schema,CN=Configuration,DC=X\nchangetype: add\nobjectClass: attributeSchema\nldapDisplayName: msTPM-TpmInformationForComputer\nadminDisplayName: TPM-TpmInformationForComputer\nadminDescription: This attribute links a Computer object to a TPM object.\nattributeId: 1.2.840.113556.1.4.2109\nattributeSyntax: 2.5.5.1\nomSyntax: 127\nisSingleValued: TRUE\nsearchFlags: 16\nomObjectClass:: KwwCh3McAIVK\nschemaIdGuid:: k3sb6khe1Ua8bE30/aeKNQ==\nshowInAdvancedViewOnly: TRUE\nisMemberOfPartialAttributeSet: FALSE\nlinkId: 2182\n#\n# ms-TPM-TpmInformation-For-Computer-BL\n# GUID: 14fa84c9-8ecd-4348-bc91-6d3ced472ab7\n#\ndn: CN=ms-TPM-Tpm-Information-For-Computer-BL,CN=Schema,CN=Configuration,DC=X\nchangetype: add\nobjectClass: attributeSchema\nldapDisplayName: msTPM-TpmInformationForComputerBL\nadminDisplayName: TPM-TpmInformationForComputerBL\nadminDescription: This attribute links a TPM object to the Computer objects associated with it.\nattributeId: 1.2.840.113556.1.4.2110\nattributeSyntax: 2.5.5.1\nomSyntax: 127\nisSingleValued: FALSE\nsearchFlags: 0\nomObjectClass:: KwwCh3McAIVK\nschemaIdGuid:: yYT6FM2OSEO8kW087Ucqtw==\nshowInAdvancedViewOnly: TRUE\nsystemOnly: TRUE\nlinkId: 2183\n#\n# Commit the new attributes\n#\ndn:\nchangetype: modify\nadd: schemaUpdateNow\nschemaUpdateNow: 1\n-\n#\n# Modify the Computer schema to support the TPM link\n#\ndn: CN=computer,CN=Schema,CN=Configuration,DC=X\nchangetype: modify\nadd: mayContain\nmayContain: msTPM-TpmInformationForComputer\n-\n#\n# Commit the modification to the computer class\n#\ndn:\nchangetype: modify\nadd: schemaUpdateNow\nschemaUpdateNow: 1\n-\n#===============================================================================\n# New schema classes\n#===============================================================================\n#\n# ms-TPM-Information-Objects-Container\n# GUID: e027a8bd-6456-45de-90a3-38593877ee74\n#\ndn: CN=ms-TPM-Information-Objects-Container,CN=Schema,CN=Configuration,DC=X\nchangetype: add\nobjectClass: classSchema\nldapDisplayName: msTPM-InformationObjectsContainer\nadminDisplayName: TPM-InformationObjectsContainer\nadminDescription: Container for TPM objects.\ngovernsID: 1.2.840.113556.1.5.276\nobjectClassCategory: 1\nsubClassOf: top\nsystemMustContain: cn\nsystemPossSuperiors: domain\nsystemPossSuperiors: domainDNS\nschemaIdGUID:: vagn4FZk3kWQozhZOHfudA==\ndefaultSecurityDescriptor: D:(A;;RPWPCRCCDCLCLORCWOWDSDDTSW;;;DA)(A;;RPWPCRCCDCLCLORCWOWDSDDTSW;;;SY)(A;;LOLCCCRP;;;DC)\ndefaultHidingValue: TRUE\ndefaultObjectCategory: CN=ms-TPM-Information-Objects-Container,CN=Schema,CN=Configuration,DC=X\n#\n# ms-TPM-Information-Object\n# GUID: 85045b6a-47a6-4243-a7cc-6890701f662c\n#\n# NOTE: If the 'defaultSecurityDescriptor' value below is changed,\n#   also change the other '.ldf' files in this directory, as appropriate.\n#\ndn: CN=ms-TPM-Information-Object,CN=Schema,CN=Configuration,DC=X\nchangetype: add\nobjectClass: classSchema\nldapDisplayName: msTPM-InformationObject\nadminDisplayName: TPM-InformationObject\nadminDescription: This class contains recovery information for a Trusted Platform Module (TPM) device.\ngovernsID: 1.2.840.113556.1.5.275\nobjectClassCategory: 1\nsubClassOf: top\nsystemMustContain: msTPM-OwnerInformation\nsystemMayContain: msTPM-SrkPubThumbprint\nsystemMayContain: msTPM-OwnerInformationTemp\nsystemPossSuperiors: 1.2.840.113556.1.5.276\nschemaIdGUID:: alsEhaZHQ0KnzGiQcB9mLA==\ndefaultSecurityDescriptor: D:(A;;RPWPCRCCDCLCLORCWOWDSDDTSW;;;DA)(A;;RPWPCRCCDCLCLORCWOWDSDDTSW;;;SY)(A;;RPLO;;;DC)(A;;WP;;;CO)\ndefaultHidingValue: TRUE\ndefaultObjectCategory: CN=ms-TPM-Information-Object,CN=Schema,CN=Configuration,DC=X\n#\n# NOTE: If the 'defaultSecurityDescriptor' value above is changed,\n#   also change the other '.ldf' files in this directory, as appropriate.\n#\n#\n# Commit the new TPM object class\n#\ndn:\nchangetype: modify\nadd: schemaUpdateNow\nschemaUpdateNow: 1\n-\n#===============================================================================\n# New objects\n#===============================================================================\n#\n# Add the TPM container to its location in the directory\n#\ndn: CN=TPM Devices,DC=X\nchangetype: add\nobjectClass: msTPM-InformationObjectsContainer\n```\n\nYou should be aware that only the Computer object that has created the TPM object can update it. This means that any subsequent updates to the TPM objects will not succeed in dual boot scenarios or scenarios where the computer is reimaged resulting in a new AD computer object being created. If you are planning to support such scenarios, you will need to update the schema further as shown in the schema extension example, TpmSchemaExtensionACLChanges.ldf.\n\n### TpmSchemaExtensionACLChanges.ldf\n\nThis schema update modifies the ACLs on the TPM object to be less restrictive so that any subsequent operating system which takes ownership of the computer object can update the owner authorization value in AD DS.\n> **Important**  After implementing this schema update, any computer in the domain can update the OwnerAuth of the TPM object (although it cannot read the OwnerAuth). When using this extension, perform a regular backup of the TPM objects and enable auditing to track the changes for these objects.\n \n``` syntax\n#===============================================================================\n#\n# Active Directory Domain Services schema extension for \n# BitLocker Drive Encryption and Trusted Platform Module (TPM) recovery\n#\n# This file modifies a class object that enables Windows Server 2008\n# and Windows Server 2008 R2 domain controllers to store TPM recovery\n# information in a new, TPM-specific location.\n#\n# This file converts the standard schema extension in which only the creator\n# of an 'ms-TPM-Information-Object' can write to the object to the Open\n# schema extension in which any Domain Computer can write to the object.\n#\n# This conversion does not apply to any 'ms-TPM-Information-Object' that\n# was created before the conversion.\n#\n# Change History: \n#   12/2011 - Created\n#\n# To change the schema, use the LDIFDE tool on the schema master of the forest.\n#\n# Sample command:\n#   ldifde -i -v -f TpmSchemaExtensionACLChanges.ldf\n#      -c \"DC=X\" \"DC=nttest,dc=microsoft,dc=com\" -k -j .\n#\n# For more information on LDIFDE tool, see\n# http://support.microsoft.com/default.aspx?scid=kb;en-us;237677 \n#\n#===============================================================================\n#\n# Modify the TPM-Information-Object class schema 'defaultSecurityDescriptor' to\n# allow any Domain Computer to write its properties (including the TPM OwnerAuth\n# value) from allowing only the creating Computer object to write its properties\n#\n# NOTE: Keep any changes to the 'defaultSecurityDescriptor' value in synchronization\n#   with the value in the TPM-Information-Object class description in the\n#   'TpmSchemaExtension.ldf' file\n#\ndn: CN=ms-TPM-Information-Object,CN=Schema,CN=Configuration,DC=X\nchangetype: modify\nreplace: defaultSecurityDescriptor\ndefaultSecurityDescriptor: D:(A;;RPWPCRCCDCLCLORCWOWDSDDTSW;;;DA)(A;;RPWPCRCCDCLCLORCWOWDSDDTSW;;;SY)(A;;RPWPLO;;;DC)\n-\n#\n# Commit the modification to the TPM-Information-Object schema\n#\ndn:\nchangetype: modify\nadd: schemaUpdateNow\nschemaUpdateNow: 1\n-\n```\n \n \n"}
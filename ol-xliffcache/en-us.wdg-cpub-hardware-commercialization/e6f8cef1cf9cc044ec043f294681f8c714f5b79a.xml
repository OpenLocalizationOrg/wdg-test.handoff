{"nodes":[{"content":"Lab 1e: Add a driver to an image","pos":[106,138]},{"content":"Lab 1e: Add a driver to an image","pos":[147,179]},{"content":"Now we'll add drivers to a Windows 10 IoT Core image.","pos":[181,234]},{"content":"When you're using a pre-built Board Support Package (BSP), you'll want to know whether there's already similar drivers on the board.","pos":[237,369]},{"content":"If not, you can usually just add the new driver.","pos":[370,418]},{"pos":[421,598],"content":"If there is, but that driver doesn't meet your needs, then you'll need to replace the driver from the BSP, which we'll cover in <bpt id=\"p1\">[</bpt>Lab 2a<ept id=\"p1\">](replace-a-driver-in-an-existing-bsp.md)</ept>."},{"pos":[600,770],"content":"In our lab, we'll use the sample driver: <bpt id=\"p1\">[</bpt>Hello, Blinky!<ept id=\"p1\">](https://ms-iot.github.io/content/en-US/win10/samples/DriverLab.htm)</ept>, package it up, and deploy it to the device."},{"pos":[871,884],"content":"Prerequisites"},{"pos":[889,954],"content":"Complete <bpt id=\"p1\">[</bpt>Lab 1a: Create a basic image<ept id=\"p1\">](create-a-basic-image.md)</ept>."},{"pos":[1082,1104],"content":"Create your test files"},{"content":"Complete the exercises in <bpt id=\"p1\">[</bpt>Installing The Sample Driver<ept id=\"p1\">](https://ms-iot.github.io/content/en-US/win10/samples/DriverLab.htm)</ept> to build the Hello, Blinky app.","pos":[1109,1265]},{"content":"You'll create three files: ACPITABL.dat, gpiokmdfdemo.inf, and gpiokmdfdemo.sys, which you'll use to install the driver.","pos":[1266,1386]},{"content":"You can also use your own IoT Core driver, so long as it doesn't conflict with the existing Board Support Package (BSP).","pos":[1391,1511]},{"content":"Copy each of the files: gpiokmdfdemo.sys, gpiokmdfdemo.inf, and ACPITABL.dat into a test folder, for example, C:\\gpiokmdfdemo","pos":[1516,1641]},{"pos":[1798,1829],"content":"Build a package for your driver"},{"pos":[1835,1905],"content":"Run <bpt id=\"p1\">**</bpt>C:<ph id=\"ph1\">\\\\</ph>IoT-ADK-AddonKit<ph id=\"ph2\">\\\\</ph>Tools<ph id=\"ph3\">\\\\</ph>IoTCoreShell<ept id=\"p1\">**</ept> as an administrator."},{"content":"Create the driver package using the .inf file as the base:","pos":[1911,1969]},{"pos":[2066,2163],"content":"The new folder at <bpt id=\"p1\">**</bpt>C:<ph id=\"ph1\">\\\\</ph>IoT-ADK-AddonKit<ph id=\"ph2\">\\\\</ph>Source-<ph id=\"ph3\">&amp;lt;</ph>arch<ph id=\"ph4\">&amp;gt;\\\\</ph>Packages<ph id=\"ph5\">\\\\</ph>Drivers.HelloBlinky<ph id=\"ph6\">\\\\</ph><ept id=\"p1\">**</ept>."},{"content":"Verify that the sample files are in the package","pos":[2168,2215]},{"pos":[2223,2374],"content":"Update the driver's package definition file, <bpt id=\"p1\">**</bpt>C:<ph id=\"ph1\">\\\\</ph>IoT-ADK-AddonKit<ph id=\"ph2\">\\\\</ph>Source-<ph id=\"ph3\">&amp;lt;</ph>arch<ph id=\"ph4\">&amp;gt;\\\\</ph>Packages<ph id=\"ph5\">\\\\</ph>Drivers.HelloBlinky<ph id=\"ph6\">\\\\</ph>Drivers.HelloBlinky.pkg.xml<ept id=\"p1\">**</ept>."},{"content":"The default package definition file includes sample XML that you can modify to add your own driver files.","pos":[2380,2485]},{"content":"If necessary, update the value of File Source to point to your .SYS file, and the ACPITABL.dat file.","pos":[2491,2591]},{"content":"(You don't need to add the .INF file.)  Add the DestinationDir of \"$(runtime.drivers)\".","pos":[2592,2679]},{"content":"From the IoT Core Shell, build the package.","pos":[3426,3469]},{"pos":[3533,3667],"content":"The package is built, appearing as <bpt id=\"p1\">**</bpt>C:<ph id=\"ph1\">\\\\</ph>IoT-ADK-AddonKit<ph id=\"ph2\">\\\\</ph>Build<ph id=\"ph3\">\\\\&amp;lt;</ph>arch<ph id=\"ph4\">&amp;gt;\\\\</ph>pkgs<ph id=\"ph5\">\\\\&amp;lt;</ph>your OEM name<ph id=\"ph6\">&amp;gt;</ph>.Drivers.HelloBlinky.cab<ept id=\"p1\">**</ept>."},{"pos":[3818,3846],"content":"Update your feature manifest"},{"content":"Add your driver package to the feature manifest","pos":[3851,3898]},{"pos":[3906,4020],"content":"Open the architecture-specific feature manifest file, <bpt id=\"p1\">**</bpt>C:<ph id=\"ph1\">\\\\</ph>IoT-ADK-AddonKit<ph id=\"ph2\">\\\\</ph>Source-<ph id=\"ph3\">&lt;arch&gt;\\\\</ph>Packages<ph id=\"ph4\">\\\\</ph>OEMFM.xml<ept id=\"p1\">**</ept>"},{"content":"Create a new PackageFile section in the XML, with your package file listed, and give it a new FeatureID, such as \"OEM<ph id=\"ph1\">\\_</ph>DriverHelloBlinky\".","pos":[4025,4163]},{"content":"You'll now be able to add your driver to your product by adding a reference to this feature manifest.","pos":[4420,4521]},{"pos":[4704,4744],"content":"Update the project's configuration files"},{"pos":[4750,4870],"content":"Open your product's test configuration file: <bpt id=\"p1\">**</bpt>C:<ph id=\"ph1\">\\\\</ph>IoT-ADK-AddonKit<ph id=\"ph2\">\\\\</ph>Source-arm<ph id=\"ph3\">\\\\</ph>Products<ph id=\"ph4\">\\\\</ph>ProductA<ph id=\"ph5\">\\\\</ph>TestOEMInput.xml<ept id=\"p1\">**</ept>."},{"content":"Make sure your feature manifest, OEMFM.xml, is in the list of AdditionalFMs.","pos":[4875,4951]},{"content":"Add it if it isn't there already there:","pos":[4952,4991]},{"content":"Add the FeatureID for your driver:","pos":[5447,5481]},{"pos":[5914,5938],"content":"Build and test the image"},{"content":"Build the image","pos":[5943,5958]},{"content":"From the IoT Core Shell, create the image:","pos":[5966,6008]},{"content":"This creates the product binaries at C:<ph id=\"ph1\">\\\\</ph>IoT-ADK-AddonKit<ph id=\"ph2\">\\\\</ph>Build<ph id=\"ph3\">\\\\&amp;lt;</ph>arch<ph id=\"ph4\">&amp;gt;\\\\</ph>ProductA<ph id=\"ph5\">\\\\</ph>Flash.FFU.","pos":[6068,6168]},{"content":"Start <bpt id=\"p1\">**</bpt>Windows IoT Core Dashboard<ept id=\"p1\">**</ept> <ph id=\"ph1\">&amp;gt;</ph> <bpt id=\"p2\">**</bpt>Setup a new device<ept id=\"p2\">**</ept> <ph id=\"ph2\">&amp;gt;</ph> <bpt id=\"p3\">**</bpt>Custom<ept id=\"p3\">**</ept>, and browse to your image.","pos":[6174,6281]},{"content":"Put the Micro SD card in the device, select it, accept the license terms, and click <bpt id=\"p1\">**</bpt>Install<ept id=\"p1\">**</ept>.","pos":[6282,6378]},{"content":"This replaces the previous image with our new image.","pos":[6379,6431]},{"content":"Put the card into the IoT device and start it up.","pos":[6436,6485]},{"content":"After a short while, the device should start automatically, and you should see your app.","pos":[6491,6579]},{"content":"Check to see if your driver works","pos":[6583,6616]},{"pos":[6624,6760],"content":"Use the procedures in the <bpt id=\"p1\">[</bpt>Hello, Blinky! lab<ept id=\"p1\">](https://ms-iot.github.io/content/en-US/win10/samples/DriverLab3.htm)</ept> to test your driver."},{"pos":[6854,6864],"content":"Next steps"},{"content":"Lab 2a: Replace a driver in an existing board support package","pos":[6867,6928]}],"content":"---\nauthor: kpacquer\nDescription: 'We''ll show you one of two ways to add a driver to the image.'\ntitle: 'Lab 1e: Add a driver to an image'\n---\n\n# Lab 1e: Add a driver to an image\n\nNow we'll add drivers to a Windows 10 IoT Core image. \n\nWhen you're using a pre-built Board Support Package (BSP), you'll want to know whether there's already similar drivers on the board. If not, you can usually just add the new driver. \n\nIf there is, but that driver doesn't meet your needs, then you'll need to replace the driver from the BSP, which we'll cover in [Lab 2a](replace-a-driver-in-an-existing-bsp.md).\n\nIn our lab, we'll use the sample driver: [Hello, Blinky!](https://ms-iot.github.io/content/en-US/win10/samples/DriverLab.htm), package it up, and deploy it to the device.\n\n## <span id=\"Prerequisites\"></span><span id=\"prerequisites\"></span><span id=\"PREREQUISITES\"></span>Prerequisites\n\n-  Complete [Lab 1a: Create a basic image](create-a-basic-image.md).\n\n## <span id=\"Create_your_test_files\"></span><span id=\"create_your_test_files\"></span><span id=\"CREATE_YOUR_TEST_FILES\"></span>Create your test files\n\n-  Complete the exercises in [Installing The Sample Driver](https://ms-iot.github.io/content/en-US/win10/samples/DriverLab.htm) to build the Hello, Blinky app. You'll create three files: ACPITABL.dat, gpiokmdfdemo.inf, and gpiokmdfdemo.sys, which you'll use to install the driver.\n\n   You can also use your own IoT Core driver, so long as it doesn't conflict with the existing Board Support Package (BSP).\n\n-  Copy each of the files: gpiokmdfdemo.sys, gpiokmdfdemo.inf, and ACPITABL.dat into a test folder, for example, C:\\gpiokmdfdemo\\.\n\n## <span id=\"Build_a_package_for_your_driver\"></span><span id=\"build_a_package_for_your_driver\"></span><span id=\"BUILD_A_PACKAGE_FOR_YOUR_DRIVER\"></span>Build a package for your driver\n\n1.  Run **C:\\\\IoT-ADK-AddonKit\\\\Tools\\\\IoTCoreShell** as an administrator.\n\n2.  Create the driver package using the .inf file as the base:\n\n    ``` syntax\n    newdrvpkg C:\\gpiokmdfdemo\\gpiokmdfdemo.inf Drivers.HelloBlinky\n    ```\n\n    The new folder at **C:\\\\IoT-ADK-AddonKit\\\\Source-&lt;arch&gt;\\\\Packages\\\\Drivers.HelloBlinky\\\\**.\n\n\n**Verify that the sample files are in the package**\n\n1.  Update the driver's package definition file, **C:\\\\IoT-ADK-AddonKit\\\\Source-&lt;arch&gt;\\\\Packages\\\\Drivers.HelloBlinky\\\\Drivers.HelloBlinky.pkg.xml**.\n\n    The default package definition file includes sample XML that you can modify to add your own driver files.\n\n    If necessary, update the value of File Source to point to your .SYS file, and the ACPITABL.dat file. (You don't need to add the .INF file.)  Add the DestinationDir of \"$(runtime.drivers)\".\n    \n    ``` syntax\n    <Package xmlns=\"urn:Microsoft.WindowsPhone/PackageSchema.v8.00\" \n         Owner=\"$(OEMNAME)\" OwnerType=\"OEM\" ReleaseType=\"Production\" \n         Platform=\"arm\" Component=\"Drivers\" SubComponent=\"HelloBlinky\"> \n      <Components> \n        <Driver InfSource=\"gpiokmdfdemo.inf\"> \n          <Reference Source=\"gpiokmdfdemo.sys\" /> \n          <Files> \n            <File Source=\"gpiokmdfdemo.sys\"  \n                  DestinationDir=\"$(runtime.drivers)\"  \n                  Name=\"gpiokmdfdemo.sys\" /> \n            <File Source=\"ACPITABL.dat\"  \n                  DestinationDir=\"$(runtime.drivers)\"  \n                  Name=\"ACPITABL.dat\" /> \n          </Files> \n        </Driver> \n      </Components> \n    </Package> \n    ```\n\n2.  From the IoT Core Shell, build the package.\n\n    ``` syntax\n    createpkg Drivers.HelloBlinky\n    ```\n\n    The package is built, appearing as **C:\\\\IoT-ADK-AddonKit\\\\Build\\\\&lt;arch&gt;\\\\pkgs\\\\&lt;your OEM name&gt;.Drivers.HelloBlinky.cab**.\n\n    \n## <span id=\"Update_your_feature_manifest\"></span><span id=\"update_your_feature_manifest\"></span><span id=\"UPDATE_YOUR_FEATURE_MANIFEST\"></span>Update your feature manifest\n\n\n**Add your driver package to the feature manifest**\n\n1.  Open the architecture-specific feature manifest file, **C:\\\\IoT-ADK-AddonKit\\\\Source-<arch>\\\\Packages\\\\OEMFM.xml**\n2.  Create a new PackageFile section in the XML, with your package file listed, and give it a new FeatureID, such as \"OEM\\_DriverHelloBlinky\".\n\n    ``` syntax      \n          <PackageFile Path=\"%PKGBLD_DIR%\" Name=\"%OEM_NAME%.Drivers.HelloBlinky.cab\">\n            <FeatureIDs>\n              <FeatureID>OEM_DriverHelloBlinky</FeatureID>\n            </FeatureIDs>\n          </PackageFile>\n    ```\n\n    You'll now be able to add your driver to your product by adding a reference to this feature manifest.\n\n\n## <span id=\"Update_the_project_s_configuration_files\"></span><span id=\"update_the_project_s_configuration_files\"></span><span id=\"UPDATE_THE_PROJECT_S_CONFIGURATION_FILES\"></span>Update the project's configuration files\n\n1.  Open your product's test configuration file: **C:\\\\IoT-ADK-AddonKit\\\\Source-arm\\\\Products\\\\ProductA\\\\TestOEMInput.xml**.\n2.  Make sure your feature manifest, OEMFM.xml, is in the list of AdditionalFMs. Add it if it isn't there already there:\n\n    ``` syntax\n      <AdditionalFMs>\n        <AdditionalFM>%AKROOT%\\FMFiles\\arm\\IoTUAPNonProductionPartnerShareFM.xml</AdditionalFM>\n        <AdditionalFM>%AKROOT%\\FMFiles\\arm\\IoTUAPRPi2FM.xml</AdditionalFM>\n        <AdditionalFM>%AKROOT%\\FMFiles\\arm\\RPi2FM.xml</AdditionalFM>\n        <AdditionalFM>%SRC_DIR%\\Packages\\OEMFM.xml</AdditionalFM>\n        <AdditionalFM>%COMMON_DIR%\\Packages\\OEMCommonFM.xml</AdditionalFM>\n      </AdditionalFMs>\n    ```\n\n3.  Add the FeatureID for your driver:\n\n    ``` syntax\n    <OEM> \n    <Feature>RPI2_DRIVERS</Feature> \n    <Feature>RPI2_DEVICE_TARGETINGINFO</Feature> \n    <Feature>PRODUCTION</Feature> \n    <Feature>OEM_AppxHelloWorld</Feature> \n    <Feature>OEM_FileAndRegKey</Feature> \n    <Feature>OEM_DriverHelloBlinky</Feature> \n    </OEM>\n    ```\n\n## <span id=\"Build_and_test_the_image\"></span><span id=\"build_and_test_the_image\"></span><span id=\"BUILD_AND_TEST_THE_IMAGE\"></span>Build and test the image\n\n\n**Build the image**\n\n1.  From the IoT Core Shell, create the image:\n\n    ``` syntax\n    createimage ProductA Test\n    ```\n\n    This creates the product binaries at C:\\\\IoT-ADK-AddonKit\\\\Build\\\\&lt;arch&gt;\\\\ProductA\\\\Flash.FFU.\n\n2.  Start **Windows IoT Core Dashboard** &gt; **Setup a new device** &gt; **Custom**, and browse to your image. Put the Micro SD card in the device, select it, accept the license terms, and click **Install**. This replaces the previous image with our new image.\n3.  Put the card into the IoT device and start it up.\n\n    After a short while, the device should start automatically, and you should see your app.\n\n**Check to see if your driver works**\n\n1.  Use the procedures in the [Hello, Blinky! lab](https://ms-iot.github.io/content/en-US/win10/samples/DriverLab3.htm) to test your driver.\n\n\n\n## <span id=\"Next_steps\"></span><span id=\"next_steps\"></span><span id=\"NEXT_STEPS\"></span>Next steps\n\n[Lab 2a: Replace a driver in an existing board support package](replace-a-driver-in-an-existing-bsp.md)"}
{"nodes":[{"content":"Bare metal reset/recovery: enable your users to create recovery media","pos":[35,104]},{"content":"Bare metal reset/recovery: enable your users to create recovery media","pos":[213,282]},{"content":"Bare metal reset/recovery: enable your users to create recovery media","pos":[291,360]},{"content":"Recovery media (bare metal recovery) helps restore a Windows device to the factory state, even if the user needs to replace the hard drive or completely wipe the drive clean.","pos":[363,537]},{"content":"Windows uses the built-in Windows files, including recent Windows and driver updates, plus any customizations included in the OEM provisioning package, to create the recovery media.","pos":[539,720]},{"content":"If you deploy Windows using the default partition layout, your users will be able to create bare metal recovery media by default.","pos":[722,851]},{"content":"If you're deploying Windows with a custom partition layout, you'll need to add a few configuration files to enable your users to create bare metal recovery media:","pos":[853,1015]},{"pos":[1021,1128],"content":"A <bpt id=\"p1\">**</bpt>partition reset script<ept id=\"p1\">**</ept>, which is a modified DiskPart script that resets your custom partition layout."},{"pos":[1133,1284],"content":"A <bpt id=\"p1\">**</bpt>push-button reset configuration file<ept id=\"p1\">**</ept> (<bpt id=\"p2\">[</bpt>ResetConfig XML<ept id=\"p2\">](resetconfig-xml-reference-s14.md)</ept>) that identifies the Windows and Windows RE partitions."},{"pos":[1397,1425],"content":"Creating configuration files"},{"content":"Partition reset script","pos":[1430,1452]},{"content":"In Notepad, create a configuration file that partitions the hard drive after the hard drive has been reset.","pos":[1460,1567]},{"content":"This script should be the same as the script used to create partitions on the hard drive, with the following exceptions:","pos":[1568,1688]},{"content":"The script should not contain commands to select or clean the drive.","pos":[1698,1766]},{"content":"Windows identifies the system drive automatically.","pos":[1767,1817]},{"content":"To learn more, see <bpt id=\"p1\">[</bpt>Identifying the System Drive<ept id=\"p1\">](#identifyingthesystemdrive)</ept> later in this topic.","pos":[1818,1916]},{"content":"The script should assign letters to the system partition, the Windows partition, and the Windows RE tools partition.","pos":[1926,2042]},{"content":"Examples:","pos":[2048,2057]},{"pos":[2063,2168],"content":"UEFI (based on <bpt id=\"p1\">[</bpt>UEFI/GPT-based hard drive partitions<ept id=\"p1\">](configure-uefigpt-based-hard-drive-partitions.md)</ept>):"},{"pos":[3803,3908],"content":"BIOS (based on <bpt id=\"p1\">[</bpt>BIOS/MBR-based hard drive partitions<ept id=\"p1\">](configure-biosmbr-based-hard-drive-partitions.md)</ept>):"},{"content":"Save your file, for example, E:<ph id=\"ph1\">\\\\</ph>Recovery<ph id=\"ph2\">\\\\</ph>RecoveryImage<ph id=\"ph3\">\\\\</ph>ResetPartitions-UEFI.txt.","pos":[5240,5323]},{"content":"Push-button reset configuration file (ResetConfig.xml)","pos":[5327,5381]},{"content":"In Notepad, create a configuration file that points to your push-button reset partition script.","pos":[5389,5484]},{"pos":[5490,5601],"content":"For information about configuring this file, see <bpt id=\"p1\">[</bpt>ResetConfig XML Reference<ept id=\"p1\">](resetconfig-xml-reference-s14.md)</ept>."},{"content":"UEFI:","pos":[5607,5612]},{"content":"BIOS:","pos":[6150,6155]},{"content":"Save the file using the UTF-8 file format:","pos":[6693,6735]},{"content":"Click <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Save As<ept id=\"p2\">**</ept>.","pos":[6741,6784]},{"content":"In the <bpt id=\"p1\">**</bpt>Encoding<ept id=\"p1\">**</ept> box, select <bpt id=\"p2\">**</bpt>UTF-8<ept id=\"p2\">**</ept>, and save this file as E:<ph id=\"ph1\">\\\\</ph>Recovery<ph id=\"ph2\">\\\\</ph>RecoveryImage<ph id=\"ph3\">\\\\</ph>ResetConfig.xml.","pos":[6785,6895]},{"pos":[6999,7027],"content":"Enable users to create media"},{"content":"Users can use this option to create recovery media, and to reclaim the hard drive space from the recovery image partition when needed.","pos":[7030,7164]},{"content":"Step 1: Add the configuration files to the destination computer","pos":[7168,7231]},{"content":"On your destination computer, insert the USB flash drive with the configuration files.","pos":[7239,7325]},{"content":"Copy the configuration files to the destination computer:","pos":[7331,7388]},{"pos":[7474,7587],"content":"where <bpt id=\"p1\">*</bpt>E<ept id=\"p1\">*</ept> is the drive letter of the USB flash drive and <bpt id=\"p2\">*</bpt>R<ept id=\"p2\">*</ept> is the drive letter of the recovery image partition."},{"content":"Step 2: Test that Windows can create recovery media","pos":[7591,7642]},{"content":"Restart the destination computer, and complete Out-Of-Box Experience (OOBE).","pos":[7650,7726]},{"pos":[7732,7859],"content":"Click <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept>, type <bpt id=\"p2\">**</bpt>create a recovery drive<ept id=\"p2\">**</ept>, and select <bpt id=\"p3\">**</bpt>Create a recovery drive<ept id=\"p3\">**</ept>, and click <bpt id=\"p4\">**</bpt>Yes<ept id=\"p4\">**</ept> at the UAC prompt."},{"content":"Insert a USB flash drive.","pos":[7865,7890]},{"pos":[7896,8013],"content":"Select <bpt id=\"p1\">**</bpt>Copy the recovery partition from the PC to the recovery drive<ept id=\"p1\">**</ept> <ph id=\"ph1\">&amp;gt;</ph> <bpt id=\"p2\">**</bpt>Next<ept id=\"p2\">**</ept> <ph id=\"ph2\">&amp;gt;</ph> <bpt id=\"p3\">**</bpt>Next<ept id=\"p3\">**</ept> <ph id=\"ph3\">&amp;gt;</ph> <bpt id=\"p4\">**</bpt>Create<ept id=\"p4\">**</ept>."},{"content":"Step 3: Test the recovery media","pos":[8017,8048]},{"content":"On a computer that has no operating system, insert your recovery media.","pos":[8056,8127]},{"content":"Start the computer, press a key to open the firmware boot menus, and then select the appropriate boot device.","pos":[8132,8241]},{"pos":[8246,8327],"content":"At the <bpt id=\"p1\">**</bpt>Windows RE Tools<ept id=\"p1\">**</ept> menus, select a keyboard layout, for example, <bpt id=\"p2\">**</bpt>US<ept id=\"p2\">**</ept>."},{"content":"Click <bpt id=\"p1\">**</bpt>Troubleshoot<ept id=\"p1\">**</ept> <ph id=\"ph1\">&amp;gt;</ph> <bpt id=\"p2\">**</bpt>Reset your PC<ept id=\"p2\">**</ept> <ph id=\"ph2\">&amp;gt;</ph> <bpt id=\"p3\">**</bpt>Next<ept id=\"p3\">**</ept>.","pos":[8332,8392]},{"content":"If you're prompted to clean the drive, select <bpt id=\"p1\">**</bpt>Yes<ept id=\"p1\">**</ept>.","pos":[8393,8447]},{"pos":[8452,8536],"content":"Select <bpt id=\"p1\">**</bpt>Yes, repartition the drives<ept id=\"p1\">**</ept> <ph id=\"ph1\">&amp;gt;</ph> <bpt id=\"p2\">**</bpt>Just remove my files<ept id=\"p2\">**</ept> <ph id=\"ph2\">&amp;gt;</ph> <bpt id=\"p3\">**</bpt>Reset<ept id=\"p3\">**</ept>."},{"content":"Troubleshooting:","pos":[8540,8556]},{"content":"Make sure that ResetConfig.xml is saved as a UTF-8 file.","pos":[8564,8620]},{"content":"Make sure that the filename listed in the <ph id=\"ph1\">&amp;lt;</ph>DiskpartScriptPath<ph id=\"ph2\">&amp;gt;</ph> element of the ResetConfig.xml file matches the filename in the Diskpart script.","pos":[8625,8774]},{"pos":[8779,8905],"content":"Make sure that the Diskpart script doesn't include commands to select the drive or clean the drive (<ph id=\"ph1\">`select disk 0`</ph>, <ph id=\"ph2\">`clean`</ph>)."},{"pos":[9042,9070],"content":"Identifying the system drive"},{"content":"Windows identifies the system drive using the following methods:","pos":[9073,9137]},{"pos":[9139,9204],"content":"<bpt id=\"p1\">**</bpt>BIOS-based computers<ept id=\"p1\">**</ept>: the BIOS-reported system drive is used."},{"content":"<bpt id=\"p1\">**</bpt>UEFI-based computers<ept id=\"p1\">**</ept>: When Windows RE is enabled by using the <ph id=\"ph1\">`reagentc /setreimage`</ph> command, Windows writes the adaptor location path and GUID of the system disk to a UEFI variable.","pos":[9206,9392]},{"content":"This step is only performed when both the system and OS partitions are on the system drive.","pos":[9393,9484]},{"content":"The variable is updated if necessary when Windows RE gets disabled and then re-enabled.","pos":[9485,9572]},{"content":"If multiple local drives are detected, Windows identifies the system drive by searching in the following order:","pos":[9576,9687]},{"content":"Windows searches for a drive with a GUID matching the value stored in firmware.","pos":[9695,9774]},{"content":"Windows searches for a drive with a location path matching the value stored in firmware.","pos":[9780,9868]},{"content":"Windows searches for a drive with an existing ESP.","pos":[9874,9924]},{"content":"If multiple drives with ESP are found, the recovery process will not proceed.","pos":[9930,10007]},{"content":"Windows searches for an uninitialized (raw) disk.","pos":[10013,10062]},{"content":"If multiple uninitialized disks are found, the recovery process will not proceed.","pos":[10068,10149]},{"pos":[10187,10201],"content":"Related topics"},{"content":"Push-Button Reset Overview","pos":[10205,10231]},{"content":"ResetConfig XML Reference","pos":[10266,10291]},{"content":"Bare metal reset/recovery: create recovery media while deploying new devices","pos":[10329,10405]},{"content":"UEFI/GPT-based hard drive partitions","pos":[10464,10500]},{"content":"BIOS/MBR-based hard drive partitions","pos":[10554,10590]}],"content":"---\nauthor: Justinha\nDescription: 'Bare metal reset/recovery: enable your users to create recovery media'\nms.assetid: 2f12f7aa-2259-453a-a433-4fa56b03b375\nMSHAttr: 'PreferredLib:/library/windows/hardware'\ntitle: 'Bare metal reset/recovery: enable your users to create recovery media'\n---\n\n# Bare metal reset/recovery: enable your users to create recovery media\n\n\nRecovery media (bare metal recovery) helps restore a Windows device to the factory state, even if the user needs to replace the hard drive or completely wipe the drive clean.\n\nWindows uses the built-in Windows files, including recent Windows and driver updates, plus any customizations included in the OEM provisioning package, to create the recovery media.\n\nIf you deploy Windows using the default partition layout, your users will be able to create bare metal recovery media by default.\n\nIf you're deploying Windows with a custom partition layout, you'll need to add a few configuration files to enable your users to create bare metal recovery media:\n\n-   A **partition reset script**, which is a modified DiskPart script that resets your custom partition layout.\n-   A **push-button reset configuration file** ([ResetConfig XML](resetconfig-xml-reference-s14.md)) that identifies the Windows and Windows RE partitions.\n\n## <span id=\"CreateConfigFiles\"></span><span id=\"createconfigfiles\"></span><span id=\"CREATECONFIGFILES\"></span>Creating configuration files\n\n\n**Partition reset script**\n\n1.  In Notepad, create a configuration file that partitions the hard drive after the hard drive has been reset. This script should be the same as the script used to create partitions on the hard drive, with the following exceptions:\n\n    -   The script should not contain commands to select or clean the drive. Windows identifies the system drive automatically. To learn more, see [Identifying the System Drive](#identifyingthesystemdrive) later in this topic.\n\n    -   The script should assign letters to the system partition, the Windows partition, and the Windows RE tools partition.\n\n    Examples:\n\n    UEFI (based on [UEFI/GPT-based hard drive partitions](configure-uefigpt-based-hard-drive-partitions.md)):\n\n    ``` syntax\n    rem == ResetPartitions-UEFI.txt ==\n    rem == These commands are used with DiskPart to\n    rem    reset the drive and recreate five partitions\n    rem    for a UEFI/GPT-based computer.\n    rem    Adjust the partition sizes to fill the drive\n    rem    as necessary. ==\n    rem == The differences between this file and\n    rem    CreatePartitions-UEFI.txt\n    rem    are noted in parenthesis.\n    rem       (NOT USED: select disk 0)\n    rem       (NOT USED: clean)\n    convert gpt\n    rem == 1. System partition =========================\n    create partition efi size=100\n    rem    ** NOTE: For Advanced Format 4Kn drives,\n    rem               change this value to size = 260 ** \n    format quick fs=fat32 label=\"System\"\n    assign letter=\"S\"\n    rem == 2. Microsoft Reserved (MSR) partition =======\n    create partition msr size=128\n    rem == 3. Windows partition ========================\n    rem ==    a. Create the Windows partition ==========\n    create partition primary \n    rem ==    b. Create space for the recovery tools ===\n    shrink minimum=500\n    rem       ** NOTE: Update this size to match the\n    rem                size of the recovery tools \n    rem                (winre.wim)                    **\n    rem ==    c. Prepare the Windows partition ========= \n    format quick fs=ntfs label=\"Windows\"\n    assign letter=\"C\"\n    rem === 4. Recovery tools partition ================\n    create partition primary\n    format quick fs=ntfs label=\"Recovery tools\"\n    assign letter=\"R\"\n    set id=\"de94bba4-06d1-4d40-a16a-bfd50179d6ac\"\n    gpt attributes=0x8000000000000001\n    list volume\n    ```\n\n    BIOS (based on [BIOS/MBR-based hard drive partitions](configure-biosmbr-based-hard-drive-partitions.md)):\n\n    ``` syntax\n    rem == ResetPartitions-BIOS.txt ==\n    rem == These commands are used with DiskPart to\n    rem    reset the drive and create three partitions\n    rem    for a BIOS/MBR-based computer.\n    rem    Adjust the partition sizes to fill the drive\n    rem    as necessary. ==\n    rem == The differences between this file and\n    rem    CreatePartitions-BIOS.txt\n    rem    are noted in parenthesis.\n    rem       (NOT USED: select disk 0 )\n    rem       (NOT USED: clean )\n    rem == 1. System partition ======================\n    create partition primary size=100\n    format quick fs=ntfs label=\"System\"\n    assign letter=\"S\"\n    active\n    rem == 2. Windows partition =====================\n    rem ==    a. Create the Windows partition =======\n    create partition primary\n    rem ==    b. Create space for the recovery tools  \n    shrink minimum=500\n    rem       ** NOTE: Update this size to match the\n    rem                size of the recovery tools \n    rem                (winre.wim)                 **\n    rem ==    c. Prepare the Windows partition ====== \n    format quick fs=ntfs label=\"Windows\"\n    assign letter=\"C\"\n    rem == 3. Recovery tools partition ==============\n    create partition primary\n    format quick fs=ntfs label=\"Recovery\"\n    assign letter=\"R\"\n    set id=27\n    list volume\n    ```\n\n2.  Save your file, for example, E:\\\\Recovery\\\\RecoveryImage\\\\ResetPartitions-UEFI.txt.\n\n**Push-button reset configuration file (ResetConfig.xml)**\n\n1.  In Notepad, create a configuration file that points to your push-button reset partition script.\n\n    For information about configuring this file, see [ResetConfig XML Reference](resetconfig-xml-reference-s14.md).\n\n    UEFI:\n\n    ``` syntax\n    <?xml version=\"1.0\" encoding=\"utf-8\"?>\n    <!-- ResetConfig.xml for UEFI -->\n    <Reset>\n        <!-- May be combined with custom scripts – insert Run Phase elements here -->\n        <SystemDisk>\n            <DiskpartScriptPath>ResetPartitions-UEFI.txt</DiskpartScriptPath>\n            <MinSize>75000</MinSize>\n            <WindowsREPartition>4</WindowsREPartition>\n            <WindowsREPath>Recovery\\WindowsRE</WindowsREPath>\n            <OSPartition>3</OSPartition>\n        </SystemDisk>\n    </Reset>\n    ```\n\n    BIOS:\n\n    ``` syntax\n    <?xml version=\"1.0\" encoding=\"utf-8\"?>\n    <!-- ResetConfig.xml for BIOS -->\n    <Reset>\n        <!-- May be combined with custom scripts – insert Run Phase elements here -->\n        <SystemDisk>\n            <DiskpartScriptPath>ResetPartitions-BIOS.txt</DiskpartScriptPath>\n            <MinSize>75000</MinSize>\n            <WindowsREPartition>3</WindowsREPartition>\n            <WindowsREPath>Recovery\\WindowsRE</WindowsREPath>\n            <OSPartition>2</OSPartition>\n        </SystemDisk>\n    </Reset>\n    ```\n\n2.  Save the file using the UTF-8 file format:\n\n    Click **File**, and then click **Save As**. In the **Encoding** box, select **UTF-8**, and save this file as E:\\\\Recovery\\\\RecoveryImage\\\\ResetConfig.xml.\n\n## <span id=\"EnableEndUsers\"></span><span id=\"enableendusers\"></span><span id=\"ENABLEENDUSERS\"></span>Enable users to create media\n\n\nUsers can use this option to create recovery media, and to reclaim the hard drive space from the recovery image partition when needed.\n\n**Step 1: Add the configuration files to the destination computer**\n\n1.  On your destination computer, insert the USB flash drive with the configuration files.\n\n2.  Copy the configuration files to the destination computer:\n\n    ``` syntax\n    Copy E:\\Recovery\\RecoveryImage\\* R:\\RecoveryImage\\*\n    ```\n\n    where *E* is the drive letter of the USB flash drive and *R* is the drive letter of the recovery image partition.\n\n**Step 2: Test that Windows can create recovery media**\n\n1.  Restart the destination computer, and complete Out-Of-Box Experience (OOBE).\n\n2.  Click **Start**, type **create a recovery drive**, and select **Create a recovery drive**, and click **Yes** at the UAC prompt.\n\n3.  Insert a USB flash drive.\n\n4.  Select **Copy the recovery partition from the PC to the recovery drive** &gt; **Next** &gt; **Next** &gt; **Create**.\n\n**Step 3: Test the recovery media**\n\n1.  On a computer that has no operating system, insert your recovery media.\n2.  Start the computer, press a key to open the firmware boot menus, and then select the appropriate boot device.\n3.  At the **Windows RE Tools** menus, select a keyboard layout, for example, **US**.\n4.  Click **Troubleshoot** &gt; **Reset your PC** &gt; **Next**. If you're prompted to clean the drive, select **Yes**.\n5.  Select **Yes, repartition the drives** &gt; **Just remove my files** &gt; **Reset**.\n\n**Troubleshooting:**\n\n-   Make sure that ResetConfig.xml is saved as a UTF-8 file.\n-   Make sure that the filename listed in the &lt;DiskpartScriptPath&gt; element of the ResetConfig.xml file matches the filename in the Diskpart script.\n-   Make sure that the Diskpart script doesn't include commands to select the drive or clean the drive (`select disk 0`, `clean`).\n\n## <span id=\"IdentifyingTheSystemDrive\"></span><span id=\"identifyingthesystemdrive\"></span><span id=\"IDENTIFYINGTHESYSTEMDRIVE\"></span>Identifying the system drive\n\n\nWindows identifies the system drive using the following methods:\n\n**BIOS-based computers**: the BIOS-reported system drive is used.\n\n**UEFI-based computers**: When Windows RE is enabled by using the `reagentc /setreimage` command, Windows writes the adaptor location path and GUID of the system disk to a UEFI variable. This step is only performed when both the system and OS partitions are on the system drive. The variable is updated if necessary when Windows RE gets disabled and then re-enabled.\n\n**If multiple local drives are detected, Windows identifies the system drive by searching in the following order:**\n\n1.  Windows searches for a drive with a GUID matching the value stored in firmware.\n\n2.  Windows searches for a drive with a location path matching the value stored in firmware.\n\n3.  Windows searches for a drive with an existing ESP.\n\n    If multiple drives with ESP are found, the recovery process will not proceed.\n\n4.  Windows searches for an uninitialized (raw) disk.\n\n    If multiple uninitialized disks are found, the recovery process will not proceed.\n\n## <span id=\"related_topics\"></span>Related topics\n\n\n[Push-Button Reset Overview](push-button-reset-overview.md)\n\n[ResetConfig XML Reference](resetconfig-xml-reference-s14.md)\n\n[Bare metal reset/recovery: create recovery media while deploying new devices](create-media-to-run-push-button-reset-features-s14.md)\n\n[UEFI/GPT-based hard drive partitions](configure-uefigpt-based-hard-drive-partitions.md)\n\n[BIOS/MBR-based hard drive partitions](configure-biosmbr-based-hard-drive-partitions.md)\n\n \n\n \n\n\n\n\n\n\n"}
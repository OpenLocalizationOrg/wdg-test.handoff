{"nodes":[{"content":"Capture and Apply Windows, System, and Recovery Partitions","pos":[35,93]},{"content":"Capture and Apply Windows, System, and Recovery Partitions","pos":[202,260]},{"content":"Capture and Apply Windows, System, and Recovery Partitions","pos":[269,327]},{"content":"Capture a Windows image (.WIM) file and use it to deploy Windows to new devices.","pos":[330,410]},{"content":"Rather than capturing each partition, you can capture just the Windows partition into an image, and then use the files from that image to set up the rest of the partitions on the drive.","pos":[412,597]},{"content":"The following diagram illustrates this process:","pos":[599,646]},{"content":"diagram showing capturing the windows partition","pos":[650,697]},{"content":"Prepare to capture the image","pos":[763,791]},{"content":"Generalize the Windows image, so it can be deployed to other devices.","pos":[799,868]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Sysprep (Generalize) a Windows installation<ept id=\"p1\">](sysprep--generalize--a-windows-installation.md)</ept>.","pos":[869,989]},{"content":"Capture the image","pos":[993,1010]},{"pos":[1018,1069],"content":"Boot the device using <bpt id=\"p1\">[</bpt>Windows PE<ept id=\"p1\">](winpe-intro.md)</ept>."},{"content":"Optional: speed up the image capture by setting the power scheme to High performance:","pos":[1075,1160]},{"content":"Capture the Windows partition.","pos":[1243,1273]},{"content":"For example:","pos":[1274,1286]},{"content":"Where D: is a USB flash drive or other file storage location.","pos":[1400,1461]},{"pos":[1577,1595],"content":"Applying the image"},{"content":"Here's a few ways to apply the image:","pos":[1598,1635]},{"content":"Apply the image manually","pos":[1639,1663]},{"content":"On the destination device, use a DiskPart script to configure and format your hard drive partitions.","pos":[1671,1771]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Configure UEFI/GPT-Based Hard Drive Partitions<ept id=\"p1\">](configure-uefigpt-based-hard-drive-partitions.md)</ept> or <bpt id=\"p2\">[</bpt>Configure BIOS/MBR-Based Hard Drive Partitions<ept id=\"p2\">](configure-biosmbr-based-hard-drive-partitions.md)</ept>.","pos":[1772,1999]},{"pos":[2005,2249],"content":"**Note**  \nIf you apply an image to a volume that has an existing Windows installation, files from the previous installation may not be deleted. Format the volume by using a tool such as DiskPart before you apply the new image. For example:","leadings":["","    "],"nodes":[{"content":"Note","pos":[2,6]},{"content":"If you apply an image to a volume that has an existing Windows installation, files from the previous installation may not be deleted. Format the volume by using a tool such as DiskPart before you apply the new image. For example:","pos":[11,240],"nodes":[{"content":"If you apply an image to a volume that has an existing Windows installation, files from the previous installation may not be deleted.","pos":[0,133]},{"content":"Format the volume by using a tool such as DiskPart before you apply the new image.","pos":[134,216]},{"content":"For example:","pos":[217,229]}]}]},{"content":"Where D: is a USB flash drive or other file storage location.","pos":[2331,2392]},{"pos":[2398,2507],"content":"In these <bpt id=\"p1\">**</bpt>DiskPart<ept id=\"p1\">**</ept> examples, the partitions are assigned the letters: System=S, Windows=W, and Recovery=R."},{"content":"We recommend changing the Windows drive letter to a letter that’s near the end of the alphabet, such as W, to avoid drive letter conflicts.","pos":[2513,2652]},{"content":"Do not use X, because this drive letter is reserved for Windows PE.","pos":[2653,2720]},{"content":"After the device reboots, the Windows partition is assigned the letter C, and the other partitions don’t receive drive letters.","pos":[2721,2848]},{"content":"If you reboot, Windows PE reassigns disk letters alphabetically, starting with the letter C, without regard to the configuration in Windows Setup.","pos":[2854,3000]},{"content":"This configuration can change based on the presence of different drives, such as USB flash drives.","pos":[3001,3099]},{"content":"Optional: speed up the image capture by setting the power scheme to High performance:","pos":[3105,3190]},{"content":"Apply the image to the Windows partition:","pos":[3273,3314]},{"content":"where W: is the Windows partition.","pos":[3415,3449]},{"content":"Configure the system partition by using the BCDBoot tool.","pos":[3455,3512]},{"content":"This tool copies and configures system partition files by using files from the Windows partition.","pos":[3513,3610]},{"content":"For example:","pos":[3611,3623]},{"content":"Copy the Windows Recovery Environment (RE) tools into the recovery tools partition.","pos":[3702,3785]},{"content":"Where R: is the recovery partition","pos":[3924,3958]},{"content":"Register the location of the WindowsRE tools by using REAgentC.","pos":[3964,4027]},{"content":"Apply the image using a script","pos":[4147,4177]},{"content":"Prerequisite: Create DiskPart scripts to deploy your images.","pos":[4185,4245]},{"content":"For samples, get: <bpt id=\"p1\">[</bpt>CreatePartitions-UEFI.txt<ept id=\"p1\">](configure-uefigpt-based-hard-drive-partitions.md)</ept> or <bpt id=\"p2\">[</bpt>CreatePartitions-BIOS.txt<ept id=\"p2\">](configure-biosmbr-based-hard-drive-partitions.md)</ept>.","pos":[4246,4423]},{"content":"Copy the following script into Notepad, and then save the file as ApplyImage.bat:","pos":[4429,4510]},{"content":"On the destination computer, run the Diskpart and ApplyImage scripts to apply the image to the computer and set up the system, Windows, and recovery partitions.","pos":[5632,5792]},{"content":"For example:","pos":[5793,5805]},{"content":"where D:<ph id=\"ph1\">\\\\</ph>Images<ph id=\"ph2\">\\\\</ph>ThinImage.wim is the name of your Windows image file.","pos":[5919,5990]},{"content":"<bpt id=\"p1\">**</bpt>Note<ept id=\"p1\">**</ept>  If the DISM /Apply-Image command fails, make sure you’re using a <bpt id=\"p2\">[</bpt>supported version of DISM<ept id=\"p2\">](dism-supported-platforms.md)</ept> for that Windows image.","pos":[5996,6151]},{"content":"For example, to apply a Windows 10 image, you’ll need the Windows 10 version of DISM.","pos":[6152,6237]},{"content":"Capture and apply individual partitions (BIOS devices only)","pos":[6248,6307]},{"content":"On your reference device, capture each of the partitions individually using DISM /Capture-Image and then apply them to your destination devices using DISM /Apply-Image.","pos":[6315,6483]},{"content":"This method allows you flexibility in setting up your system partition.","pos":[6489,6560]},{"content":"Note, for UEFI-based devices, do not capture and apply the EFI system partition or the MSR partition – these are managed by the device.","pos":[6561,6696]},{"content":"Use the BCDBoot command to set up the system partition.","pos":[6702,6757]},{"content":"Capture and apply the entire drive","pos":[6808,6842]},{"content":"**** You can use the Full Flash Update (FFU) file format to capture and apply the entire drive.","pos":[6850,6945]},{"content":"To learn more, see <bpt id=\"p1\">[</bpt>Deploy Windows using Full Flash Update (FFU)<ept id=\"p1\">](deploy-windows-using-full-flash-update--ffu.md)</ept>.","pos":[6946,7060]},{"pos":[7098,7112],"content":"Related topics"},{"content":"Configure UEFI/GPT-Based Hard Drive Partitions","pos":[7116,7162]},{"content":"Configure BIOS/MBR-Based Hard Drive Partitions","pos":[7216,7262]},{"content":"BCDboot Command-Line Options","pos":[7316,7344]},{"content":"REAgentC Command-Line Options","pos":[7392,7421]}],"content":"---\nauthor: Justinha\nDescription: 'Capture and Apply Windows, System, and Recovery Partitions'\nms.assetid: db1f011f-2cf3-46b7-a386-8333f6214b9e\nMSHAttr: 'PreferredLib:/library/windows/hardware'\ntitle: 'Capture and Apply Windows, System, and Recovery Partitions'\n---\n\n# Capture and Apply Windows, System, and Recovery Partitions\n\n\nCapture a Windows image (.WIM) file and use it to deploy Windows to new devices.\n\nRather than capturing each partition, you can capture just the Windows partition into an image, and then use the files from that image to set up the rest of the partitions on the drive.\n\nThe following diagram illustrates this process:\n\n![diagram showing capturing the windows partition](images/dep-adk-partitions-uefi-overview-capture-windows.jpg)\n\n**Prepare to capture the image**\n\n-   Generalize the Windows image, so it can be deployed to other devices. For more information, see [Sysprep (Generalize) a Windows installation](sysprep--generalize--a-windows-installation.md).\n\n**Capture the image**\n\n1.  Boot the device using [Windows PE](winpe-intro.md).\n\n2.  Optional: speed up the image capture by setting the power scheme to High performance:\n\n    ``` syntax\n    powercfg /s 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c\n    ```\n\n3.  Capture the Windows partition. For example:\n\n    ``` syntax\n    Dism /Capture-Image /ImageFile:\"D:\\fabrikam.wim\" /CaptureDir:C:\\ /Name:Fabrikam\n    ```\n\n    Where D: is a USB flash drive or other file storage location.\n\n## <span id=\"Applying_the_image\"></span><span id=\"applying_the_image\"></span><span id=\"APPLYING_THE_IMAGE\"></span>Applying the image\n\n\nHere's a few ways to apply the image:\n\n**Apply the image manually**\n\n1.  On the destination device, use a DiskPart script to configure and format your hard drive partitions. For more information, see [Configure UEFI/GPT-Based Hard Drive Partitions](configure-uefigpt-based-hard-drive-partitions.md) or [Configure BIOS/MBR-Based Hard Drive Partitions](configure-biosmbr-based-hard-drive-partitions.md).\n\n    **Note**  \n    If you apply an image to a volume that has an existing Windows installation, files from the previous installation may not be deleted. Format the volume by using a tool such as DiskPart before you apply the new image. For example:\n\n     \n\n    ``` syntax\n    diskpart /s D:\\CreatePartitions-UEFI.txt\n    ```\n\n    Where D: is a USB flash drive or other file storage location.\n\n    In these **DiskPart** examples, the partitions are assigned the letters: System=S, Windows=W, and Recovery=R.\n\n    We recommend changing the Windows drive letter to a letter that’s near the end of the alphabet, such as W, to avoid drive letter conflicts. Do not use X, because this drive letter is reserved for Windows PE. After the device reboots, the Windows partition is assigned the letter C, and the other partitions don’t receive drive letters.\n\n    If you reboot, Windows PE reassigns disk letters alphabetically, starting with the letter C, without regard to the configuration in Windows Setup. This configuration can change based on the presence of different drives, such as USB flash drives.\n\n2.  Optional: speed up the image capture by setting the power scheme to High performance:\n\n    ``` syntax\n    powercfg /s 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c\n    ```\n\n3.  Apply the image to the Windows partition:\n\n    ``` syntax\n    dism /Apply-Image /ImageFile:D:\\install.wim /Index:1 /ApplyDir:W:\\\n    ```\n\n    where W: is the Windows partition.\n\n4.  Configure the system partition by using the BCDBoot tool. This tool copies and configures system partition files by using files from the Windows partition. For example:\n\n    ``` syntax\n    W:\\Windows\\System32\\bcdboot W:\\Windows /s S:\n    ```\n\n5.  Copy the Windows Recovery Environment (RE) tools into the recovery tools partition.\n\n    ``` syntax\n    md R:\\Recovery\\WindowsRE\n    copy C:\\Windows\\System32\\Recovery\\winre.wim R:\\Recovery\\WindowsRE\\winre.wim\n    ```\n\n    Where R: is the recovery partition\n\n6.  Register the location of the WindowsRE tools by using REAgentC.\n\n    ``` syntax\n    W:\\Windows\\System32\\reagentc /setreimage /path R:\\Recovery\\WindowsRE /target W:\\Windows\n    ```\n\n**Apply the image using a script**\n\n1.  Prerequisite: Create DiskPart scripts to deploy your images. For samples, get: [CreatePartitions-UEFI.txt](configure-uefigpt-based-hard-drive-partitions.md) or [CreatePartitions-BIOS.txt](configure-biosmbr-based-hard-drive-partitions.md).\n\n2.  Copy the following script into Notepad, and then save the file as ApplyImage.bat:\n\n    ``` syntax\n    rem == ApplyImage.bat ==\n\n    rem == These commands deploy a specified Windows\n    rem    image file to the Windows partition, and configure\n    rem    the system partition.\n\n    rem    Usage:   ApplyImage WimFileName \n    rem    Example: ApplyImage E:\\Images\\ThinImage.wim ==\n\n    rem == Set high-performance power scheme to speed deployment ==\n    call powercfg /s 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c\n\n    rem == Apply the image to the Windows partition ==\n    dism /Apply-Image /ImageFile:%1 /Index:1 /ApplyDir:W:\\\n\n    rem == Copy boot files to the System partition ==\n    W:\\Windows\\System32\\bcdboot W:\\Windows /s S:\n\n    :rem == Copy the Windows RE image to the\n    :rem    Windows RE Tools partition ==\n    md R:\\Recovery\\WindowsRE\n    xcopy /h W:\\Windows\\System32\\Recovery\\Winre.wim R:\\Recovery\\WindowsRE\\\n\n    :rem == Register the location of the recovery tools ==\n    W:\\Windows\\System32\\Reagentc /Setreimage /Path R:\\Recovery\\WindowsRE /Target W:\\Windows\n\n    :rem == Verify the configuration status of the images. ==\n    W:\\Windows\\System32\\Reagentc /Info /Target W:\\Windows\n    ```\n\n3.  On the destination computer, run the Diskpart and ApplyImage scripts to apply the image to the computer and set up the system, Windows, and recovery partitions. For example:\n\n    ``` syntax\n    diskpart /s D:\\CreatePartitions-UEFI.txt\n    ApplyImage E:\\Images\\ThinImage.wim\n    ```\n\n    where D:\\\\Images\\\\ThinImage.wim is the name of your Windows image file.\n\n    **Note**  If the DISM /Apply-Image command fails, make sure you’re using a [supported version of DISM](dism-supported-platforms.md) for that Windows image. For example, to apply a Windows 10 image, you’ll need the Windows 10 version of DISM.\n\n     \n\n**Capture and apply individual partitions (BIOS devices only)**\n\n1.  On your reference device, capture each of the partitions individually using DISM /Capture-Image and then apply them to your destination devices using DISM /Apply-Image.\n\n    This method allows you flexibility in setting up your system partition. Note, for UEFI-based devices, do not capture and apply the EFI system partition or the MSR partition – these are managed by the device.\n\n2.  Use the BCDBoot command to set up the system partition.\n\n    ``` syntax\n    bcdboot C:\\Windows\n    ```\n\n**Capture and apply the entire drive**\n\n-   **** You can use the Full Flash Update (FFU) file format to capture and apply the entire drive. To learn more, see [Deploy Windows using Full Flash Update (FFU)](deploy-windows-using-full-flash-update--ffu.md).\n\n## <span id=\"related_topics\"></span>Related topics\n\n\n[Configure UEFI/GPT-Based Hard Drive Partitions](configure-uefigpt-based-hard-drive-partitions.md)\n\n[Configure BIOS/MBR-Based Hard Drive Partitions](configure-biosmbr-based-hard-drive-partitions.md)\n\n[BCDboot Command-Line Options](bcdboot-command-line-options-techref-di.md)\n\n[REAgentC Command-Line Options](reagentc-command-line-options.md)\n\n \n\n \n\n\n\n\n\n\n"}
{"nodes":[{"content":"Exercise 4 - Identify Problems with USB Devices","pos":[11,58]},{"content":"The USB host controllers can power down only after all of the devices connected to them have entered a low power state.","pos":[72,191]},{"content":"Exercise 4 - Identify Problems with USB Devices","pos":[327,374]},{"content":"The USB host controllers can power down only after all of the devices connected to them have entered a low power state.","pos":[377,496]},{"content":"This means that USB devices must support selective suspend on Modern Standby devices to ensure that the SoC can enter <bpt id=\"p1\">**</bpt>DRIPS<ept id=\"p1\">**</ept> while the screen is off.","pos":[497,649]},{"content":"Part 1: Use a SleepStudy report to identify problems","pos":[654,706]},{"pos":[713,891],"content":"Download the pre-generated <bpt id=\"p1\">**</bpt>sleepstudy-report<ph id=\"ph1\">\\_</ph>2.html<ept id=\"p1\">**</ept> report <bpt id=\"p2\">[</bpt>here<ept id=\"p2\">](http://download.microsoft.com/download/3/2/E/32E8B553-47F6-4E2A-9109-C6D678FE0EE8/sleepstudy-report_2.mdl)</ept>."},{"pos":[897,959],"content":"Open <bpt id=\"p1\">**</bpt>sleepstudy-report<ph id=\"ph1\">\\_</ph>2.html<ept id=\"p1\">**</ept> with your favorite browser."},{"content":"Notice that the system is able to consume as little as 120 mW during Standby (e.g. see Standby Session 6).","pos":[969,1075]},{"content":"Click on <bpt id=\"p1\">**</bpt>Session 10<ept id=\"p1\">**</ept>.","pos":[1114,1138]},{"content":"The system consumes 2.83 Watts of energy during 11 minutes and the <bpt id=\"p1\">**</bpt>DRIPS %<ept id=\"p1\">**</ept> is 0.","pos":[1139,1223]},{"pos":[1263,1299],"content":"Look at the <bpt id=\"p1\">**</bpt>Top Offenders<ept id=\"p1\">**</ept> table."},{"pos":[1309,1395],"content":"The USB host controller (<bpt id=\"p1\">**</bpt><ph id=\"ph1\">\\_</ph>SB.PCI0.XHC<ept id=\"p1\">**</ept>) is active for 99% of the session duration."},{"content":"XHC is the USB 3.0 host controller.","pos":[1405,1440]},{"content":"When the USB bus controller is active for minutes at a time in Modern Standby, it usually means that one USB device attached to the bus is not entering selective suspend, possibly because it doesn’t support selective suspend.","pos":[1472,1697]},{"content":"The next logical step is to determine which USB device is staying in D0 by looking at an ETL trace.","pos":[1698,1797]},{"pos":[1799,1950],"content":"For more information on selective suspend, see the <bpt id=\"p1\">[</bpt>USB Selective Suspend<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/hardware/ff540144)</ept> topic on MSDN."},{"content":"Part 2: Use an ETL trace to identify problems","pos":[1955,2000]},{"pos":[2003,2130],"content":"In order to further the USB investigation, an ETL trace was captured on the same system where the <bpt id=\"p1\">**</bpt>SleepStudy<ept id=\"p1\">**</ept> was generated."},{"pos":[2132,2201],"content":"To investigate USB issues, you’ll use the <bpt id=\"p1\">**</bpt>DState<ept id=\"p1\">**</ept> graph and table."},{"pos":[2207,2364],"content":"Download the pre-generated <bpt id=\"p1\">**</bpt>USBProblem.etl<ept id=\"p1\">**</ept> trace <bpt id=\"p2\">[</bpt>here<ept id=\"p2\">](http://download.microsoft.com/download/5/1/C/51CB1607-D3A8-455B-828A-244A56B06791/USBProblem.etl)</ept>."},{"pos":[2370,2407],"content":"Open <bpt id=\"p1\">**</bpt>USBProblem.etl<ept id=\"p1\">**</ept> with <bpt id=\"p2\">**</bpt>WPA<ept id=\"p2\">**</ept>."},{"pos":[2413,2471],"content":"Drag and drop the <bpt id=\"p1\">**</bpt>DRIPS<ept id=\"p1\">**</ept> graph in the <bpt id=\"p2\">**</bpt>analysis<ept id=\"p2\">**</ept> tab."},{"pos":[2477,2608],"content":"Look at the <bpt id=\"p1\">**</bpt>Non-Drips Reasons<ept id=\"p1\">**</ept>, and find the USB xHCI Host controller as a device preventing the system from entering <bpt id=\"p2\">**</bpt>DRIPS<ept id=\"p2\">**</ept>."},{"pos":[2618,2720],"content":"You can see that the device is active for 98% of the trace (as shown in the <bpt id=\"p1\">**</bpt>% Reason time<ept id=\"p1\">**</ept> column)."},{"content":"Zoom in the region where the USB xHCI Host controller is active.","pos":[2764,2828]},{"content":"Select the device in the table.","pos":[2838,2869]},{"content":"Right-click on the light blue interval in the graph, and select zoom.","pos":[2879,2948]},{"pos":[2958,2999],"content":"The <bpt id=\"p1\">**</bpt>% Reason time<ept id=\"p1\">**</ept> should now be 100%."},{"pos":[3039,3127],"content":"Find the <bpt id=\"p1\">**</bpt>Device Dstate<ept id=\"p1\">**</ept> graph under the <bpt id=\"p2\">**</bpt>Power<ept id=\"p2\">**</ept> category of the <bpt id=\"p3\">**</bpt>Graph Explorer<ept id=\"p3\">**</ept>."},{"pos":[3167,3233],"content":"Drag and drop the <bpt id=\"p1\">**</bpt>Device Dstate<ept id=\"p1\">**</ept> graph in the <bpt id=\"p2\">**</bpt>analysis<ept id=\"p2\">**</ept> tab."},{"content":"The <bpt id=\"p1\">**</bpt>Device DState<ept id=\"p1\">**</ept> graph shows the effective D-States of devices over time.","pos":[3243,3321]},{"content":"You can use the data to determine if a specific device enters the appropriate D-state while the system is in Modern Standby.","pos":[3322,3446]},{"pos":[3460,3542],"content":"<bpt id=\"p1\">**</bpt>PoFx type<ept id=\"p1\">**</ept>: Used for devices managed by the Windows Power Management Framework."},{"pos":[3556,3605],"content":"<bpt id=\"p1\">**</bpt>Non-PoFx type<ept id=\"p1\">**</ept>: Used for USB-attached devices."},{"content":"Move the <bpt id=\"p1\">**</bpt>DState<ept id=\"p1\">**</ept> column right next to the <bpt id=\"p2\">**</bpt>Type<ept id=\"p2\">**</ept> column.","pos":[3611,3672]},{"content":"Your viewport should look like this:","pos":[3673,3709]},{"pos":[3749,3782],"content":"Expand the <bpt id=\"p1\">**</bpt>Non-PoFX<ept id=\"p1\">**</ept> category."},{"pos":[3788,3855],"content":"Expand the <bpt id=\"p1\">**</bpt>Dstate<ept id=\"p1\">**</ept> row with the 0x0 value (D0 state, or active)."},{"pos":[3861,3914],"content":"Sort by the <bpt id=\"p1\">**</bpt>Name<ept id=\"p1\">**</ept> column and find the USB devices."},{"content":"The data in the D-state table shows that, while the system was in standby, a USB composite device was still in state D0 for 100% of the time.","pos":[3950,4091]},{"content":"The hardware id of the composite device is USB<ph id=\"ph1\">\\\\</ph>VID<ph id=\"ph2\">\\_</ph>0BB4&amp;PID<ph id=\"ph3\">\\_</ph>0BA1<ph id=\"ph4\">\\\\</ph>00000015B42EE80F0000000000000000.","pos":[4092,4194]},{"content":"This is the device that was preventing the XHCI controller from powering down.","pos":[4195,4273]},{"content":"If the device is managed by a driver authored by Microsoft, please report the issue to Microsoft.","pos":[4275,4372]},{"content":"If not, then this information must be reported to the hardware vendor who owns the driver to find a solution and ensure that the device enters selective suspend.","pos":[4373,4534]}],"content":"---\ntitle: Exercise 4 - Identify Problems with USB Devices\ndescription: The USB host controllers can power down only after all of the devices connected to them have entered a low power state.\nMSHAttr:\n- 'PreferredSiteName:MSDN'\n- 'PreferredLib:/library/windows/hardware'\nms.assetid: AE0C4C51-7DD6-4A18-AEC4-DD01CB24A7A4\n---\n\n# Exercise 4 - Identify Problems with USB Devices\n\n\nThe USB host controllers can power down only after all of the devices connected to them have entered a low power state. This means that USB devices must support selective suspend on Modern Standby devices to ensure that the SoC can enter **DRIPS** while the screen is off.\n\n## Part 1: Use a SleepStudy report to identify problems\n\n\n1.  Download the pre-generated **sleepstudy-report\\_2.html** report [here](http://download.microsoft.com/download/3/2/E/32E8B553-47F6-4E2A-9109-C6D678FE0EE8/sleepstudy-report_2.mdl).\n\n2.  Open **sleepstudy-report\\_2.html** with your favorite browser.\n\n    -   Notice that the system is able to consume as little as 120 mW during Standby (e.g. see Standby Session 6).\n\n    ![](images/standbylab9.png)\n\n3.  Click on **Session 10**. The system consumes 2.83 Watts of energy during 11 minutes and the **DRIPS %** is 0.\n\n    ![](images/standbylab10.png)\n\n4.  Look at the **Top Offenders** table.\n\n    1.  The USB host controller (**\\_SB.PCI0.XHC**) is active for 99% of the session duration.\n\n    2.  XHC is the USB 3.0 host controller.\n\n![](images/standbylab11.png)\n\nWhen the USB bus controller is active for minutes at a time in Modern Standby, it usually means that one USB device attached to the bus is not entering selective suspend, possibly because it doesn’t support selective suspend. The next logical step is to determine which USB device is staying in D0 by looking at an ETL trace.\n\nFor more information on selective suspend, see the [USB Selective Suspend](https://msdn.microsoft.com/library/windows/hardware/ff540144) topic on MSDN.\n\n## Part 2: Use an ETL trace to identify problems\n\n\nIn order to further the USB investigation, an ETL trace was captured on the same system where the **SleepStudy** was generated.\n\nTo investigate USB issues, you’ll use the **DState** graph and table.\n\n1.  Download the pre-generated **USBProblem.etl** trace [here](http://download.microsoft.com/download/5/1/C/51CB1607-D3A8-455B-828A-244A56B06791/USBProblem.etl).\n\n2.  Open **USBProblem.etl** with **WPA**.\n\n3.  Drag and drop the **DRIPS** graph in the **analysis** tab.\n\n4.  Look at the **Non-Drips Reasons**, and find the USB xHCI Host controller as a device preventing the system from entering **DRIPS**.\n\n    -   You can see that the device is active for 98% of the trace (as shown in the **% Reason time** column).\n\n        ![](images/standbylab12.png)\n\n5.  Zoom in the region where the USB xHCI Host controller is active.\n\n    1.  Select the device in the table.\n\n    2.  Right-click on the light blue interval in the graph, and select zoom.\n\n    3.  The **% Reason time** should now be 100%.\n\n    ![](images/standbylab13.png)\n\n6.  Find the **Device Dstate** graph under the **Power** category of the **Graph Explorer**.\n\n    ![](images/standbylab14.png)\n\n7.  Drag and drop the **Device Dstate** graph in the **analysis** tab.\n\n    -   The **Device DState** graph shows the effective D-States of devices over time. You can use the data to determine if a specific device enters the appropriate D-state while the system is in Modern Standby.\n\n        -   **PoFx type**: Used for devices managed by the Windows Power Management Framework.\n\n        -   **Non-PoFx type**: Used for USB-attached devices.\n\n8.  Move the **DState** column right next to the **Type** column. Your viewport should look like this:\n\n    ![](images/standbylab15.png)\n\n9.  Expand the **Non-PoFX** category.\n\n10. Expand the **Dstate** row with the 0x0 value (D0 state, or active).\n\n11. Sort by the **Name** column and find the USB devices.\n\n    ![](images/standbylab16.png)\n\nThe data in the D-state table shows that, while the system was in standby, a USB composite device was still in state D0 for 100% of the time. The hardware id of the composite device is USB\\\\VID\\_0BB4&PID\\_0BA1\\\\00000015B42EE80F0000000000000000. This is the device that was preventing the XHCI controller from powering down.\n\nIf the device is managed by a driver authored by Microsoft, please report the issue to Microsoft. If not, then this information must be reported to the hardware vendor who owns the driver to find a solution and ensure that the device enters selective suspend.\n\n \n\n \n\n\n\n\n\n\n"}
{"nodes":[{"content":"Exercise 3 - Track Driver Footprint and Dynamic Allocations During Boot","pos":[11,82]},{"content":"Pool is the memory resource for kernel mode components that the OS and device drivers use to store their data structures.","pos":[96,217]},{"content":"Exercise 3 - Track Driver Footprint and Dynamic Allocations During Boot","pos":[406,477]},{"content":"<bpt id=\"p1\">**</bpt>Pool<ept id=\"p1\">**</ept> is the memory resource for kernel mode components that the OS and device drivers use to store their data structures.","pos":[480,605]},{"content":"Pool has four basic allocation areas:","pos":[606,643]},{"pos":[649,721],"content":"<bpt id=\"p1\">**</bpt>Non Paged Pool:<ept id=\"p1\">**</ept> Allocations guaranteed to reside in physical memory."},{"pos":[727,803],"content":"<bpt id=\"p1\">**</bpt>Paged Pool:<ept id=\"p1\">**</ept> Allocations that can be paged out of memory to the pagefile."},{"pos":[809,883],"content":"<bpt id=\"p1\">**</bpt>NX Non Pageable Pool:<ept id=\"p1\">**</ept> Non-paged allocations, which are not executable."},{"content":"<bpt id=\"p1\">**</bpt>Session pool:<ept id=\"p1\">**</ept> Allocations made per session.","pos":[889,936]},{"content":"These are pageable.","pos":[937,956]},{"content":"Pool usage is a significant contributor to the overall memory usage on a machine – it is the largest consumer of memory immediately after boot.","pos":[958,1101]},{"content":"Any reduction in Pool usage reduces the overall memory usage of the system across the OS, with non-pageable memory being the highest priority category to drive reductions (for).","pos":[1102,1279]},{"content":"In this exercise, you’ll review inbox Microsoft driver allocations and their footprint (at their initialization time) during boot.","pos":[1281,1411]},{"content":"Step 1: Gather a pool memory trace across a boot transition","pos":[1416,1475]},{"pos":[1478,1605],"content":"In this step, you’ll gather a boot trace using <bpt id=\"p1\">**</bpt>Windows Performance Recorder (WPR)<ept id=\"p1\">**</ept> that contains pool and resident set data."},{"pos":[1611,1647],"content":"Open <bpt id=\"p1\">**</bpt>WPR<ept id=\"p1\">**</ept> from the <bpt id=\"p2\">**</bpt>Start<ept id=\"p2\">**</ept> menu"},{"content":"Select the right event providers:","pos":[1653,1686]},{"content":"Pool usage","pos":[1698,1708]},{"content":"Resident Set","pos":[1722,1734]},{"content":"First Level Triage","pos":[1748,1766]},{"pos":[1774,1822],"content":"Select <bpt id=\"p1\">**</bpt>boot<ept id=\"p1\">**</ept> as the <bpt id=\"p2\">**</bpt>performance scenario<ept id=\"p2\">**</ept>."},{"pos":[1828,1868],"content":"Select <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept> as the <bpt id=\"p2\">**</bpt>logging mode<ept id=\"p2\">**</ept>."},{"pos":[1874,1912],"content":"Set 1 as the <bpt id=\"p1\">**</bpt>Number of Iterations<ept id=\"p1\">**</ept>."},{"pos":[1918,1982],"content":"Click <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> and then select a location to save the ETL file."},{"content":"The system automatically reboots, gathers a trace, and stops after the desktop becomes visible.","pos":[1984,2079]},{"content":"Step 2: Review pool data using WPA","pos":[2122,2156]},{"content":"The <bpt id=\"p1\">**</bpt>Pool<ept id=\"p1\">**</ept> data is exposed via the <bpt id=\"p2\">**</bpt>Pool Graph<ept id=\"p2\">**</ept> summary table in <bpt id=\"p3\">**</bpt>WPA<ept id=\"p3\">**</ept>.","pos":[2159,2236]},{"content":"The key columns of interest are in the following table.","pos":[2237,2292]},{"content":"You can add or remove columns if you right-click on the column headers.","pos":[2294,2365]},{"content":"Terminology","pos":[2369,2380]},{"content":"Description","pos":[2387,2398]},{"content":"Pool Tag","pos":[2619,2627]},{"content":"The tag associated with a pool allocation.","pos":[2637,2679]},{"content":"Pool Tag Module","pos":[2744,2759]},{"content":"The module (driver) associated with a pool tag.","pos":[2762,2809]},{"content":"Stack","pos":[2869,2874]},{"content":"Shows the code path on a thread leading to a memory allocation.","pos":[2887,2950]},{"content":"Paged","pos":[2994,2999]},{"content":"Indicates whether or not the allocations were placed into a Paged Pool or Non-Paged Pool.","pos":[3012,3101]},{"content":"Impacting type","pos":[3119,3133]},{"content":"Shows whether an allocation contributes to the steady state memory usage or is a transient allocation.","pos":[3137,3239]},{"pos":[3250,3301],"content":"Open the trace you captured in Step 1 with <bpt id=\"p1\">**</bpt>WPA<ept id=\"p1\">**</ept>."},{"pos":[3307,3369],"content":"Open the <bpt id=\"p1\">**</bpt>Trace<ept id=\"p1\">**</ept> menu and select <bpt id=\"p2\">**</bpt>Configure symbols path<ept id=\"p2\">**</ept>."},{"content":"Specify the path of the symbol cache.","pos":[3379,3416]},{"content":"For more information on symbols, see the <bpt id=\"p1\">[</bpt>Symbol Support<ept id=\"p1\">](https://go.microsoft.com/fwlink/?linkid=623019)</ept> page on MSDN.","pos":[3417,3536]},{"pos":[3542,3594],"content":"Open the <bpt id=\"p1\">**</bpt>Trace<ept id=\"p1\">**</ept> menu and select <bpt id=\"p2\">**</bpt>Load symbols<ept id=\"p2\">**</ept>."},{"pos":[3600,3676],"content":"Find the <bpt id=\"p1\">**</bpt>Pool<ept id=\"p1\">**</ept> graph in the <bpt id=\"p2\">**</bpt>Memory<ept id=\"p2\">**</ept> category of the <bpt id=\"p3\">**</bpt>Graph Explorer<ept id=\"p3\">**</ept>"},{"pos":[3682,3741],"content":"Drag and drop the <bpt id=\"p1\">**</bpt>Pool<ept id=\"p1\">**</ept> graph onto the <bpt id=\"p2\">**</bpt>Analysis<ept id=\"p2\">**</ept> tab."},{"content":"Organize the table to show these columns:","pos":[3747,3788]},{"content":"Pool tag module","pos":[3800,3815]},{"content":"Paged","pos":[3829,3834]},{"content":"Impacting type","pos":[3848,3862]},{"content":"Stack","pos":[3876,3881]},{"content":"Pool tag","pos":[3895,3903]},{"content":"Count","pos":[3917,3922]},{"pos":[3934,3965],"content":"<bpt id=\"p1\">**</bpt>Impacting Size<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>Size<ept id=\"p2\">**</ept>"},{"content":"Note on Pool Tags:","pos":[3973,3991]},{"content":"If you’re a driver developer, make sure that the pool tags used by your driver are clear and easily identifiable to facilitate analysis.","pos":[4001,4137]},{"content":"For example, if your company name is Fabrikam, you could add a “Fbk” prefix to all pool tags: FbkPool1, FbkPool2, FbkBuffer, etc.","pos":[4138,4267]},{"pos":[4315,4425],"content":"Disable all series on the graph (Right-click -<ph id=\"ph1\">&amp;gt;</ph> <bpt id=\"p1\">**</bpt>Disable<ept id=\"p1\">**</ept><ph id=\"ph2\"> -&amp;gt;</ph> <bpt id=\"p2\">**</bpt>In Entire Graph<ept id=\"p2\">**</ept><ph id=\"ph3\"> -&amp;gt;</ph> <bpt id=\"p3\">**</bpt>All Series<ept id=\"p3\">**</ept>)"},{"pos":[4473,4548],"content":"Sort by impacting size by clicking on the <bpt id=\"p1\">**</bpt>Impacting Size<ept id=\"p1\">**</ept> column header."},{"content":"Drivers that have the highest steady state memory usage display at the top.","pos":[4554,4629]},{"content":"Step 3: Intercept pool allocation data","pos":[4634,4672]},{"content":"Zoom into the first 30 seconds of the timeline.","pos":[4679,4726]},{"content":"Select one driver (for example, ACPI.sys, but any will do).","pos":[4732,4791]},{"pos":[4801,4851],"content":"Review the <bpt id=\"p1\">**</bpt>NonPaged<ept id=\"p1\">**</ept> memory and expand the row."},{"pos":[4861,5004],"content":"<bpt id=\"p1\">**</bpt>NonPaged<ept id=\"p1\">**</ept> memory should be the focus of your investigations as it can’t be moved to the pagefile when there’s memory pressure on the system."},{"pos":[5014,5087],"content":"Enable the <bpt id=\"p1\">**</bpt>Legend<ept id=\"p1\">**</ept> for the <bpt id=\"p2\">**</bpt>Impacting<ept id=\"p2\">**</ept> and <bpt id=\"p3\">**</bpt>Transient<ept id=\"p3\">**</ept> categories."},{"pos":[5139,5199],"content":"Sort by <bpt id=\"p1\">**</bpt>Impacting Size<ept id=\"p1\">**</ept> by clicking on the column header."},{"content":"<bpt id=\"p1\">**</bpt>Impacting<ept id=\"p1\">**</ept> memory directly contributes to the overall memory footprint of the driver at all times.","pos":[5205,5306]},{"content":"In the preceding example, you can tell that ACPI.sys uses some non-paged memory at all times, and that this steady state usage increases twice (first when the driver is loading, then a second time at around 3 seconds).","pos":[5307,5525]},{"content":"Expand the stack and navigate through it.","pos":[5535,5576]},{"content":"At the top, you should see function calls that lead to the largest steady state pool allocations.","pos":[5577,5674]},{"content":"In the following example, you can see that ACPI.sys makes a total of 255 pool allocations, totaling 1.2 MB under the <bpt id=\"p1\">**</bpt>ACPIInitStartACPI<ept id=\"p1\">**</ept> function.","pos":[5684,5832]},{"content":"This is where the driver developer should focus in order to improve the driver steady state memory usage, as this function accounts for most of the driver allocations.","pos":[5833,6000]},{"pos":[6052,6102],"content":"Sort by <bpt id=\"p1\">**</bpt>Size<ept id=\"p1\">**</ept> by clicking on the column header."},{"content":"Do the same thing for the <bpt id=\"p1\">**</bpt>Transient<ept id=\"p1\">**</ept> category.","pos":[6108,6157]},{"content":"Expand the stack and navigate through it.","pos":[6158,6199]},{"content":"At the top, you should see function calls leading to the largest transient pool allocations.","pos":[6200,6292]},{"content":"In the following example, you can see the initial spike of transient memory usage is mainly caused by ACPI executing DPCs of devices (<bpt id=\"p1\">**</bpt>ACPI.sys!ACPIBuildDeviceDpc<ept id=\"p1\">**</ept>).","pos":[6302,6469]},{"content":"The spike that introduced the code under this function call totals 455 KB.","pos":[6470,6544]},{"content":"Step 4: Measure the driver code footprint","pos":[6595,6636]},{"pos":[6643,6728],"content":"Find the <bpt id=\"p1\">**</bpt>Resident Set<ept id=\"p1\">**</ept> graph in the <bpt id=\"p2\">**</bpt>Memory<ept id=\"p2\">**</ept> category of the <bpt id=\"p3\">**</bpt>Graph Explorer<ept id=\"p3\">**</ept>."},{"pos":[6734,6797],"content":"Drag and drop the <bpt id=\"p1\">**</bpt>Resident Set<ept id=\"p1\">**</ept> graph onto the Analysis tab."},{"content":"Make sure to unzoom the graph (Ctrl+Shift+”-“).","pos":[6803,6850]},{"pos":[6856,6901],"content":"Select the <bpt id=\"p1\">**</bpt>File Backed Page<ept id=\"p1\">**</ept> graph preset."},{"pos":[6949,7078],"content":"Through the <bpt id=\"p1\">**</bpt>path tree<ept id=\"p1\">**</ept> column, navigate to the driver you selected in Step 3 (for example, ACPI.sys under C:/Windows/drivers)."},{"pos":[7084,7149],"content":"Expand the <bpt id=\"p1\">**</bpt>Driver<ept id=\"p1\">**</ept> category and focus on the <bpt id=\"p2\">**</bpt>Active<ept id=\"p2\">**</ept> pages."},{"content":"The value in the <bpt id=\"p1\">**</bpt>Size<ept id=\"p1\">**</ept> column represents the impact the driver code has on the memory footprint.","pos":[7155,7254]},{"content":"In the following example, it is 0.48 MB.","pos":[7255,7295]}],"content":"---\ntitle: Exercise 3 - Track Driver Footprint and Dynamic Allocations During Boot\ndescription: Pool is the memory resource for kernel mode components that the OS and device drivers use to store their data structures.\nMSHAttr:\n- 'PreferredSiteName:MSDN'\n- 'PreferredLib:/library/windows/hardware'\nms.assetid: C77947E1-D20A-4728-878C-3748B1068DEC\nms.prod: W10\nms.mktglfcycl: operate\nms.sitesec: msdn\n---\n\n# Exercise 3 - Track Driver Footprint and Dynamic Allocations During Boot\n\n\n**Pool** is the memory resource for kernel mode components that the OS and device drivers use to store their data structures. Pool has four basic allocation areas:\n\n1.  **Non Paged Pool:** Allocations guaranteed to reside in physical memory.\n\n2.  **Paged Pool:** Allocations that can be paged out of memory to the pagefile.\n\n3.  **NX Non Pageable Pool:** Non-paged allocations, which are not executable.\n\n4.  **Session pool:** Allocations made per session. These are pageable.\n\nPool usage is a significant contributor to the overall memory usage on a machine – it is the largest consumer of memory immediately after boot. Any reduction in Pool usage reduces the overall memory usage of the system across the OS, with non-pageable memory being the highest priority category to drive reductions (for).\n\nIn this exercise, you’ll review inbox Microsoft driver allocations and their footprint (at their initialization time) during boot.\n\n## Step 1: Gather a pool memory trace across a boot transition\n\n\nIn this step, you’ll gather a boot trace using **Windows Performance Recorder (WPR)** that contains pool and resident set data.\n\n1.  Open **WPR** from the **Start** menu\n\n2.  Select the right event providers:\n\n    1.  **Pool usage**\n\n    2.  **Resident Set**\n\n    3.  **First Level Triage**\n\n3.  Select **boot** as the **performance scenario**.\n\n4.  Select **File** as the **logging mode**.\n\n5.  Set 1 as the **Number of Iterations**.\n\n6.  Click **Start** and then select a location to save the ETL file.\n\nThe system automatically reboots, gathers a trace, and stops after the desktop becomes visible.\n\n![](images/memoryfootprintlab25.png)\n\n## Step 2: Review pool data using WPA\n\n\nThe **Pool** data is exposed via the **Pool Graph** summary table in **WPA**. The key columns of interest are in the following table.\n\nYou can add or remove columns if you right-click on the column headers.\n\n| Terminology     | Description                                                                                            |\n|-----------------|--------------------------------------------------------------------------------------------------------|\n| Pool Tag        | The tag associated with a pool allocation.                                                             |\n| Pool Tag Module | The module (driver) associated with a pool tag.                                                        |\n| Stack           | Shows the code path on a thread leading to a memory allocation.                                        |\n| Paged           | Indicates whether or not the allocations were placed into a Paged Pool or Non-Paged Pool.              |\n| Impacting type  | Shows whether an allocation contributes to the steady state memory usage or is a transient allocation. |\n\n \n\n1.  Open the trace you captured in Step 1 with **WPA**.\n\n2.  Open the **Trace** menu and select **Configure symbols path**.\n\n    -   Specify the path of the symbol cache. For more information on symbols, see the [Symbol Support](https://go.microsoft.com/fwlink/?linkid=623019) page on MSDN.\n\n3.  Open the **Trace** menu and select **Load symbols**.\n\n4.  Find the **Pool** graph in the **Memory** category of the **Graph Explorer**\n\n5.  Drag and drop the **Pool** graph onto the **Analysis** tab.\n\n6.  Organize the table to show these columns:\n\n    1.  **Pool tag module**\n\n    2.  **Paged**\n\n    3.  **Impacting type**\n\n    4.  **Stack**\n\n    5.  **Pool tag**\n\n    6.  **Count**\n\n    7.  **Impacting Size** and **Size**\n\n    **Note on Pool Tags:  **\n\n    If you’re a driver developer, make sure that the pool tags used by your driver are clear and easily identifiable to facilitate analysis. For example, if your company name is Fabrikam, you could add a “Fbk” prefix to all pool tags: FbkPool1, FbkPool2, FbkBuffer, etc.\n\n    ![](images/memoryfootprintlab26.png)\n\n7.  Disable all series on the graph (Right-click -&gt; **Disable** -&gt; **In Entire Graph** -&gt; **All Series**)\n\n    ![](images/memoryfootprintlab27.png)\n\n8.  Sort by impacting size by clicking on the **Impacting Size** column header.\n\n    Drivers that have the highest steady state memory usage display at the top.\n\n## Step 3: Intercept pool allocation data\n\n\n1.  Zoom into the first 30 seconds of the timeline.\n\n2.  Select one driver (for example, ACPI.sys, but any will do).\n\n    1.  Review the **NonPaged** memory and expand the row.\n\n        **NonPaged** memory should be the focus of your investigations as it can’t be moved to the pagefile when there’s memory pressure on the system.\n\n    2.  Enable the **Legend** for the **Impacting** and **Transient** categories.\n\n        ![](images/memoryfootprintlab28.png)\n\n3.  Sort by **Impacting Size** by clicking on the column header.\n\n4.  **Impacting** memory directly contributes to the overall memory footprint of the driver at all times. In the preceding example, you can tell that ACPI.sys uses some non-paged memory at all times, and that this steady state usage increases twice (first when the driver is loading, then a second time at around 3 seconds).\n\n    1.  Expand the stack and navigate through it. At the top, you should see function calls that lead to the largest steady state pool allocations.\n\n    2.  In the following example, you can see that ACPI.sys makes a total of 255 pool allocations, totaling 1.2 MB under the **ACPIInitStartACPI** function. This is where the driver developer should focus in order to improve the driver steady state memory usage, as this function accounts for most of the driver allocations.\n\n        ![](images/memoryfootprintlab29.png)\n\n5.  Sort by **Size** by clicking on the column header.\n\n6.  Do the same thing for the **Transient** category. Expand the stack and navigate through it. At the top, you should see function calls leading to the largest transient pool allocations.\n\n    -   In the following example, you can see the initial spike of transient memory usage is mainly caused by ACPI executing DPCs of devices (**ACPI.sys!ACPIBuildDeviceDpc**). The spike that introduced the code under this function call totals 455 KB.\n\n        ![](images/memoryfootprintlab30.png)\n\n## Step 4: Measure the driver code footprint\n\n\n1.  Find the **Resident Set** graph in the **Memory** category of the **Graph Explorer**.\n\n2.  Drag and drop the **Resident Set** graph onto the Analysis tab.\n\n3.  Make sure to unzoom the graph (Ctrl+Shift+”-“).\n\n4.  Select the **File Backed Page** graph preset.\n\n    ![](images/memoryfootprintlab31.png)\n\n5.  Through the **path tree** column, navigate to the driver you selected in Step 3 (for example, ACPI.sys under C:/Windows/drivers).\n\n6.  Expand the **Driver** category and focus on the **Active** pages.\n\n    The value in the **Size** column represents the impact the driver code has on the memory footprint. In the following example, it is 0.48 MB.![](images/memoryfootprintlab32.png)\n\n \n\n \n\n\n\n\n\n\n"}
{"nodes":[{"content":"Enabling Heap Data Capture","pos":[11,37]},{"content":"Enabling Heap Data Capture","pos":[51,77]},{"content":"Enabling Heap Data Capture","pos":[266,292]},{"content":"Process heap analysis is most effective when stacks are collected capturing <bpt id=\"p1\">**</bpt>HeapAlloc<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>HeapRealloc<ept id=\"p2\">**</ept> events.","pos":[295,412]},{"content":"To decode stacks with symbols, you must enable symbol decoding.","pos":[413,476]},{"content":"You can capture heap data either when a process is started or on an existing process.","pos":[477,562]},{"content":"To Enable Data Capture When a Process Is Started","pos":[567,615]},{"content":"This example starts the process being analyzed from the command-line sequence that starts data capture.","pos":[618,721]},{"content":"Enabling data capture when a process is started guarantees that there is no loss of allocation information or history.","pos":[722,840]},{"content":"Take the following steps to enable data capture on process launch:","pos":[841,907]},{"pos":[913,973],"content":"From an elevated command prompt, type the following command:"},{"pos":[1043,1079],"content":"The following is an example command:"},{"content":"The sidebar opens on the desktop.","pos":[1262,1295]},{"content":"The following table describes these commands.","pos":[1301,1346]},{"pos":[1352,3169],"content":"<table>\n<colgroup>\n<col width=\"50%\" />\n<col width=\"50%\" />\n</colgroup>\n<thead>\n<tr class=\"header\">\n<th>Command</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr class=\"odd\">\n<td><p>-start HeapSession</p></td>\n<td><p>Initializes a tracing session or logger session. In this case the session is named &quot;HeapSession&quot;.</p></td>\n</tr>\n<tr class=\"even\">\n<td><p>-heap</p></td>\n<td><p>Identifies &quot;HeapSession&quot; as a heap trace.</p></td>\n</tr>\n<tr class=\"odd\">\n<td><p>-PidNewProcess</p></td>\n<td><p>Initializes a process. In this case, initializes the Windows Sidebar.</p></td>\n</tr>\n<tr class=\"even\">\n<td><p>-BufferSize</p></td>\n<td><p>Sets the buffer size of the buffer in which the event data is stored. An optimum size for a buffer is 1024 KB. The default is 64 KB.</p></td>\n</tr>\n<tr class=\"odd\">\n<td><p>-MinBuffers</p></td>\n<td><p>Sets the minimum number of buffers for event data storage. <strong>MinBuffers</strong> should be equal to <strong>MaxBuffers</strong> to guarantee consistency between traces.</p></td>\n</tr>\n<tr class=\"even\">\n<td><p>-MaxBuffers</p></td>\n<td><p>Allocate <strong>MaxBuffers</strong> conservatively, because buffers are allocated from non-paged memory, which is a finite system resource.</p></td>\n</tr>\n<tr class=\"odd\">\n<td><p>-stackwalk</p></td>\n<td><p>Initializes the stackwalk facility to collect allocation and deallocation information and associate that information with specific threads.</p></td>\n</tr>\n<tr class=\"even\">\n<td><p>HeapAlloc+HeapRealloc</p></td>\n<td><p>Identifies specific heap events to be captured and presented by the stackwalk facility.</p></td>\n</tr>\n</tbody>\n</table>","leadings":["","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    "],"nodes":[{"content":"Command","pos":[103,110]},{"content":"Description","pos":[120,131]},{"content":"-start HeapSession","pos":[184,202]},{"content":"Initializes a tracing session or logger session. In this case the session is named &quot;HeapSession&quot;.","pos":[219,326],"nodes":[{"content":"Initializes a tracing session or logger session.","pos":[0,48]},{"content":"In this case the session is named <ph id=\"ph1\">&amp;quot;</ph>HeapSession<ph id=\"ph2\">&amp;quot;</ph>.","pos":[49,107]}]},{"content":"-heap","pos":[367,372]},{"content":"Identifies <ph id=\"ph1\">&amp;quot;</ph>HeapSession<ph id=\"ph2\">&amp;quot;</ph> as a heap trace.","pos":[389,440]},{"content":"-PidNewProcess","pos":[480,494]},{"content":"Initializes a process. In this case, initializes the Windows Sidebar.","pos":[511,580],"nodes":[{"content":"Initializes a process.","pos":[0,22]},{"content":"In this case, initializes the Windows Sidebar.","pos":[23,69]}]},{"content":"-BufferSize","pos":[621,632]},{"content":"Sets the buffer size of the buffer in which the event data is stored. An optimum size for a buffer is 1024 KB. The default is 64 KB.","pos":[649,781],"nodes":[{"content":"Sets the buffer size of the buffer in which the event data is stored.","pos":[0,69]},{"content":"An optimum size for a buffer is 1024 KB.","pos":[70,110]},{"content":"The default is 64 KB.","pos":[111,132]}]},{"content":"-MinBuffers","pos":[821,832]},{"content":"Sets the minimum number of buffers for event data storage. <strong>MinBuffers</strong> should be equal to <strong>MaxBuffers</strong> to guarantee consistency between traces.","pos":[849,1023],"nodes":[{"content":"Sets the minimum number of buffers for event data storage.","pos":[0,58]},{"content":"MinBuffers<ph id=\"ph1\">&lt;/strong&gt;</ph> should be equal to <ph id=\"ph2\">&lt;strong&gt;</ph>MaxBuffers<ph id=\"ph3\">&lt;/strong&gt;</ph> to guarantee consistency between traces.","pos":[67,174]}]},{"content":"-MaxBuffers","pos":[1064,1075]},{"content":"Allocate <ph id=\"ph1\">&lt;strong&gt;</ph>MaxBuffers<ph id=\"ph2\">&lt;/strong&gt;</ph> conservatively, because buffers are allocated from non-paged memory, which is a finite system resource.","pos":[1092,1232]},{"content":"-stackwalk","pos":[1272,1282]},{"content":"Initializes the stackwalk facility to collect allocation and deallocation information and associate that information with specific threads.","pos":[1299,1438]},{"content":"HeapAlloc+HeapRealloc","pos":[1479,1500]},{"content":"Identifies specific heap events to be captured and presented by the stackwalk facility.","pos":[1517,1604]}]},{"pos":[3182,3209],"content":"Type the following command:"},{"pos":[3264,3361],"content":"The <ph id=\"ph1\">`-d HeapTrace.etl`</ph> command merges traces produced in the session into the HeapTrace.etl file."},{"content":"To Enable Data Capture on an Existing Process","pos":[3366,3411]},{"content":"This option enables data capture without stopping and restarting the process.","pos":[3414,3491]},{"content":"This may be advantageous when the scenario being analyzed does not occur until well after the application starts, and initial heap allocation (which can generate extremely large trace files) is not needed.","pos":[3492,3697]},{"content":"Take the following steps:","pos":[3699,3724]},{"pos":[3730,3820],"content":"From an elevated command prompt, start the NT Kernel Logger with the BASE flag as follows:"},{"pos":[3843,3958],"content":"To enable heap tracing on an existing process, substitute the actual process ID for <bpt id=\"p1\">*</bpt>XXX<ept id=\"p1\">*</ept> in the following command:"},{"pos":[4088,4190],"content":"Prepare the traces for analysis in the same manner as done for data capture when a process is started:"},{"content":"Related topics","pos":[4244,4258]},{"content":"heap","pos":[4262,4266]}],"content":"---\ntitle: Enabling Heap Data Capture\ndescription: Enabling Heap Data Capture\nMSHAttr:\n- 'PreferredSiteName:MSDN'\n- 'PreferredLib:/library/windows/hardware'\nms.assetid: 73d49914-7f60-426e-9833-cee7c5ec5d10\nms.prod: W10\nms.mktglfcycl: operate\nms.sitesec: msdn\n---\n\n# Enabling Heap Data Capture\n\n\nProcess heap analysis is most effective when stacks are collected capturing **HeapAlloc** and **HeapRealloc** events. To decode stacks with symbols, you must enable symbol decoding. You can capture heap data either when a process is started or on an existing process.\n\n## To Enable Data Capture When a Process Is Started\n\n\nThis example starts the process being analyzed from the command-line sequence that starts data capture. Enabling data capture when a process is started guarantees that there is no loss of allocation information or history. Take the following steps to enable data capture on process launch:\n\n1.  From an elevated command prompt, type the following command: `xperf -on Base -BufferSize 1024 -MinBuffers 10 -MaxBuffers 16`\n\n2.  The following is an example command: `xperf -start HeapSession -heap -PidNewProcess \"C:\\Program Files\\Windows Sidebar\\sidebar.exe\" -BufferSize 1024 -MinBuffers 128 -MaxBuffers 128 -stackwalk HeapAlloc+HeapRealloc`\n\n    The sidebar opens on the desktop.\n\n    The following table describes these commands.\n\n    <table>\n    <colgroup>\n    <col width=\"50%\" />\n    <col width=\"50%\" />\n    </colgroup>\n    <thead>\n    <tr class=\"header\">\n    <th>Command</th>\n    <th>Description</th>\n    </tr>\n    </thead>\n    <tbody>\n    <tr class=\"odd\">\n    <td><p>-start HeapSession</p></td>\n    <td><p>Initializes a tracing session or logger session. In this case the session is named &quot;HeapSession&quot;.</p></td>\n    </tr>\n    <tr class=\"even\">\n    <td><p>-heap</p></td>\n    <td><p>Identifies &quot;HeapSession&quot; as a heap trace.</p></td>\n    </tr>\n    <tr class=\"odd\">\n    <td><p>-PidNewProcess</p></td>\n    <td><p>Initializes a process. In this case, initializes the Windows Sidebar.</p></td>\n    </tr>\n    <tr class=\"even\">\n    <td><p>-BufferSize</p></td>\n    <td><p>Sets the buffer size of the buffer in which the event data is stored. An optimum size for a buffer is 1024 KB. The default is 64 KB.</p></td>\n    </tr>\n    <tr class=\"odd\">\n    <td><p>-MinBuffers</p></td>\n    <td><p>Sets the minimum number of buffers for event data storage. <strong>MinBuffers</strong> should be equal to <strong>MaxBuffers</strong> to guarantee consistency between traces.</p></td>\n    </tr>\n    <tr class=\"even\">\n    <td><p>-MaxBuffers</p></td>\n    <td><p>Allocate <strong>MaxBuffers</strong> conservatively, because buffers are allocated from non-paged memory, which is a finite system resource.</p></td>\n    </tr>\n    <tr class=\"odd\">\n    <td><p>-stackwalk</p></td>\n    <td><p>Initializes the stackwalk facility to collect allocation and deallocation information and associate that information with specific threads.</p></td>\n    </tr>\n    <tr class=\"even\">\n    <td><p>HeapAlloc+HeapRealloc</p></td>\n    <td><p>Identifies specific heap events to be captured and presented by the stackwalk facility.</p></td>\n    </tr>\n    </tbody>\n    </table>\n\n     \n\n3.  Type the following command: `xperf -stop -stop HeapSession -d HeapTrace.etl`\n\n    The `-d HeapTrace.etl` command merges traces produced in the session into the HeapTrace.etl file.\n\n## To Enable Data Capture on an Existing Process\n\n\nThis option enables data capture without stopping and restarting the process. This may be advantageous when the scenario being analyzed does not occur until well after the application starts, and initial heap allocation (which can generate extremely large trace files) is not needed.\n\nTake the following steps:\n\n1.  From an elevated command prompt, start the NT Kernel Logger with the BASE flag as follows: `xperf -on BASE`\n\n2.  To enable heap tracing on an existing process, substitute the actual process ID for *XXX* in the following command: `xperf -start HeapSession -heap -Pid XXX -BufferSize 1024 -MinBuffers 128 -MaxBuffers 128 -stackwalk HeapAlloc+HeapRealloc`\n\n3.  Prepare the traces for analysis in the same manner as done for data capture when a process is started: `xperf -stop -stop HeapSession -d heapTrace.etl`\n\n## Related topics\n\n\n[heap](heap.md)\n\n \n\n \n\n\n\n\n\n\n\n"}
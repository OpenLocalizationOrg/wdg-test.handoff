{"nodes":[{"content":"Add and Remove Drivers to an Offline Windows Image","pos":[34,84]},{"content":"Add and Remove Drivers to an Offline Windows Image","pos":[191,241]},{"content":"Add and Remove Drivers to an Offline Windows Image","pos":[249,299]},{"content":"You can use the Deployment Image Servicing and Management (DISM) tool to install or remove driver (.inf) files in an offline Windows image.","pos":[302,441]},{"content":"You can either apply an unattended answer file to a mounted .wim, .vhd, or .vhdx file, or you can add or remove the drivers directly by using the command prompt.","pos":[442,603]},{"content":"When you use DISM to install a device driver to an offline image, the device driver is added to the driver store in the offline image.","pos":[605,739]},{"content":"When the image is booted, Plug and Play (PnP) runs and associates the drivers in the store to the corresponding devices on the computer.","pos":[740,876]},{"content":"<bpt id=\"p1\">**</bpt>Note<ept id=\"p1\">**</ept>   To add drivers to a Windows 10 image offline, you must use a technician computer running Windows 10, Windows Server 2016 Technical Preview, or Windows Preinstallation Environment (WinPE) for Windows 10.","pos":[878,1091]},{"content":"Driver signature verification may fail when you add a driver to a Windows 10 image offline from a technician computer running any other operating system.","pos":[1092,1245]},{"content":"To add drivers to an offline image by using DISM","pos":[1251,1299]},{"content":"At an elevated command prompt, retrieve the name or index number for the image that you want to modify.","pos":[1305,1408]},{"content":"For example, type:","pos":[1409,1427]},{"content":"An index or name value is required for most operations that specify a WIM file.","pos":[1519,1598]},{"content":"For a VHD file, you must specify <ph id=\"ph1\">`/Index:1`</ph>.","pos":[1599,1643]},{"content":"Mount the offline Windows image.","pos":[1649,1681]},{"content":"For example, type:","pos":[1682,1700]},{"content":"Add a driver to the image.","pos":[1838,1864]},{"pos":[1970,2090],"content":"To install all of the drivers from a folder and all its subfolders, point to the folder and use the <bpt id=\"p1\">**</bpt>/Recurse<ept id=\"p1\">**</ept> option."},{"content":"<bpt id=\"p1\">**</bpt>Warning<ept id=\"p1\">**</ept>  While /Recurse can be handy, it's easy to bloat your image with it.","pos":[2192,2272]},{"content":"Some driver packages include multiple .inf driver packages, which often share payload files from the same folder.","pos":[2273,2386]},{"content":"During installation, each .inf driver package is expanded into a separate folder, each with a copy of the payload files.","pos":[2387,2507]},{"content":"We've seen cases where a popular driver in a 900MB folder added 10GB to images when added with the /Recurse option.","pos":[2508,2623]},{"pos":[2629,2787],"content":"To install an unsigned driver, use <bpt id=\"p1\">**</bpt>/ForceUnsigned<ept id=\"p1\">**</ept> to override the requirement that drivers installed on X64-based computers must have a digital signature."},{"content":"Review the list of third-party driver (.inf) files in the Windows image.","pos":[2908,2980]},{"content":"Drivers added to the Windows image are named Oem<ph id=\"ph1\">\\*</ph>.inf.","pos":[2981,3036]},{"content":"This is to guarantee unique naming for new drivers added to the computer.","pos":[3037,3110]},{"content":"For example, the files MyDriver1.inf and MyDriver2.inf are renamed Oem0.inf and Oem1.inf.","pos":[3111,3200]},{"content":"Commit the changes and unmount the image.","pos":[3276,3317]},{"content":"To remove drivers from an offline image by using DISM","pos":[3404,3457]},{"content":"At an elevated command prompt, retrieve the name or index number for the image that you want to modify.","pos":[3463,3566]},{"content":"An index or name value is required for most operations that specify a WIM file.","pos":[3658,3737]},{"content":"For a VHD file, you must specify <ph id=\"ph1\">`/Index:1`</ph>.","pos":[3738,3782]},{"content":"Mount the offline Windows image.","pos":[3788,3820]},{"content":"For example:","pos":[3821,3833]},{"content":"Remove a specific driver from the image.","pos":[3973,4013]},{"content":"Multiple drivers can be removed on one command line.","pos":[4014,4066]},{"pos":[4177,4404],"content":"**Warning**  \nRemoving a boot-critical driver package can make the offline Windows image unbootable. For more information, see [DISM Driver Servicing Command-Line Options](dism-driver-servicing-command-line-options-s14.md).","leadings":["","    "],"nodes":[{"content":"Warning","pos":[2,9]},{"content":"Removing a boot-critical driver package can make the offline Windows image unbootable. For more information, see [DISM Driver Servicing Command-Line Options](dism-driver-servicing-command-line-options-s14.md).","pos":[14,223],"nodes":[{"content":"Removing a boot-critical driver package can make the offline Windows image unbootable.","pos":[0,86]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>DISM Driver Servicing Command-Line Options<ept id=\"p1\">](dism-driver-servicing-command-line-options-s14.md)</ept>.","pos":[87,209]}]}]},{"content":"Commit the changes and unmount the image.","pos":[4416,4457]},{"content":"To add drivers to an offline Windows image by using an unattended answer file","pos":[4544,4621]},{"content":"Locate the device driver .inf files that you intend to install on the Windows image.","pos":[4627,4711]},{"pos":[4717,5001],"content":"**Note**  \nAll drivers in the directory and subdirectories that are referenced in the answer file are added to the image. You should manage the answer file and these directories carefully to address concerns about increasing the size of the image with unnecessary driver packages.","leadings":["","    "],"nodes":[{"content":"Note","pos":[2,6]},{"content":"All drivers in the directory and subdirectories that are referenced in the answer file are added to the image. You should manage the answer file and these directories carefully to address concerns about increasing the size of the image with unnecessary driver packages.","pos":[11,280],"nodes":[{"content":"All drivers in the directory and subdirectories that are referenced in the answer file are added to the image.","pos":[0,110]},{"content":"You should manage the answer file and these directories carefully to address concerns about increasing the size of the image with unnecessary driver packages.","pos":[111,269]}]}]},{"content":"Use Windows System Image Manager (Windows SIM) to create an answer file that contains the paths to the device drivers that you intend to install.","pos":[5007,5152]},{"pos":[5158,5287],"content":"Add the Microsoft-Windows-PnpCustomizationsNonWinPE component to your answer file in the <bpt id=\"p1\">**</bpt>offlineServicing<ept id=\"p1\">**</ept> configuration pass."},{"content":"Expand the <bpt id=\"p1\">**</bpt>Microsoft-Windows-PnpCustomizationsNonWinPE<ept id=\"p1\">**</ept> node in the answer file.","pos":[5293,5376]},{"content":"Right-click <bpt id=\"p1\">**</bpt>DevicePaths<ept id=\"p1\">**</ept>, and then select <bpt id=\"p2\">**</bpt>Insert New PathAndCredentials<ept id=\"p2\">**</ept>.","pos":[5377,5456]},{"pos":[5462,5509],"content":"A new <bpt id=\"p1\">**</bpt>PathAndCredentials<ept id=\"p1\">**</ept> list item appears."},{"pos":[5515,5608],"content":"For each location that you intend to access, add a separate <bpt id=\"p1\">**</bpt>PathAndCredentials<ept id=\"p1\">**</ept> list item."},{"content":"In the Microsoft-Windows-PnpCustomizationsNonWinPE component, specify the path to the device driver and the credentials that are used to access the file, if the file is on a network share.","pos":[5614,5802]},{"pos":[5808,6187],"content":"**Note**  \nYou can include multiple device driver paths by adding multiple **PathAndCredentials** list items. If you add multiple list items, you must increment the value of **Key** for each path. For example, you can add two separate driver paths where the value of **Key** for the first path is equal to **1** and the value of **Key** for the second path is equal to **2**.","leadings":["","    "],"nodes":[{"content":"Note","pos":[2,6]},{"content":"You can include multiple device driver paths by adding multiple **PathAndCredentials** list items. If you add multiple list items, you must increment the value of **Key** for each path. For example, you can add two separate driver paths where the value of **Key** for the first path is equal to **1** and the value of **Key** for the second path is equal to **2**.","pos":[11,375],"nodes":[{"content":"You can include multiple device driver paths by adding multiple <bpt id=\"p1\">**</bpt>PathAndCredentials<ept id=\"p1\">**</ept> list items.","pos":[0,98]},{"content":"If you add multiple list items, you must increment the value of <bpt id=\"p1\">**</bpt>Key<ept id=\"p1\">**</ept> for each path.","pos":[99,185]},{"content":"For example, you can add two separate driver paths where the value of <bpt id=\"p1\">**</bpt>Key<ept id=\"p1\">**</ept> for the first path is equal to <bpt id=\"p2\">**</bpt>1<ept id=\"p2\">**</ept> and the value of <bpt id=\"p3\">**</bpt>Key<ept id=\"p3\">**</ept> for the second path is equal to <bpt id=\"p4\">**</bpt>2<ept id=\"p4\">**</ept>.","pos":[186,364]}]}]},{"content":"Save the answer file and exit Windows SIM.","pos":[6193,6235]},{"content":"The answer file must resemble the following sample.","pos":[6236,6287]},{"content":"Mount the Windows image that you intend to install the drivers to by using DISM.","pos":[7164,7244]},{"content":"For example, type:","pos":[7245,7263]},{"content":"An index or name value is required for most operations that specify a WIM file.","pos":[7388,7467]},{"content":"For a VHD file, you must specify <ph id=\"ph1\">`/Index:1`</ph>.","pos":[7468,7512]},{"content":"Use DISM to apply the answer file to the mounted Windows image.","pos":[7518,7581]},{"content":"For example, type:","pos":[7582,7600]},{"pos":[7713,7873],"content":"For more information about how to apply an answer file, see <bpt id=\"p1\">[</bpt>DISM Unattended Servicing Command-Line Options<ept id=\"p1\">](dism-unattended-servicing-command-line-options.md)</ept>."},{"content":"The .inf files referenced in the path in the answer file are added to the Windows image.","pos":[7879,7967]},{"content":"Review the list of third-party driver (.inf) files in the Windows image.","pos":[7973,8045]},{"content":"Drivers added to the Windows image are named Oem<ph id=\"ph1\">\\*</ph>.inf.","pos":[8046,8101]},{"content":"This is to guarantee that all new drivers that are added to the computer are uniquely named.","pos":[8102,8194]},{"content":"For example, the files MyDriver1.inf and MyDriver2.inf are renamed Oem0.inf and Oem1.inf.","pos":[8195,8284]},{"content":"For example, type:","pos":[8290,8308]},{"content":"Unmount the .wim file and commit the changes.","pos":[8384,8429]},{"content":"For example, type:","pos":[8430,8448]},{"content":"If you need drivers for WinPE to see the local hard disk drive or a network, you must use the <bpt id=\"p1\">**</bpt>windowsPE<ept id=\"p1\">**</ept> configuration pass of an answer file to add drivers to the WinPE driver store and to reflect boot-critical drivers required by WinPE.","pos":[8532,8773]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Add Device Drivers to Windows During Windows Setup<ept id=\"p1\">](add-device-drivers-to-windows-during-windows-setup.md)</ept>.","pos":[8774,8908]},{"pos":[8946,8960],"content":"Related topics"},{"content":"Device Drivers and Deployment Overview","pos":[8964,9002]},{"content":"Add Device Drivers to Windows During Windows Setup","pos":[9049,9099]},{"content":"DISM - Deployment Image Servicing and Management Technical Reference for Windows","pos":[9158,9238]}],"content":"---\nauthor: Justinha\nDescription: Add and Remove Drivers to an Offline Windows Image\nms.assetid: 71651630-2e26-4174-8161-8f83b8ae4bc3\nMSHAttr: 'PreferredLib:/library/windows/hardware'\ntitle: Add and Remove Drivers to an Offline Windows Image\n---\n\n# Add and Remove Drivers to an Offline Windows Image\n\n\nYou can use the Deployment Image Servicing and Management (DISM) tool to install or remove driver (.inf) files in an offline Windows image. You can either apply an unattended answer file to a mounted .wim, .vhd, or .vhdx file, or you can add or remove the drivers directly by using the command prompt.\n\nWhen you use DISM to install a device driver to an offline image, the device driver is added to the driver store in the offline image. When the image is booted, Plug and Play (PnP) runs and associates the drivers in the store to the corresponding devices on the computer.\n\n**Note**   To add drivers to a Windows 10 image offline, you must use a technician computer running Windows 10, Windows Server 2016 Technical Preview, or Windows Preinstallation Environment (WinPE) for Windows 10. Driver signature verification may fail when you add a driver to a Windows 10 image offline from a technician computer running any other operating system.\n\n\n## To add drivers to an offline image by using DISM\n\n1.  At an elevated command prompt, retrieve the name or index number for the image that you want to modify. For example, type:\n\n    ``` syntax\n    Dism /Get-ImageInfo /ImageFile:C:\\test\\images\\install.wim\n    ```\n\n    An index or name value is required for most operations that specify a WIM file. For a VHD file, you must specify `/Index:1`.\n\n2.  Mount the offline Windows image. For example, type:\n\n    ``` syntax\n    Dism /Mount-Image /ImageFile:C:\\test\\images\\install.wim /Name:\"Windows Drive\" /MountDir:C:\\test\\offline\n    ```\n\n3.  Add a driver to the image.\n\n    ``` syntax\n    Dism /Image:C:\\test\\offline /Add-Driver /Driver:C:\\drivers\\mydriver.inf\n    ```\n\n    To install all of the drivers from a folder and all its subfolders, point to the folder and use the **/Recurse** option.\n\n    ``` syntax\n    Dism /Image:C:\\test\\offline /Add-Driver /Driver:c:\\drivers /Recurse\n    ```\n\n    **Warning**  While /Recurse can be handy, it's easy to bloat your image with it. Some driver packages include multiple .inf driver packages, which often share payload files from the same folder. During installation, each .inf driver package is expanded into a separate folder, each with a copy of the payload files. We've seen cases where a popular driver in a 900MB folder added 10GB to images when added with the /Recurse option.\n\n    To install an unsigned driver, use **/ForceUnsigned** to override the requirement that drivers installed on X64-based computers must have a digital signature.\n\n    ``` syntax\n    Dism /Image:C:\\test\\offline /Add-Driver /Driver:C:\\drivers\\mydriver.inf /ForceUnsigned\n    ```\n\n4.  Review the list of third-party driver (.inf) files in the Windows image. Drivers added to the Windows image are named Oem\\*.inf. This is to guarantee unique naming for new drivers added to the computer. For example, the files MyDriver1.inf and MyDriver2.inf are renamed Oem0.inf and Oem1.inf.\n\n    ``` syntax\n    Dism /Image:C:\\test\\offline /Get-Drivers \n    ```\n\n5.  Commit the changes and unmount the image.\n\n    ``` syntax\n    Dism /Unmount-Image /MountDir:C:\\test\\offline /Commit\n    ```\n\n## To remove drivers from an offline image by using DISM\n\n1.  At an elevated command prompt, retrieve the name or index number for the image that you want to modify.\n\n    ``` syntax\n    Dism /Get-ImageInfo /ImageFile:C:\\test\\images\\install.wim\n    ```\n\n    An index or name value is required for most operations that specify a WIM file. For a VHD file, you must specify `/Index:1`.\n\n2.  Mount the offline Windows image. For example:\n\n    ``` syntax\n    Dism /Mount-Image /ImageFile:C:\\test\\images\\install.wim /Name:\"Windows 10 Home\" /MountDir:C:\\test\\offline\n    ```\n\n3.  Remove a specific driver from the image. Multiple drivers can be removed on one command line.\n\n    ``` syntax\n    Dism /Image:C:\\test\\offline /Remove-Driver /Driver:OEM1.inf /Driver:OEM2.inf\n    ```\n\n    **Warning**  \n    Removing a boot-critical driver package can make the offline Windows image unbootable. For more information, see [DISM Driver Servicing Command-Line Options](dism-driver-servicing-command-line-options-s14.md).\n     \n\n4.  Commit the changes and unmount the image.\n\n    ``` syntax\n    Dism /Unmount-Image /MountDir:C:\\test\\offline /Commit\n    ```\n\n## To add drivers to an offline Windows image by using an unattended answer file\n\n1.  Locate the device driver .inf files that you intend to install on the Windows image.\n\n    **Note**  \n    All drivers in the directory and subdirectories that are referenced in the answer file are added to the image. You should manage the answer file and these directories carefully to address concerns about increasing the size of the image with unnecessary driver packages.\n\n2.  Use Windows System Image Manager (Windows SIM) to create an answer file that contains the paths to the device drivers that you intend to install.\n\n3.  Add the Microsoft-Windows-PnpCustomizationsNonWinPE component to your answer file in the **offlineServicing** configuration pass.\n\n4.  Expand the **Microsoft-Windows-PnpCustomizationsNonWinPE** node in the answer file. Right-click **DevicePaths**, and then select **Insert New PathAndCredentials**.\n\n    A new **PathAndCredentials** list item appears.\n\n5.  For each location that you intend to access, add a separate **PathAndCredentials** list item.\n\n6.  In the Microsoft-Windows-PnpCustomizationsNonWinPE component, specify the path to the device driver and the credentials that are used to access the file, if the file is on a network share.\n\n    **Note**  \n    You can include multiple device driver paths by adding multiple **PathAndCredentials** list items. If you add multiple list items, you must increment the value of **Key** for each path. For example, you can add two separate driver paths where the value of **Key** for the first path is equal to **1** and the value of **Key** for the second path is equal to **2**.\n\n7.  Save the answer file and exit Windows SIM. The answer file must resemble the following sample.\n\n    ``` syntax\n    <?xml version=\"1.0\" ?><unattend xmlns=\"urn:schemas-microsoft-com:asm.v3\" xmlns:wcm=\"http://schemas.microsoft.com/WMIConfig/2002/State\">\n       <settings pass=\"offlineServicing\">\n          <component name=\"Microsoft-Windows-PnpCustomizationsNonWinPE\" processorArchitecture=\"x86\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\">\n             <DriverPaths>\n                <PathAndCredentials wcm:keyValue=\"1\">\n                   <Path>\\\\networkshare\\share\\drivers</Path>\n                   <Credentials>\n                      <Domain>Fabrikam</Domain>\n                      <Username>MyUserName</Username>\n                      <Password>MyPassword</Password>\n                   </Credentials>\n                </PathAndCredentials>\n             </DriverPaths>\n          </component>\n       </settings>\n    </unattend>\n    ```\n\n8.  Mount the Windows image that you intend to install the drivers to by using DISM. For example, type:\n\n    ``` syntax\n    Dism /Mount-Image /ImageFile:C:\\test\\images\\install.wim /Index:1 /MountDir:C:\\test\\offline\n    ```\n\n    An index or name value is required for most operations that specify a WIM file. For a VHD file, you must specify `/Index:1`.\n\n9.  Use DISM to apply the answer file to the mounted Windows image. For example, type:\n\n    ``` syntax\n    DISM /Image:C:\\test\\offline /Apply-Unattend:C:\\test\\answerfiles\\myunattend.xml\n    ```\n\n    For more information about how to apply an answer file, see [DISM Unattended Servicing Command-Line Options](dism-unattended-servicing-command-line-options.md).\n\n    The .inf files referenced in the path in the answer file are added to the Windows image.\n\n10. Review the list of third-party driver (.inf) files in the Windows image. Drivers added to the Windows image are named Oem\\*.inf. This is to guarantee that all new drivers that are added to the computer are uniquely named. For example, the files MyDriver1.inf and MyDriver2.inf are renamed Oem0.inf and Oem1.inf.\n\n    For example, type:\n\n    ``` syntax\n    Dism /Image:C:\\test\\offline /Get-Drivers \n    ```\n\n11. Unmount the .wim file and commit the changes. For example, type:\n\n    ``` syntax\n    Dism /Unmount-Image /MountDir:C:\\test\\offline /Commit\n    ```\n\nIf you need drivers for WinPE to see the local hard disk drive or a network, you must use the **windowsPE** configuration pass of an answer file to add drivers to the WinPE driver store and to reflect boot-critical drivers required by WinPE. For more information, see [Add Device Drivers to Windows During Windows Setup](add-device-drivers-to-windows-during-windows-setup.md).\n\n## <span id=\"related_topics\"></span>Related topics\n\n\n[Device Drivers and Deployment Overview](device-drivers-and-deployment-overview.md)\n\n[Add Device Drivers to Windows During Windows Setup](add-device-drivers-to-windows-during-windows-setup.md)\n\n[DISM - Deployment Image Servicing and Management Technical Reference for Windows](dism---deployment-image-servicing-and-management-technical-reference-for-windows.md)\n\n \n\n \n\n\n\n\n\n\n"}
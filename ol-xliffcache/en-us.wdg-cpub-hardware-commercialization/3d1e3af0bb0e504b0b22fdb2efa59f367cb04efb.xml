{"nodes":[{"content":"Add a Custom Script to Windows Setup","pos":[34,70]},{"content":"Add a Custom Script to Windows Setup","pos":[177,213]},{"content":"Add a Custom Script to Windows Setup","pos":[221,257]},{"content":"<bpt id=\"p1\">**</bpt>Windows Setup scripts<ept id=\"p1\">**</ept>: <bpt id=\"p2\">**</bpt>Setupcomplete.cmd<ept id=\"p2\">**</ept> and <bpt id=\"p3\">**</bpt>ErrorHandler.cmd<ept id=\"p3\">**</ept> are custom scripts that run during or after the Windows Setup process.","pos":[260,404]},{"content":"They can be used to install applications or run other tasks by using <bpt id=\"p1\">**</bpt>cscript/wscript<ept id=\"p1\">**</ept> scripts.","pos":[405,502]},{"content":"<bpt id=\"p1\">**</bpt>%WINDIR%<ph id=\"ph1\">\\\\</ph>Setup<ph id=\"ph2\">\\\\</ph>Scripts<ph id=\"ph3\">\\\\</ph>SetupComplete.cmd<ept id=\"p1\">**</ept>: This script runs immediately after the user sees the desktop.","pos":[508,618]},{"content":"This setting is disabled when using OEM product keys.","pos":[619,672]},{"content":"It runs with local system permission.","pos":[673,710]},{"content":"<bpt id=\"p1\">**</bpt>%WINDIR%<ph id=\"ph1\">\\\\</ph>Setup<ph id=\"ph2\">\\\\</ph>Scripts<ph id=\"ph3\">\\\\</ph>ErrorHandler.cmd<ept id=\"p1\">**</ept>: This script runs automatically when Setup encounters a fatal error.","pos":[715,830]},{"content":"It runs with local system permission.","pos":[831,868]},{"content":"<bpt id=\"p1\">**</bpt>Windows Unattend scripts<ept id=\"p1\">**</ept>: Create an Unattend.xml file with one of these settings to run during the Windows Setup process.","pos":[870,995]},{"content":"This can be used with OEM product keys.","pos":[996,1035]},{"content":"To run services or commands that can start at the same time, use RunAsynchronousCommands.","pos":[1037,1126]},{"content":"To run commands that need to finish before other commands can start, use RunSynchronousCommands.","pos":[1127,1223]},{"pos":[1225,1564],"content":"<bpt id=\"p1\">**</bpt>Note<ept id=\"p1\">**</ept>  As of Windows 10, <bpt id=\"p2\">[</bpt>Microsoft-Window-Shell-Setup<ph id=\"ph1\">\\\\</ph>LogonCommands<ph id=\"ph2\">\\\\</ph>AsynchronousCommand<ept id=\"p2\">](https://msdn.microsoft.com/library/windows/hardware/dn915476)</ept> now works like LogonCommands<ph id=\"ph3\">\\\\</ph>AsynchronousCommand: all commands using these unattend settings are now started at the same time, and no longer wait for the previous command to finish."},{"content":"Some of these settings run in the user context, others run in the system context depending on the configuration pass.","pos":[1569,1686]},{"content":"Add <bpt id=\"p1\">[</bpt>Microsoft-Windows-Setup<ph id=\"ph1\">\\\\</ph>RunAsynchronousCommand<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/hardware/dn915798)</ept> or <bpt id=\"p2\">[</bpt>RunSynchronousCommand<ept id=\"p2\">](https://msdn.microsoft.com/library/windows/hardware/dn915802)</ept> to run a script as Windows Setup starts.","pos":[1692,1937]},{"content":"This can be helpful for setting hard disk partitions.","pos":[1938,1991]},{"content":"Add <bpt id=\"p1\">[</bpt>Microsoft-Windows-Deployment<ph id=\"ph1\">\\\\</ph>RunAsynchronousCommand<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/hardware/dn915797)</ept> or <bpt id=\"p2\">[</bpt>RunSynchronousCommand<ept id=\"p2\">](https://msdn.microsoft.com/library/windows/hardware/dn915801)</ept> to the <bpt id=\"p3\">**</bpt>auditUser<ept id=\"p3\">**</ept> configuration pass to run a script that runs when the PC enters audit mode.","pos":[1996,2302]},{"content":"This can be helpful for tasks like automated app installation or testing.","pos":[2303,2376]},{"content":"Add <bpt id=\"p1\">[</bpt>Microsoft-Windows-Shell-Setup<ph id=\"ph1\">\\\\</ph>LogonCommands<ph id=\"ph2\">\\\\</ph>AsynchronousCommand<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/hardware/dn915476)</ept> or <bpt id=\"p2\">[</bpt>FirstLogonCommands<ph id=\"ph3\">\\\\</ph>SynchronousCommand<ept id=\"p2\">](https://msdn.microsoft.com/library/windows/hardware/dn922797)</ept> to run after the Out of Box Experience (OOBE) but before the user sees the desktop.","pos":[2381,2704]},{"content":"This can be especially useful to set up language-specific apps or content after the user has already selected their language.","pos":[2705,2830]},{"content":"Use these scripts sparingly because long scripts can prevent the user from reaching the Start screen quickly.","pos":[2836,2945]},{"content":"For retail versions of Windows, additional restrictions apply to these scripts.","pos":[2946,3025]},{"content":"For info, see the Licensing and Policy guidance on the <bpt id=\"p1\">[</bpt>OEM Partner Center<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=131358)</ept>.","pos":[3026,3149]},{"content":"<bpt id=\"p1\">**</bpt>Note<ept id=\"p1\">**</ept>   When you add a script using FirstLogonCommands, it will be triggered on the next boot, even if you boot into audit mode using Ctrl+Shift+F3.","pos":[3155,3306]},{"content":"To boot to audit mode without triggering these scripts, add the setting: Microsoft-Windows-Deployment<ph id=\"ph1\">\\\\</ph>Reseal<ph id=\"ph2\">\\\\</ph><bpt id=\"p1\">[</bpt>Mode<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/hardware/dn923110)</ept> = Audit.","pos":[3307,3495]},{"pos":[3657,3713],"content":"Run a script after setup is complete (SetupComplete.cmd)"},{"content":"Order of operations","pos":[3718,3737]},{"pos":[3745,3915],"content":"After Windows is installed but before the logon screen appears, Windows Setup searches for the <bpt id=\"p1\">**</bpt>SetupComplete.cmd<ept id=\"p1\">**</ept> file in the <bpt id=\"p2\">**</bpt>%WINDIR%<ph id=\"ph1\">\\\\</ph>Setup<ph id=\"ph2\">\\\\</ph>Scripts<ph id=\"ph3\">\\\\</ph> directory<ept id=\"p2\">**</ept>."},{"content":"If a <bpt id=\"p1\">**</bpt>SetupComplete.cmd<ept id=\"p1\">**</ept> file is found, Windows Setup runs the script.","pos":[3920,3992]},{"content":"Windows Setup logs the action in the <bpt id=\"p1\">**</bpt>C:<ph id=\"ph1\">\\\\</ph>Windows<ph id=\"ph2\">\\\\</ph>Panther<ph id=\"ph3\">\\\\</ph>UnattendGC<ph id=\"ph4\">\\\\</ph>Setupact.log<ept id=\"p1\">**</ept> file.","pos":[3993,4086]},{"pos":[4092,4199],"content":"Setup does not verify any exit codes or error levels in the script after it executes <bpt id=\"p1\">**</bpt>SetupComplete.cmd<ept id=\"p1\">**</ept>."},{"content":"<bpt id=\"p1\">**</bpt>Warning<ept id=\"p1\">**</ept>  You cannot reboot the system and resume running <bpt id=\"p2\">**</bpt>SetupComplete.cmd<ept id=\"p2\">**</ept>.","pos":[4205,4288]},{"content":"You should not reboot the system by adding a command such as <bpt id=\"p1\">**</bpt>shutdown -r<ept id=\"p1\">**</ept>.","pos":[4289,4366]},{"content":"This will put the system in a bad state.","pos":[4367,4407]},{"content":"If the computer joins a domain during installation, the Group Policy that is defined in the domain is not applied to the computer until <bpt id=\"p1\">**</bpt>Setupcomplete.cmd<ept id=\"p1\">**</ept> is finished.","pos":[4420,4590]},{"content":"This is to make sure that the Group Policy configuration activity does not interfere with the script.","pos":[4591,4692]},{"pos":[4881,4954],"content":"Run a script if Windows Setup encounters a fatal error (ErrorHandler.cmd)"},{"content":"This script is useful when you're installing many systems at the same time.","pos":[4957,5032]},{"content":"This helps you detect when an error occurs during Windows Setup.","pos":[5033,5097]},{"content":"When it does, Setup automatically runs a script that can contain custom commands or actions to address the cause of the error.","pos":[5098,5224]},{"content":"If Windows Setup encounters a fatal error and is prevented from completing the installation, Windows Setup searches for a command script in the following directory: <bpt id=\"p1\">**</bpt>%WINDIR%<ph id=\"ph1\">\\\\</ph>Setup<ph id=\"ph2\">\\\\</ph>Scripts<ph id=\"ph3\">\\\\</ph>ErrorHandler.cmd<ept id=\"p1\">**</ept>.","pos":[5226,5438]},{"content":"One of two actions will occur, depending on whether the script is found.","pos":[5439,5511]},{"content":"If the script is not found, a dialog box is displayed with the error text.","pos":[5517,5591]},{"content":"A user must dismiss the dialog box before Windows Setup exits.","pos":[5592,5654]},{"content":"If the script is found, the script executes synchronously.","pos":[5659,5717]},{"content":"No dialog box or error text is displayed.","pos":[5718,5759]},{"content":"After the <bpt id=\"p1\">**</bpt>ErrorHandler.cmd<ept id=\"p1\">**</ept> script has finished running, Windows Setup exits.","pos":[5760,5840]},{"content":"Depending on the phase of Windows Setup, the computer will return to the environment from which Windows Setup was executed, such as an earlier version of the operating system or Windows Preinstallation Environment (Windows PE), for example.","pos":[5842,6082]},{"content":"There may be instances when Windows Setup encounters more than one error and runs the ErrorHandler.cmd script more than once.","pos":[6084,6209]},{"content":"When developing the code for <bpt id=\"p1\">**</bpt>ErrorHandler.cmd<ept id=\"p1\">**</ept>, make sure that you can run this script multiple times.","pos":[6210,6315]},{"pos":[6318,6382],"content":"<bpt id=\"p1\">**</bpt>To use ErrorHandler.cmd<ept id=\"p1\">**</ept>, you can do either of the following:"},{"content":"Mount the image, and add it to the image, in <bpt id=\"p1\">**</bpt>%WINDIR%<ph id=\"ph1\">\\\\</ph>Setup<ph id=\"ph2\">\\\\</ph>Scripts<ph id=\"ph3\">\\\\</ph>ErrorHandler.cmd<ept id=\"p1\">**</ept>.","pos":[6388,6480]},{"content":"Unmount the image.","pos":[6481,6499]},{"content":"-or-","pos":[6505,6509]},{"pos":[6515,6663],"content":"Add <bpt id=\"p1\">**</bpt>ErrorHandler.cmd<ept id=\"p1\">**</ept> to a temporary file location (for example, C:<ph id=\"ph1\">\\\\</ph>Temp<ph id=\"ph2\">\\\\</ph>ErrorHandler.cmd), and then run Windows Setup using the <bpt id=\"p2\">**</bpt>/m<ept id=\"p2\">**</ept> option."},{"pos":[6713,6808],"content":"To learn more, see <bpt id=\"p1\">[</bpt>Windows Setup Command-Line Options<ept id=\"p1\">](windows-setup-command-line-options.md)</ept>."},{"pos":[6846,6860],"content":"Related topics"},{"content":"Windows Setup Technical Reference","pos":[6864,6897]},{"content":"Boot from a DVD","pos":[6939,6954]},{"content":"Use a Configuration Set with Windows Setup","pos":[6978,7020]},{"content":"Deploy a Custom Image","pos":[7071,7092]},{"content":"Boot Windows to Audit Mode or OOBE","pos":[7122,7156]},{"content":"Add Device Drivers to Windows During Windows Setup","pos":[7199,7249]}],"content":"---\nauthor: Justinha\nDescription: Add a Custom Script to Windows Setup\nms.assetid: a22c2f2f-c297-4027-9712-d747b08f7476\nMSHAttr: 'PreferredLib:/library/windows/hardware'\ntitle: Add a Custom Script to Windows Setup\n---\n\n# Add a Custom Script to Windows Setup\n\n\n**Windows Setup scripts**: **Setupcomplete.cmd** and **ErrorHandler.cmd** are custom scripts that run during or after the Windows Setup process. They can be used to install applications or run other tasks by using **cscript/wscript** scripts.\n\n-   **%WINDIR%\\\\Setup\\\\Scripts\\\\SetupComplete.cmd**: This script runs immediately after the user sees the desktop. This setting is disabled when using OEM product keys. It runs with local system permission.\n-   **%WINDIR%\\\\Setup\\\\Scripts\\\\ErrorHandler.cmd**: This script runs automatically when Setup encounters a fatal error. It runs with local system permission.\n\n**Windows Unattend scripts**: Create an Unattend.xml file with one of these settings to run during the Windows Setup process. This can be used with OEM product keys.\n\nTo run services or commands that can start at the same time, use RunAsynchronousCommands. To run commands that need to finish before other commands can start, use RunSynchronousCommands.\n\n**Note**  As of Windows 10, [Microsoft-Window-Shell-Setup\\\\LogonCommands\\\\AsynchronousCommand](https://msdn.microsoft.com/library/windows/hardware/dn915476) now works like LogonCommands\\\\AsynchronousCommand: all commands using these unattend settings are now started at the same time, and no longer wait for the previous command to finish.\n\n \n\nSome of these settings run in the user context, others run in the system context depending on the configuration pass.\n\n-   Add [Microsoft-Windows-Setup\\\\RunAsynchronousCommand](https://msdn.microsoft.com/library/windows/hardware/dn915798) or [RunSynchronousCommand](https://msdn.microsoft.com/library/windows/hardware/dn915802) to run a script as Windows Setup starts. This can be helpful for setting hard disk partitions.\n-   Add [Microsoft-Windows-Deployment\\\\RunAsynchronousCommand](https://msdn.microsoft.com/library/windows/hardware/dn915797) or [RunSynchronousCommand](https://msdn.microsoft.com/library/windows/hardware/dn915801) to the **auditUser** configuration pass to run a script that runs when the PC enters audit mode. This can be helpful for tasks like automated app installation or testing.\n-   Add [Microsoft-Windows-Shell-Setup\\\\LogonCommands\\\\AsynchronousCommand](https://msdn.microsoft.com/library/windows/hardware/dn915476) or [FirstLogonCommands\\\\SynchronousCommand](https://msdn.microsoft.com/library/windows/hardware/dn922797) to run after the Out of Box Experience (OOBE) but before the user sees the desktop. This can be especially useful to set up language-specific apps or content after the user has already selected their language.\n\n    Use these scripts sparingly because long scripts can prevent the user from reaching the Start screen quickly. For retail versions of Windows, additional restrictions apply to these scripts. For info, see the Licensing and Policy guidance on the [OEM Partner Center](http://go.microsoft.com/fwlink/?LinkId=131358).\n\n    **Note**   When you add a script using FirstLogonCommands, it will be triggered on the next boot, even if you boot into audit mode using Ctrl+Shift+F3. To boot to audit mode without triggering these scripts, add the setting: Microsoft-Windows-Deployment\\\\Reseal\\\\[Mode](https://msdn.microsoft.com/library/windows/hardware/dn923110) = Audit.\n\n     \n\n## <span id=\"run_a_script_after_setup_is_complete__setupcomplete.cmd_\"></span><span id=\"RUN_A_SCRIPT_AFTER_SETUP_IS_COMPLETE__SETUPCOMPLETE.CMD_\"></span>Run a script after setup is complete (SetupComplete.cmd)\n\n\n**Order of operations**\n\n1.  After Windows is installed but before the logon screen appears, Windows Setup searches for the **SetupComplete.cmd** file in the **%WINDIR%\\\\Setup\\\\Scripts\\\\ directory**.\n2.  If a **SetupComplete.cmd** file is found, Windows Setup runs the script. Windows Setup logs the action in the **C:\\\\Windows\\\\Panther\\\\UnattendGC\\\\Setupact.log** file.\n\n    Setup does not verify any exit codes or error levels in the script after it executes **SetupComplete.cmd**.\n\n    **Warning**  You cannot reboot the system and resume running **SetupComplete.cmd**. You should not reboot the system by adding a command such as **shutdown -r**. This will put the system in a bad state.\n\n     \n\n3.  If the computer joins a domain during installation, the Group Policy that is defined in the domain is not applied to the computer until **Setupcomplete.cmd** is finished. This is to make sure that the Group Policy configuration activity does not interfere with the script.\n\n## <span id=\"run_a_script_if_windows_setup_encounters_a_fatal_error__errorhandler.cmd_\"></span><span id=\"RUN_A_SCRIPT_IF_WINDOWS_SETUP_ENCOUNTERS_A_FATAL_ERROR__ERRORHANDLER.CMD_\"></span>Run a script if Windows Setup encounters a fatal error (ErrorHandler.cmd)\n\n\nThis script is useful when you're installing many systems at the same time. This helps you detect when an error occurs during Windows Setup. When it does, Setup automatically runs a script that can contain custom commands or actions to address the cause of the error.\n\nIf Windows Setup encounters a fatal error and is prevented from completing the installation, Windows Setup searches for a command script in the following directory: **%WINDIR%\\\\Setup\\\\Scripts\\\\ErrorHandler.cmd**. One of two actions will occur, depending on whether the script is found.\n\n-   If the script is not found, a dialog box is displayed with the error text. A user must dismiss the dialog box before Windows Setup exits.\n-   If the script is found, the script executes synchronously. No dialog box or error text is displayed. After the **ErrorHandler.cmd** script has finished running, Windows Setup exits.\n\nDepending on the phase of Windows Setup, the computer will return to the environment from which Windows Setup was executed, such as an earlier version of the operating system or Windows Preinstallation Environment (Windows PE), for example.\n\nThere may be instances when Windows Setup encounters more than one error and runs the ErrorHandler.cmd script more than once. When developing the code for **ErrorHandler.cmd**, make sure that you can run this script multiple times.\n\n\n**To use ErrorHandler.cmd**, you can do either of the following:\n\n-   Mount the image, and add it to the image, in **%WINDIR%\\\\Setup\\\\Scripts\\\\ErrorHandler.cmd**. Unmount the image.\n\n    -or-\n\n-   Add **ErrorHandler.cmd** to a temporary file location (for example, C:\\\\Temp\\\\ErrorHandler.cmd), and then run Windows Setup using the **/m** option.\n    ``` syntax\n    Setup /m:C:\\Temp\n    ```\n\n    To learn more, see [Windows Setup Command-Line Options](windows-setup-command-line-options.md).\n\n## <span id=\"related_topics\"></span>Related topics\n\n\n[Windows Setup Technical Reference](windows-setup-technical-reference.md)\n\n[Boot from a DVD](boot-from-a-dvd.md)\n\n[Use a Configuration Set with Windows Setup](use-a-configuration-set-with-windows-setup.md)\n\n[Deploy a Custom Image](deploy-a-custom-image.md)\n\n[Boot Windows to Audit Mode or OOBE](boot-windows-to-audit-mode-or-oobe.md)\n\n[Add Device Drivers to Windows During Windows Setup](add-device-drivers-to-windows-during-windows-setup.md)\n\n \n\n \n\n\n\n\n\n\n"}
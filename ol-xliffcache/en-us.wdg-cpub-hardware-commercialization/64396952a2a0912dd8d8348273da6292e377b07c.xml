{"nodes":[{"content":"Update a KMDF device driver","pos":[34,61]},{"content":"Update a KMDF device driver","pos":[168,195]},{"content":"Update a KMDF device driver","pos":[203,230]},{"content":"Like all other components that are added to the OS, KMDF (Kernel-Mode Driver Framework) drivers are included in the OS image by using .spkg package files that are referenced by an OEMInput.xml file when OEMs builds the image.","pos":[233,458]},{"content":"Similarly, driver updates are published by using .spkg package files.","pos":[460,529]},{"content":"Like all package updates, the package version must be incremented for each update; for more information, see <bpt id=\"p1\">[</bpt>Update requirements<ept id=\"p1\">](update-requirements.md)</ept>.","pos":[530,685]},{"content":"When driver updates are prepared, the value of the <bpt id=\"p1\">**</bpt>DriverVer<ept id=\"p1\">**</ept> directive in the driver INF file must also be incremented.","pos":[686,809]},{"content":"This walkthrough shows how to prepare a KMDF device driver update and confirm that the updated driver is loaded by the OS.","pos":[810,932]},{"content":"This topic assumes that you are familiar with the general concepts associated with Windows device driver installation and the use of the INF file.","pos":[934,1080]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Device and driver installation<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/hardware/ff549731)</ept>.","pos":[1081,1202]},{"pos":[1348,1376],"content":"Driver INF files and updates"},{"content":"Visual Studio automatically generates an INF file when building a Windows 10 Mobile KMDF driver project.","pos":[1379,1483]},{"content":"In Windows, driver installation uses the INF file directly.","pos":[1484,1543]},{"content":"However, in Windows 10 Mobile, the INF file is converted to a registry entries (.reg) file.","pos":[1544,1635]},{"content":"The .reg file is included in the .spkg file when the driver is packaged.","pos":[1636,1708]},{"pos":[1710,1876],"content":"When creating a KMDF driver update, two version numbers must be incremented: the version number of the .spkg package file and the <bpt id=\"p1\">**</bpt>DriverVer<ept id=\"p1\">**</ept> value in the INF file."},{"content":"Package version","pos":[1880,1895]},{"content":"The package version number must be incremented to cause the update to be applied to the OS.","pos":[1899,1990]},{"content":"If the update package version is not greater than the existing version, the update will not be applied.","pos":[1991,2094]},{"content":"INF driver version","pos":[2098,2116]},{"content":"The INF driver version number must be incremented to cause the updated driver data to be applied to the active driver registry key in the System hive.","pos":[2120,2270]},{"content":"The driver version is specified in the following format:","pos":[2271,2327]},{"content":"<bpt id=\"p1\">*</bpt>MM<ept id=\"p1\">*</ept><ph id=\"ph1\">/</ph><bpt id=\"p2\">*</bpt>DD<ept id=\"p2\">*</ept><ph id=\"ph2\">/</ph><bpt id=\"p3\">*</bpt>YYYY<ept id=\"p3\">*</ept>, <bpt id=\"p4\">*</bpt>n<ept id=\"p4\">*</ept>.","pos":[2329,2351]},{"content":"<bpt id=\"p1\">*</bpt>n<ept id=\"p1\">*</ept>.","pos":[2352,2356]},{"content":"<bpt id=\"p1\">*</bpt>n<ept id=\"p1\">*</ept>.","pos":[2357,2361]},{"content":"n","pos":[2363,2364]},{"content":"<bpt id=\"p1\">*</bpt>MM<ept id=\"p1\">*</ept> is month, <bpt id=\"p2\">*</bpt>DD<ept id=\"p2\">*</ept> is day, and <bpt id=\"p3\">*</bpt>YYYY<ept id=\"p3\">*</ept> is year, followed by the version number.","pos":[2367,2446]},{"content":"The first digit of the version number is the major version, followed by the minor versions.","pos":[2447,2538]},{"content":"For driver updates, the entire string is evaluated as the version number.","pos":[2539,2612]},{"content":"If just the date (<bpt id=\"p1\">*</bpt>MM<ept id=\"p1\">*</ept><ph id=\"ph1\">/</ph><bpt id=\"p2\">*</bpt>DD<ept id=\"p2\">*</ept><ph id=\"ph2\">/</ph><bpt id=\"p3\">*</bpt>YYYY<ept id=\"p3\">*</ept>) is incremented, it is considered to be a newer version of the driver.","pos":[2613,2718]},{"pos":[2873,2904],"content":"Driver walkthrough introduction"},{"content":"The driver update walkthrough covers the following tasks:","pos":[2907,2964]},{"content":"Build the version 1 driver package","pos":[2971,3005]},{"content":"Add the version 1 driver to the OS","pos":[3032,3066]},{"content":"View the driver registry settings","pos":[3094,3127]},{"content":"Examine the registry keys to confirm that the driver is active","pos":[3153,3215]},{"content":"Build the version 2 driver package","pos":[3248,3282]},{"content":"Add the version 2 driver to the OS","pos":[3312,3346]},{"content":"Confirm that the updated driver is active","pos":[3374,3415]},{"content":"In this example, the following version numbers are used:","pos":[3448,3504]},{"content":"Driver version in INF file","pos":[3622,3648]},{"content":"Package version","pos":[3671,3686]},{"content":"11/01/2012,1.00.00.00","pos":[3752,3773]},{"content":"8.00.9907.12","pos":[3803,3815]},{"content":"02/19/2013,1.32.00.00","pos":[3869,3890]},{"content":"8.00.10211.25","pos":[3920,3933]},{"content":"The driver file is named XKmdfDriver.sys, and the INF file is XKmdfDriver.inf.","pos":[3971,4049]},{"content":"Note","pos":[4053,4057]},{"content":"Replace these file names with the name of the driver that you want to use in this walkthrough.","pos":[4062,4156]},{"content":"The original driver will be located in the <ph id=\"ph1\">\\\\</ph>Version1 folder, and the updated version will be located in <ph id=\"ph2\">\\\\</ph>Version2.","pos":[4161,4277]},{"content":"The walkthrough assumes that the following environmental variables are similar to what is shown here:","pos":[4279,4380]},{"pos":[4671,4705],"content":"Build the version 1 driver package"},{"content":"Use the following steps to include the version 1 driver in the OS.","pos":[4708,4774]},{"content":"Copy the driver files to the <ph id=\"ph1\">\\\\</ph>Version1 directory:","pos":[4780,4830]},{"content":"XKmdfDriver.inf","pos":[4840,4855]},{"content":"XKmdfdriver.pkg.xml","pos":[4865,4884]},{"content":"XKmdfDriver.sys","pos":[4894,4909]},{"content":"In the XKmdfDriver.inf file, set the <ph id=\"ph1\">`DriverVer`</ph> directive in the <ph id=\"ph2\">`[Version]`</ph> section as shown here.","pos":[4915,5015]},{"content":"The highlighted string \"11/01/2012,1.00.00.00\" is the version number of the driver.","pos":[5016,5099]},{"content":"The package XML (XKmdfdriver.pkg.xml) for the version 1 driver, is shown below.","pos":[5376,5455]},{"content":"Specify an OEM <ph id=\"ph1\">`Owner`</ph> name.","pos":[5456,5484]},{"content":"Move to the <ph id=\"ph1\">\\\\</ph>Version1 directory, set the package version as shown, and build the driver package.","pos":[6206,6303]},{"pos":[6552,6632],"content":"Confirm that the <bpt id=\"p1\">*</bpt>OEMName<ept id=\"p1\">*</ept>.Phone.Test.BaseOS.XKmdfDriver.spkg package was built."},{"pos":[6745,6779],"content":"Add the version 1 driver to the OS"},{"content":"Use the following steps to include the version 1 driver in the OS by using IUTool and a production or test build.","pos":[6782,6895]},{"content":"Alternatively, include the package in an image and then flash that image to the phone.","pos":[6896,6982]},{"content":"Connect the device to the PC by using a USB cable.","pos":[6988,7038]},{"content":"Use IuTool to add the version 1 driver package to an existing image.","pos":[7044,7112]},{"content":"Confirm that the IuTool was able to deploy the package to the device","pos":[7199,7267]},{"pos":[7374,7407],"content":"View the driver registry settings"},{"content":"Use the following process to mount the device in mass storage mode and view the registry.","pos":[7410,7499]},{"content":"Reboot the device to USB mass storage mode.","pos":[7505,7548]},{"content":"This is done by using a specific key sequence on the phone—for example, holding the camera button down when powering up.","pos":[7549,7669]},{"content":"Connect the device to the PC with a USB cable.","pos":[7675,7721]},{"content":"When the device is connected to the PC in USB mass storage mode, it will appear as a logical drive on the PC.","pos":[7727,7836]},{"content":"Open a Command Prompt window as an administrator.","pos":[7842,7891]},{"pos":[7897,7978],"content":"Locate the registry SYSTEM hive under the folder <bpt id=\"p1\">**</bpt><ph id=\"ph1\">\\\\</ph>WINDOWS<ph id=\"ph2\">\\\\</ph>SYSTEM32<ph id=\"ph3\">\\\\</ph>CONFIG<ept id=\"p1\">**</ept>."},{"content":"Start the Registry Editor (Regedit.exe) on the PC.","pos":[7984,8034]},{"pos":[8040,8123],"content":"In the Registry Editor, click <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept> <ph id=\"ph1\">&amp;gt;</ph> <bpt id=\"p2\">**</bpt>Load Hive<ept id=\"p2\">**</ept> and load the SYSTEM hive."},{"content":"Provide a name for the imported hive—for this example, DRIVER<ph id=\"ph1\">\\_</ph>VERSION1","pos":[8129,8200]},{"content":"Proceed to the next section to examine the contents of the imported registry hive.","pos":[8206,8288]},{"pos":[8416,8478],"content":"Examine the registry keys to confirm that the driver is active"},{"content":"When Windows 10 Mobile installs the driver, the following registry keys appear in the SYSTEM hive:","pos":[8481,8579]},{"pos":[8585,8657],"content":"A driver-specific registry key is created under <ph id=\"ph1\">`SYSTEM\\DriverDatabase`</ph>."},{"pos":[8663,8749],"content":"An active driver subkey is created under <ph id=\"ph1\">`SYSTEM\\ControlSet001\\Enum\\ROOT\\XKmdfDriver`</ph>."},{"content":"Each of these two areas is discussed in the following sections.","pos":[8751,8814]},{"content":"Use this information in the registry to determine if the driver is ready to be installed and if the OS has recognized the hardware and installed the proper version of the driver.","pos":[8815,8993]},{"pos":[9101,9116],"content":"Driver database"},{"content":"Driver settings are staged for later installation in <ph id=\"ph1\">`SYSTEM\\DriverDatabase`</ph>.","pos":[9118,9195]},{"content":"The OS uses this subkey to install drivers when the new hardware is identified.","pos":[9196,9275]},{"content":"It contains:","pos":[9276,9288]},{"content":"Information about the XKmdfDriver.inf","pos":[9294,9331]},{"content":"A specific GUID <ph id=\"ph1\">`{4d36e97d-e325-11ce-bfc1-08002be10318}`</ph> that identifies the XKmdfDriver as a SYSTEM class driver, not a driver that uses a dynamically enumerable bus (such as ACPI or USB).","pos":[9337,9526]},{"content":"This example uses a system class driver to simplify the walkthrough, but the concepts illustrated are similar with other types of drivers.","pos":[9527,9665]},{"pos":[9667,9880],"content":"When the package is installed, the XKmkdfDriver.inf is added to <ph id=\"ph1\">`[SYSTEM\\DriverDatabase\\DeviceIds\\{4d36e97d-e325-11ce-bfc1-08002be10318}]`</ph>, where <ph id=\"ph2\">`{4d36e97d-e325-11ce-bfc1-08002be10318}`</ph> is the system driver GUID."},{"pos":[9882,10001],"content":"The following shows the system driver GUID in the <ph id=\"ph1\">`[SYSTEM\\DriverDatabase\\DeviceIds\\Root\\XKmdfDriver]`</ph> registry subkey."},{"pos":[10206,10379],"content":"Under the <ph id=\"ph1\">`[SYSTEM\\DriverDatabase\\DriverInfFiles\\XKmdfDriver.inf]`</ph> subkey, the active INF file is specified with the entry <ph id=\"ph2\">`\"Active\"=\"xkmdfdriver.inf_arm_c8e7ab79be6b088b\"`</ph>."},{"content":"The <ph id=\"ph1\">`\"Active\"`</ph> entry is pointing to the active driver INF.","pos":[10381,10439]},{"content":"When the driver package is updated, there are multiple INF settings, and <ph id=\"ph1\">`\"Active\"`</ph> points to the latest one.","pos":[10440,10549]},{"pos":[11035,11179],"content":"The <ph id=\"ph1\">`[SYSTEM\\DriverDatabase\\DriverPackages\\xkmdfdriver.inf_arm_c8e7ab79be6b088b]`</ph> subkey contains a replication of the XKmdfDriver.inf contents."},{"content":"This subkey references the service associated with the system driver:","pos":[11553,11622]},{"content":"This subkey sets the driver description strings:","pos":[11799,11847]},{"content":"This subkey sets the value of the driver description string:","pos":[12067,12127]},{"pos":[12397,12420],"content":"Control set enumeration"},{"content":"is created when the OS successfully installs the matching device driver with the INF file.","pos":[12469,12559]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>HKLM<ph id=\"ph1\">\\\\</ph>SYSTEM<ph id=\"ph2\">\\\\</ph>CurrentControlSet<ph id=\"ph3\">\\\\</ph>Enum Registry Tree<ept id=\"p1\">](http://msdn.microsoft.com/library/windows/hardware/ff546173.aspx)</ept> on MSDN.","pos":[12560,12714]},{"content":"The <ph id=\"ph1\">`Control`</ph> subkey contains information for controlling system startup and some aspects of device.","pos":[12716,12816]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>HKLM<ph id=\"ph1\">\\\\</ph>SYSTEM<ph id=\"ph2\">\\\\</ph>CurrentControlSet<ph id=\"ph3\">\\\\</ph>Control Registry Tree<ept id=\"p1\">](http://msdn.microsoft.com/library/windows/hardware/ff546165.aspx)</ept> on MSDN.","pos":[12817,12974]},{"content":"indicates that the driver has the 120th rank among SYSTEM class drivers.","pos":[13057,13129]},{"content":"This subkey includes the driver date and version as shown here:","pos":[13130,13193]},{"content":"The DeviceClasses subkey includes the device instance ID:","pos":[13541,13598]},{"content":"This next subkey associates the XKmdfDriver with the system containerId 00000000-0000-0000-ffff-ffffffffffff:","pos":[13808,13917]},{"content":"contains information about the installed driver.","pos":[14168,14216]},{"content":"It has one instance, <ph id=\"ph1\">`XKmdfDriver\\0000`</ph>:","pos":[14217,14257]},{"content":"contains the driver file \"ImagePath\" value; it is ASCII characters encoded in hexadecimal binary format.","pos":[14885,14989]},{"content":"The actual value is \"ImagePath\" = REG<ph id=\"ph1\">\\_</ph>EXPAND<ph id=\"ph2\">\\_</ph>SZ: \"<ph id=\"ph3\">\\\\</ph>SystemRoot<ph id=\"ph4\">\\\\</ph>System32<ph id=\"ph5\">\\\\</ph>drivers<ph id=\"ph6\">\\\\</ph>XKmdfDriver.sys\".","pos":[14990,15092]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Registry Value Types<ept id=\"p1\">](http://msdn.microsoft.com/library/windows/desktop/ms724884.aspx)</ept> on MSDN.","pos":[15093,15215]},{"pos":[15897,15929],"content":"contains the WDF version number:"},{"pos":[16221,16257],"content":"Close the tools and eject the device"},{"pos":[16264,16420],"content":"In the Registry Editor, click <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept> <ph id=\"ph1\">&amp;gt;</ph> <bpt id=\"p2\">**</bpt>Unload Hive<ept id=\"p2\">**</ept> to unload the <ph id=\"ph2\">`DRIVER_VERSION1`</ph> hive, so that the PC registry is restored to its previous state."},{"content":"Close the Registry Editor.","pos":[16426,16452]},{"content":"Close the Command Prompt window and any open instances of Windows Explorer that were used to view the temp folder.","pos":[16458,16572]},{"pos":[16578,16754],"content":"Eject the phone (use <bpt id=\"p1\">**</bpt>Safely Remove Hardware and Eject Media<ept id=\"p1\">**</ept> in the notification area or the Windows Explorer <bpt id=\"p2\">**</bpt>Eject<ept id=\"p2\">**</ept> command), and then disconnect the device from the PC."},{"pos":[16873,16907],"content":"Build the version 2 driver package"},{"content":"As described earlier, the new driver version will be 2/19/2013,1.32.00.00, which will be contained in a new package version, 8.00.10211.25.","pos":[16910,17049]},{"content":"Create a second copy of the driver files in the <ph id=\"ph1\">\\\\</ph>Version2 directory.","pos":[17055,17124]},{"pos":[17130,17208],"content":"Edit the XKmdfDriver.inf file and change <ph id=\"ph1\">`DriverVer`</ph> to 02/19/2013,1.32.00.00."},{"content":"Add a new registry value named \"DW123\", of type DWORD.","pos":[17214,17268]},{"content":"The presence of this key is used as an additional indication that the version 2 driver is active.","pos":[17269,17366]},{"content":"Move to the <ph id=\"ph1\">\\\\</ph>Version2 directory, set the package version, and build the package.","pos":[17695,17776]},{"pos":[18133,18167],"content":"Add the version 2 driver to the OS"},{"content":"Use the following steps to include the version 2 driver in the OS using IUTool and a production or test build:","pos":[18170,18280]},{"content":"Connect the device to the PC by using a USB cable.","pos":[18286,18336]},{"content":"Use IuTool to add the version 2 driver package to an existing image.","pos":[18342,18410]},{"content":"Confirm that the IUTool was able to deploy the package to the device","pos":[18497,18565]},{"pos":[18708,18749],"content":"Confirm that the updated driver is active"},{"content":"Use the following process to confirm that the updated driver is active.","pos":[18752,18823]},{"pos":[18829,18965],"content":"Use the process described previously in <bpt id=\"p1\">[</bpt>View the driver registry settings<ept id=\"p1\">](#viewtheregistry)</ept> to load and view the system registry hive."},{"content":"DriverPackages should have two INF registry key sets: one for the previously installed driver and the one for the updated driver.","pos":[18971,19100]},{"pos":[19299,19352],"content":"in XKmdfDriver.inf should point to the newer INF key:"},{"content":"The driver still has the 120th rank under SYSTEM Class driver, but the date and version should be updated.","pos":[19493,19599]},{"content":"\"DriverDate\"=\"2-19-2013\"","pos":[19609,19633]},{"content":"\"DriverVersion\"=\"1.32.0.0\"","pos":[19643,19669]},{"pos":[20066,20160],"content":"The newly added DWORD registry value DW123 should appear under the <ph id=\"ph1\">`Device Parameters`</ph> subkey."},{"pos":[20286,20408],"content":"Use the process described earlier in <bpt id=\"p1\">[</bpt>Close the tools and eject the phone<ept id=\"p1\">](#closethetools)</ept> to safely disconnect the device"},{"pos":[20446,20460],"content":"Related topics"},{"content":"Update","pos":[20464,20470]}],"content":"---\nauthor: kpacquer\nDescription: Update a KMDF device driver\nms.assetid: e391e00a-b764-4d47-8e14-30b4446ddfb2\nMSHAttr: 'PreferredLib:/library/windows/hardware'\ntitle: Update a KMDF device driver\n---\n\n# Update a KMDF device driver\n\n\nLike all other components that are added to the OS, KMDF (Kernel-Mode Driver Framework) drivers are included in the OS image by using .spkg package files that are referenced by an OEMInput.xml file when OEMs builds the image.\n\nSimilarly, driver updates are published by using .spkg package files. Like all package updates, the package version must be incremented for each update; for more information, see [Update requirements](update-requirements.md). When driver updates are prepared, the value of the **DriverVer** directive in the driver INF file must also be incremented. This walkthrough shows how to prepare a KMDF device driver update and confirm that the updated driver is loaded by the OS.\n\nThis topic assumes that you are familiar with the general concepts associated with Windows device driver installation and the use of the INF file. For more information, see [Device and driver installation](https://msdn.microsoft.com/library/windows/hardware/ff549731).\n\n## <span id=\"Driver_INF_files_and_updates\"></span><span id=\"driver_inf_files_and_updates\"></span><span id=\"DRIVER_INF_FILES_AND_UPDATES\"></span>Driver INF files and updates\n\n\nVisual Studio automatically generates an INF file when building a Windows 10 Mobile KMDF driver project. In Windows, driver installation uses the INF file directly. However, in Windows 10 Mobile, the INF file is converted to a registry entries (.reg) file. The .reg file is included in the .spkg file when the driver is packaged.\n\nWhen creating a KMDF driver update, two version numbers must be incremented: the version number of the .spkg package file and the **DriverVer** value in the INF file.\n\n**Package version**\n\nThe package version number must be incremented to cause the update to be applied to the OS. If the update package version is not greater than the existing version, the update will not be applied.\n\n**INF driver version**\n\nThe INF driver version number must be incremented to cause the updated driver data to be applied to the active driver registry key in the System hive. The driver version is specified in the following format:\n\n*MM*/*DD*/*YYYY*, *n*. *n*. *n*. *n*\n\n*MM* is month, *DD* is day, and *YYYY* is year, followed by the version number. The first digit of the version number is the major version, followed by the minor versions. For driver updates, the entire string is evaluated as the version number. If just the date (*MM*/*DD*/*YYYY*) is incremented, it is considered to be a newer version of the driver.\n\n## <span id=\"Driver_walkthrough_introduction\"></span><span id=\"driver_walkthrough_introduction\"></span><span id=\"DRIVER_WALKTHROUGH_INTRODUCTION\"></span>Driver walkthrough introduction\n\n\nThe driver update walkthrough covers the following tasks:\n\n-   [Build the version 1 driver package](#buildtheversion1)\n\n-   [Add the version 1 driver to the OS](#addingtheversion1)\n\n-   [View the driver registry settings](#viewtheregistry)\n\n-   [Examine the registry keys to confirm that the driver is active](#examinetheregistrykeys)\n\n-   [Build the version 2 driver package](#buildingtheversion2)\n\n-   [Add the version 2 driver to the OS](#addingtheversion2)\n\n-   [Confirm that the updated driver is active](#confirmthattheupdateddriver)\n\nIn this example, the following version numbers are used:\n\n<table>\n<colgroup>\n<col width=\"50%\" />\n<col width=\"50%\" />\n</colgroup>\n<thead>\n<tr class=\"header\">\n<th align=\"left\">Driver version in INF file</th>\n<th align=\"left\">Package version</th>\n</tr>\n</thead>\n<tbody>\n<tr class=\"odd\">\n<td align=\"left\"><p>11/01/2012,1.00.00.00</p></td>\n<td align=\"left\"><p>8.00.9907.12</p></td>\n</tr>\n<tr class=\"even\">\n<td align=\"left\"><p>02/19/2013,1.32.00.00</p></td>\n<td align=\"left\"><p>8.00.10211.25</p></td>\n</tr>\n</tbody>\n</table>\n\n \n\nThe driver file is named XKmdfDriver.sys, and the INF file is XKmdfDriver.inf.\n\n**Note**  \nReplace these file names with the name of the driver that you want to use in this walkthrough.\n\n \n\nThe original driver will be located in the \\\\Version1 folder, and the updated version will be located in \\\\Version2.\n\nThe walkthrough assumes that the following environmental variables are similar to what is shown here:\n\n``` syntax\nset AK_ROOT=C:\\Program Files (x86)\\Windows Kits\\10\nset WINKIT_ROOT=C:\\Program Files (x86)\\Windows Kits\\10\nPATH=%AK_ROOT%\\Tools\\bin\\i386;%WINKIT_ROOT%\\bin\\x86;%PATH%\n```\n\n## <span id=\"BuildTheVersion1\"></span><span id=\"buildtheversion1\"></span><span id=\"BUILDTHEVERSION1\"></span>Build the version 1 driver package\n\n\nUse the following steps to include the version 1 driver in the OS.\n\n1.  Copy the driver files to the \\\\Version1 directory:\n\n    -   XKmdfDriver.inf\n\n    -   XKmdfdriver.pkg.xml\n\n    -   XKmdfDriver.sys\n\n2.  In the XKmdfDriver.inf file, set the `DriverVer` directive in the `[Version]` section as shown here. The highlighted string \"11/01/2012,1.00.00.00\" is the version number of the driver.\n\n    ``` syntax\n    …\n    [Version]\n    Signature=\"$WINDOWS NT$\"\n    Class=System\n    ClassGuid={4d36e97d-e325-11ce-bfc1-08002be10318}\n    Provider=%MSFT%\n    DriverVer=11/01/2012,1.00.00.00\n    BootCritical=1\n\n    [DestinationDirs]\n    DefaultDestDir = 12\n    …\n    ```\n\n3.  The package XML (XKmdfdriver.pkg.xml) for the version 1 driver, is shown below. Specify an OEM `Owner` name.\n\n    ``` syntax\n    <?xml version=\"1.0\" encoding=\"utf-8\"?>\n    <Package xmlns=\"urn:Microsoft.WindowsPhone/PackageSchema.v8.00\"\n      Owner=\"OEMName\"\n      OwnerType=\"OEM\"     \n      ReleaseType=\"Test\"\n      Platform=\"QC8960\"           \n      Component=\"Phone.Test.BaseOS\"\n      SubComponent=\"XKmdfDriver\"\n      Partition=\"MainOS\"\n      BinaryPartition=\"false\">\n      <Components>\n        <OSComponent>\n            <Files>\n                <File Source=\"XKmdfDriver.sys\" DestinationDir=\"$(runtime.system32)\\drivers\"/>\n            </Files>\n        </OSComponent>\n        <Driver InfSource=\"XKmdfDriver.inf\">\n            <Reference Source=\"XKmdfDriver.sys\"/>\n        </Driver>\n      </Components>\n    </Package>\n    ```\n\n4.  Move to the \\\\Version1 directory, set the package version as shown, and build the driver package.\n\n    ``` syntax\n    cd \\Version1\n    set PKGVER=8.00.9907.12\n    pkggen  XKmdfDriver.pkg.xml /version:%PKGVER% /build:fre /cpu:ARM /config:\"%AK_ROOT%\\Tools\\bin\\i386\\pkggen.cfg.xml\" /output:. /variables:\"HIVE_ROOT=%AK_ROOT%\\CoreSystem\"\n    ```\n\n5.  Confirm that the *OEMName*.Phone.Test.BaseOS.XKmdfDriver.spkg package was built.\n\n## <span id=\"AddingTheVersion1\"></span><span id=\"addingtheversion1\"></span><span id=\"ADDINGTHEVERSION1\"></span>Add the version 1 driver to the OS\n\n\nUse the following steps to include the version 1 driver in the OS by using IUTool and a production or test build. Alternatively, include the package in an image and then flash that image to the phone.\n\n1.  Connect the device to the PC by using a USB cable.\n\n2.  Use IuTool to add the version 1 driver package to an existing image.\n\n    ``` syntax\n    IuTool -p OEMName.Phone.Test.BaseOS.XKmdfDriver.spkg\n    ```\n\n3.  Confirm that the IuTool was able to deploy the package to the device\n\n## <span id=\"ViewTheRegistry\"></span><span id=\"viewtheregistry\"></span><span id=\"VIEWTHEREGISTRY\"></span>View the driver registry settings\n\n\nUse the following process to mount the device in mass storage mode and view the registry.\n\n1.  Reboot the device to USB mass storage mode. This is done by using a specific key sequence on the phone—for example, holding the camera button down when powering up.\n\n2.  Connect the device to the PC with a USB cable.\n\n3.  When the device is connected to the PC in USB mass storage mode, it will appear as a logical drive on the PC.\n\n4.  Open a Command Prompt window as an administrator.\n\n5.  Locate the registry SYSTEM hive under the folder **\\\\WINDOWS\\\\SYSTEM32\\\\CONFIG**.\n\n6.  Start the Registry Editor (Regedit.exe) on the PC.\n\n7.  In the Registry Editor, click **File** &gt; **Load Hive** and load the SYSTEM hive.\n\n8.  Provide a name for the imported hive—for this example, DRIVER\\_VERSION1\n\n9.  Proceed to the next section to examine the contents of the imported registry hive.\n\n## <span id=\"ExamineTheRegistryKeys\"></span><span id=\"examinetheregistrykeys\"></span><span id=\"EXAMINETHEREGISTRYKEYS\"></span>Examine the registry keys to confirm that the driver is active\n\n\nWhen Windows 10 Mobile installs the driver, the following registry keys appear in the SYSTEM hive:\n\n-   A driver-specific registry key is created under `SYSTEM\\DriverDatabase`.\n\n-   An active driver subkey is created under `SYSTEM\\ControlSet001\\Enum\\ROOT\\XKmdfDriver`.\n\nEach of these two areas is discussed in the following sections. Use this information in the registry to determine if the driver is ready to be installed and if the OS has recognized the hardware and installed the proper version of the driver.\n\n### <span id=\"Driver_database\"></span><span id=\"driver_database\"></span><span id=\"DRIVER_DATABASE\"></span>Driver database\n\nDriver settings are staged for later installation in `SYSTEM\\DriverDatabase`. The OS uses this subkey to install drivers when the new hardware is identified. It contains:\n\n-   Information about the XKmdfDriver.inf\n\n-   A specific GUID `{4d36e97d-e325-11ce-bfc1-08002be10318}` that identifies the XKmdfDriver as a SYSTEM class driver, not a driver that uses a dynamically enumerable bus (such as ACPI or USB). This example uses a system class driver to simplify the walkthrough, but the concepts illustrated are similar with other types of drivers.\n\nWhen the package is installed, the XKmkdfDriver.inf is added to `[SYSTEM\\DriverDatabase\\DeviceIds\\{4d36e97d-e325-11ce-bfc1-08002be10318}]`, where `{4d36e97d-e325-11ce-bfc1-08002be10318}` is the system driver GUID.\n\nThe following shows the system driver GUID in the `[SYSTEM\\DriverDatabase\\DeviceIds\\Root\\XKmdfDriver]` registry subkey.\n\n``` syntax\n[SYSTEM\\DriverDatabase\\DeviceIds\\Root\\XKmdfDriver]\n\"XKmdfDriver.inf\"=hex:01,ff,00,00\n[SYSTEM\\DriverDatabase\\DeviceIds\\{4d36e97d-e325-11ce-bfc1-08002be10318}]\n..\n\"XKmdfDriver.inf\"=hex(0):\n```\n\nUnder the `[SYSTEM\\DriverDatabase\\DriverInfFiles\\XKmdfDriver.inf]` subkey, the active INF file is specified with the entry `\"Active\"=\"xkmdfdriver.inf_arm_c8e7ab79be6b088b\"`.\n\nThe `\"Active\"` entry is pointing to the active driver INF. When the driver package is updated, there are multiple INF settings, and `\"Active\"` points to the latest one.\n\n``` syntax\n[SYSTEM\\DriverDatabase\\DriverInfFiles\\XKmdfDriver.inf]\n\"Active\"=\"xkmdfdriver.inf_arm_c8e7ab79be6b088b\"\n@=hex(7):78,00,6b,00,6d,00,64,00,66,00,64,00,72,00,69,00,76,00,65,00,72,00,2e,\\\n00,69,00,6e,00,66,00,5f,00,61,00,72,00,6d,00,5f,00,63,00,38,00,65,00,37,00,\\\n61,00,62,00,37,00,39,00,62,00,65,00,36,00,62,00,30,00,38,00,38,00,62,00,00,\\\n00,00,00\n\"Configurations\"=hex(7):58,00,4b,00,4d,00,44,00,46,00,44,00,52,00,49,00,56,00,\\\n45,00,52,00,2e,00,4e,00,54,00,00,00,00,00\n```\n\nThe `[SYSTEM\\DriverDatabase\\DriverPackages\\xkmdfdriver.inf_arm_c8e7ab79be6b088b]` subkey contains a replication of the XKmdfDriver.inf contents.\n\n``` syntax\n[SYSTEM\\DriverDatabase\\DriverPackages\\xkmdfdriver.inf_arm_c8e7ab79be6b088b]\n@=\"XKmdfDriver.inf\"\n\"BootCritical\"=dword:00000001\n\"Provider\"=\"Microsoft\"\n\"SignerName\"=\"\"\n\"SignerScore\"=dword:0d000003\n\"Version\"=hex:ff,ff,05,00,00,00,00,00,7d,e9,36,4d,25,e3,ce,11,bf,c1,08,00,2b,\\\ne1,03,18,00,40,f9,d5,c3,b7,cd,01,00,00,00,00,00,00,01,00,00,00,00,00,00,00,\\\n00,00\n```\n\nThis subkey references the service associated with the system driver:\n\n``` syntax\n[SYSTEM\\DriverDatabase\\DriverPackages\\xkmdfdriver.inf_arm_c8e7ab79be6b088b\\Configurations\\XKMDFDRIVER.NT]\n\"ConfigFlags\"=dword:00000000\n\"Service\"=\"XKmdfDriver\"\n```\n\nThis subkey sets the driver description strings:\n\n``` syntax\n[SYSTEM\\DriverDatabase\\DriverPackages\\xkmdfdriver.inf_arm_c8e7ab79be6b088b\\Descriptors\\Root\\XKmdfDriver]\n\"Configuration\"=\"XKMDFDRIVER.NT\"\n\"Description\"=\"%xkmdfdriver_devdesc%\"\n\"Manufacturer\"=\"%StdMfg%\"\n```\n\nThis subkey sets the value of the driver description string:\n\n``` syntax\n[SYSTEM\\DriverDatabase\\DriverPackages\\xkmdfdriver.inf_arm_c8e7ab79be6b088b\\Strings]\n\"xkmdfdriver_devdesc\"=\"X KMDF Driver\"\n```\n\n### <span id=\"Control_set_enumeration\"></span><span id=\"control_set_enumeration\"></span><span id=\"CONTROL_SET_ENUMERATION\"></span>Control set enumeration\n\n`[SYSTEM\\ControlSet001\\Enum\\ROOT\\XKmdfDriver]` is created when the OS successfully installs the matching device driver with the INF file. For more information, see [HKLM\\\\SYSTEM\\\\CurrentControlSet\\\\Enum Registry Tree](http://msdn.microsoft.com/library/windows/hardware/ff546173.aspx) on MSDN.\n\nThe `Control` subkey contains information for controlling system startup and some aspects of device. For more information, see [HKLM\\\\SYSTEM\\\\CurrentControlSet\\\\Control Registry Tree](http://msdn.microsoft.com/library/windows/hardware/ff546165.aspx) on MSDN.\n\n`SYSTEM\\ControlSet001\\Control\\Class\\{4d36e97d-e325-11ce-bfc1-08002be10318}\\0120` indicates that the driver has the 120th rank among SYSTEM class drivers. This subkey includes the driver date and version as shown here:\n\n``` syntax\n[SYSTEM\\ControlSet001\\Control\\Class\\{4d36e97d-e325-11ce-bfc1-08002be10318}\\0120]\n\"DriverDesc\"=\"X KMDF Driver\"\n\"ProviderName\"=\"Microsoft\"\n\"DriverDateData\"=hex:00,40,f9,d5,c3,b7,cd,01\n\"DriverDate\"=\"11-1-2012\"\n\"DriverVersion\"=\"1.0.0.0\"\n\"InfPath\"=\"XKmdfDriver.inf\"\n\"InfSection\"=\"XKMDFDRIVER.NT\"\n\"MatchingDeviceId\"=\"ROOT\\\\XKmdfDriver\"\n```\n\nThe DeviceClasses subkey includes the device instance ID:\n\n``` syntax\n[SYSTEM\\ControlSet001\\Control\\DeviceClasses\\{5cdce65b-f1bc-4e15-a1f8-c541f21c43f2}\\##?#ROOT#XKmdfDriver#0000#{5cdce65b-f1bc-4e15-a1f8-c541f21c43f2}]\n\"DeviceInstance\"=\"ROOT\\\\XKmdfDriver\\\\0000\"\n```\n\nThis next subkey associates the XKmdfDriver with the system containerId 00000000-0000-0000-ffff-ffffffffffff:\n\n``` syntax\n[SYSTEM\\ControlSet001\\Control\\DeviceContainers\\{00000000-0000-0000-FFFF-FFFFFFFFFFFF}\\BaseContainers\\{00000000-0000-0000-FFFF-FFFFFFFFFFFF}]\n..\n\"ROOT\\\\XKmdfDriver\\\\0000\"=hex(0):\n..\n```\n\n`[SYSTEM\\ControlSet001\\Enum\\ROOT\\XKmdfDriver\\0000]` contains information about the installed driver. It has one instance, `XKmdfDriver\\0000`:\n\n``` syntax\n[SYSTEM\\ControlSet001\\Enum\\ROOT\\XKmdfDriver\\0000]\n\"HardwareID\"=hex(7):52,00,4f,00,4f,00,54,00,5c,00,58,00,4b,00,6d,00,64,00,66,\\\n  00,44,00,72,00,69,00,76,00,65,00,72,00,00,00,00,00\n\"ConfigFlags\"=dword:00000000\n\"DeviceReported\"=dword:00000001\n\"Service\"=\"XKmdfDriver\"\n\"Capabilities\"=dword:00000000\n\"ClassGUID\"=\"{4d36e97d-e325-11ce-bfc1-08002be10318}\"\n\"DeviceDesc\"=\"@XKmdfDriver.inf,%xkmdfdriver_devdesc%;X KMDF Driver\"\n\"Driver\"=\"{4d36e97d-e325-11ce-bfc1-08002be10318}\\\\0120\"\n\"Mfg\"=\"@XKmdfDriver.inf,%StdMfg%;\"\n\"ContainerID\"=\"{00000000-0000-0000-FFFF-FFFFFFFFFFFF}\"\n```\n\n`[SYSTEM\\ControlSet001\\services\\XKmdfDriver]` contains the driver file \"ImagePath\" value; it is ASCII characters encoded in hexadecimal binary format. The actual value is \"ImagePath\" = REG\\_EXPAND\\_SZ: \"\\\\SystemRoot\\\\System32\\\\drivers\\\\XKmdfDriver.sys\". For more information, see [Registry Value Types](http://msdn.microsoft.com/library/windows/desktop/ms724884.aspx) on MSDN.\n\n``` syntax\n[SYSTEM\\ControlSet001\\services\\XKmdfDriver]\n\"DisplayName\"=\"@XKmdfDriver.inf,%xkmdfdriver_DevDesc%;X KMDF Driver\"\n\"ErrorControl\"=dword:00000001\n\"ImagePath\"=hex(2):5c,00,53,00,79,00,73,00,74,00,65,00,6d,00,52,00,6f,00,6f,00,\\\n74,00,5c,00,53,00,79,00,73,00,74,00,65,00,6d,00,33,00,32,00,5c,00,64,00,72,\\\n00,69,00,76,00,65,00,72,00,73,00,5c,00,58,00,4b,00,6d,00,64,00,66,00,44,00,\\\n72,00,69,00,76,00,65,00,72,00,2e,00,73,00,79,00,73,00,00,00\n\"Start\"=dword:00000001\n\"Type\"=dword:00000001\n\"Owners\"=hex(7):58,00,4b,00,6d,00,64,00,66,00,44,00,72,00,69,00,76,00,65,00,72,\\\n00,2e,00,69,00,6e,00,66,00,00,00,00,00\n```\n\n`[SYSTEM\\ControlSet001\\services\\XKmdfDriver\\Parameters\\Wdf]` contains the WDF version number:\n\n``` syntax\n[SYSTEM\\ControlSet001\\services\\XKmdfDriver\\Parameters\\Wdf]\n\"WdfMajorVersion\"=dword:00000001\n\"WdfMinorVersion\"=dword:0000000b\n\"TimeOfLastSqmLog\"=hex(b):20,41,89,d7,2c,c0,cd,01\n```\n\n## <span id=\"CloseTheTools\"></span><span id=\"closethetools\"></span><span id=\"CLOSETHETOOLS\"></span>Close the tools and eject the device\n\n\n1.  In the Registry Editor, click **File** &gt; **Unload Hive** to unload the `DRIVER_VERSION1` hive, so that the PC registry is restored to its previous state.\n\n2.  Close the Registry Editor.\n\n3.  Close the Command Prompt window and any open instances of Windows Explorer that were used to view the temp folder.\n\n4.  Eject the phone (use **Safely Remove Hardware and Eject Media** in the notification area or the Windows Explorer **Eject** command), and then disconnect the device from the PC.\n\n## <span id=\"BuildingTheVersion2\"></span><span id=\"buildingtheversion2\"></span><span id=\"BUILDINGTHEVERSION2\"></span>Build the version 2 driver package\n\n\nAs described earlier, the new driver version will be 2/19/2013,1.32.00.00, which will be contained in a new package version, 8.00.10211.25.\n\n1.  Create a second copy of the driver files in the \\\\Version2 directory.\n\n2.  Edit the XKmdfDriver.inf file and change `DriverVer` to 02/19/2013,1.32.00.00.\n\n3.  Add a new registry value named \"DW123\", of type DWORD. The presence of this key is used as an additional indication that the version 2 driver is active.\n\n    ``` syntax\n    [Version]\n    Signature=\"$WINDOWS NT$\"\n    Class=System\n    ClassGuid={4d36e97d-e325-11ce-bfc1-08002be10318}\n    Provider=%MSFT%\n    DriverVer=02/19/2013,1.32.00.00\n    [XKMDFDRIVER.NT.HW]\n    AddReg=XKMDFDRIVER.AddReg\n\n    [XKMDFDRIVER.AddReg]\n    HKR,,\" DW123\",    %REG_DWORD%, 0x4567\n    ...\n    ```\n\n4.  Move to the \\\\Version2 directory, set the package version, and build the package.\n\n    ``` syntax\n    cd \\Version2\n    set PKGVER=8.00.10211.25\n    pkggen  XKmdfDriver.pkg.xml /version:%PKGVER% /build:fre /cpu:ARM /config:\"%AK_ROOT%\\Tools\\bin\\i386\\pkggen.cfg.xml\" /output:. /variables:\"HIVE_ROOT=%AK_ROOT%\\CoreSystem\"\n    ```\n\n## <span id=\"AddingTheVersion2\"></span><span id=\"addingtheversion2\"></span><span id=\"ADDINGTHEVERSION2\"></span>Add the version 2 driver to the OS\n\n\nUse the following steps to include the version 2 driver in the OS using IUTool and a production or test build:\n\n1.  Connect the device to the PC by using a USB cable.\n\n2.  Use IuTool to add the version 2 driver package to an existing image.\n\n    ``` syntax\n    IuTool -p OEMName.Phone.Test.BaseOS.XKmdfDriver.spkg\n    ```\n\n3.  Confirm that the IUTool was able to deploy the package to the device\n\n## <span id=\"ConfirmThatTheUpdatedDriver\"></span><span id=\"confirmthattheupdateddriver\"></span><span id=\"CONFIRMTHATTHEUPDATEDDRIVER\"></span>Confirm that the updated driver is active\n\n\nUse the following process to confirm that the updated driver is active.\n\n1.  Use the process described previously in [View the driver registry settings](#viewtheregistry) to load and view the system registry hive.\n\n2.  DriverPackages should have two INF registry key sets: one for the previously installed driver and the one for the updated driver.\n\n    ``` syntax\n    [SYSTEM\\DriverDatabase\\DriverPackages\\xkmdfdriver.inf_arm_6ec7dae5e1ab5fd5]\n    [SYSTEM\\DriverDatabase\\DriverPackages\\xkmdfdriver.inf_arm_c8e7ab79be6b088b]\n    ```\n\n3.  `Active` in XKmdfDriver.inf should point to the newer INF key:\n\n    ``` syntax\n    [SYSTEM\\DriverDatabase\\DriverInfFiles\\XKmdfDriver.inf]\n    \"Active\"=\"xkmdfdriver.inf_arm_6ec7dae5e1ab5fd5\"\n    ```\n\n4.  The driver still has the 120th rank under SYSTEM Class driver, but the date and version should be updated.\n\n    -   \"DriverDate\"=\"2-19-2013\"\n\n    -   \"DriverVersion\"=\"1.32.0.0\"\n\n    ``` syntax\n    [SYSTEM\\ControlSet001\\Control\\Class\\{4d36e97d-e325-11ce-bfc1-08002be10318}\\0120]\n    \"DriverDate\"=\"2-19-2013\"\n    \"DriverDateData\"=hex:00,c0,69,0f,34,0e,ce,01\n    \"DriverDesc\"=\"X KMDF Driver\"\n    \"DriverVersion\"=\"1.32.0.0\"\n    \"InfPath\"=\"XKmdfDriver.inf\"\n    \"InfSection\"=\"XKMDFDRIVER.NT\"\n    \"MatchingDeviceId\"=\"ROOT\\\\XKmdfDriver\"\n    \"ProviderName\"=\"Microsoft\"\n    ```\n\n5.  The newly added DWORD registry value DW123 should appear under the `Device Parameters` subkey.\n\n    ``` syntax\n    [SYSTEM\\ControlSet001\\Enum\\ROOT\\XKmdfDriver\\0000\\Device Parameters]\n    \"DWORD123\"=\"0x4567\"\n    ```\n\n6.  Use the process described earlier in [Close the tools and eject the phone](#closethetools) to safely disconnect the device\n\n## <span id=\"related_topics\"></span>Related topics\n\n\n[Update](index.md)\n\n \n\n \n\n\n\n\n\n\n"}
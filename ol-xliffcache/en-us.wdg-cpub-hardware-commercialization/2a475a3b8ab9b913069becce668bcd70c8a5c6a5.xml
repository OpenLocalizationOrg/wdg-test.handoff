{"nodes":[{"content":"Windows Secure Boot Key Creation and Management Guidance","pos":[34,90]},{"content":"Windows Secure Boot Key Creation and Management Guidance","pos":[197,253]},{"content":"Windows Secure Boot Key Creation and Management Guidance","pos":[261,317]},{"pos":[320,387],"content":"<bpt id=\"p1\">**</bpt>Vishal Manan, Architect, OEM Consulting<ept id=\"p1\">**</ept>, <bpt id=\"p2\">&lt;</bpt>vmanan@microsoft.com<ept id=\"p2\">&gt;</ept>"},{"pos":[389,462],"content":"<bpt id=\"p1\">**</bpt>Arie van der Hoeven, Architect, OEM Consulting<ept id=\"p1\">**</ept>, <bpt id=\"p2\">&lt;</bpt>ariev@microsoft.com<ept id=\"p2\">&gt;</ept>"},{"content":"This document helps guide OEMs and ODMs in creation and management of the Secure Boot keys and certificates in a manufacturing environment.","pos":[464,603]},{"content":"It addresses questions related to creation, storage and retrieval of Platform Keys (PKs), secure firmware update keys, and third party Key Exchange Keys (KEKs).","pos":[604,764]},{"content":"Windows requirements for UEFI and Secure Boot can be found in the <bpt id=\"p1\">[</bpt>Windows Hardware Certification Requirements<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=320504)</ept> and other documents made available through sources such as Windows Connect and MSDN.","pos":[766,1011]},{"content":"This paper does not introduce new requirements or represent an official Windows program.","pos":[1012,1100]},{"content":"It is intended as guidance beyond certification requirements, to assist in building efficient and secure processes for creating and managing Secure Boot Keys.","pos":[1101,1259]},{"content":"This is important because UEFI Secure Boot is based on the usage of Private Key Infrastructure to authenticate code before allowed to execute.","pos":[1260,1402]},{"pos":[1404,1610],"content":"The reader is expected to know the fundamentals of UEFI, basic understanding of Secure Boot (Chapter 27 of the <bpt id=\"p1\">[</bpt>UEFI specification<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?LinkID=220187)</ept>), and PKI security model."},{"content":"Requirements, tests, and tools validating Secure Boot on Windows are available today through the <bpt id=\"p1\">[</bpt>Windows Hardware Certification Kit (HCK)<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=254893)</ept>.","pos":[1612,1801]},{"content":"However, these HCK resources do not address creation and management of keys for Windows deployments.","pos":[1802,1902]},{"content":"This paper addresses key management as a resource to help guide partners through deployment of the keys used by the firmware.","pos":[1903,2028]},{"content":"It is not intended as prescriptive guidance and does not include any new requirements.","pos":[2029,2115]},{"content":"On this page:","pos":[2117,2130]},{"pos":[2136,2307],"content":"<bpt id=\"p1\">[</bpt>1. Secure Boot, Windows and Key Management<ept id=\"p1\">](#securebootkeymanagement)</ept> contains information on boot security and PKI architecture as it applies to Windows and Secure Boot."},{"pos":[2313,2463],"content":"<bpt id=\"p1\">[</bpt>2. Key Management Solutions<ept id=\"p1\">](#keymanagementsolutions)</ept> is intended to help partners design a key management and design solution that fits their needs."},{"pos":[2469,2578],"content":"<bpt id=\"p1\">[</bpt>3. Summary and Resources<ept id=\"p1\">](#summaryandresources)</ept> includes appendices, checklists, APIs, and other references."},{"content":"This document serves as a starting point in developing customer ready PCs, factory deployment tools and key security best practices.","pos":[2580,2712]},{"pos":[2843,2885],"content":"1. Secure Boot, Windows and Key Management"},{"content":"The UEFI (Unified Extensible Firmware Interface) specification defines a firmware execution authentication process called Secure Boot.","pos":[2888,3022]},{"content":"As an industry standard, Secure Boot defines how platform firmware manages certificates, authenticates firmware, and how the operating system interfaces with this process.","pos":[3023,3194]},{"content":"Secure Boot is based on the Public Key Infrastructure (PKI) process to authenticate modules before they are allowed to execute.","pos":[3196,3323]},{"content":"These modules can include firmware drivers, option ROMs, UEFI drivers on disk, UEFI applications, or UEFI boot loaders.","pos":[3324,3443]},{"content":"Through image authentication before execution, Secure Boot reduces the risk of pre-boot malware attacks such as rootkits.","pos":[3444,3565]},{"content":"Microsoft relies on UEFI Secure Boot in Windows 10, Windows 8.1 and Windows 8 as part of its Trusted Boot security architecture to improve platform security for our customers.","pos":[3566,3741]},{"content":"Secure Boot is required for Windows 10, Windows 8.1 and Windows 8 client PCs as defined in the Windows Hardware Certification Requirements.","pos":[3742,3881]},{"content":"The Secure Boot process works as follows and as shown in Figure 1:","pos":[3883,3949]},{"pos":[3955,4078],"content":"<bpt id=\"p1\">**</bpt>Firmware Boot Components:<ept id=\"p1\">**</ept> The firmware verifies the OS loader is trusted (Windows or another trusted operating system.)"},{"content":"Windows boot components: BootMgr, WinLoad, Windows Kernel Startup.","pos":[4086,4152]},{"content":"Windows boot components verify the signature on each component.","pos":[4155,4218]},{"content":"Any non-trusted components will not be loaded and instead will trigger Secure Boot remediation.","pos":[4219,4314]},{"pos":[4324,4543],"content":"<bpt id=\"p1\">**</bpt>Antivirus and Antimalware Software initialization:<ept id=\"p1\">**</ept> This software is checked for a special signature issued by Microsoft verifying that it is a trusted boot critical driver, and will launch early in the boot process."},{"pos":[4553,4697],"content":"<bpt id=\"p1\">**</bpt>Boot Critical Driver initialization:<ept id=\"p1\">**</ept> The signatures on all Boot-critical drivers are checked as part of Secure Boot verification in WinLoad."},{"content":"Additional OS Initialization","pos":[4705,4733]},{"content":"Windows Logon Screen","pos":[4743,4763]},{"content":"image of platform integrity architecture","pos":[4769,4809]},{"content":"Figure 1: Windows Trusted Boot Architecture","pos":[4874,4917]},{"content":"Implementation of UEFI Secure Boot is part of Microsoft’s Trusted Boot Architecture, introduced in Windows 8.1.","pos":[4920,5031]},{"content":"A growing trend in the evolution of malware exploits is targeting the boot path as a preferred attack vector.","pos":[5032,5141]},{"content":"This class of attack has been difficult to guard against, since antimalware products can be disabled by malicious software that prevents them from loading entirely.","pos":[5142,5306]},{"content":"With Windows Trusted Boot architecture and its establishment of a root of trust with Secure Boot, the customer is protected from malicious code executing in the boot path by ensuring that only signed, certified “known good” code and boot loaders can execute before the operating system itself loads.","pos":[5307,5606]},{"pos":[5822,5873],"content":"1.1 Public-Key Infrastructure (PKI) and Secure Boot"},{"content":"The PKI establishes authenticity and trust in a system.","pos":[5875,5930]},{"content":"Secure Boot leverages PKI for two high-level purposes:","pos":[5931,5985]},{"content":"During boot to determine if early boot modules are trusted for execution.","pos":[5991,6064]},{"content":"To authenticate requests to service requests include modification of Secure Boot databases and updates to platform firmware.","pos":[6070,6194]},{"content":"A PKI consists of:","pos":[6196,6214]},{"content":"A certificate authority (CA) that issues the digital certificates.","pos":[6220,6286]},{"content":"A registration authority which verifies the identity of users requesting a certificate from the CA.","pos":[6292,6391]},{"content":"A central directory in which to store and index keys.","pos":[6397,6450]},{"content":"A certificate management system.","pos":[6456,6488]},{"pos":[6632,6659],"content":"1.2 Public Key Cryptography"},{"content":"Public key cryptography uses a pair of mathematically related cryptographic keys, known as the public and private key.","pos":[6661,6779]},{"content":"If you know one of the keys, you cannot easily calculate what the other one is.","pos":[6780,6859]},{"content":"If one key is used to encrypt information, then only the corresponding key can decrypt that information.","pos":[6860,6964]},{"content":"For Secure Boot, the private key is used to digitally sign code and the public key is used to verify the signature on that code to prove its authenticity.","pos":[6965,7119]},{"content":"If a private key is compromised, then systems with corresponding public keys are no longer secure.","pos":[7120,7218]},{"content":"This can lead to boot kit attacks and will damage the reputation of the entity responsible for ensuring the security of the private key.","pos":[7219,7355]},{"content":"In a Secure Boot public key system you have the following:","pos":[7357,7415]},{"content":"1.2.1 RSA 2048 Encryption","pos":[7423,7448]},{"content":"RSA-2048 is an asymmetric cryptographic algorithm.","pos":[7456,7506]},{"content":"The space needed to store an RSA-2048 modulus in raw form is 2048 bits.","pos":[7507,7578]},{"content":"1.2.2 Self-signed certificate","pos":[7586,7615]},{"content":"A certificate signed by the private key that matches the public key of the certificate is known as a self-signed certificate.","pos":[7623,7748]},{"content":"Root certification authority (CA) certificates fall into this category.","pos":[7749,7820]},{"content":"1.2.3 Certification Authority","pos":[7828,7857]},{"content":"The certification authority (CA) issues signed certificates that affirm the identity of the certificate subject and bind that identity to the public key contained in the certificate.","pos":[7865,8047]},{"content":"The CA signs the certificate by using its private key.","pos":[8048,8102]},{"content":"It issues the corresponding public key to all interested parties in a self-signed root CA certificate.","pos":[8103,8205]},{"content":"In Secure Boot, Certification Authorities (CAs) include the OEM (or their delegates) and Microsoft.","pos":[8211,8310]},{"content":"The CAs generate the key pairs that form the root of trust and then use the private keys to sign legitimate operations such as allowed early boot EFI modules and firmware servicing requests.","pos":[8311,8501]},{"content":"The corresponding public keys are shipped embedded into the UEFI firmware on Secure Boot-enabled PCs and are used to verify these operations.","pos":[8502,8643]},{"content":"(More information on usage of CAs and key exchanges is readily available on the internet which relates to the Secure Boot model.)","pos":[8649,8778]},{"content":"1.2.4 Public Key","pos":[8786,8802]},{"content":"The public Platform Key ships on the PC and is accessible or “public”.","pos":[8810,8880]},{"content":"In this document we will use the suffix “pub” to denote public key.","pos":[8881,8948]},{"content":"For example, PKpub denotes the public half of the PK.","pos":[8949,9002]},{"content":"1.2.5 Private Key","pos":[9010,9027]},{"content":"For PKI to work the private key needs to be securely managed.","pos":[9035,9096]},{"content":"It should be accessible to a few highly trusted individuals in an organization and located in a physically secure location with strong access policy restrictions in place.","pos":[9097,9268]},{"content":"In this document we will use the suffix “priv” to denote private key.","pos":[9269,9338]},{"content":"For example, the PKpriv indicates private half of the PK.","pos":[9339,9396]},{"content":"1.2.6 Certificates","pos":[9404,9422]},{"content":"The primary use for digital certificates is to verify the origin of signed data, such as binaries etc. A common use of certificates is for internet message security using Transport Layer Security (TLS) or Secure Sockets Layer (SSL).","pos":[9430,9662]},{"content":"Verifying the signed data with a certificate lets the recipient know the origin of the data and if it has been altered in transit.","pos":[9663,9793]},{"content":"A digital certificate in general contains, at a high level, a distinguished name (DN), a public key, and a signature.","pos":[9799,9916]},{"content":"The DN identifies an entity -- a company, for example -- that holds the private key that matches the public key of the certificate.","pos":[9917,10048]},{"content":"Signing the certificate with a private key and placing the signature in the certificate ties the private key to the public key.","pos":[10049,10176]},{"content":"Certificates can contain some other types of data.","pos":[10182,10232]},{"content":"For example, an X.509 certificate includes the format of the certificate, the serial number of the certificate, the algorithm used to sign the certificate, the name of the CA that issued the certificate, the name and public key of the entity requesting the certificate, and the CA's signature.","pos":[10233,10526]},{"content":"1.2.7 Chaining certificates","pos":[10534,10561]},{"pos":[10569,10643],"content":"From: <bpt id=\"p1\">[</bpt>Certificate chains<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=321183)</ept>:"},{"content":"root ca is self-signed, others signed by root ca","pos":[10651,10699]},{"content":"Figure 2: Three-certificate chain","pos":[10758,10791]},{"content":"User certificates are often signed by a different private key, such as a private key of the CA.","pos":[10798,10893]},{"content":"This constitutes a two-certificate chain.","pos":[10894,10935]},{"content":"Verifying that a user certificate is genuine involves verifying its signature, which requires the public key of the CA, from its certificate.","pos":[10936,11077]},{"content":"But before the public key of the CA can be used, the enclosing CA certificate needs to be verified.","pos":[11078,11177]},{"content":"Because the CA certificate is self-signed, the CA public key is used to verify the certificate.","pos":[11178,11273]},{"content":"A user certificate need not be signed by the private key of the root CA.","pos":[11279,11351]},{"content":"It could be signed by the private key of an intermediary whose certificate is signed by the private key of the CA.","pos":[11352,11466]},{"content":"This is an instance of a three-certificate chain: user certificate, intermediary certificate, and CA certificate.","pos":[11467,11580]},{"content":"But more than one intermediary can be part of the chain, so certificate chains can be of any length.","pos":[11581,11681]},{"pos":[11840,11872],"content":"1.3 Secure Boot PKI requirements"},{"content":"The UEFI-defined root of trust consists of the Platform Key and any keys an OEM or ODM includes in the firmware core.","pos":[11874,11991]},{"content":"Pre-UEFI security and a root of trust are not addressed by the UEFI Secure Boot process, but instead by National Institute of Standards and Technology (NIST), and Trusted Computing Group (TCG) publications referenced in this paper.","pos":[11992,12223]},{"content":"1.3.1 Secure Boot requirements","pos":[12231,12261]},{"content":"You’ll need to consider the following parameters for implementing Secure Boot:","pos":[12269,12347]},{"content":"Customer requirements","pos":[12357,12378]},{"content":"Windows HCK requirements","pos":[12388,12412]},{"content":"Key generation and management requirements.","pos":[12422,12465]},{"content":"You would need to pick hardware for Secure Boot key management like Hardware Security Modules (HSMs), consider special requirements on PCs to ship to governments and other agencies and finally the process of creating, populating and managing the life cycle of various Secure Boot keys.","pos":[12471,12756]},{"content":"1.3.2 Secure Boot related keys","pos":[12764,12794]},{"content":"The keys used for Secure Boot are below:","pos":[12802,12842]},{"content":"pk, kek, db, dbx, and firmware key, winrt key","pos":[12850,12895]},{"content":"Figure 3: Keys related to Secure Boot","pos":[12940,12977]},{"content":"Figure 3 above represents the signatures and keys in a PC with Secure Boot.","pos":[12984,13059]},{"content":"The platform is secured through a platform key that the OEM installs in firmware during manufacturing.","pos":[13060,13162]},{"content":"Other keys are used by Secure Boot to protect access to databases that store keys to allow or disallow execution of firmware.","pos":[13163,13288]},{"content":"The authorized database (db) contains public keys and certificates that represent trusted firmware components and operating system loaders.","pos":[13294,13433]},{"content":"The forbidden signature database (dbx) contains hashes of malicious and vulnerable components as well as compromised keys and certificates and blocks execution of those malicious components.","pos":[13434,13624]},{"content":"The strength of these policies is based on signing firmware using Authenticode and Public Key Infrastructure (PKI).","pos":[13625,13740]},{"content":"PKI is a well-established process for creating, managing, and revoking certificates that establish trust during information exchange.","pos":[13741,13874]},{"content":"PKI is at the core of the security model for Secure Boot.","pos":[13875,13932]},{"content":"Below are more details on these keys.","pos":[13938,13975]},{"content":"1.3.3 Platform Key (PK)","pos":[13983,14006]},{"content":"As per section 27.5.1 of the UEFI 2.3.1 Errata C, the platform key establishes a trust relationship between the platform owner and the platform firmware.","pos":[14014,14167]},{"content":"The platform owner enrolls the public half of the key (PKpub) into the platform firmware as specified in <bpt id=\"p1\">**</bpt>Section 7.2.1 of the UEFI 2.3.1 Errata C<ept id=\"p1\">**</ept>. This step moves the platform into user mode from setup mode.","pos":[14168,14379]},{"content":"Microsoft recommends that the Platform Key be of type <bpt id=\"p1\">**</bpt>EFI<ph id=\"ph1\">\\_</ph>CERT<ph id=\"ph2\">\\_</ph>X509<ph id=\"ph3\">\\_</ph>GUID<ept id=\"p1\">**</ept> with public key algorithm RSA, public key length of 2048 bits, and signature algorithm sha256RSA.","pos":[14380,14557]},{"content":"The platform owner may use type <bpt id=\"p1\">**</bpt>EFI<ph id=\"ph1\">\\_</ph>CERT<ph id=\"ph2\">\\_</ph>RSA2048<ph id=\"ph3\">\\_</ph>GUID<ept id=\"p1\">**</ept> if storage space is a concern.","pos":[14558,14649]},{"content":"Public keys are used to check signatures as described earlier in this document.","pos":[14650,14729]},{"content":"The platform owner can later use the private half of the key (PKpriv):","pos":[14730,14800]},{"content":"To change platform ownership you must put the firmware into UEFI defined <bpt id=\"p1\">**</bpt>setup mode<ept id=\"p1\">**</ept> which disables Secure Boot.","pos":[14810,14925]},{"content":"We recommend reverting to setup mode only if there is a need to do this during manufacturing.","pos":[14926,15019]},{"content":"1.3.3.1 To enroll or update a Key Exchange Key (KEK) Enrolling the Platform Key","pos":[15027,15106]},{"content":"The platform owner enrolls the public half of the Platform Key (<bpt id=\"p1\">**</bpt>PKpub<ept id=\"p1\">**</ept>) by calling the UEFI Boot Service SetVariable() as specified in Section 7.2.1 and resetting the platform.","pos":[15114,15293]},{"content":"If the platform is in setup mode, then the new <bpt id=\"p1\">**</bpt>PKpub<ept id=\"p1\">**</ept> shall be signed with its <bpt id=\"p2\">**</bpt>PKpriv<ept id=\"p2\">**</ept> counterpart.","pos":[15294,15399]},{"content":"If the platform is in user mode, then the new <bpt id=\"p1\">**</bpt>PKpub<ept id=\"p1\">**</ept> must be signed with the current <bpt id=\"p2\">**</bpt>PKpriv<ept id=\"p2\">**</ept>.","pos":[15400,15499]},{"content":"If the PK is of type <bpt id=\"p1\">**</bpt>EFI<ph id=\"ph1\">\\_</ph>CERT<ph id=\"ph2\">\\_</ph>X509<ph id=\"ph3\">\\_</ph>GUID<ept id=\"p1\">**</ept>, then this must be signed by the immediate <bpt id=\"p2\">**</bpt>PKpriv<ept id=\"p2\">**</ept>, not a private key of any certificate issued under the PK.","pos":[15500,15659]},{"content":"1.3.3.2 Clearing the Platform Key","pos":[15667,15700]},{"content":"The platform owner clears the public half of the Platform Key (<bpt id=\"p1\">**</bpt>PKpub<ept id=\"p1\">**</ept>) by calling the UEFI Boot Ser¬vice SetVariable() with a variable size of 0 and resetting the platform.","pos":[15708,15883]},{"content":"If the platform is in setup mode, then the empty variable does not need to be authenticated.","pos":[15884,15976]},{"content":"If the platform is in user mode, then the empty variable must be signed with the current <bpt id=\"p1\">**</bpt>PKpriv<ept id=\"p1\">**</ept>; see Section 7.2(Variable Services) under <bpt id=\"p2\">[</bpt>UEFI specification<ept id=\"p2\">](http://go.microsoft.com/fwlink/p/?LinkID=220187)</ept> 2.3.1 Errata C for details.","pos":[15977,16216]},{"content":"It is strongly recommended that the production PKpriv never be used to sign a package to reset the platform since this allows Secure Boot to be disabled.","pos":[16217,16370]},{"content":"This is primarily a pre-production test scenario.","pos":[16371,16420]},{"content":"The platform key may also be cleared using a secure platform-specific method.","pos":[16426,16503]},{"content":"In this case, the global variable Setup Mode must also be updated to 1.","pos":[16504,16575]},{"content":"image: pk determines setup mode or user mode","pos":[16583,16627]},{"content":"Figure 4: Platform Key State diagram","pos":[16672,16708]},{"content":"1.3.3.3 PK generation","pos":[16717,16738]},{"content":"As per UEFI recommendations, the public key must be stored in non-volatile storage which is tamper and delete resistant on the PC.","pos":[16746,16876]},{"content":"The Private keys stay secure at Partner or in the OEM’s Security Office and only the public key is loaded onto the platform.","pos":[16877,17001]},{"content":"There are more details under section 2.2.1 and 2.3.","pos":[17002,17053]},{"content":"The number of PK generated is at the discretion of the Platform owner (OEM).","pos":[17059,17135]},{"content":"These keys could be:","pos":[17136,17156]},{"content":"<bpt id=\"p1\">**</bpt>One per PC<ept id=\"p1\">**</ept>.","pos":[17166,17181]},{"content":"This may be required for government agencies, financial institutions, or other customers with high-security needs.","pos":[17182,17296]},{"content":"It may require additional storage and crypto processing power to generate private and public keys for large numbers of PCs.","pos":[17297,17420]},{"content":"There are a few different HSM solutions available to manage large number of keys based on the HSM vendor.","pos":[17421,17526]},{"content":"For more info, see <bpt id=\"p1\">[</bpt>Secure Boot Key Generation Using HSM<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=321184)</ept>.","pos":[17527,17632]},{"content":"<bpt id=\"p1\">**</bpt>One per model<ept id=\"p1\">**</ept>.","pos":[17642,17660]},{"content":"The tradeoff here is that if a key is compromised all the machines within the same model would be vulnerable.","pos":[17661,17770]},{"content":"<bpt id=\"p1\">**</bpt>One per product line<ept id=\"p1\">**</ept>.","pos":[17780,17805]},{"content":"If a key is compromised a whole product line would be vulnerable.","pos":[17806,17871]},{"content":"<bpt id=\"p1\">**</bpt>One per OEM<ept id=\"p1\">**</ept>.","pos":[17881,17897]},{"content":"While this may be the simplest to set up, if the key is compromised, every PC you manufacture would be vulnerable.","pos":[17898,18012]},{"content":"To speed up operation on the factory floor, the PK and potentially other keys could be pre-generated and stored in a safe location.","pos":[18013,18144]},{"content":"These could be later retrieved and used in the assembly line.","pos":[18145,18206]},{"content":"Chapters 2 and 3 have more details.","pos":[18207,18242]},{"content":"1.3.3.4 Rekeying the PK","pos":[18250,18273]},{"content":"This may be needed if the PK gets compromised or as a requirement by a customer that for security reasons may decide to enroll their own PK.","pos":[18281,18421]},{"content":"Rekeying could be done either for a model or PC based on what method was selected to create PK.","pos":[18427,18522]},{"content":"All the newer PCs will get signed with the newly created PK.","pos":[18523,18583]},{"content":"Updating the PK on a production PC would require either a variable update signed with the existing PK that replaces the PK or a firmware update package.","pos":[18589,18741]},{"content":"An OEM could also create a SetVariable() package and distribute that with a simple application such as PowerShell that just changes the PK.","pos":[18742,18881]},{"content":"The firmware update package would be signed by the secure firmware update key and verified by firmware.","pos":[18882,18985]},{"content":"If doing a firmware update to update the PK, care should be taken to ensure the KEK, db, and dbx are preserved.","pos":[18986,19097]},{"content":"On all PCs, it is recommended to not use the PK as the secure firmware update key.","pos":[19103,19185]},{"content":"If the PKpriv is compromised then so is the secure firmware update key (since they are the same).","pos":[19186,19283]},{"content":"In this case the update to enroll a new PKpub might not be possible since the process of updating has also been compromised.","pos":[19284,19408]},{"content":"On SOCs PCs, there is another reason to not use the PK as the secure firmware update key.","pos":[19414,19503]},{"content":"This is because the secure firmware update key is permanently burnt into fuses on PCs that meet Windows Hardware Certification requirements.","pos":[19504,19644]},{"content":"<bpt id=\"p1\">**</bpt>1.3.4 Key Exchange Key (KEK)<ept id=\"p1\">**</ept>Key exchange keys establish a trust relationship between the operating system and the platform firmware.","pos":[19650,19786]},{"content":"Each operating system (and potentially, each 3rd party application which need to communicate with platform firmware) enrolls a public key (<bpt id=\"p1\">**</bpt>KEKpub<ept id=\"p1\">**</ept>) into the platform firmware.","pos":[19787,19965]},{"content":"1.3.4.1 Enrolling Key Exchange Keys","pos":[19973,20008]},{"content":"Key exchange keys are stored in a signature database as described in <bpt id=\"p1\">[</bpt>1.4 Signature Databases (Db and Dbx)<ept id=\"p1\">](#signaturedatabase)</ept>.","pos":[20016,20144]},{"content":"The signature database is stored as an authenticated UEFI variable.","pos":[20145,20212]},{"pos":[20218,20886],"content":"The platform owner enrolls the key exchange keys by either calling SetVariable() as specified in Section 7.2(Variable Services) under <bpt id=\"p1\">[</bpt>UEFI specification<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?LinkID=220187)</ept> 2.3.1 Errata C. with the EFI<ph id=\"ph1\">\\_</ph>VARIABLE<ph id=\"ph2\">\\_</ph>APPEND<ph id=\"ph3\">\\_</ph>WRITE attribute set and the Data parameter containing the new key(s), or by reading the database using GetVariable(), appending the new key exchange key to the existing keys and then writing the database using SetVariable()as specified in Section 7.2(Variable Services) under <bpt id=\"p2\">[</bpt>UEFI specification<ept id=\"p2\">](http://go.microsoft.com/fwlink/p/?LinkID=220187)</ept> 2.3.1 Errata C without the EFI<ph id=\"ph4\">\\_</ph>VARIABLE<ph id=\"ph5\">\\_</ph>APPEND<ph id=\"ph6\">\\_</ph>WRITE attribute set."},{"content":"If the platform is in setup mode, the signature database variable does not need to be signed but the parameters to the SetVariable() call shall still be prepared as specified for authenticated variables in Section 7.2.1.","pos":[20892,21112]},{"content":"If the platform is in user mode, the signature database must be signed with the current PKpriv","pos":[21113,21207]},{"content":"1.3.4.2 Clearing the KEK","pos":[21215,21239]},{"content":"It is possible to “clear” (delete) the KEK.","pos":[21247,21290]},{"content":"Note that if the PK is not installed on the platform, “clear” requests are not required to be signed.","pos":[21291,21392]},{"content":"If they are signed, then to clear the KEK requires a PK-signed package, and to clear either db or dbx requires a package signed by any entity present in the KEK.","pos":[21393,21554]},{"content":"1.3.4.3 Microsoft KEK","pos":[21562,21583]},{"content":"The Microsoft KEK is required to enable revocation of bad images by updating the dbx and potentially for updating db to prepare for newer Windows signed images.","pos":[21591,21751]},{"content":"Include the Microsoft Corporation KEK CA 2011 in the KEK database, with the following values:","pos":[21757,21850]},{"pos":[21860,21939],"content":"SHA-1 cert hash: <ph id=\"ph1\">`31 59 0b fd 89 c9 d7 4e d0 87 df ac 66 33 4b 39 31 25 4b 30`</ph>."},{"pos":[21949,22011],"content":"SignatureOwner GUID: <ph id=\"ph1\">`{77fa9abd-0359-4d32-bd60-28f4e78f784b}`</ph>."},{"pos":[22021,22181],"content":"Microsoft will provide the certificate to partners and it can be added either as an <bpt id=\"p1\">**</bpt>EFI<ph id=\"ph1\">\\_</ph>CERT<ph id=\"ph2\">\\_</ph>X509<ph id=\"ph3\">\\_</ph>GUID<ept id=\"p1\">**</ept> or an <bpt id=\"p2\">**</bpt>EFI<ph id=\"ph4\">\\_</ph>CERT<ph id=\"ph5\">\\_</ph>RSA2048<ph id=\"ph6\">\\_</ph>GUID<ept id=\"p2\">**</ept> type signature."},{"pos":[22187,22289],"content":"The Microsoft KEK certificate can be downloaded from: <bpt id=\"p1\">&lt;</bpt>http://go.microsoft.com/fwlink/?LinkId=321185<ept id=\"p1\">&gt;</ept>."},{"content":"<bpt id=\"p1\">**</bpt>1.3.4.4 KEKDefault<ept id=\"p1\">**</ept> The platform vendor may provide a default set of Key Exchange Keys in the KEKDefault variable.","pos":[22295,22412]},{"content":"Please reference <bpt id=\"p1\">[</bpt>UEFI specification<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?LinkID=220187)</ept> section 27.3.3 for more information.","pos":[22413,22536]},{"content":"1.3.4.5 OEM/3rd party KEK on non-Windows RT PCs","pos":[22544,22591]},{"content":"Partners don’t need to have their own KEK.","pos":[22599,22641]},{"content":"On non-Windows RT PCs the OEM may have additional KEKs to allow additional OEM or a trusted 3rd party control of the db and dbx.","pos":[22642,22770]},{"content":"In that case you will need to store the private half of the KEK in a safe storage location.","pos":[22776,22867]},{"content":"The public half will be on the PC in UEFI defined KEK database.","pos":[22868,22931]},{"content":"As per UEFI recommendations, the public key must be stored in non-volatile storage which is tamper and delete resistant on the PC.","pos":[22932,23062]},{"content":"<bpt id=\"p1\">**</bpt>1.3.5 Secure Boot firmware update key<ept id=\"p1\">**</ept>The Secure firmware update key is used to sign the firmware when it needs to be updated.","pos":[23068,23197]},{"content":"This key has to have a minimum key strength of RSA-2048.","pos":[23198,23254]},{"content":"All firmware updates must be signed securely by the OEM, their trusted delegate such as the ODM or IBV (Independent BIOS Vendor), or by a secure signing service.","pos":[23255,23416]},{"pos":[23422,23565],"content":"As per <bpt id=\"p1\">[</bpt>NIST publication 800-147 Field Firmware Update<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=321186)</ept> must support all elements of guidelines:"},{"content":"Any update to the firmware flash store must be signed by creator.","pos":[23571,23636]},{"content":"Firmware must check signature of the update.","pos":[23642,23686]},{"content":"1.3.6 Creation of keys for Secure Firmware Update","pos":[23694,23743]},{"content":"The same key will be used to sign all firmware updates since the public half will be residing on the PC.","pos":[23751,23855]},{"content":"You could also sign the firmware update with a key which chains to Secure Firmware update key.","pos":[23856,23950]},{"content":"There could be one key per PC like PK or one per model or one per product line.","pos":[23956,24035]},{"content":"If there is one key per PC that would mean that millions of unique update packages will need to be generated.","pos":[24036,24145]},{"content":"Please consider based on resource availability what method would work for you.","pos":[24146,24224]},{"content":"Having a key per model or product line is a good compromise.","pos":[24225,24285]},{"content":"The Secure Firmware Update public key (or its hash to save space) would be stored in some protected storage on the platform – generally protected flash (PC) or one-time-programmable fuses (SOC).","pos":[24291,24485]},{"content":"If only the hash of this key is stored (to save space), then the firmware update will include the key, and the first stage of the update process will be verifying that the public key in the update matches the hash stored on the platform.","pos":[24491,24728]},{"content":"Capsules are a means by which the OS can pass data to UEFI environment across a reboot.","pos":[24734,24821]},{"content":"Windows calls the UEFI UpdateCapsule() to deliver system and PC firmware updates.","pos":[24822,24903]},{"content":"At boot time prior to calling ExitBootServices(),Windows will pass in any new firmware updates found in the Windows Driver Store into UpdateCapsule().","pos":[24904,25054]},{"content":"UEFI system firmware can use this process to update system and PC firmware.","pos":[25055,25130]},{"content":"By leveraging this Windows firmware support an OEM can rely on the same common format and process for updating firmware for both system and PC firmware.","pos":[25131,25283]},{"content":"Firmware must implement the ACPI ESRT table in order to support UEFI UpdateCapsule() for Windows.","pos":[25284,25381]},{"content":"For details on implementing support for the Windows UEFI Firmware Update Platform consult the following documentation: Windows UEFI Firmware Update Platform.","pos":[25387,25544]},{"content":"Update capsules can be in memory or on the disk.","pos":[25550,25598]},{"content":"Windows supports in memory updates.","pos":[25599,25634]},{"content":"1.3.6.1 Capsule (Capsule-in-Memory)","pos":[25642,25677]},{"content":"Following is the flow of events for an In-memory update capsule to work.","pos":[25685,25757]},{"content":"A capsule is put in memory by an application in the OS","pos":[25767,25821]},{"content":"Mailbox event is set to inform BIOS of pending update","pos":[25831,25884]},{"content":"PC reboots, verifies the capsule image and update is performed by the BIOS","pos":[25894,25968]},{"content":"1.3.7 Workflow of a typical firmware update","pos":[25976,26019]},{"content":"Download and install the firmware driver.","pos":[26031,26072]},{"content":"Reboot.","pos":[26082,26089]},{"content":"OS Loader detects and verifies the firmware.","pos":[26099,26143]},{"content":"OS Loader passes a binary blob to UEFI.","pos":[26153,26192]},{"content":"UEFI performs the firmware update (This process is owned by the silicon vendor).","pos":[26202,26282]},{"content":"OS Loader detection completes successfully.","pos":[26292,26335]},{"content":"OS finishes booting.","pos":[26345,26365]},{"pos":[26479,26515],"content":"1.4 Signature Databases (Db and Dbx)"},{"content":"1.4.1 Allowed Signature database (db)","pos":[26523,26560]},{"content":"The contents of the EFI <ph id=\"ph1\">\\_</ph>IMAGE<ph id=\"ph2\">\\_</ph>SECURITY<ph id=\"ph3\">\\_</ph>DATABASE db control what images are trusted when verifying loaded images.","pos":[26568,26684]},{"content":"The database may contain multiple certificates, keys, and hashes in order to identify allowed images.","pos":[26685,26786]},{"content":"The <bpt id=\"p1\">**</bpt>Microsoft Windows Production PCA 2011<ept id=\"p1\">**</ept> with a SHA-1 Cert Hash of <ph id=\"ph1\">`58 0a 6f 4c c4 e4 b6 69 b9 eb dc 1b 2b 3e 08 7b 80 d0 67 8d`</ph> must be included in db in order to allow the Windows OS Loader to load.","pos":[26792,26997]},{"content":"The Windows CA can be downloaded from here: <bpt id=\"p1\">&lt;</bpt>http://go.microsoft.com/fwlink/p/?linkid=321192<ept id=\"p1\">&gt;</ept>.","pos":[26998,27092]},{"content":"On non-Windows RT PCs the OEM should consider including the <bpt id=\"p1\">**</bpt>Microsoft Corporation UEFI CA 2011<ept id=\"p1\">**</ept> with a SHA-1 Certificate Hash of <ph id=\"ph1\">`46 de f6 3b 5c e6 1c f8 ba 0d e2 e6 63 9c 10 19 d0 ed 14 f3`</ph>.","pos":[27098,27292]},{"content":"Signing UEFI drivers and applications with this certificate will allow UEFI drivers and applications from 3rd parties to run on the PC without requiring additional steps for the user.","pos":[27293,27476]},{"content":"The UEFI CA can be downloaded from here: <bpt id=\"p1\">&lt;</bpt>http://go.microsoft.com/fwlink/p/?linkid=321194<ept id=\"p1\">&gt;</ept>.","pos":[27477,27568]},{"content":"On non-Windows RT PCs the OEM may also have additional items in the db to allow other operating systems or OEM-approved UEFI drivers or apps, but these images must not compromise the security of the PC in any way.","pos":[27574,27787]},{"content":"<bpt id=\"p1\">**</bpt>1.4.2 DbDefault<ept id=\"p1\">**</ept>: The platform vendor may provide a default set of entries for the Signature Database in the dbDefault variable.","pos":[27793,27924]},{"content":"For more information see section 27.5.3 in the UEFI specification.","pos":[27925,27991]},{"content":"1.4.3 Forbidden Signature Database (dbx)","pos":[27999,28039]},{"content":"The contents of <bpt id=\"p1\">**</bpt>EFI<ph id=\"ph1\">\\_</ph>IMAGE<ph id=\"ph2\">\\_</ph>SIGNATURE<ph id=\"ph3\">\\_</ph>DATABASE1<ept id=\"p1\">**</ept> dbx must be checked when verifying images before checking db and any matches must prevent the image from executing.","pos":[28047,28215]},{"content":"The database may contain multiple certificates, keys, and hashes in order to identify forbidden images.","pos":[28216,28319]},{"content":"The Windows Hardware Certification Requirements state that a dbx must be present, so any dummy value, such as the SHA-256 hash of <ph id=\"ph1\">`0`</ph>, may be used as a safe placeholder until such time as Microsoft begins delivering dbx updates.","pos":[28320,28548]},{"content":"<bpt id=\"p1\">**</bpt>1.4.4 DbxDefault<ept id=\"p1\">**</ept>: The platform vendor may provide a default set of entries for the Signature Database in the dbxDefault variable.","pos":[28554,28687]},{"content":"For more information see section 27.5.3 in the UEFI specification.","pos":[28688,28754]},{"pos":[28949,28993],"content":"1.5 Keys Required for Secure Boot on all PCs"},{"content":"Key/db Name","pos":[29151,29162]},{"content":"Variable","pos":[29185,29193]},{"content":"Owner","pos":[29216,29221]},{"content":"Notes","pos":[29244,29249]},{"content":"PKpub","pos":[29315,29320]},{"content":"PK","pos":[29350,29352]},{"content":"OEM","pos":[29382,29385]},{"content":"PK – 1 only.","pos":[29415,29427]},{"content":"Must be RSA 2048 or stronger.","pos":[29428,29457]},{"content":"Microsoft Corporation KEK CA 2011","pos":[29511,29544]},{"content":"KEK","pos":[29574,29577]},{"content":"Microsoft","pos":[29607,29616]},{"content":"Allows updates to db and dbx:","pos":[29646,29675]},{"content":"<bpt id=\"p1\">[</bpt>http://go.microsoft.com/fwlink/p/?linkid=321185<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=321185)</ept>.","pos":[29683,29782]},{"content":"Microsoft Windows Production CA 2011","pos":[29835,29871]},{"content":"db","pos":[29901,29903]},{"content":"Microsoft","pos":[29933,29942]},{"content":"This CA in the Signature Database (db) allows Windows to boot: <bpt id=\"p1\">[</bpt>http://go.microsoft.com/fwlink/?LinkId=321192<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=321192)</ept>.","pos":[29972,30130]},{"content":"Forbidden Signature Database","pos":[30184,30212]},{"content":"dbx","pos":[30242,30245]},{"content":"Microsoft","pos":[30275,30284]},{"content":"List of known bad Keys, CAs or images from Microsoft","pos":[30314,30366]},{"content":"Secure firmware update key","pos":[30419,30445]},{"content":"OEM","pos":[30505,30508]},{"content":"Recommendation is to have this key be different from PK","pos":[30538,30593]},{"content":"Table 1: Keys/db needed for Secure Boot","pos":[30632,30671]},{"content":"1.5.1 Key recommended for non-Windows RT PCs","pos":[30680,30724]},{"pos":[30732,31496],"content":"<table>\n<colgroup>\n<col width=\"25%\" />\n<col width=\"25%\" />\n<col width=\"25%\" />\n<col width=\"25%\" />\n</colgroup>\n<thead>\n<tr class=\"header\">\n<th align=\"left\">Key/db Name</th>\n<th align=\"left\">Variable</th>\n<th align=\"left\">Owner</th>\n<th align=\"left\">Notes</th>\n</tr>\n</thead>\n<tbody>\n<tr class=\"odd\">\n<td align=\"left\"><p>Microsoft UEFI driver signing CA</p></td>\n<td align=\"left\"><p>db</p></td>\n<td align=\"left\"><p>Microsoft</p></td>\n<td align=\"left\"><p>Microsoft signer for 3rd party UEFI drivers and Apps signed through the DevCenter program: [http://go.microsoft.com/fwlink/?LinkId=321194](http://go.microsoft.com/fwlink/?LinkId=321194).</p></td>\n</tr>\n</tbody>\n</table>","leadings":["","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    ","    "],"nodes":[{"content":"Key/db Name","pos":[156,167]},{"content":"Variable","pos":[190,198]},{"content":"Owner","pos":[221,226]},{"content":"Notes","pos":[249,254]},{"content":"Microsoft UEFI driver signing CA","pos":[320,352]},{"content":"db","pos":[382,384]},{"content":"Microsoft","pos":[414,423]},{"content":"Microsoft signer for 3rd party UEFI drivers and Apps signed through the DevCenter program: <bpt id=\"p1\">[</bpt>http://go.microsoft.com/fwlink/?LinkId=321194<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=321194)</ept>.","pos":[453,639]}]},{"content":"Table 2: Non-Windows RT Secure Boot keys","pos":[31510,31550]},{"content":"1.5.2 Secure Boot PKI workflow","pos":[31559,31589]},{"content":"Generating a key:","pos":[31597,31614]},{"content":"Create keys: PK, Secure firmware update key, and other keys as needed.","pos":[31624,31694]},{"content":"Create a backup of the PK, in case you need to rekey the PC, or if the original is lost.","pos":[31704,31792]},{"content":"Install the MS KEK, db, and empty dbx (unless otherwise specified) using PowerShell scripts and/or BIOS vendor firmware methods.","pos":[31802,31930]},{"content":"Update the firmware with pre-generated SecureFirmwareUpdateKey-public or hash (to save space).","pos":[31940,32034]},{"content":"Sign and install UEFI variable PK using PowerShell scripts and/or BIOS vendor firmware.","pos":[32044,32131]},{"content":"Run tests, including Windows HCK Secure Boot tests.","pos":[32141,32192]},{"content":"For example, use <bpt id=\"p1\">[</bpt>ChipSec<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=398265)</ept> to analyze the security of the platform components.","pos":[32193,32318]},{"pos":[32328,32567],"content":"Verify the state of Secure Boot variables by using PowerShell SecureBoot cmdlets, for example: <bpt id=\"p1\">[</bpt>Confirm-SecureBootUEFI<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=398260)</ept> and <bpt id=\"p2\">[</bpt>Get-SecureBootUEFI<ept id=\"p2\">](http://go.microsoft.com/fwlink/?LinkId=398261)</ept>."},{"pos":[32695,32722],"content":"2. Key Management Solutions"},{"content":"Below are given some of the metrics we used for comparison.","pos":[32725,32784]},{"pos":[32895,32911],"content":"2.1 Metrics used"},{"pos":[32913,33093],"content":"The following metrics can help you select a HSM PC based on the requirements of <bpt id=\"p1\">[</bpt>UEFI specification<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?LinkID=220187)</ept> 2.3.1 Errata C and your needs."},{"content":"Public Key Infrastructure (PKI) related","pos":[33097,33136]},{"content":"Does it support RSA 2048 or higher?","pos":[33144,33179]},{"content":"- The <bpt id=\"p1\">[</bpt>UEFI specification<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?LinkID=220187)</ept> 2.3.1 Errata C recommends the keys to be RSA-2048 or better.","pos":[33180,33316]},{"content":"Does it have the ability to generate keys and sign?","pos":[33322,33373]},{"content":"How many keys can it store?","pos":[33379,33406]},{"content":"Does it store keys on HSM or an attached server?","pos":[33407,33455]},{"content":"Authentication method for key retrieval.","pos":[33461,33501]},{"content":"Some PCs support multiple authentication entities to be present for key retrieval.","pos":[33507,33589]},{"content":"Pricing","pos":[33593,33600]},{"content":"What is the price point?","pos":[33608,33632]},{"content":"HSMs can range in price from $1,500 to $70,000 depending on available features.","pos":[33633,33712]},{"content":"Manufacturing environment","pos":[33716,33741]},{"content":"Speed of operation on factory floor.","pos":[33749,33785]},{"content":"Crypto processors can speed up key creation and access.","pos":[33786,33841]},{"content":"Ease of setup, deployment, maintenance.","pos":[33847,33886]},{"content":"Skillset and training required?","pos":[33892,33923]},{"content":"Network access for backup and High Availability","pos":[33929,33976]},{"content":"Standards and Compliance","pos":[33980,34004]},{"content":"What level of FIPS compliance does it have?","pos":[34012,34055]},{"content":"Is it tamper resistant?","pos":[34056,34079]},{"content":"Support for other standards, for example, MS crypto APIs.","pos":[34085,34142]},{"content":"Does it meet government and other agency requirements?","pos":[34148,34202]},{"content":"Reliability and disaster recovery","pos":[34206,34239]},{"content":"Does it allow for Key Backup?","pos":[34247,34276]},{"content":"Backups can be stored both onsite in a safe location that is a different physical location than the CA computer and HSM and /or at an offsite location.","pos":[34282,34433]},{"content":"Does it allow for High Availability for disaster recovery?","pos":[34439,34497]},{"pos":[34638,34664],"content":"2.2 Key Management Options"},{"content":"2.2.1 Hardware Security Module (HSM)","pos":[34672,34708]},{"content":"Based on the above criteria this is probably the most suitable and secure solution.","pos":[34716,34799]},{"content":"Most HSM have FIPS 140-2 level 3 compliance.","pos":[34800,34844]},{"content":"FIPS 140-2 level 3 compliance is strict on authentication and requires that keys are not exported or imported from the HSM.","pos":[34845,34968]},{"content":"They support multiple ways of key storage.","pos":[34974,35016]},{"content":"They could be stored either locally on the HSM itself or on the server attached to the HSM.","pos":[35017,35108]},{"content":"On the server the keys are encrypted and stored and is preferable for solutions which requires lots of keys to be stored.","pos":[35109,35230]},{"content":"The cryptographic module security policy shall specify a physical security policy, including physical security mechanisms that are implemented in a cryptographic module such as, tamper-evident seals, locks, tamper response and zeroization switches, and alarms.","pos":[35236,35496]},{"content":"It also allows specifying actions required by the operator(s) to ensure that physical security is maintained such as periodic inspection of tamper-evident seals or testing of tamper response and zeroization switches.","pos":[35497,35713]},{"content":"2.2.1.1 Network HSM","pos":[35721,35740]},{"content":"This solution is the best in its class in terms of security, adherence to standards, key generation, storage and retrieval.","pos":[35748,35871]},{"content":"Most of these PCs support high availability and have ability to backup keys.","pos":[35872,35948]},{"content":"The costs of these products can be in tens of thousands of dollars based on the extra services they offer.","pos":[35954,36060]},{"content":"2.2.1.2 Standalone HSM","pos":[36068,36090]},{"content":"These work great with standalone servers.","pos":[36098,36139]},{"content":"One can use Microsoft CAPI and CNG or any other secure API supported by HSM.","pos":[36140,36216]},{"content":"These HSMs come in variety of form factors supporting USB, PCIe and PCMCIA buses.","pos":[36217,36298]},{"content":"They optionally support key backup and high availability.","pos":[36304,36361]},{"content":"2.2.2 Custom solutions providers","pos":[36369,36401]},{"content":"Public Key cryptography can be challenging and require understanding of cryptographic concepts which maybe new.","pos":[36409,36520]},{"content":"There are custom solution providers who could help with the getting Secure Boot to work in the manufacturing environment.","pos":[36521,36642]},{"content":"There are varieties of custom solutions offered by BIOS vendors, HSM companies and PKI consulting companies to get Secure Boot PKI working in the manufacturing environment.","pos":[36648,36820]},{"content":"Some of the providers are listed below:","pos":[36826,36865]},{"content":"2.2.2.1 BIOS vendors","pos":[36873,36893]},{"content":"There are some BIOS vendors which may be able to provide custom solutions.","pos":[36901,36975]},{"content":"2.2.2.2 HSM vendors","pos":[36983,37002]},{"content":"Some HSM vendors may be able to provide custom consulting.","pos":[37010,37068]},{"content":"For more info, see <bpt id=\"p1\">[</bpt>Secure Boot Key Generation and Signing Using HSM (Example)<ept id=\"p1\">](secure-boot-key-generation-and-signing-using-hsm--example.md)</ept>.","pos":[37069,37211]},{"content":"2.2.3 Trusted Platform Module (TPM)","pos":[37219,37254]},{"content":"A Trusted Platform Module (TPM) is a hardware chip on the motherboard that stores cryptographic keys used for encryption.","pos":[37262,37383]},{"content":"Many computers include a TPM, but if the PC doesn’t include it, it is not feasible to add one.","pos":[37384,37478]},{"content":"Once enabled, the Trusted Platform Module can help secure full disk encryption products such as Microsoft BitLocker capabilities.","pos":[37479,37608]},{"content":"It keeps hard drives locked, or sealed, until the PC completes a system verification or authentication process.","pos":[37609,37720]},{"content":"The TPM can generate, store, and protect keys used in the encryption and decryption process.","pos":[37726,37818]},{"content":"The drawbacks of TPMs are that it may not have fast crypto processors to speed up processing in the manufacturing environment.","pos":[37824,37950]},{"content":"They also are not suitable for storing large number of keys.","pos":[37951,38011]},{"content":"Backup and high availability and standards compliance to FIPS 140-2 level 3 may not be available.","pos":[38012,38109]},{"content":"2.2.4 Smart Cards","pos":[38117,38134]},{"content":"A smart card can generate and store keys.","pos":[38142,38183]},{"content":"They do share some features which HSM support like authentication and tamper proofing, but they don’t include much key storage or backup.","pos":[38184,38321]},{"content":"They require manual intervention and may not be suitable for automation and use in production environment as the performance maybe low.","pos":[38322,38457]},{"content":"The drawbacks of Smart cards are similar to TPMs.","pos":[38463,38512]},{"content":"They may not have fast crypto processors to speed up processing in the manufacturing environment.","pos":[38513,38610]},{"content":"They also are not suitable for storing large number of keys.","pos":[38611,38671]},{"content":"Backup and high availability and standards compliance to FIPS 140-2 level 3 may not be available.","pos":[38672,38769]},{"content":"2.2.5 Software-centric approaches (NOT RECOMMENDED)","pos":[38777,38828]},{"content":"Use crypto APIs for key management.","pos":[38836,38871]},{"content":"This may involve storing a key in a key container on an encrypted hard drive and possible for additional sandboxing and security use a Virtual machine.","pos":[38872,39023]},{"content":"These solutions are not as secure as using an HSM and expose a higher attack vector.","pos":[39029,39113]},{"content":"2.2.5.1 Makecert (NOT RECOMMENDED)","pos":[39121,39155]},{"content":"Makecert is a Microsoft tool and can be used as follows for key generation.","pos":[39163,39238]},{"content":"To make sure that the attack surface is minimized you may need to “air gap” the PC.","pos":[39239,39322]},{"content":"The PC that has the PKpriv on should not be connected to the network.","pos":[39323,39392]},{"content":"It should be in a secure location and ideally should at least use a smart card reader if not a real HSM.","pos":[39393,39497]},{"pos":[39601,39712],"content":"For more info, see <bpt id=\"p1\">[</bpt>Certificate Creation Tool (Makecert.exe)<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=211849)</ept>."},{"content":"This solution is not recommended.","pos":[39718,39751]},{"pos":[39979,40034],"content":"2.3 HSM Key generation and storage for Secure Boot keys"},{"content":"2.3.1 Storing Private keys","pos":[40042,40068]},{"content":"The space requirement for each RSA-2048 key is 2048 bits.","pos":[40076,40133]},{"content":"The actual location of the storage of the keys depends on the solution chosen.","pos":[40134,40212]},{"content":"HSM are a good way of storing keys.","pos":[40213,40248]},{"content":"The physical location of the PCs on the factory floor would need to be a protected area with limited user access like a secure cage.","pos":[40254,40386]},{"content":"Depending on your requirements these keys could also be stored in a diverse geographical location or backed up in a different location.","pos":[40392,40527]},{"content":"The rekeying requirements for these keys could vary based on the customer (see Appendix A for Federal bridge certificate authority rekeying guidelines).","pos":[40533,40685]},{"content":"These could be done once per year.","pos":[40691,40725]},{"content":"You may need to have access to these keys for up to 30 years (depending on the rekeying requirements etc.).","pos":[40726,40833]},{"content":"2.3.2 Retrieving the private Keys","pos":[40841,40874]},{"content":"The keys may need to be retrieved for many reasons.","pos":[40882,40933]},{"content":"The PK may need to be retrieved to issue an updated PK due to it being compromised or to adhere to government /other agency regulations.","pos":[40943,41079]},{"content":"KEKpri will be used to update the db and dbx.","pos":[41089,41134]},{"content":"Secure firmware update key –pri will be used to sign newer updates.","pos":[41144,41211]},{"content":"2.3.3 Authentication","pos":[41219,41239]},{"content":"As per FIPS 140-2 authentication is based on level of access.","pos":[41247,41308]},{"content":"Level 2","pos":[41316,41323]},{"content":"Security Level 2 requires, at a minimum, role-based authentication in which a cryptographic module authenticates the authorization of an operator to assume a specific role and perform a corresponding set of services.","pos":[41331,41547]},{"content":"Level 3","pos":[41555,41562]},{"content":"Security Level 3 requires identity-based authentication mechanisms, enhancing the security provided by the role-based authentication mechanisms specified for Security Level 2.","pos":[41570,41745]},{"content":"A cryptographic module authenticates the identity of an operator and verifies that the identified operator is authorized to assume a specific role and perform a corresponding set of services.","pos":[41746,41937]},{"content":"PCs like HSM’s support Security Level 3, which requires identity-based “k of m authentication”.","pos":[41943,42038]},{"content":"This means k entities are given access to the HSM with a token but at a given point at least k out of the m tokens need to be present for authentication to work to get access to private keys from HSM.","pos":[42039,42239]},{"content":"For example, you could have 3 out of 5 tokens should be authenticated to access HSM.","pos":[42245,42329]},{"content":"Those members could be the security officers, transaction authorizer and/or members from Executive Management.","pos":[42330,42440]},{"content":"HSM Tokens","pos":[42448,42458]},{"content":"You could have a policy on the HSM which require the token to be present:","pos":[42466,42539]},{"content":"Locally","pos":[42549,42556]},{"content":"Remotely","pos":[42566,42574]},{"content":"Configured to be automated","pos":[42584,42610]},{"content":"As a good practice, please use a combination of token and per token password.","pos":[42616,42693]},{"pos":[42867,42904],"content":"2.4 Secure Boot and 3rd party signing"},{"content":"2.4.1 UEFI driver signing","pos":[42912,42937]},{"content":"UEFI Drivers must be signed by a CA or key in the db as described elsewhere in the document, or have the hash of the driver image included in db.","pos":[42945,43090]},{"content":"Microsoft will be providing a UEFI driver signing service similar to the WHQL driver signing service using the <bpt id=\"p1\">**</bpt>Microsoft Corporation UEFI CA 2011<ept id=\"p1\">**</ept>.","pos":[43091,43241]},{"content":"Any drivers signed by this will run seamlessly on any PCs that include the Microsoft UEFI CA.","pos":[43242,43335]},{"content":"It is also possible for an OEM to sign trusted drivers and include the OEM CA in the db, or to include hashes of the drivers in the db.","pos":[43336,43471]},{"content":"In all cases a UEFI driver (Option ROM) shall not execute if it is not trusted in the db.","pos":[43472,43561]},{"content":"Any drivers that are included in the system firmware image do not need to be re-verified.","pos":[43567,43656]},{"content":"Being part of the overall system image provides sufficient assurance that the driver is trusted on the PC.","pos":[43657,43763]},{"content":"Microsoft has this made available to anyone who wants to sign UEFI drivers.","pos":[43769,43844]},{"content":"This certificate is part of the Windows HCK Secure Boot tests.","pos":[43845,43907]},{"content":"2.4.2 Boot loaders","pos":[43915,43933]},{"content":"The Microsoft UEFI driver signing certificate can be used for signing other OSs.","pos":[43941,44021]},{"content":"For example, Fedora’s Linux boot loader will be signed by it.","pos":[44022,44083]},{"content":"This solution doesn’t require any more certificates to be added to the key Db.","pos":[44089,44167]},{"content":"In addition to being cost effective, it can be used for any Linux distribution.","pos":[44168,44247]},{"content":"This solution would work for any hardware which supports Windows so it is useful for a wide range of hardware.","pos":[44248,44358]},{"content":"The UEFI-CA can be downloaded from here: <bpt id=\"p1\">&lt;</bpt>http://go.microsoft.com/fwlink/p/?LinkID=321194<ept id=\"p1\">&gt;</ept>.","pos":[44364,44455]},{"content":"The following links have more information on Windows HCK UEFI signing and submission:","pos":[44456,44541]},{"content":"Windows Dev Center Hardware Dashboard","pos":[44552,44589]},{"content":"Windows Certification Dashboard Administration","pos":[44650,44696]},{"content":"UEFI Firmware Signing","pos":[44755,44776]},{"content":"Windows Hardware Certification blog: UEFI signing CA update","pos":[44835,44894]},{"pos":[45063,45087],"content":"3. Summary and Resources"},{"content":"This section intends to summarize the above sections and show a step by step approach:","pos":[45090,45176]},{"content":"Establish a secure CA or identify a partner to securely generate and store keys","pos":[45184,45263]},{"content":"If you are not using a 3rd party solution:","pos":[45271,45313]},{"content":"Install and configure the HSM software on the HSM server.","pos":[45325,45382]},{"content":"Check your HSM reference manual for installation instructions.","pos":[45385,45447]},{"content":"The server will either be connected to a standalone or network HSM.","pos":[45448,45515]},{"content":"For info about HSM configuration, see Section 2.2.1, 2.3 and Appendix C.","pos":[45525,45597]},{"content":"Most HSMs offer FIPS 140-2 level 2 and 3 compliance.","pos":[45607,45659]},{"content":"Configure the HSM for either level 2 or level 3 compliance.","pos":[45660,45719]},{"content":"Level 3 compliance has stricter requirements around authentication and key access and hence is more secure.","pos":[45720,45827]},{"content":"Level 3 is recommended.","pos":[45828,45851]},{"content":"Configure HSM for High Availability, Backup and Authentication.","pos":[45863,45926]},{"content":"Check your HSM reference manual.","pos":[45929,45961]},{"content":"Follow HSM provider guidelines on setting up HSM for High Availability and backup.","pos":[45971,46053]},{"content":"Also, Network HSMs typically have multiple network ports to segregate traffic; allowing a server to communicate with network HSMs on a network separate from the regular production network.","pos":[46063,46251]},{"content":"Once team members who are part of the security team have been identified and tokens assigned to them.","pos":[46261,46362]},{"content":"You will need to setup HSM hardware for k-of-m authentication.","pos":[46363,46425]},{"content":"Secure Boot Keys and certificate pre-generation.","pos":[46437,46485]},{"content":"See Sections 1.3 to 1.5","pos":[46488,46511]},{"content":"Use HSM APIs to pre-generate (generate in advance) the PK and Firmware Update Key and certificates.","pos":[46521,46620]},{"content":"Required - PK (recommend 1 per model), Firmware Update key (recommend 1 per model), Microsoft KEK, Db, DbxNOTE: The Microsoft KEK, db, and dbx don’t have to be generated by the OEM and are mentioned for completeness.Optional - OEM/3rd party KEK db, dbx and any other keys which would go into OEM Db.","pos":[46630,46929]},{"content":"Apply a Windows image to the PC.","pos":[46937,46969]},{"content":"<bpt id=\"p1\">**</bpt>Install Microsoft db and dbx<ept id=\"p1\">**</ept>.","pos":[46977,47010]},{"content":"See Section 1.3.6 and <bpt id=\"p1\">[</bpt>Appendix B – Secure Boot APIs<ept id=\"p1\">](#securebootapis)</ept>.","pos":[47011,47082]},{"pos":[47092,47154],"content":"Install the <bpt id=\"p1\">**</bpt>Microsoft Windows Production PCA 2011<ept id=\"p1\">**</ept> into db."},{"content":"Install an empty dbx if Microsoft does not provide one.","pos":[47164,47219]},{"pos":[47225,47342],"content":"**Note**  \nUse PowerShell cmdlets which are part of the Windows HCK tests or use methods provided by BIOS vendor.","leadings":["","    "],"nodes":[{"content":"Note","pos":[2,6]},{"content":"Use PowerShell cmdlets which are part of the Windows HCK tests or use methods provided by BIOS vendor.","pos":[11,113]}]},{"content":"<bpt id=\"p1\">**</bpt>Install Microsoft KEK<ept id=\"p1\">**</ept>.","pos":[47355,47381]},{"content":"See Section 1.3.3.","pos":[47382,47400]},{"content":"Install Microsoft KEK into the UEFI KEK database","pos":[47406,47454]},{"pos":[47460,47580],"content":"**Caution**  \nUse PowerShell cmdlets which are part of the Windows HCK tests or use methods provided by BIOS vendor.","leadings":["","    "],"nodes":[{"content":"Caution","pos":[2,9]},{"content":"Use PowerShell cmdlets which are part of the Windows HCK tests or use methods provided by BIOS vendor.","pos":[14,116]}]},{"content":"<bpt id=\"p1\">**</bpt>Optional step - OEM/3rd party secure boot components<ept id=\"p1\">**</ept>.","pos":[47593,47650]},{"content":"See Section 1.3.4 and 1.4.","pos":[47651,47677]},{"content":"Identify if you have need for creating a OEM/3rd party KEK, db and dbx.","pos":[47687,47758]},{"content":"Sign OEM/3rd party db and dbx with OEM/3rd party KEK(generated earlier) using HSM API.","pos":[47768,47854]},{"content":"Install OEM/3rd party KEK, db and dbx.","pos":[47864,47902]},{"pos":[47908,47950],"content":"<bpt id=\"p1\">**</bpt>UEFI driver signing<ept id=\"p1\">**</ept> – See Section 2.4."},{"pos":[47956,48083],"content":"If supporting add-in cards or other UEFI drivers/apps/bootloaders, install <bpt id=\"p1\">**</bpt>Microsoft Corporation UEFI CA 2011<ept id=\"p1\">**</ept> into UEFI db."},{"pos":[48089,48145],"content":"<bpt id=\"p1\">**</bpt>Secure boot firmware update key<ept id=\"p1\">**</ept> - See Section 1.3.5."},{"content":"Non-Windows RT PCs only: Install the Secure firmware update public key or its hash to save space.","pos":[48155,48252]},{"content":"On SoC only, you may need to do something different, for example, burn Secure firmware update key: public or its hash.","pos":[48262,48380]},{"content":"<bpt id=\"p1\">**</bpt>Enabling Secure Boot<ept id=\"p1\">**</ept>.","pos":[48386,48411]},{"content":"See <bpt id=\"p1\">[</bpt>Appendix B – Secure Boot APIs<ept id=\"p1\">](#securebootapis)</ept>.","pos":[48412,48465]},{"content":"Install the OEM/ODM PKpub (certificate preferred, but key is okay) into the UEFI PK.","pos":[48475,48559]},{"content":"Enroll the PK using Secure Boot API.","pos":[48569,48605]},{"content":"The PC should be now enabled for Secure Boot.","pos":[48606,48651]},{"pos":[48657,48802],"content":"**Note**  \nIf you install the PK at the end, the MS KEK, db, dbx don’t need to be signed – no SignerInfo must be present. This is a shortcut.","leadings":["","    "],"nodes":[{"content":"Note","pos":[2,6]},{"content":"If you install the PK at the end, the MS KEK, db, dbx don’t need to be signed – no SignerInfo must be present. This is a shortcut.","pos":[11,141],"nodes":[{"content":"If you install the PK at the end, the MS KEK, db, dbx don’t need to be signed – no SignerInfo must be present.","pos":[0,110]},{"content":"This is a shortcut.","pos":[111,130]}]}]},{"content":"<bpt id=\"p1\">**</bpt>Testing Secure Boot<ept id=\"p1\">**</ept>: Execute any proprietary tests and Windows HCK tests as per instructions.","pos":[48815,48912]},{"content":"See <bpt id=\"p1\">[</bpt>Appendix B – Secure Boot APIs<ept id=\"p1\">](#securebootapis)</ept>.","pos":[48913,48966]},{"pos":[48972,49048],"content":"<bpt id=\"p1\">**</bpt>Ship platform<ept id=\"p1\">**</ept>: The PKpriv will likely never be used again, keep it safe."},{"pos":[49054,49185],"content":"<bpt id=\"p1\">**</bpt>Servicing<ept id=\"p1\">**</ept>: Future firmware updates are securely signed with the Secure Firmware Update “private” key using the signing service."},{"pos":[49287,49300],"content":"3.1 Resources"},{"pos":[49302,49385],"content":"Security Strategies White Paper - <bpt id=\"p1\">&lt;</bpt>http://go.microsoft.com/fwlink/p/?linkid=321288<ept id=\"p1\">&gt;</ept>"},{"pos":[49387,49460],"content":"Windows HCK Submission -<bpt id=\"p1\">&lt;</bpt>http://go.microsoft.com/fwlink/p/?linkid=321287<ept id=\"p1\">&gt;</ept>"},{"pos":[49588,49644],"content":"Appendix A – Secure Boot PKI checklist for manufacturing"},{"content":"Below is a high-level checklist summarizing the steps needed for enabling Secure Boot on non-Windows RT PCs.","pos":[49647,49755]},{"content":"Setting up Secure Boot","pos":[49759,49781]},{"content":"Define security strategy (identify threats, define proactive and reactive strategy) as per the white paper in section 4.","pos":[49789,49909]},{"content":"Identify security team as per the white paper in section 4.","pos":[49915,49974]},{"content":"Establish a secure CA or identify a partner (recommended solution) to securely generate and store keys.","pos":[49980,50083]},{"content":"Identify policy for how frequently you will be rekeying keys.","pos":[50089,50150]},{"content":"This may depend on if you have any special customer requirements like governments or other agencies.","pos":[50151,50251]},{"content":"Have a contingency plan in case the Secure Boot Key is compromised.","pos":[50257,50324]},{"content":"Identify how many PK and other keys will you be generating as per section 1.3.3 and 1.5.","pos":[50330,50418]},{"content":"This will be based on customer base, key storage solution and security of PCs.","pos":[50424,50502]},{"content":"You can skip steps 7-8 if you are using the recommended solution of using a 3rd party for key management.","pos":[50508,50613]},{"content":"Procure server and hardware for key management.","pos":[50619,50666]},{"content":"– network or standalone HSM per section 2.2.1.","pos":[50667,50713]},{"content":"Consider whether you will need one or several HSMs for high availability and your key back up strategy.","pos":[50714,50817]},{"content":"Identify at least 3-4 team members who will have an authentication token for authentication on HSM.","pos":[50823,50922]},{"content":"Use HSM or 3rd party to pre-generate Secure Boot-related keys and certificates.","pos":[50928,51007]},{"content":"The keys will depend on the PC type: SoC, Windows RT or non-Windows RT.","pos":[51008,51079]},{"content":"For more info, see Sections 1.3 through 1.5.","pos":[51080,51124]},{"content":"Populate the firmware with the appropriate keys.","pos":[51130,51178]},{"content":"Enroll the Secure Boot Platform Key to enable Secure Boot.","pos":[51184,51242]},{"content":"See Appendix B for more details.","pos":[51243,51275]},{"content":"Execute any proprietary tests and HCK Secure Boot tests as per instructions.","pos":[51281,51357]},{"content":"See Appendix B for more details.","pos":[51358,51390]},{"content":"Ship the PC.","pos":[51396,51408]},{"content":"The PKpriv will likely never be used again, keep it safe.","pos":[51409,51466]},{"content":"Servicing (Updating firmware)","pos":[51470,51499]},{"content":"You may need to update firmware for several reasons such as updating an UEFI component or fixing Secure Boot key compromise or periodic rekeying of Secure Boot keys.","pos":[51503,51668]},{"content":"For more info, see Section 1.3.5 and section 1.3.6.","pos":[51670,51721]},{"pos":[51825,51854],"content":"Appendix B – Secure Boot APIs"},{"content":"Secure Boot API","pos":[51863,51878]},{"content":"The following APIs are related to UEFI/Secure Boot:","pos":[51886,51937]},{"pos":[51947,52097],"content":"<bpt id=\"p1\">[</bpt>GetFirmwareEnvironmentVariableEx<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=398262)</ept>: Retrieves the value of the specified firmware environment variable."},{"pos":[52107,52252],"content":"<bpt id=\"p1\">[</bpt>SetFirmwareEnvironmentVariableEx<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=398263)</ept>: Sets the value of the specified firmware environment variable."},{"pos":[52262,52356],"content":"<bpt id=\"p1\">[</bpt>GetFirmwareType<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=398264)</ept>: Retrieves the firmware type."},{"content":"Setting PK","pos":[52364,52374]},{"content":"Use the Set-SecureBootUEFI cmdlet to turn on Secure Boot.","pos":[52382,52439]},{"content":"After your code sets the PK, system enforcement of Secure Boot does not take effect until the next reboot.","pos":[52440,52546]},{"content":"Prior to the reboot, your code could call GetFirmwareEnvironmentVariableEx() or the PowerShell cmdlet: Get-SecureBootUEFI to confirm the contents of the Secure Boot databases.","pos":[52547,52722]},{"content":"Verification","pos":[52730,52742]},{"content":"You can use Msinfo32.exe or PowerShell cmdlets to check Secure Boot variable state.","pos":[52750,52833]},{"content":"There is no WMI interface.","pos":[52834,52860]},{"content":"You could also test by having someone insert an incorrectly-signed bootable USB stick (for example, from the Windows HCK Secure Boot Manual Logo Test) and verify that it fails to boot.","pos":[52861,53045]},{"content":"Secure Boot Powershell Cmdlets","pos":[53053,53083]},{"pos":[53095,53163],"content":"<bpt id=\"p1\">**</bpt>Confirm-SecureBootUEFI<ept id=\"p1\">**</ept>: Is UEFI Secure Boot “ON”, True or False?"},{"content":"SetupMode == 0 &amp;&amp; SecureBoot == 1","pos":[53173,53206]},{"pos":[53216,53293],"content":"<bpt id=\"p1\">**</bpt>Set-SecureBootUEFI<ept id=\"p1\">**</ept>: Set or Append authenticated SecureBoot UEFI variables"},{"pos":[53303,53376],"content":"<bpt id=\"p1\">**</bpt>Get-SecureBootUEFI<ept id=\"p1\">**</ept>: Get authenticated SecureBoot UEFI variable values"},{"pos":[53386,53492],"content":"<bpt id=\"p1\">**</bpt>Format-SecureBootUEFI<ept id=\"p1\">**</ept>: Creates EFI<ph id=\"ph1\">\\_</ph>SIGNATURE<ph id=\"ph2\">\\_</ph>LISTs &amp; EFI<ph id=\"ph3\">\\_</ph>VARIABLE<ph id=\"ph4\">\\_</ph>AUTHENTICATION<ph id=\"ph5\">\\_</ph>2 serializations"},{"content":"Windows HCK and Secure Boot Instructions","pos":[53500,53540]},{"content":"The following steps apply to system tests and non-class driver PC tests.","pos":[53548,53620]},{"content":"Disable Secure Boot protections.","pos":[53630,53662]},{"content":"Enter your BIOS configuration and disable Secure Boot.","pos":[53672,53726]},{"content":"Install the HCK Client software.","pos":[53736,53768]},{"content":"Run all of the Windows HCK tests, except for the following:","pos":[53778,53837]},{"content":"BitLocker TPM and Recovery password tests with PCR<ph id=\"ph1\">\\[</ph>7","pos":[53851,53904]},{"content":"BitLocker TPM and Recovery password tests for ARM PCs with Secure Boot","pos":[53920,53990]},{"content":"Secure Boot Logo Test","pos":[54004,54025]},{"content":"Secure Boot Manual Logo Test","pos":[54039,54067]},{"content":"Enter your BIOS configuration, enable Secure Boot, and restore Secure Boot to the Default configuration.","pos":[54077,54181]},{"content":"Run the following BitLocker and Secure Boot tests:","pos":[54191,54241]},{"content":"BitLocker TPM and Recovery password tests with PCR<ph id=\"ph1\">\\[</ph>7","pos":[54255,54308]},{"content":"BitLocker TPM and Recovery password tests for ARM PCs with Secure Boot","pos":[54324,54394]},{"content":"Secure Boot Logo Test (automated)","pos":[54408,54441]},{"content":"Enter the BIOS configuration and clear the Secure Boot configuration.","pos":[54451,54520]},{"content":"This restores the PC to Setup Mode by deleting PK and other keys.","pos":[54521,54586]},{"pos":[54596,54664],"content":"**Note**  \nSupport for clearing is required for x86/x64 PCs.","leadings":["","        "],"nodes":[{"content":"Note","pos":[2,6]},{"content":"Support for clearing is required for x86/x64 PCs.","pos":[11,60]}]},{"content":"Run the Secure Boot Manual Logo Test.","pos":[54685,54722]},{"pos":[54732,54832],"content":"**Note**  \nSecure Boot requires Windows HCK signed or VeriSign drivers on non-Windows RT PCs","leadings":["","        "],"nodes":[{"content":"Note","pos":[2,6]},{"content":"Secure Boot requires Windows HCK signed or VeriSign drivers on non-Windows RT PCs","pos":[11,92]}]},{"content":"Windows HCK Secure Boot Logo Test (automated)","pos":[54851,54896]},{"content":"This test will check for proper out-of-box Secure Boot configuration.","pos":[54904,54973]},{"content":"This includes:","pos":[54974,54988]},{"content":"Secure Boot is Enabled.","pos":[54998,55021]},{"content":"The PK is not a known, test PK.","pos":[55031,55062]},{"content":"KEK contains the production Microsoft KEK.","pos":[55072,55114]},{"content":"db contains the production Windows CA.","pos":[55124,55162]},{"content":"dbx present.","pos":[55172,55184]},{"content":"Many 1kB variables are created/deleted.","pos":[55194,55233]},{"content":"A 32kB variable is created/deleted.","pos":[55243,55278]},{"content":"Windows HCK Secure Boot manual test folder layout","pos":[55286,55335]},{"content":"The Windows HCK Secure Boot Manual Logo test folder layout is described below:","pos":[55343,55421]},{"pos":[55441,55466],"content":"folder has the following:"},{"content":"Manufacturing and Servicing Test","pos":[55480,55512]},{"content":"Programmatically Enable Secure Boot in test configuration","pos":[55526,55583]},{"content":"Servicing Tests","pos":[55597,55612]},{"content":"Append a cert to db, verify function","pos":[55626,55662]},{"content":"Append a hash to dbx, verify function","pos":[55676,55713]},{"content":"Append a cert to dbx, verify function","pos":[55727,55764]},{"content":"Append 600+ hashes to dbx, verify size","pos":[55778,55816]},{"content":"Programmatically change the PK","pos":[55830,55860]},{"pos":[55884,55928],"content":"folder has scripts which show the following:"},{"content":"How test certificates were created","pos":[55942,55976]},{"content":"The test certificates and private keys are included","pos":[55990,56041]},{"content":"How all of the tests were created","pos":[56055,56088]},{"content":"Turning certificates and hashes into signed packages","pos":[56102,56154]},{"content":"You can run this yourself, substitute your own certificates","pos":[56168,56227]},{"pos":[56248,56308],"content":"folder has all of the certificates you need to boot Windows:"},{"pos":[56318,56634],"content":"**Note**  \nPlease don’t use the methodology used in “ManualTests\\\\generate\\\\TestCerts” to generate keys and certificates. This is meant for Windows HCK test purposes only. It uses keys which are stored on disk which is very insecure and not recommended. This is not meant for use in a production environment.","leadings":["","        "],"nodes":[{"content":"Note","pos":[2,6]},{"content":"Please don’t use the methodology used in “ManualTests\\\\generate\\\\TestCerts” to generate keys and certificates. This is meant for Windows HCK test purposes only. It uses keys which are stored on disk which is very insecure and not recommended. This is not meant for use in a production environment.","pos":[11,308],"nodes":[{"content":"Please don’t use the methodology used in “ManualTests<ph id=\"ph1\">\\\\</ph>generate<ph id=\"ph2\">\\\\</ph>TestCerts” to generate keys and certificates.","pos":[0,110]},{"content":"This is meant for Windows HCK test purposes only.","pos":[111,160]},{"content":"It uses keys which are stored on disk which is very insecure and not recommended.","pos":[161,242]},{"content":"This is not meant for use in a production environment.","pos":[243,297]}]}]},{"pos":[56688,56780],"content":"folder has scripts which you can leverage for installation of Secure Boot on production PCs."},{"content":"The “ManualTests<ph id=\"ph1\">\\\\</ph>generate<ph id=\"ph2\">\\\\</ph>tests<ph id=\"ph3\">\\\\</ph>subcreate<ph id=\"ph4\">\\_</ph>outofbox<ph id=\"ph5\">\\_</ph>example.ps1” demonstrates how these examples were generated and have “TODO” sections when a partner can substitute their PK and other metadata.","pos":[56790,56989]},{"content":"Windows HCK UEFI signing and submission","pos":[56997,57036]},{"content":"The following links have more information:","pos":[57044,57086]},{"content":"Hardware Developer Center Dashboard","pos":[57097,57132]},{"content":"UEFI Firmware Signing","pos":[57193,57214]},{"content":"Windows Certification Dashboard Administration","pos":[57275,57321]},{"content":"Windows Hardware Certification blog: Microsoft UEFI CA Signing policy updates","pos":[57382,57459]},{"pos":[57683,57772],"content":"Appendix C – Federal Bridge Certification Authority Certificate Policy Assurance Mappings"},{"content":"Rudimentary","pos":[57781,57792]},{"content":"This level provides the lowest degree of assurance concerning identity of the individual.","pos":[57800,57889]},{"content":"One of the primary functions of this level is to provide data integrity to the information being signed.","pos":[57890,57994]},{"content":"This level is relevant to environments in which the risk of malicious activity is considered to be low.","pos":[57995,58098]},{"content":"It is not suitable for transactions requiring authentication, and is generally insufficient for transactions requiring confidentiality, but may be used for the latter where certificates having higher levels of assurance are unavailable.","pos":[58099,58335]},{"content":"Basic","pos":[58343,58348]},{"content":"This level provides a basic level of assurance relevant to environments where there are risks and consequences of data compromise, but they are not considered to be of major significance.","pos":[58356,58543]},{"content":"This may include access to private information where the likelihood of malicious access is not high.","pos":[58544,58644]},{"content":"It is assumed at this security level that users are not likely to be malicious.","pos":[58645,58724]},{"content":"Medium","pos":[58732,58738]},{"content":"This level is relevant to environments where risks and consequences of data compromise are moderate.","pos":[58746,58846]},{"content":"This may include transactions having substantial monetary value or risk of fraud, or involving access to private information where the likelihood of malicious access is substantial.","pos":[58847,59028]},{"content":"High","pos":[59036,59040]},{"content":"This level is appropriate for use where the threats to data are high, or the consequences of the failure of security services are high.","pos":[59048,59183]},{"content":"This may include very high value transactions or high levels of fraud risk.","pos":[59184,59259]},{"pos":[59297,59311],"content":"Related topics"},{"content":"Secure Boot Key Generation and Signing Using HSM (Example)","pos":[59315,59373]},{"content":"UEFI Validation Option ROM Validation Guidance","pos":[59439,59485]},{"content":"Secure Boot Overview","pos":[59540,59560]}],"content":"---\nauthor: Justinha\nDescription: Windows Secure Boot Key Creation and Management Guidance\nms.assetid: 603ae3a4-d9b6-4d2a-bf46-b2fdffcd6baf\nMSHAttr: 'PreferredLib:/library/windows/hardware'\ntitle: Windows Secure Boot Key Creation and Management Guidance\n---\n\n# Windows Secure Boot Key Creation and Management Guidance\n\n\n**Vishal Manan, Architect, OEM Consulting**, <vmanan@microsoft.com>\n\n**Arie van der Hoeven, Architect, OEM Consulting**, <ariev@microsoft.com>\n\nThis document helps guide OEMs and ODMs in creation and management of the Secure Boot keys and certificates in a manufacturing environment. It addresses questions related to creation, storage and retrieval of Platform Keys (PKs), secure firmware update keys, and third party Key Exchange Keys (KEKs).\n\nWindows requirements for UEFI and Secure Boot can be found in the [Windows Hardware Certification Requirements](http://go.microsoft.com/fwlink/p/?linkid=320504) and other documents made available through sources such as Windows Connect and MSDN. This paper does not introduce new requirements or represent an official Windows program. It is intended as guidance beyond certification requirements, to assist in building efficient and secure processes for creating and managing Secure Boot Keys. This is important because UEFI Secure Boot is based on the usage of Private Key Infrastructure to authenticate code before allowed to execute.\n\nThe reader is expected to know the fundamentals of UEFI, basic understanding of Secure Boot (Chapter 27 of the [UEFI specification](http://go.microsoft.com/fwlink/p/?LinkID=220187)), and PKI security model.\n\nRequirements, tests, and tools validating Secure Boot on Windows are available today through the [Windows Hardware Certification Kit (HCK)](http://go.microsoft.com/fwlink/p/?linkid=254893). However, these HCK resources do not address creation and management of keys for Windows deployments. This paper addresses key management as a resource to help guide partners through deployment of the keys used by the firmware. It is not intended as prescriptive guidance and does not include any new requirements.\n\nOn this page:\n\n-   [1. Secure Boot, Windows and Key Management](#securebootkeymanagement) contains information on boot security and PKI architecture as it applies to Windows and Secure Boot.\n\n-   [2. Key Management Solutions](#keymanagementsolutions) is intended to help partners design a key management and design solution that fits their needs.\n\n-   [3. Summary and Resources](#summaryandresources) includes appendices, checklists, APIs, and other references.\n\nThis document serves as a starting point in developing customer ready PCs, factory deployment tools and key security best practices.\n\n## <span id=\"SecureBootKeyManagement\"></span><span id=\"securebootkeymanagement\"></span><span id=\"SECUREBOOTKEYMANAGEMENT\"></span>1. Secure Boot, Windows and Key Management\n\n\nThe UEFI (Unified Extensible Firmware Interface) specification defines a firmware execution authentication process called Secure Boot. As an industry standard, Secure Boot defines how platform firmware manages certificates, authenticates firmware, and how the operating system interfaces with this process.\n\nSecure Boot is based on the Public Key Infrastructure (PKI) process to authenticate modules before they are allowed to execute. These modules can include firmware drivers, option ROMs, UEFI drivers on disk, UEFI applications, or UEFI boot loaders. Through image authentication before execution, Secure Boot reduces the risk of pre-boot malware attacks such as rootkits. Microsoft relies on UEFI Secure Boot in Windows 10, Windows 8.1 and Windows 8 as part of its Trusted Boot security architecture to improve platform security for our customers. Secure Boot is required for Windows 10, Windows 8.1 and Windows 8 client PCs as defined in the Windows Hardware Certification Requirements.\n\nThe Secure Boot process works as follows and as shown in Figure 1:\n\n1.  **Firmware Boot Components:** The firmware verifies the OS loader is trusted (Windows or another trusted operating system.)\n\n2.  **Windows boot components: BootMgr, WinLoad, Windows Kernel Startup.** Windows boot components verify the signature on each component. Any non-trusted components will not be loaded and instead will trigger Secure Boot remediation.\n\n    -   **Antivirus and Antimalware Software initialization:** This software is checked for a special signature issued by Microsoft verifying that it is a trusted boot critical driver, and will launch early in the boot process.\n\n    -   **Boot Critical Driver initialization:** The signatures on all Boot-critical drivers are checked as part of Secure Boot verification in WinLoad.\n\n3.  **Additional OS Initialization**\n\n4.  **Windows Logon Screen**\n\n![image of platform integrity architecture](images/dep-8-secureboot-platform-integrity-architecture.png)\n\n*Figure 1: Windows Trusted Boot Architecture*\n\nImplementation of UEFI Secure Boot is part of Microsoft’s Trusted Boot Architecture, introduced in Windows 8.1. A growing trend in the evolution of malware exploits is targeting the boot path as a preferred attack vector. This class of attack has been difficult to guard against, since antimalware products can be disabled by malicious software that prevents them from loading entirely. With Windows Trusted Boot architecture and its establishment of a root of trust with Secure Boot, the customer is protected from malicious code executing in the boot path by ensuring that only signed, certified “known good” code and boot loaders can execute before the operating system itself loads.\n\n### <span id=\"1.1_Public-Key_Infrastructure__PKI__and_Secure_Boot\"></span><span id=\"1.1_public-key_infrastructure__pki__and_secure_boot\"></span><span id=\"1.1_PUBLIC-KEY_INFRASTRUCTURE__PKI__AND_SECURE_BOOT\"></span>1.1 Public-Key Infrastructure (PKI) and Secure Boot\n\nThe PKI establishes authenticity and trust in a system. Secure Boot leverages PKI for two high-level purposes:\n\n1.  During boot to determine if early boot modules are trusted for execution.\n\n2.  To authenticate requests to service requests include modification of Secure Boot databases and updates to platform firmware.\n\nA PKI consists of:\n\n-   A certificate authority (CA) that issues the digital certificates.\n\n-   A registration authority which verifies the identity of users requesting a certificate from the CA.\n\n-   A central directory in which to store and index keys.\n\n-   A certificate management system.\n\n### <span id=\"1.2_Public_Key_Cryptography\"></span><span id=\"1.2_public_key_cryptography\"></span><span id=\"1.2_PUBLIC_KEY_CRYPTOGRAPHY\"></span>1.2 Public Key Cryptography\n\nPublic key cryptography uses a pair of mathematically related cryptographic keys, known as the public and private key. If you know one of the keys, you cannot easily calculate what the other one is. If one key is used to encrypt information, then only the corresponding key can decrypt that information. For Secure Boot, the private key is used to digitally sign code and the public key is used to verify the signature on that code to prove its authenticity. If a private key is compromised, then systems with corresponding public keys are no longer secure. This can lead to boot kit attacks and will damage the reputation of the entity responsible for ensuring the security of the private key.\n\nIn a Secure Boot public key system you have the following:\n\n-   **1.2.1 RSA 2048 Encryption**\n\n    RSA-2048 is an asymmetric cryptographic algorithm. The space needed to store an RSA-2048 modulus in raw form is 2048 bits.\n\n-   **1.2.2 Self-signed certificate**\n\n    A certificate signed by the private key that matches the public key of the certificate is known as a self-signed certificate. Root certification authority (CA) certificates fall into this category.\n\n-   **1.2.3 Certification Authority**\n\n    The certification authority (CA) issues signed certificates that affirm the identity of the certificate subject and bind that identity to the public key contained in the certificate. The CA signs the certificate by using its private key. It issues the corresponding public key to all interested parties in a self-signed root CA certificate.\n\n    In Secure Boot, Certification Authorities (CAs) include the OEM (or their delegates) and Microsoft. The CAs generate the key pairs that form the root of trust and then use the private keys to sign legitimate operations such as allowed early boot EFI modules and firmware servicing requests. The corresponding public keys are shipped embedded into the UEFI firmware on Secure Boot-enabled PCs and are used to verify these operations.\n\n    (More information on usage of CAs and key exchanges is readily available on the internet which relates to the Secure Boot model.)\n\n-   **1.2.4 Public Key**\n\n    The public Platform Key ships on the PC and is accessible or “public”. In this document we will use the suffix “pub” to denote public key. For example, PKpub denotes the public half of the PK.\n\n-   **1.2.5 Private Key**\n\n    For PKI to work the private key needs to be securely managed. It should be accessible to a few highly trusted individuals in an organization and located in a physically secure location with strong access policy restrictions in place. In this document we will use the suffix “priv” to denote private key. For example, the PKpriv indicates private half of the PK.\n\n-   **1.2.6 Certificates**\n\n    The primary use for digital certificates is to verify the origin of signed data, such as binaries etc. A common use of certificates is for internet message security using Transport Layer Security (TLS) or Secure Sockets Layer (SSL). Verifying the signed data with a certificate lets the recipient know the origin of the data and if it has been altered in transit.\n\n    A digital certificate in general contains, at a high level, a distinguished name (DN), a public key, and a signature. The DN identifies an entity -- a company, for example -- that holds the private key that matches the public key of the certificate. Signing the certificate with a private key and placing the signature in the certificate ties the private key to the public key.\n\n    Certificates can contain some other types of data. For example, an X.509 certificate includes the format of the certificate, the serial number of the certificate, the algorithm used to sign the certificate, the name of the CA that issued the certificate, the name and public key of the entity requesting the certificate, and the CA's signature.\n\n-   **1.2.7 Chaining certificates**\n\n    From: [Certificate chains](http://go.microsoft.com/fwlink/?LinkId=321183):\n\n    ![root ca is self-signed, others signed by root ca](images/dep-8-secureboot-threecertificatechain.png)\n\n    *Figure 2: Three-certificate chain*\n\n    User certificates are often signed by a different private key, such as a private key of the CA. This constitutes a two-certificate chain. Verifying that a user certificate is genuine involves verifying its signature, which requires the public key of the CA, from its certificate. But before the public key of the CA can be used, the enclosing CA certificate needs to be verified. Because the CA certificate is self-signed, the CA public key is used to verify the certificate.\n\n    A user certificate need not be signed by the private key of the root CA. It could be signed by the private key of an intermediary whose certificate is signed by the private key of the CA. This is an instance of a three-certificate chain: user certificate, intermediary certificate, and CA certificate. But more than one intermediary can be part of the chain, so certificate chains can be of any length.\n\n### <span id=\"1.3_Secure_Boot_PKI_requirements\"></span><span id=\"1.3_secure_boot_pki_requirements\"></span><span id=\"1.3_SECURE_BOOT_PKI_REQUIREMENTS\"></span>1.3 Secure Boot PKI requirements\n\nThe UEFI-defined root of trust consists of the Platform Key and any keys an OEM or ODM includes in the firmware core. Pre-UEFI security and a root of trust are not addressed by the UEFI Secure Boot process, but instead by National Institute of Standards and Technology (NIST), and Trusted Computing Group (TCG) publications referenced in this paper.\n\n-   **1.3.1 Secure Boot requirements**\n\n    You’ll need to consider the following parameters for implementing Secure Boot:\n\n    -   Customer requirements\n\n    -   Windows HCK requirements\n\n    -   Key generation and management requirements.\n\n    You would need to pick hardware for Secure Boot key management like Hardware Security Modules (HSMs), consider special requirements on PCs to ship to governments and other agencies and finally the process of creating, populating and managing the life cycle of various Secure Boot keys.\n\n-   **1.3.2 Secure Boot related keys**\n\n    The keys used for Secure Boot are below:\n\n    ![pk, kek, db, dbx, and firmware key, winrt key](images/dep-8-secureboot-allkeys.png)\n\n    *Figure 3: Keys related to Secure Boot*\n\n    Figure 3 above represents the signatures and keys in a PC with Secure Boot. The platform is secured through a platform key that the OEM installs in firmware during manufacturing. Other keys are used by Secure Boot to protect access to databases that store keys to allow or disallow execution of firmware.\n\n    The authorized database (db) contains public keys and certificates that represent trusted firmware components and operating system loaders. The forbidden signature database (dbx) contains hashes of malicious and vulnerable components as well as compromised keys and certificates and blocks execution of those malicious components. The strength of these policies is based on signing firmware using Authenticode and Public Key Infrastructure (PKI). PKI is a well-established process for creating, managing, and revoking certificates that establish trust during information exchange. PKI is at the core of the security model for Secure Boot.\n\n    Below are more details on these keys.\n\n-   **1.3.3 Platform Key (PK)**\n\n    As per section 27.5.1 of the UEFI 2.3.1 Errata C, the platform key establishes a trust relationship between the platform owner and the platform firmware. The platform owner enrolls the public half of the key (PKpub) into the platform firmware as specified in **Section 7.2.1 of the UEFI 2.3.1 Errata C**. This step moves the platform into user mode from setup mode. Microsoft recommends that the Platform Key be of type **EFI\\_CERT\\_X509\\_GUID** with public key algorithm RSA, public key length of 2048 bits, and signature algorithm sha256RSA. The platform owner may use type **EFI\\_CERT\\_RSA2048\\_GUID** if storage space is a concern. Public keys are used to check signatures as described earlier in this document. The platform owner can later use the private half of the key (PKpriv):\n\n    -   To change platform ownership you must put the firmware into UEFI defined **setup mode** which disables Secure Boot. We recommend reverting to setup mode only if there is a need to do this during manufacturing.\n\n    **1.3.3.1 To enroll or update a Key Exchange Key (KEK) Enrolling the Platform Key**\n\n    The platform owner enrolls the public half of the Platform Key (**PKpub**) by calling the UEFI Boot Service SetVariable() as specified in Section 7.2.1 and resetting the platform. If the platform is in setup mode, then the new **PKpub** shall be signed with its **PKpriv** counterpart. If the platform is in user mode, then the new **PKpub** must be signed with the current **PKpriv**. If the PK is of type **EFI\\_CERT\\_X509\\_GUID**, then this must be signed by the immediate **PKpriv**, not a private key of any certificate issued under the PK.\n\n    **1.3.3.2 Clearing the Platform Key**\n\n    The platform owner clears the public half of the Platform Key (**PKpub**) by calling the UEFI Boot Ser¬vice SetVariable() with a variable size of 0 and resetting the platform. If the platform is in setup mode, then the empty variable does not need to be authenticated. If the platform is in user mode, then the empty variable must be signed with the current **PKpriv**; see Section 7.2(Variable Services) under [UEFI specification](http://go.microsoft.com/fwlink/p/?LinkID=220187) 2.3.1 Errata C for details. It is strongly recommended that the production PKpriv never be used to sign a package to reset the platform since this allows Secure Boot to be disabled. This is primarily a pre-production test scenario.\n\n    The platform key may also be cleared using a secure platform-specific method. In this case, the global variable Setup Mode must also be updated to 1.\n\n    ![image: pk determines setup mode or user mode](images/dep-8-secureboot-pkstate.png)\n\n    *Figure 4: Platform Key State diagram*\n\n    **1.3.3.3 PK generation**\n\n    As per UEFI recommendations, the public key must be stored in non-volatile storage which is tamper and delete resistant on the PC. The Private keys stay secure at Partner or in the OEM’s Security Office and only the public key is loaded onto the platform. There are more details under section 2.2.1 and 2.3.\n\n    The number of PK generated is at the discretion of the Platform owner (OEM). These keys could be:\n\n    1.  **One per PC**. This may be required for government agencies, financial institutions, or other customers with high-security needs. It may require additional storage and crypto processing power to generate private and public keys for large numbers of PCs. There are a few different HSM solutions available to manage large number of keys based on the HSM vendor. For more info, see [Secure Boot Key Generation Using HSM](http://go.microsoft.com/fwlink/?LinkId=321184).\n\n    2.  **One per model**. The tradeoff here is that if a key is compromised all the machines within the same model would be vulnerable.\n\n    3.  **One per product line**. If a key is compromised a whole product line would be vulnerable.\n\n    4.  **One per OEM**. While this may be the simplest to set up, if the key is compromised, every PC you manufacture would be vulnerable. To speed up operation on the factory floor, the PK and potentially other keys could be pre-generated and stored in a safe location. These could be later retrieved and used in the assembly line. Chapters 2 and 3 have more details.\n\n    **1.3.3.4 Rekeying the PK**\n\n    This may be needed if the PK gets compromised or as a requirement by a customer that for security reasons may decide to enroll their own PK.\n\n    Rekeying could be done either for a model or PC based on what method was selected to create PK. All the newer PCs will get signed with the newly created PK.\n\n    Updating the PK on a production PC would require either a variable update signed with the existing PK that replaces the PK or a firmware update package. An OEM could also create a SetVariable() package and distribute that with a simple application such as PowerShell that just changes the PK. The firmware update package would be signed by the secure firmware update key and verified by firmware. If doing a firmware update to update the PK, care should be taken to ensure the KEK, db, and dbx are preserved.\n\n    On all PCs, it is recommended to not use the PK as the secure firmware update key. If the PKpriv is compromised then so is the secure firmware update key (since they are the same). In this case the update to enroll a new PKpub might not be possible since the process of updating has also been compromised.\n\n    On SOCs PCs, there is another reason to not use the PK as the secure firmware update key. This is because the secure firmware update key is permanently burnt into fuses on PCs that meet Windows Hardware Certification requirements.\n\n-   **1.3.4 Key Exchange Key (KEK)**Key exchange keys establish a trust relationship between the operating system and the platform firmware. Each operating system (and potentially, each 3rd party application which need to communicate with platform firmware) enrolls a public key (**KEKpub**) into the platform firmware.\n\n    **1.3.4.1 Enrolling Key Exchange Keys**\n\n    Key exchange keys are stored in a signature database as described in [1.4 Signature Databases (Db and Dbx)](#signaturedatabase). The signature database is stored as an authenticated UEFI variable.\n\n    The platform owner enrolls the key exchange keys by either calling SetVariable() as specified in Section 7.2(Variable Services) under [UEFI specification](http://go.microsoft.com/fwlink/p/?LinkID=220187) 2.3.1 Errata C. with the EFI\\_VARIABLE\\_APPEND\\_WRITE attribute set and the Data parameter containing the new key(s), or by reading the database using GetVariable(), appending the new key exchange key to the existing keys and then writing the database using SetVariable()as specified in Section 7.2(Variable Services) under [UEFI specification](http://go.microsoft.com/fwlink/p/?LinkID=220187) 2.3.1 Errata C without the EFI\\_VARIABLE\\_APPEND\\_WRITE attribute set.\n\n    If the platform is in setup mode, the signature database variable does not need to be signed but the parameters to the SetVariable() call shall still be prepared as specified for authenticated variables in Section 7.2.1. If the platform is in user mode, the signature database must be signed with the current PKpriv\n\n    **1.3.4.2 Clearing the KEK**\n\n    It is possible to “clear” (delete) the KEK. Note that if the PK is not installed on the platform, “clear” requests are not required to be signed. If they are signed, then to clear the KEK requires a PK-signed package, and to clear either db or dbx requires a package signed by any entity present in the KEK.\n\n    **1.3.4.3 Microsoft KEK**\n\n    The Microsoft KEK is required to enable revocation of bad images by updating the dbx and potentially for updating db to prepare for newer Windows signed images.\n\n    Include the Microsoft Corporation KEK CA 2011 in the KEK database, with the following values:\n\n    -   SHA-1 cert hash: `31 59 0b fd 89 c9 d7 4e d0 87 df ac 66 33 4b 39 31 25 4b 30`.\n\n    -   SignatureOwner GUID: `{77fa9abd-0359-4d32-bd60-28f4e78f784b}`.\n\n    -   Microsoft will provide the certificate to partners and it can be added either as an **EFI\\_CERT\\_X509\\_GUID** or an **EFI\\_CERT\\_RSA2048\\_GUID** type signature.\n\n    The Microsoft KEK certificate can be downloaded from: <http://go.microsoft.com/fwlink/?LinkId=321185>.\n\n    **1.3.4.4 KEKDefault** The platform vendor may provide a default set of Key Exchange Keys in the KEKDefault variable. Please reference [UEFI specification](http://go.microsoft.com/fwlink/p/?LinkID=220187) section 27.3.3 for more information.\n\n    **1.3.4.5 OEM/3rd party KEK on non-Windows RT PCs**\n\n    Partners don’t need to have their own KEK. On non-Windows RT PCs the OEM may have additional KEKs to allow additional OEM or a trusted 3rd party control of the db and dbx.\n\n    In that case you will need to store the private half of the KEK in a safe storage location. The public half will be on the PC in UEFI defined KEK database. As per UEFI recommendations, the public key must be stored in non-volatile storage which is tamper and delete resistant on the PC.\n\n-   **1.3.5 Secure Boot firmware update key**The Secure firmware update key is used to sign the firmware when it needs to be updated. This key has to have a minimum key strength of RSA-2048. All firmware updates must be signed securely by the OEM, their trusted delegate such as the ODM or IBV (Independent BIOS Vendor), or by a secure signing service.\n\n    As per [NIST publication 800-147 Field Firmware Update](http://go.microsoft.com/fwlink/?LinkId=321186) must support all elements of guidelines:\n\n    Any update to the firmware flash store must be signed by creator.\n\n    Firmware must check signature of the update.\n\n-   **1.3.6 Creation of keys for Secure Firmware Update**\n\n    The same key will be used to sign all firmware updates since the public half will be residing on the PC. You could also sign the firmware update with a key which chains to Secure Firmware update key.\n\n    There could be one key per PC like PK or one per model or one per product line. If there is one key per PC that would mean that millions of unique update packages will need to be generated. Please consider based on resource availability what method would work for you. Having a key per model or product line is a good compromise.\n\n    The Secure Firmware Update public key (or its hash to save space) would be stored in some protected storage on the platform – generally protected flash (PC) or one-time-programmable fuses (SOC).\n\n    If only the hash of this key is stored (to save space), then the firmware update will include the key, and the first stage of the update process will be verifying that the public key in the update matches the hash stored on the platform.\n\n    Capsules are a means by which the OS can pass data to UEFI environment across a reboot. Windows calls the UEFI UpdateCapsule() to deliver system and PC firmware updates. At boot time prior to calling ExitBootServices(),Windows will pass in any new firmware updates found in the Windows Driver Store into UpdateCapsule(). UEFI system firmware can use this process to update system and PC firmware. By leveraging this Windows firmware support an OEM can rely on the same common format and process for updating firmware for both system and PC firmware. Firmware must implement the ACPI ESRT table in order to support UEFI UpdateCapsule() for Windows.\n\n    For details on implementing support for the Windows UEFI Firmware Update Platform consult the following documentation: Windows UEFI Firmware Update Platform.\n\n    Update capsules can be in memory or on the disk. Windows supports in memory updates.\n\n    **1.3.6.1 Capsule (Capsule-in-Memory)**\n\n    Following is the flow of events for an In-memory update capsule to work.\n\n    1.  A capsule is put in memory by an application in the OS\n\n    2.  Mailbox event is set to inform BIOS of pending update\n\n    3.  PC reboots, verifies the capsule image and update is performed by the BIOS\n\n-   **1.3.7 Workflow of a typical firmware update**\n\n    1.  Download and install the firmware driver.\n\n    2.  Reboot.\n\n    3.  OS Loader detects and verifies the firmware.\n\n    4.  OS Loader passes a binary blob to UEFI.\n\n    5.  UEFI performs the firmware update (This process is owned by the silicon vendor).\n\n    6.  OS Loader detection completes successfully.\n\n    7.  OS finishes booting.\n\n### <span id=\"SignatureDatabase\"></span><span id=\"signaturedatabase\"></span><span id=\"SIGNATUREDATABASE\"></span>1.4 Signature Databases (Db and Dbx)\n\n-   **1.4.1 Allowed Signature database (db)**\n\n    The contents of the EFI \\_IMAGE\\_SECURITY\\_DATABASE db control what images are trusted when verifying loaded images. The database may contain multiple certificates, keys, and hashes in order to identify allowed images.\n\n    The **Microsoft Windows Production PCA 2011** with a SHA-1 Cert Hash of `58 0a 6f 4c c4 e4 b6 69 b9 eb dc 1b 2b 3e 08 7b 80 d0 67 8d` must be included in db in order to allow the Windows OS Loader to load. The Windows CA can be downloaded from here: <http://go.microsoft.com/fwlink/p/?linkid=321192>.\n\n    On non-Windows RT PCs the OEM should consider including the **Microsoft Corporation UEFI CA 2011** with a SHA-1 Certificate Hash of `46 de f6 3b 5c e6 1c f8 ba 0d e2 e6 63 9c 10 19 d0 ed 14 f3`. Signing UEFI drivers and applications with this certificate will allow UEFI drivers and applications from 3rd parties to run on the PC without requiring additional steps for the user. The UEFI CA can be downloaded from here: <http://go.microsoft.com/fwlink/p/?linkid=321194>.\n\n    On non-Windows RT PCs the OEM may also have additional items in the db to allow other operating systems or OEM-approved UEFI drivers or apps, but these images must not compromise the security of the PC in any way.\n\n-   **1.4.2 DbDefault**: The platform vendor may provide a default set of entries for the Signature Database in the dbDefault variable. For more information see section 27.5.3 in the UEFI specification.\n\n-   **1.4.3 Forbidden Signature Database (dbx)**\n\n    The contents of **EFI\\_IMAGE\\_SIGNATURE\\_DATABASE1** dbx must be checked when verifying images before checking db and any matches must prevent the image from executing. The database may contain multiple certificates, keys, and hashes in order to identify forbidden images. The Windows Hardware Certification Requirements state that a dbx must be present, so any dummy value, such as the SHA-256 hash of `0`, may be used as a safe placeholder until such time as Microsoft begins delivering dbx updates.\n\n-   **1.4.4 DbxDefault**: The platform vendor may provide a default set of entries for the Signature Database in the dbxDefault variable. For more information see section 27.5.3 in the UEFI specification.\n\n### <span id=\"1.5_Keys_Required_for_Secure_Boot_on_all_PCs\"></span><span id=\"1.5_keys_required_for_secure_boot_on_all_pcs\"></span><span id=\"1.5_KEYS_REQUIRED_FOR_SECURE_BOOT_ON_ALL_PCS\"></span>1.5 Keys Required for Secure Boot on all PCs\n\n<table>\n<colgroup>\n<col width=\"25%\" />\n<col width=\"25%\" />\n<col width=\"25%\" />\n<col width=\"25%\" />\n</colgroup>\n<thead>\n<tr class=\"header\">\n<th align=\"left\">Key/db Name</th>\n<th align=\"left\">Variable</th>\n<th align=\"left\">Owner</th>\n<th align=\"left\">Notes</th>\n</tr>\n</thead>\n<tbody>\n<tr class=\"odd\">\n<td align=\"left\"><p>PKpub</p></td>\n<td align=\"left\"><p>PK</p></td>\n<td align=\"left\"><p>OEM</p></td>\n<td align=\"left\"><p>PK – 1 only. Must be RSA 2048 or stronger.</p></td>\n</tr>\n<tr class=\"even\">\n<td align=\"left\"><p>Microsoft Corporation KEK CA 2011</p></td>\n<td align=\"left\"><p>KEK</p></td>\n<td align=\"left\"><p>Microsoft</p></td>\n<td align=\"left\"><p>Allows updates to db and dbx:</p>\n<p>[http://go.microsoft.com/fwlink/p/?linkid=321185](http://go.microsoft.com/fwlink/p/?linkid=321185).</p></td>\n</tr>\n<tr class=\"odd\">\n<td align=\"left\"><p>Microsoft Windows Production CA 2011</p></td>\n<td align=\"left\"><p>db</p></td>\n<td align=\"left\"><p>Microsoft</p></td>\n<td align=\"left\"><p>This CA in the Signature Database (db) allows Windows to boot: [http://go.microsoft.com/fwlink/?LinkId=321192](http://go.microsoft.com/fwlink/?LinkId=321192).</p></td>\n</tr>\n<tr class=\"even\">\n<td align=\"left\"><p>Forbidden Signature Database</p></td>\n<td align=\"left\"><p>dbx</p></td>\n<td align=\"left\"><p>Microsoft</p></td>\n<td align=\"left\"><p>List of known bad Keys, CAs or images from Microsoft</p></td>\n</tr>\n<tr class=\"odd\">\n<td align=\"left\"><p>Secure firmware update key</p></td>\n<td align=\"left\"><p></p></td>\n<td align=\"left\"><p>OEM</p></td>\n<td align=\"left\"><p>Recommendation is to have this key be different from PK</p></td>\n</tr>\n</tbody>\n</table>\n\n \n\n*Table 1: Keys/db needed for Secure Boot*\n\n-   **1.5.1 Key recommended for non-Windows RT PCs**\n\n    <table>\n    <colgroup>\n    <col width=\"25%\" />\n    <col width=\"25%\" />\n    <col width=\"25%\" />\n    <col width=\"25%\" />\n    </colgroup>\n    <thead>\n    <tr class=\"header\">\n    <th align=\"left\">Key/db Name</th>\n    <th align=\"left\">Variable</th>\n    <th align=\"left\">Owner</th>\n    <th align=\"left\">Notes</th>\n    </tr>\n    </thead>\n    <tbody>\n    <tr class=\"odd\">\n    <td align=\"left\"><p>Microsoft UEFI driver signing CA</p></td>\n    <td align=\"left\"><p>db</p></td>\n    <td align=\"left\"><p>Microsoft</p></td>\n    <td align=\"left\"><p>Microsoft signer for 3rd party UEFI drivers and Apps signed through the DevCenter program: [http://go.microsoft.com/fwlink/?LinkId=321194](http://go.microsoft.com/fwlink/?LinkId=321194).</p></td>\n    </tr>\n    </tbody>\n    </table>\n\n     \n\n    *Table 2: Non-Windows RT Secure Boot keys*\n\n    **1.5.2 Secure Boot PKI workflow**\n\n    Generating a key:\n\n    1.  Create keys: PK, Secure firmware update key, and other keys as needed.\n\n    2.  Create a backup of the PK, in case you need to rekey the PC, or if the original is lost.\n\n    3.  Install the MS KEK, db, and empty dbx (unless otherwise specified) using PowerShell scripts and/or BIOS vendor firmware methods.\n\n    4.  Update the firmware with pre-generated SecureFirmwareUpdateKey-public or hash (to save space).\n\n    5.  Sign and install UEFI variable PK using PowerShell scripts and/or BIOS vendor firmware.\n\n    6.  Run tests, including Windows HCK Secure Boot tests. For example, use [ChipSec](http://go.microsoft.com/fwlink/?LinkId=398265) to analyze the security of the platform components.\n\n    7.  Verify the state of Secure Boot variables by using PowerShell SecureBoot cmdlets, for example: [Confirm-SecureBootUEFI](http://go.microsoft.com/fwlink/?LinkId=398260) and [Get-SecureBootUEFI](http://go.microsoft.com/fwlink/?LinkId=398261).\n\n## <span id=\"KeyManagementSolutions\"></span><span id=\"keymanagementsolutions\"></span><span id=\"KEYMANAGEMENTSOLUTIONS\"></span>2. Key Management Solutions\n\n\nBelow are given some of the metrics we used for comparison.\n\n### <span id=\"2.1_Metrics_used\"></span><span id=\"2.1_metrics_used\"></span><span id=\"2.1_METRICS_USED\"></span>2.1 Metrics used\n\nThe following metrics can help you select a HSM PC based on the requirements of [UEFI specification](http://go.microsoft.com/fwlink/p/?LinkID=220187) 2.3.1 Errata C and your needs.\n\n**Public Key Infrastructure (PKI) related**\n\n-   Does it support RSA 2048 or higher? - The [UEFI specification](http://go.microsoft.com/fwlink/p/?LinkID=220187) 2.3.1 Errata C recommends the keys to be RSA-2048 or better.\n\n-   Does it have the ability to generate keys and sign?\n\n-   How many keys can it store? Does it store keys on HSM or an attached server?\n\n-   Authentication method for key retrieval.\n\n    Some PCs support multiple authentication entities to be present for key retrieval.\n\n**Pricing**\n\n-   What is the price point? HSMs can range in price from $1,500 to $70,000 depending on available features.\n\n**Manufacturing environment**\n\n-   Speed of operation on factory floor. Crypto processors can speed up key creation and access.\n\n-   Ease of setup, deployment, maintenance.\n\n-   Skillset and training required?\n\n-   Network access for backup and High Availability\n\n**Standards and Compliance**\n\n-   What level of FIPS compliance does it have? Is it tamper resistant?\n\n-   Support for other standards, for example, MS crypto APIs.\n\n-   Does it meet government and other agency requirements?\n\n**Reliability and disaster recovery**\n\n-   Does it allow for Key Backup?\n\n    Backups can be stored both onsite in a safe location that is a different physical location than the CA computer and HSM and /or at an offsite location.\n\n-   Does it allow for High Availability for disaster recovery?\n\n### <span id=\"2.2_Key_Management_Options\"></span><span id=\"2.2_key_management_options\"></span><span id=\"2.2_KEY_MANAGEMENT_OPTIONS\"></span>2.2 Key Management Options\n\n-   **2.2.1 Hardware Security Module (HSM)**\n\n    Based on the above criteria this is probably the most suitable and secure solution. Most HSM have FIPS 140-2 level 3 compliance. FIPS 140-2 level 3 compliance is strict on authentication and requires that keys are not exported or imported from the HSM.\n\n    They support multiple ways of key storage. They could be stored either locally on the HSM itself or on the server attached to the HSM. On the server the keys are encrypted and stored and is preferable for solutions which requires lots of keys to be stored.\n\n    The cryptographic module security policy shall specify a physical security policy, including physical security mechanisms that are implemented in a cryptographic module such as, tamper-evident seals, locks, tamper response and zeroization switches, and alarms. It also allows specifying actions required by the operator(s) to ensure that physical security is maintained such as periodic inspection of tamper-evident seals or testing of tamper response and zeroization switches.\n\n    **2.2.1.1 Network HSM**\n\n    This solution is the best in its class in terms of security, adherence to standards, key generation, storage and retrieval. Most of these PCs support high availability and have ability to backup keys.\n\n    The costs of these products can be in tens of thousands of dollars based on the extra services they offer.\n\n    **2.2.1.2 Standalone HSM**\n\n    These work great with standalone servers. One can use Microsoft CAPI and CNG or any other secure API supported by HSM. These HSMs come in variety of form factors supporting USB, PCIe and PCMCIA buses.\n\n    They optionally support key backup and high availability.\n\n-   **2.2.2 Custom solutions providers**\n\n    Public Key cryptography can be challenging and require understanding of cryptographic concepts which maybe new. There are custom solution providers who could help with the getting Secure Boot to work in the manufacturing environment.\n\n    There are varieties of custom solutions offered by BIOS vendors, HSM companies and PKI consulting companies to get Secure Boot PKI working in the manufacturing environment.\n\n    Some of the providers are listed below:\n\n    **2.2.2.1 BIOS vendors**\n\n    There are some BIOS vendors which may be able to provide custom solutions.\n\n    **2.2.2.2 HSM vendors**\n\n    Some HSM vendors may be able to provide custom consulting. For more info, see [Secure Boot Key Generation and Signing Using HSM (Example)](secure-boot-key-generation-and-signing-using-hsm--example.md).\n\n-   **2.2.3 Trusted Platform Module (TPM)**\n\n    A Trusted Platform Module (TPM) is a hardware chip on the motherboard that stores cryptographic keys used for encryption. Many computers include a TPM, but if the PC doesn’t include it, it is not feasible to add one. Once enabled, the Trusted Platform Module can help secure full disk encryption products such as Microsoft BitLocker capabilities. It keeps hard drives locked, or sealed, until the PC completes a system verification or authentication process.\n\n    The TPM can generate, store, and protect keys used in the encryption and decryption process.\n\n    The drawbacks of TPMs are that it may not have fast crypto processors to speed up processing in the manufacturing environment. They also are not suitable for storing large number of keys. Backup and high availability and standards compliance to FIPS 140-2 level 3 may not be available.\n\n-   **2.2.4 Smart Cards**\n\n    A smart card can generate and store keys. They do share some features which HSM support like authentication and tamper proofing, but they don’t include much key storage or backup. They require manual intervention and may not be suitable for automation and use in production environment as the performance maybe low.\n\n    The drawbacks of Smart cards are similar to TPMs. They may not have fast crypto processors to speed up processing in the manufacturing environment. They also are not suitable for storing large number of keys. Backup and high availability and standards compliance to FIPS 140-2 level 3 may not be available.\n\n-   **2.2.5 Software-centric approaches (NOT RECOMMENDED)**\n\n    Use crypto APIs for key management. This may involve storing a key in a key container on an encrypted hard drive and possible for additional sandboxing and security use a Virtual machine.\n\n    These solutions are not as secure as using an HSM and expose a higher attack vector.\n\n    **2.2.5.1 Makecert (NOT RECOMMENDED)**\n\n    Makecert is a Microsoft tool and can be used as follows for key generation. To make sure that the attack surface is minimized you may need to “air gap” the PC. The PC that has the PKpriv on should not be connected to the network. It should be in a secure location and ideally should at least use a smart card reader if not a real HSM.\n\n    ``` syntax\n    makecert -pe -ss MY -$ individual -n \"CN=your name here\" -len 2048 -r\n    ```\n\n    For more info, see [Certificate Creation Tool (Makecert.exe)](http://go.microsoft.com/fwlink/p/?linkid=211849).\n\n    This solution is not recommended.\n\n### <span id=\"2.3_HSM_Key_generation_and_storage_for_Secure_Boot_keys\"></span><span id=\"2.3_hsm_key_generation_and_storage_for_secure_boot_keys\"></span><span id=\"2.3_HSM_KEY_GENERATION_AND_STORAGE_FOR_SECURE_BOOT_KEYS\"></span>2.3 HSM Key generation and storage for Secure Boot keys\n\n-   **2.3.1 Storing Private keys**\n\n    The space requirement for each RSA-2048 key is 2048 bits. The actual location of the storage of the keys depends on the solution chosen. HSM are a good way of storing keys.\n\n    The physical location of the PCs on the factory floor would need to be a protected area with limited user access like a secure cage.\n\n    Depending on your requirements these keys could also be stored in a diverse geographical location or backed up in a different location.\n\n    The rekeying requirements for these keys could vary based on the customer (see Appendix A for Federal bridge certificate authority rekeying guidelines).\n\n    These could be done once per year. You may need to have access to these keys for up to 30 years (depending on the rekeying requirements etc.).\n\n-   **2.3.2 Retrieving the private Keys**\n\n    The keys may need to be retrieved for many reasons.\n\n    1.  The PK may need to be retrieved to issue an updated PK due to it being compromised or to adhere to government /other agency regulations.\n\n    2.  KEKpri will be used to update the db and dbx.\n\n    3.  Secure firmware update key –pri will be used to sign newer updates.\n\n-   **2.3.3 Authentication**\n\n    As per FIPS 140-2 authentication is based on level of access.\n\n    **Level 2**\n\n    Security Level 2 requires, at a minimum, role-based authentication in which a cryptographic module authenticates the authorization of an operator to assume a specific role and perform a corresponding set of services.\n\n    **Level 3**\n\n    Security Level 3 requires identity-based authentication mechanisms, enhancing the security provided by the role-based authentication mechanisms specified for Security Level 2. A cryptographic module authenticates the identity of an operator and verifies that the identified operator is authorized to assume a specific role and perform a corresponding set of services.\n\n    PCs like HSM’s support Security Level 3, which requires identity-based “k of m authentication”. This means k entities are given access to the HSM with a token but at a given point at least k out of the m tokens need to be present for authentication to work to get access to private keys from HSM.\n\n    For example, you could have 3 out of 5 tokens should be authenticated to access HSM. Those members could be the security officers, transaction authorizer and/or members from Executive Management.\n\n    **HSM Tokens**\n\n    You could have a policy on the HSM which require the token to be present:\n\n    -   Locally\n\n    -   Remotely\n\n    -   Configured to be automated\n\n    As a good practice, please use a combination of token and per token password.\n\n### <span id=\"2.4_Secure_Boot_and_3rd_party_signing\"></span><span id=\"2.4_secure_boot_and_3rd_party_signing\"></span><span id=\"2.4_SECURE_BOOT_AND_3RD_PARTY_SIGNING\"></span>2.4 Secure Boot and 3rd party signing\n\n-   **2.4.1 UEFI driver signing**\n\n    UEFI Drivers must be signed by a CA or key in the db as described elsewhere in the document, or have the hash of the driver image included in db. Microsoft will be providing a UEFI driver signing service similar to the WHQL driver signing service using the **Microsoft Corporation UEFI CA 2011**. Any drivers signed by this will run seamlessly on any PCs that include the Microsoft UEFI CA. It is also possible for an OEM to sign trusted drivers and include the OEM CA in the db, or to include hashes of the drivers in the db. In all cases a UEFI driver (Option ROM) shall not execute if it is not trusted in the db.\n\n    Any drivers that are included in the system firmware image do not need to be re-verified. Being part of the overall system image provides sufficient assurance that the driver is trusted on the PC.\n\n    Microsoft has this made available to anyone who wants to sign UEFI drivers. This certificate is part of the Windows HCK Secure Boot tests.\n\n-   **2.4.2 Boot loaders**\n\n    The Microsoft UEFI driver signing certificate can be used for signing other OSs. For example, Fedora’s Linux boot loader will be signed by it.\n\n    This solution doesn’t require any more certificates to be added to the key Db. In addition to being cost effective, it can be used for any Linux distribution. This solution would work for any hardware which supports Windows so it is useful for a wide range of hardware.\n\n    The UEFI-CA can be downloaded from here: <http://go.microsoft.com/fwlink/p/?LinkID=321194>. The following links have more information on Windows HCK UEFI signing and submission:\n\n    -   [Windows Dev Center Hardware Dashboard](http://go.microsoft.com/fwlink/p/?LinkID=321287)\n\n    -   [Windows Certification Dashboard Administration](http://go.microsoft.com/fwlink/?LinkId=321286)\n\n    -   [UEFI Firmware Signing](http://go.microsoft.com/fwlink/?LinkId=321285)\n\n    -   [Windows Hardware Certification blog: UEFI signing CA update](http://go.microsoft.com/fwlink/p/?linkid=398267)\n\n## <span id=\"SummaryAndResources\"></span><span id=\"summaryandresources\"></span><span id=\"SUMMARYANDRESOURCES\"></span>3. Summary and Resources\n\n\nThis section intends to summarize the above sections and show a step by step approach:\n\n1.  **Establish a secure CA or identify a partner to securely generate and store keys**\n\n    If you are not using a 3rd party solution:\n\n    1.  **Install and configure the HSM software on the HSM server.** Check your HSM reference manual for installation instructions. The server will either be connected to a standalone or network HSM.\n\n        For info about HSM configuration, see Section 2.2.1, 2.3 and Appendix C.\n\n        Most HSMs offer FIPS 140-2 level 2 and 3 compliance. Configure the HSM for either level 2 or level 3 compliance. Level 3 compliance has stricter requirements around authentication and key access and hence is more secure. Level 3 is recommended.\n\n    2.  **Configure HSM for High Availability, Backup and Authentication.** Check your HSM reference manual.\n\n        Follow HSM provider guidelines on setting up HSM for High Availability and backup.\n\n        Also, Network HSMs typically have multiple network ports to segregate traffic; allowing a server to communicate with network HSMs on a network separate from the regular production network.\n\n        Once team members who are part of the security team have been identified and tokens assigned to them. You will need to setup HSM hardware for k-of-m authentication.\n\n    3.  **Secure Boot Keys and certificate pre-generation.** See Sections 1.3 to 1.5\n\n        Use HSM APIs to pre-generate (generate in advance) the PK and Firmware Update Key and certificates.\n\n        Required - PK (recommend 1 per model), Firmware Update key (recommend 1 per model), Microsoft KEK, Db, DbxNOTE: The Microsoft KEK, db, and dbx don’t have to be generated by the OEM and are mentioned for completeness.Optional - OEM/3rd party KEK db, dbx and any other keys which would go into OEM Db.\n\n2.  **Apply a Windows image to the PC.**\n\n3.  **Install Microsoft db and dbx**. See Section 1.3.6 and [Appendix B – Secure Boot APIs](#securebootapis).\n\n    1.  Install the **Microsoft Windows Production PCA 2011** into db.\n\n    2.  Install an empty dbx if Microsoft does not provide one.\n\n    **Note**  \n    Use PowerShell cmdlets which are part of the Windows HCK tests or use methods provided by BIOS vendor.\n\n     \n\n4.  **Install Microsoft KEK**. See Section 1.3.3.\n\n    Install Microsoft KEK into the UEFI KEK database\n\n    **Caution**  \n    Use PowerShell cmdlets which are part of the Windows HCK tests or use methods provided by BIOS vendor.\n\n     \n\n5.  **Optional step - OEM/3rd party secure boot components**. See Section 1.3.4 and 1.4.\n\n    1.  Identify if you have need for creating a OEM/3rd party KEK, db and dbx.\n\n    2.  Sign OEM/3rd party db and dbx with OEM/3rd party KEK(generated earlier) using HSM API.\n\n    3.  Install OEM/3rd party KEK, db and dbx.\n\n6.  **UEFI driver signing** – See Section 2.4.\n\n    If supporting add-in cards or other UEFI drivers/apps/bootloaders, install **Microsoft Corporation UEFI CA 2011** into UEFI db.\n\n7.  **Secure boot firmware update key** - See Section 1.3.5.\n\n    1.  Non-Windows RT PCs only: Install the Secure firmware update public key or its hash to save space.\n\n    2.  On SoC only, you may need to do something different, for example, burn Secure firmware update key: public or its hash.\n\n8.  **Enabling Secure Boot**. See [Appendix B – Secure Boot APIs](#securebootapis).\n\n    1.  Install the OEM/ODM PKpub (certificate preferred, but key is okay) into the UEFI PK.\n\n    2.  Enroll the PK using Secure Boot API. The PC should be now enabled for Secure Boot.\n\n    **Note**  \n    If you install the PK at the end, the MS KEK, db, dbx don’t need to be signed – no SignerInfo must be present. This is a shortcut.\n\n     \n\n9.  **Testing Secure Boot**: Execute any proprietary tests and Windows HCK tests as per instructions. See [Appendix B – Secure Boot APIs](#securebootapis).\n\n10. **Ship platform**: The PKpriv will likely never be used again, keep it safe.\n\n11. **Servicing**: Future firmware updates are securely signed with the Secure Firmware Update “private” key using the signing service.\n\n### <span id=\"3.1_Resources\"></span><span id=\"3.1_resources\"></span><span id=\"3.1_RESOURCES\"></span>3.1 Resources\n\nSecurity Strategies White Paper - <http://go.microsoft.com/fwlink/p/?linkid=321288>\n\nWindows HCK Submission -<http://go.microsoft.com/fwlink/p/?linkid=321287>\n\n## <span id=\"SecureBootPKIChecklist\"></span><span id=\"securebootpkichecklist\"></span><span id=\"SECUREBOOTPKICHECKLIST\"></span>Appendix A – Secure Boot PKI checklist for manufacturing\n\n\nBelow is a high-level checklist summarizing the steps needed for enabling Secure Boot on non-Windows RT PCs.\n\n**Setting up Secure Boot**\n\n1.  Define security strategy (identify threats, define proactive and reactive strategy) as per the white paper in section 4.\n\n2.  Identify security team as per the white paper in section 4.\n\n3.  Establish a secure CA or identify a partner (recommended solution) to securely generate and store keys.\n\n4.  Identify policy for how frequently you will be rekeying keys. This may depend on if you have any special customer requirements like governments or other agencies.\n\n5.  Have a contingency plan in case the Secure Boot Key is compromised.\n\n6.  Identify how many PK and other keys will you be generating as per section 1.3.3 and 1.5.\n\n    This will be based on customer base, key storage solution and security of PCs.\n\n    You can skip steps 7-8 if you are using the recommended solution of using a 3rd party for key management.\n\n7.  Procure server and hardware for key management. – network or standalone HSM per section 2.2.1. Consider whether you will need one or several HSMs for high availability and your key back up strategy.\n\n8.  Identify at least 3-4 team members who will have an authentication token for authentication on HSM.\n\n9.  Use HSM or 3rd party to pre-generate Secure Boot-related keys and certificates. The keys will depend on the PC type: SoC, Windows RT or non-Windows RT. For more info, see Sections 1.3 through 1.5.\n\n10. Populate the firmware with the appropriate keys.\n\n11. Enroll the Secure Boot Platform Key to enable Secure Boot. See Appendix B for more details.\n\n12. Execute any proprietary tests and HCK Secure Boot tests as per instructions. See Appendix B for more details.\n\n13. Ship the PC. The PKpriv will likely never be used again, keep it safe.\n\n**Servicing (Updating firmware)**\n\nYou may need to update firmware for several reasons such as updating an UEFI component or fixing Secure Boot key compromise or periodic rekeying of Secure Boot keys.\n\nFor more info, see Section 1.3.5 and section 1.3.6.\n\n## <span id=\"SecureBootAPIs\"></span><span id=\"securebootapis\"></span><span id=\"SECUREBOOTAPIS\"></span>Appendix B – Secure Boot APIs\n\n\n1.  **Secure Boot API**\n\n    The following APIs are related to UEFI/Secure Boot:\n\n    1.  [GetFirmwareEnvironmentVariableEx](http://go.microsoft.com/fwlink/?LinkId=398262): Retrieves the value of the specified firmware environment variable.\n\n    2.  [SetFirmwareEnvironmentVariableEx](http://go.microsoft.com/fwlink/?LinkId=398263): Sets the value of the specified firmware environment variable.\n\n    3.  [GetFirmwareType](http://go.microsoft.com/fwlink/?LinkId=398264): Retrieves the firmware type.\n\n2.  **Setting PK**\n\n    Use the Set-SecureBootUEFI cmdlet to turn on Secure Boot. After your code sets the PK, system enforcement of Secure Boot does not take effect until the next reboot. Prior to the reboot, your code could call GetFirmwareEnvironmentVariableEx() or the PowerShell cmdlet: Get-SecureBootUEFI to confirm the contents of the Secure Boot databases.\n\n3.  **Verification**\n\n    You can use Msinfo32.exe or PowerShell cmdlets to check Secure Boot variable state. There is no WMI interface. You could also test by having someone insert an incorrectly-signed bootable USB stick (for example, from the Windows HCK Secure Boot Manual Logo Test) and verify that it fails to boot.\n\n4.  **Secure Boot Powershell Cmdlets**\n\n    -   **Confirm-SecureBootUEFI**: Is UEFI Secure Boot “ON”, True or False?\n\n        SetupMode == 0 && SecureBoot == 1\n\n    -   **Set-SecureBootUEFI**: Set or Append authenticated SecureBoot UEFI variables\n\n    -   **Get-SecureBootUEFI**: Get authenticated SecureBoot UEFI variable values\n\n    -   **Format-SecureBootUEFI**: Creates EFI\\_SIGNATURE\\_LISTs & EFI\\_VARIABLE\\_AUTHENTICATION\\_2 serializations\n\n5.  **Windows HCK and Secure Boot Instructions**\n\n    The following steps apply to system tests and non-class driver PC tests.\n\n    1.  Disable Secure Boot protections.\n\n        Enter your BIOS configuration and disable Secure Boot.\n\n    2.  Install the HCK Client software.\n\n    3.  Run all of the Windows HCK tests, except for the following:\n\n        -   BitLocker TPM and Recovery password tests with PCR\\[7\\]\n\n        -   BitLocker TPM and Recovery password tests for ARM PCs with Secure Boot\n\n        -   Secure Boot Logo Test\n\n        -   Secure Boot Manual Logo Test\n\n    4.  Enter your BIOS configuration, enable Secure Boot, and restore Secure Boot to the Default configuration.\n\n    5.  Run the following BitLocker and Secure Boot tests:\n\n        -   BitLocker TPM and Recovery password tests with PCR\\[7\\]\n\n        -   BitLocker TPM and Recovery password tests for ARM PCs with Secure Boot\n\n        -   Secure Boot Logo Test (automated)\n\n    6.  Enter the BIOS configuration and clear the Secure Boot configuration. This restores the PC to Setup Mode by deleting PK and other keys.\n\n        **Note**  \n        Support for clearing is required for x86/x64 PCs.\n\n         \n\n    7.  Run the Secure Boot Manual Logo Test.\n\n        **Note**  \n        Secure Boot requires Windows HCK signed or VeriSign drivers on non-Windows RT PCs\n\n         \n\n6.  **Windows HCK Secure Boot Logo Test (automated)**\n\n    This test will check for proper out-of-box Secure Boot configuration. This includes:\n\n    -   Secure Boot is Enabled.\n\n    -   The PK is not a known, test PK.\n\n    -   KEK contains the production Microsoft KEK.\n\n    -   db contains the production Windows CA.\n\n    -   dbx present.\n\n    -   Many 1kB variables are created/deleted.\n\n    -   A 32kB variable is created/deleted.\n\n7.  **Windows HCK Secure Boot manual test folder layout**\n\n    The Windows HCK Secure Boot Manual Logo test folder layout is described below:\n\n    -   `“\\Test”` folder has the following:\n\n        -   Manufacturing and Servicing Test\n\n        -   Programmatically Enable Secure Boot in test configuration\n\n        -   Servicing Tests\n\n        -   Append a cert to db, verify function\n\n        -   Append a hash to dbx, verify function\n\n        -   Append a cert to dbx, verify function\n\n        -   Append 600+ hashes to dbx, verify size\n\n        -   Programmatically change the PK\n\n    -   `“\\Generate”` folder has scripts which show the following:\n\n        -   How test certificates were created\n\n        -   The test certificates and private keys are included\n\n        -   How all of the tests were created\n\n        -   Turning certificates and hashes into signed packages\n\n        -   You can run this yourself, substitute your own certificates\n\n    -   `“\\certs”` folder has all of the certificates you need to boot Windows:\n\n        **Note**  \n        Please don’t use the methodology used in “ManualTests\\\\generate\\\\TestCerts” to generate keys and certificates. This is meant for Windows HCK test purposes only. It uses keys which are stored on disk which is very insecure and not recommended. This is not meant for use in a production environment.\n\n         \n\n    -   `“ManualTests\\example\\OutOfBox”` folder has scripts which you can leverage for installation of Secure Boot on production PCs.\n\n        The “ManualTests\\\\generate\\\\tests\\\\subcreate\\_outofbox\\_example.ps1” demonstrates how these examples were generated and have “TODO” sections when a partner can substitute their PK and other metadata.\n\n8.  **Windows HCK UEFI signing and submission**\n\n    The following links have more information:\n\n    -   [Hardware Developer Center Dashboard](http://go.microsoft.com/fwlink/p/?linkid=321287)\n\n    -   [UEFI Firmware Signing](http://go.microsoft.com/fwlink/p/?linkid=321285)\n\n    -   [Windows Certification Dashboard Administration](http://go.microsoft.com/fwlink/p/?linkid=321286)\n\n    -   [Windows Hardware Certification blog: Microsoft UEFI CA Signing policy updates](http://go.microsoft.com/fwlink/?LinkId=398267)\n\n## <span id=\"FBCACertificatePolicyAssuranceMappings\"></span><span id=\"fbcacertificatepolicyassurancemappings\"></span><span id=\"FBCACERTIFICATEPOLICYASSURANCEMAPPINGS\"></span>Appendix C – Federal Bridge Certification Authority Certificate Policy Assurance Mappings\n\n\n1.  **Rudimentary**\n\n    This level provides the lowest degree of assurance concerning identity of the individual. One of the primary functions of this level is to provide data integrity to the information being signed. This level is relevant to environments in which the risk of malicious activity is considered to be low. It is not suitable for transactions requiring authentication, and is generally insufficient for transactions requiring confidentiality, but may be used for the latter where certificates having higher levels of assurance are unavailable.\n\n2.  **Basic**\n\n    This level provides a basic level of assurance relevant to environments where there are risks and consequences of data compromise, but they are not considered to be of major significance. This may include access to private information where the likelihood of malicious access is not high. It is assumed at this security level that users are not likely to be malicious.\n\n3.  **Medium**\n\n    This level is relevant to environments where risks and consequences of data compromise are moderate. This may include transactions having substantial monetary value or risk of fraud, or involving access to private information where the likelihood of malicious access is substantial.\n\n4.  **High**\n\n    This level is appropriate for use where the threats to data are high, or the consequences of the failure of security services are high. This may include very high value transactions or high levels of fraud risk.\n\n## <span id=\"related_topics\"></span>Related topics\n\n\n[Secure Boot Key Generation and Signing Using HSM (Example)](secure-boot-key-generation-and-signing-using-hsm--example.md)\n\n[UEFI Validation Option ROM Validation Guidance](uefi-validation-option-rom-validation-guidance.md)\n\n[Secure Boot Overview](secure-boot-overview.md)\n\n \n\n \n\n\n\n\n\n\n"}
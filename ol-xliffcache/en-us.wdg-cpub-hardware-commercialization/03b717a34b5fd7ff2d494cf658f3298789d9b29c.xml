{"nodes":[{"content":"UEFI Validation Option ROM Guidance","pos":[34,69]},{"content":"UEFI Validation Option ROM Guidance","pos":[176,211]},{"content":"UEFI Validation Option ROM Guidance","pos":[219,254]},{"pos":[257,320],"content":"Vishal Manan, Architect, OEM Consulting, <bpt id=\"p1\">&lt;</bpt>vmanan@microsoft.com<ept id=\"p1\">&gt;</ept>"},{"pos":[322,436],"content":"Jeremiah Cox, Sr. SDET, Windows Security &amp; Identity Team, <bpt id=\"p1\">[</bpt>jerecox@microsoft.com<ept id=\"p1\">](mailto:%20jerecox@microsoft.com)</ept>"},{"pos":[438,553],"content":"Tony Lin, Engineering Service Engineer, TW-WIN Plan Ecosystem, <bpt id=\"p1\">[</bpt>tolin@microsoft.com<ept id=\"p1\">](mailto:%20tolin@microsoft.com)</ept>"},{"content":"Version 1.3","pos":[555,566]},{"content":"This document helps OEMs and ODMs validate that their firmware checks the signatures of its option ROM as part of the Secure Boot chain of trust.","pos":[568,713]},{"content":"This guide assumes you know the fundamentals of UEFI, basic understanding of Secure Boot (Chapters 1, 2, 13, 20 and 27 of the UEFI specification), and PKI security model.","pos":[715,885]},{"content":"On this page:","pos":[887,900]},{"content":"Introduction","pos":[907,919]},{"content":"1. UEFI and Option ROMs","pos":[942,965]},{"content":"2. Problem statement","pos":[993,1013]},{"content":"3. Who is affected?","pos":[1040,1059]},{"content":"4. How to test for it?","pos":[1083,1105]},{"content":"5. How to fix it","pos":[1130,1146]},{"content":"6. Resources","pos":[1167,1179]},{"content":"Appendix A: Alternate approach to testing using unsigned option ROM drivers","pos":[1199,1274]},{"content":"Appendix B: Scripts for enabling Secure Boot with NULL db","pos":[1340,1397]},{"pos":[1537,1549],"content":"Introduction"},{"content":"Option ROMs (or OpROMs) are firmware run by the PC BIOS during platform initialization.","pos":[1552,1639]},{"content":"They are usually stored on a plug-in card, though they can reside on the system board.","pos":[1640,1726]},{"content":"Devices that typically require option ROMs are video cards, network adapters, and storage drivers for RAID modules.","pos":[1728,1843]},{"content":"These option ROMs also typically provide firmware drivers to the PC.","pos":[1844,1912]},{"content":"They include a variety of types of firmware drivers, including legacy PC-AT, Open Firmware, and EFI option ROMs.","pos":[1914,2026]},{"content":"Examples of firmware drivers include Video BIOS on video cards, PXE boot drivers for Ethernet adapters, and storage drivers on RAID controllers.","pos":[2027,2171]},{"content":"These devices typically have Option ROMs that provide firmware drivers.","pos":[2172,2243]},{"content":"The Unified Extensible Firmware Interface (UEFI) has support for Legacy mode option ROMs.","pos":[2245,2334]},{"content":"As per latest UEFI specification (currently at 2.3.1 Errata C – section 2.5.1.2), ISA (legacy) option ROMs are not a part of the UEFI Specification.","pos":[2336,2484]},{"content":"For the purposes of this discussion, only PCI-based UEFI-compatible option ROMs will be considered.","pos":[2485,2584]},{"content":"Option ROMs can be used when it's not be possible to embed a device's firmware in the PC firmware.","pos":[2586,2684]},{"content":"When the option ROM carries the driver, the IHV can leverage that driver, and keep the driver and device in one place.","pos":[2685,2803]},{"content":"This document talks about why you need to validate option ROMs and shows some techniques of doing it.","pos":[2805,2906]},{"pos":[3092,3133],"content":"Supporting both UEFI BIOS and Legacy BIOS"},{"content":"Many manufacturers create devices that include option ROMs and firmware for many types of PCs.","pos":[3135,3229]},{"content":"Common combos include:","pos":[3230,3252]},{"content":"Legacy ROM Only","pos":[3258,3273]},{"content":"UEFI Native OpROM","pos":[3279,3296]},{"content":"Legacy ROM + UEFI EBC OpROM","pos":[3302,3329]},{"content":"Legacy ROM + UEFI x64 OpROM","pos":[3335,3362]},{"content":"Legacy ROM + UEFI x64 + UEFI IA32","pos":[3368,3401]},{"content":"Legacy ROM + UEFI x64 + UEFI IA32 + UEFI EBC OpROM","pos":[3407,3457]},{"content":"UEFI BIOS can load and execute legacy firmware drivers when a Compatibility Support Module (CSM) is enabled.","pos":[3459,3567]},{"content":"Note that when Secure Boot is enabled, execution of the Compatibility Support Module and legacy ROMs is prohibited because legacy firmware drivers do not support authentication.If the Option ROM format in the BIOS configuration is set to legacy ROM, it will always use the legacy ROM on the device.","pos":[3568,3866]},{"pos":[3868,4005],"content":"If the Option ROM format is set to <bpt id=\"p1\">**</bpt>UEFI Compatible<ept id=\"p1\">**</ept>, it will use the newer EFI ROM if one is present and the legacy ROM if one is not."},{"content":"UEFI drivers are necessary for many of the new firmware level security features as well as to enable UEFI boot sequences.","pos":[4007,4128]},{"content":"For example, installing Windows from an optical disk which is attached to a non-UEFI compatible storage controller is not possible when a system is booting in UEFI mode when Secure Boot is enabled.","pos":[4129,4326]},{"pos":[4439,4462],"content":"1. UEFI and Option ROMs"},{"content":"diagram of uefi driver considerations","pos":[4467,4504]},{"content":"Figure 2: UEFI Driver Security Consideration, Source: UEFI 2.3.1 Errata C","pos":[4569,4642]},{"content":"From Section 31.1.4 from the UEFI 2.3.1 Errata C:","pos":[4647,4696]},{"content":"Since the UEFI user profile details a number of security-related privileges, it is important that the User Identity Manager and User Credential Providers and the environment in which they execute are trusted.","pos":[4700,4908]},{"content":"This includes:","pos":[4910,4924]},{"content":"Protecting the storage area where these drivers are stored.","pos":[4930,4989]},{"content":"Protecting the means by which these drivers are selected.","pos":[4995,5052]},{"content":"Protecting the execution environment of these drivers from unverified drivers.","pos":[5058,5136]},{"content":"The data structures used by these drivers should not be corrupted by unauthorized drivers while they are still being used.","pos":[5142,5264]},{"content":"Components like User Identity Manager, the User Credential drivers and on board drivers maybe located in a secure location like write-protected flash drive which is trusted by platform policy.","pos":[5266,5458]},{"content":"Some other drivers may reside on an unprotected storage locations like option ROMs or a hard drive partition and may be easily replaced.","pos":[5460,5596]},{"content":"These drivers must be verified.","pos":[5597,5628]},{"content":"For example, either the default platform policy must successfully be able to verify drivers listed in the Driver<ph id=\"ph1\">\\#\\#\\#\\#</ph> load options, or else the user must be identified prior to processing these drivers.","pos":[5630,5835]},{"content":"Otherwise, the driver execution should be deferred.","pos":[5836,5887]},{"content":"If the user profile is changed through a subsequent call to Identify () or through dynamic authentication, the Driver<ph id=\"ph1\">\\#\\#\\#\\#</ph> options may not be processed again.","pos":[5888,6049]},{"content":"The user profile database is closed using different UEFI signal events based on whether it can be protected.","pos":[6051,6159]},{"content":"UEFI Drivers &amp; UEFI option ROMs will only be executed for devices in the boot path.","pos":[6161,6244]},{"content":"PCI spec allows multiple option ROM images on the same device.","pos":[6246,6308]},{"content":"These option ROMS could be Legacy x86 &amp; UEFI.","pos":[6309,6354]},{"content":"UEFI firmware sets platform policy for picking the option ROM.","pos":[6355,6417]},{"content":"That can make the optional adapter's ROM execute as its own control device.","pos":[6418,6493]},{"content":"The firmware verifies signatures during BDS and DXE phases.","pos":[6495,6554]},{"content":"The sequence of events is as follows:","pos":[6555,6592]},{"content":"Initialize PCI and derivative Buses","pos":[6598,6633]},{"content":"Probe PCI Devices for option ROMs","pos":[6639,6672]},{"content":"Found option ROMs are mapped in memory","pos":[6678,6716]},{"content":"DXE phase loads any UEFI drivers in ROMs","pos":[6722,6762]},{"content":"UEFI option ROMs can be anywhere in memory.","pos":[6764,6807]},{"content":"The default is to let the ROM on the card manage the device.","pos":[6808,6868]},{"content":"UEFI allows platform to control policy around what option ROM controls what device using EFI<ph id=\"ph1\">\\_</ph>PLATFORM<ph id=\"ph2\">\\_</ph>DRIVER<ph id=\"ph3\">\\_</ph>OVERRIDE.","pos":[6869,6990]},{"content":"UEFI supports option ROMs to register a configuration interface.","pos":[6991,7055]},{"content":"On a PC with Secure Boot enabled, option ROM drivers pose a security threat if they are not signed or not validated.","pos":[7057,7173]},{"content":"Signature validation for option ROMs is a WHCK requirement.","pos":[7174,7233]},{"content":"The same is true while servicing option ROMs to make sure that the update is validated prior to installation.","pos":[7234,7343]},{"content":"From the UEFI 2.3.1 Eratta C specification:","pos":[7345,7388]},{"content":"Mandatory.","pos":[7393,7403]},{"content":"<bpt id=\"p1\">**</bpt>Signed Firmware Code Integrity Check<ept id=\"p1\">**</ept>.","pos":[7404,7445]},{"content":"Firmware that is installed by the OEM and is either read-only or protected by a secure firmware update process, as defined above, may be considered protected.","pos":[7446,7604]},{"content":"<bpt id=\"p1\">**</bpt>Systems shall verify that all unprotected firmware components, UEFI drivers, and UEFI applications are sigend using minimum RSA-2048 with SHA-256 (MD5 and SHA-1 are prohibited)<ept id=\"p1\">**</ept>, and verify that UEFI applications and drivers that are not signed as per these requirements will fail to run (this is the default policy for acceptable signature algorithms).","pos":[7605,7961]},{"content":"If an images signature is not found in the authorized database, or is found in the forbidden database, the image must not be started, and instead, information about it shall be placed in the Image Execution Information Table.11.","pos":[7962,8190]},{"content":"Mandatory.","pos":[8191,8201]},{"content":"Verify Signature of all Boot Apps and Boot Loaders.","pos":[8204,8255]},{"content":"Upon power-on, the platform shall start executing boot firmware and use public key cryptography as per algorithm policy to verify the signatures of all images in the boot sequence up-to and including the Windows Boot Manager.","pos":[8258,8483]},{"pos":[8593,8613],"content":"2. Problem statement"},{"content":"Some builds of Secure Boot-enabled UEFI BIOS, including Tiano Core, did not by default authenticate UEFI option ROMs because signed UEFI option ROMs were not available during Secure Boot development.","pos":[8616,8815]},{"content":"This exposes an attack surface/vulnerability in UEFI Secure Boot.","pos":[8816,8881]},{"content":"2.1.","pos":[8998,9002]},{"content":"Vulnerability","pos":[9003,9016]},{"content":"This vulnerability was still present in EDK II and UDK2010 as of August 2013.","pos":[9018,9095]},{"content":"The source maintainers are aware of the issue and a bug is filed.","pos":[9096,9161]},{"content":"Any firmware derived from EDK II and UDK2010 should verify how Option ROM verification is managed.","pos":[9162,9260]},{"content":"Option ROM verification behavior is controlled by a PCD value <ph id=\"ph1\">`PcdOptionRomImageVerificationPolicy`</ph> in the EDK II SecurityPkg package.","pos":[9261,9395]},{"content":"The source code for the TianoCore vulnerability is SecurityPkg<ph id=\"ph1\">\\\\</ph>SecurityPkg.dec file:","pos":[9397,9482]},{"content":"The default value (0x00) is ALWAYS<ph id=\"ph1\">\\_</ph>EXECUTE, which does not properly perform verification of signed drivers in Option ROMs for add-in peripherals.","pos":[9982,10128]},{"content":"This is not an ideal value for any system implementing UEFI Secure Boot functionality.","pos":[10129,10215]},{"pos":[10217,10251],"content":"Recommended Value (Best Security):"},{"pos":[10297,10334],"content":"Recommended Value (Best Flexibility):"},{"content":"In EDK II &amp; UDK2010, proper coding practice uses an override mechanism to modify PCD values for platform firmware.","pos":[10378,10492]},{"content":"Therefore, the value for <ph id=\"ph1\">`PcdOptionRomImageVerificationPolicy`</ph> should not be changed in <ph id=\"ph2\">`SecurityPkg\\SecurityPkg.dec`</ph>.","pos":[10493,10611]},{"content":"The override value should be set in the platform’s DSC file.","pos":[10612,10672]},{"content":"An example is shown below using Nt32Pkg<ph id=\"ph1\">\\\\</ph>Nt32Pkg.dsc:","pos":[10673,10726]},{"content":"The PCD override should be placed under the <ph id=\"ph1\">`[PcdsFixedAtBuild]`</ph> section of the DSC file.","pos":[10834,10923]},{"content":"The exact mechanism for overriding parameters may differ depending on BIOS vendor tools.","pos":[10924,11012]},{"content":"Note","pos":[11016,11020]},{"content":"This vulnerability may exist in early implementations of UEFI Secure Boot BIOS from independent BIOS vendors.","pos":[11025,11134]},{"content":"Contact your BIOS vendor to determine if your version may be impacted.","pos":[11135,11205]},{"pos":[11309,11328],"content":"3. Who is affected?"},{"content":"A UEFI PC which implements Secure Boot and has a UEFI option ROM driver which is not signed.","pos":[11331,11423]},{"content":"Furthermore, the firmware for compatibility to get the existing cards working may have a security vulnerability which doesn’t verify option ROMs.","pos":[11424,11569]},{"content":"<bpt id=\"p1\">**</bpt>Laptops, netbooks, ultrabooks, &amp; tablets: most are not affected<ept id=\"p1\">**</ept>.","pos":[11571,11639]},{"content":"Option ROMs are typically present on backplane buses such as PCI/e, ISA, and their derivatives (ExpressCard, miniPCI, CardBus, PCCard, LPC, ThunderBolt etc).","pos":[11640,11797]},{"content":"If a laptop has none of these exposed, then its attack surface is greatly reduced.","pos":[11798,11880]},{"content":"Moreover, it is likely UEFI drivers for onboard laptop components are integrated into the core BIOS firmware volume, not located on a separate option ROM.","pos":[11881,12035]},{"content":"Thus most laptops are not at risk.","pos":[12036,12070]},{"content":"Also, when Legacy option ROMs are disabled, it looks like UEFI only supports PCI-based option ROMs.","pos":[12071,12170]},{"content":"However, if you have a desktop, motherboard or a server which has a UEFI BIOS and implement Secure Boot, you may be affected.","pos":[12172,12297]},{"content":"On a server’s dedicated RAID controller, or add-in storage controller for SATA, FC etc. or Ethernet PCIe network cards may have option ROMs.","pos":[12298,12438]},{"content":"Add-in controllers supporting a wide array of functionality on servers are common so this especially applies to the server space.","pos":[12439,12568]},{"content":"This can potentially affect 32-bit and 64-bit PCs, both class 2 and class 3.","pos":[12570,12646]},{"content":"If a Secure Boot platform supports option ROMs from devices not permanently attached to the platform and it supports the ability to authenticate those option ROMs, then it must support the option ROM validation methods described in Network Protocols — UDP and MTFTP and the authenticated EFI variables described in UEFI specification 2.3.1 Errata C Section 7.2.","pos":[12648,13009]},{"pos":[13113,13135],"content":"4. How to test for it?"},{"content":"If you are developing the firmware and it is based on Tiano Core please check for vulnerability mentioned in the section 2.1.","pos":[13138,13263]},{"content":"If you are using another IBV’s firmware please check with them.","pos":[13264,13327]},{"content":"Or you could do the test it yourself as mentioned below.","pos":[13328,13384]},{"content":"You will need the following:","pos":[13386,13414]},{"content":"PC under test with UEFI firmware","pos":[13420,13452]},{"content":"PCI device with Option ROM on the PC under test (like a video card)","pos":[13458,13525]},{"content":"Make sure Secure Boot is enabled","pos":[13531,13563]},{"content":"Steps for testing:","pos":[13565,13583]},{"content":"Insert a UEFI add on PCI card with UEFI Option ROM to the PC under test.","pos":[13589,13661]},{"content":"If you are using a PCI video card for testing, hookup an external monitor.","pos":[13667,13741]},{"content":"Enable Secure Boot with the settings below:","pos":[13747,13790]},{"content":"PK: Your PK or self-signed Test PK","pos":[13800,13834]},{"content":"KEK: MS KEK, PK-signed Fabrikam test KEK or another KEK","pos":[13844,13899]},{"content":"DB: NULL.","pos":[13909,13918]},{"content":"(This must be NULL.)","pos":[13919,13939]},{"content":"DBX: NULL.","pos":[13949,13959]},{"content":"SecureBoot: The UEFI variable should be set to true","pos":[13969,14020]},{"content":"Reboot the PC","pos":[14026,14039]},{"content":"Expect the following result:","pos":[14045,14073]},{"content":"If the UEFI firmware is implemented correctly, the UEFI option ROM driver wouldn’t load since the presence of an option ROM will make the firmware check the “Db” for a certificate.","pos":[14083,14263]},{"content":"Since the “Db” is NULL the UEFI driver will fail to load.","pos":[14264,14321]},{"content":"For example, if you are using the video card to test, you will see that nothing shows up on display.","pos":[14322,14422]},{"content":"If the firmware isn’t implemented correctly, UEFI driver will load from the option ROM since the firmware doesn’t check for signatures in “Db”.","pos":[14432,14575]},{"content":"For example, if you are using the video card for test, you will see that the monitor hooked to the option ROM card will have display.","pos":[14576,14709]},{"content":"Note","pos":[14713,14717]},{"content":"It doesn’t matter if the UEFI option ROM driver is signed or not, the option ROM will not load when DB is null and SB is enabled (PK and KEK are enrolled).","pos":[14722,14877]},{"content":"Please refer to sample scripts available in the WHCK for generating the PK and KEK.","pos":[14882,14965]},{"content":"You can download the scripts from here: <bpt id=\"p1\">&lt;</bpt>http://go.microsoft.com/fwlink/?LinkId=321292<ept id=\"p1\">&gt;</ept> .","pos":[14966,15055]},{"content":"Appendix B has sample scripts and more details.","pos":[15056,15103]},{"content":"You can also reference Appendix A for another approach to performing the above test.","pos":[15105,15189]},{"content":"This approach doesn’t require setting the DB to Null but needs an unsigned UEFI option ROM driver from the IHV.","pos":[15190,15301]},{"pos":[15393,15409],"content":"5. How to fix it"},{"content":"If the above test fails, work with your IBV to acquire the necessary versions and configure them to validate option ROMs.","pos":[15412,15533]},{"content":"Make sure that the firmware passes the test.","pos":[15534,15578]},{"content":"For PCs which have shipped you will need to do a secure firmware update.","pos":[15579,15651]},{"content":"Please refer to <bpt id=\"p1\">[</bpt>NIST publication 800-147<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=321186)</ept> and/or see <bpt id=\"p2\">[</bpt>Windows 8.1 Secure Boot Key Creation and Management Guidance<ept id=\"p2\">](windows-secure-boot-key-creation-and-management-guidance.md)</ept>.","pos":[15652,15879]},{"content":"You can test the PC and leverage Windows HCK as a test tool (not a certification tool) for testing the secure firmware update.","pos":[15881,16007]},{"content":"5.1.","pos":[16139,16143]},{"content":"Signing the driver","pos":[16144,16162]},{"content":"In case you find that you may have unsigned drivers on UEFI option ROMs please read below on how to fix that.","pos":[16164,16273]},{"content":"Sign each option ROM driver individually.","pos":[16275,16316]},{"content":"That will break the format of the PCI Option ROM.","pos":[16317,16366]},{"content":"You only need to sign the UEFI driver before creating the combined Option ROM.","pos":[16367,16445]},{"content":"Before inserting the UEFI driver in the OpROM, sign the UEFI image and test it with Secure Boot ON &amp; OFF at the UEFI Shell (load/unload the driver file).","pos":[16447,16600]},{"content":"Then put the signed driver into the combined option ROM.","pos":[16601,16657]},{"content":"You can direct your IHV to Microsoft SysDev center to get their UEFI option ROMs signed through a service available through SysDev center.","pos":[16659,16797]},{"content":"5.2.","pos":[16935,16939]},{"content":"Validation of update","pos":[16940,16960]},{"content":"Run the test you mentioned above to verify that the vulnerability does not exist.","pos":[16962,17043]},{"content":"Use the HCK tests to ensure that there are no functional regressions.","pos":[17044,17113]},{"pos":[17202,17214],"content":"6. Resources"},{"pos":[17221,17350],"content":"UEFI Platform Initialization Specification, Volume 5 Standards, 1.2.1 Errata A: <bpt id=\"p1\">&lt;</bpt>http://go.microsoft.com/fwlink/p/?linkid=220187<ept id=\"p1\">&gt;</ept>"},{"content":"Relevant info from UEFI 2.3.1 spec:","pos":[17356,17391]},{"content":"2.5.1: Legacy Option ROM Issues","pos":[17401,17432]},{"content":"10: Protocols –UEFI Driver Model","pos":[17442,17474]},{"content":"13.4.2: PCI Option ROMs","pos":[17484,17507]},{"content":"20: EFI Byte Code Virtual Machine","pos":[17517,17550]},{"content":"28: HII Overview","pos":[17560,17576]},{"content":"29: HII Protocols","pos":[17586,17603]},{"content":"30: HII Configuration Processing and Browser Protocol","pos":[17613,17666]},{"content":"UEFI Forum Learning Center","pos":[17673,17699]},{"content":"UEFI IHV resources @ intel.com","pos":[17756,17786]},{"pos":[17840,17969],"content":"Use the <bpt id=\"p1\">[</bpt>TianoCore edk2-devel mailing list<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=398276)</ept> for support from other UEFI developers"},{"pos":[17975,18094],"content":"TechNet: <bpt id=\"p1\">[</bpt>Best Practices for Enterprise Security: Security strategies<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=321288)</ept>"},{"pos":[18100,18178],"content":"<bpt id=\"p1\">[</bpt>UEFI specification<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?LinkID=220187)</ept> errata C"},{"content":"Trusted Computing Group","pos":[18185,18208]},{"content":"Tianocore UEFI Development Kit","pos":[18264,18294]},{"content":"UEFI Firmware","pos":[18349,18362]},{"content":"Intel Press: Beyond BIOS 2nd Edition","pos":[18388,18424]},{"content":"Windows 8.1 Secure Boot Key Creation and Management Guidance","pos":[18479,18539]},{"content":"Validating Windows UEFI Firmware Update Platform Functionality","pos":[18608,18670]},{"pos":[18945,19020],"content":"Appendix A: Alternate approach to testing using unsigned option ROM drivers"},{"content":"This approach relies on getting tools from IHV to make sure that the UEFI option ROM driver is signed.","pos":[19023,19125]},{"content":"You will need the following:","pos":[19127,19155]},{"content":"PC under test with UEFI firmware","pos":[19161,19193]},{"content":"PCI device with an unsigned Option ROM driver attached to the PC under test (like a Video card)","pos":[19199,19294]},{"content":"Make sure Secure Boot is enabled","pos":[19300,19332]},{"content":"Option IHV tools to detect signature on option ROM driver if it isn’t apparent that the option ROM driver is signed or not","pos":[19338,19460]},{"content":"If the firmware is implemented correctly, and the option ROM is unsigned the card should fail the check by firmware and not load the driver on the card.","pos":[19462,19614]},{"content":"The PC should report an error code such as <bpt id=\"p1\">**</bpt>EFI<ph id=\"ph1\">\\_</ph>IMAGE<ph id=\"ph2\">\\_</ph>EXECUTION<ph id=\"ph3\">\\_</ph>AUTH<ph id=\"ph4\">\\_</ph>SIG<ph id=\"ph5\">\\_</ph>FOUND<ept id=\"p1\">**</ept>.","pos":[19615,19702]},{"content":"In case you are using a video card, you may see that the PC shows just a black screen since the option ROM driver didn’t load.","pos":[19703,19829]},{"content":"If the firmware is implemented incorrectly, this test would work.","pos":[19831,19896]},{"pos":[20072,20129],"content":"Appendix B: Scripts for enabling Secure Boot with NULL db"},{"content":"You can either use your current set of Secure Boot variables (PK and KEK) or generate test ones for testing this.","pos":[20132,20245]},{"content":"Below are steps used to generate the test PK, KEK and setting Db to NULL.","pos":[20247,20320]},{"content":"Make sure that Secure Boot is not enabled; otherwise these steps would require signed UEFI bin files.","pos":[20321,20422]},{"content":"Note","pos":[20426,20430]},{"content":"We set the Secure Boot variable – Db, KEK and PK in reverse order so we don’t have to sign the UEFI bin files.","pos":[20435,20545]},{"content":"Prior to this step the PC should be in setup mode.","pos":[20550,20600]},{"content":"Create KEK and PK certificates","pos":[20608,20638]},{"pos":[20646,20765],"content":"This step requires the makecert.exe tool available in the <bpt id=\"p1\">[</bpt>Windows SDK<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=271979)</ept>."},{"content":"Script to generate test PK","pos":[21053,21079]},{"pos":[21087,21212],"content":"You can either use your own PK or leverage the scripts from the WHCK for this <bpt id=\"p1\">&lt;</bpt>http://go.microsoft.com/fwlink/?LinkId=321292<ept id=\"p1\">&gt;</ept>"},{"content":"A sample is provided below.","pos":[21218,21245]},{"content":"Generate test KEK or use your own OEM KEK","pos":[24021,24062]},{"content":"You can leverage your own OEM KEK or scripts from the WHCK for this.","pos":[24070,24138]},{"content":"You can also use the Fabrikam<ph id=\"ph1\">\\_</ph>PK<ph id=\"ph2\">\\_</ph>SigList.bin from <bpt id=\"p1\">&lt;</bpt>http://go.microsoft.com/fwlink/?LinkId=321292<ept id=\"p1\">&gt;</ept> instead of generating your own test KEK.","pos":[24139,24279]},{"content":"A sample is provided below.","pos":[24285,24312]},{"content":"Set Db to Null and set KEK and PK","pos":[26809,26842]},{"content":"The first thing this script does is set the Db to Null.","pos":[26850,26905]},{"pos":[26911,27071],"content":"**Note**  \nPlease keep in mind if the Fabrikam Test KEK CA is the only KEK CA present (meaning there is no Windows KEK CA), the PC may boot into Windows RE.","leadings":["","    "],"nodes":[{"content":"Note","pos":[2,6]},{"content":"Please keep in mind if the Fabrikam Test KEK CA is the only KEK CA present (meaning there is no Windows KEK CA), the PC may boot into Windows RE.","pos":[11,156]}]},{"content":"Plug in the option ROM card and test","pos":[27911,27947]},{"content":"The test should either pass or fail based on firmware correctness.","pos":[27955,28021]},{"content":"For example:","pos":[28022,28034]},{"content":"If the option ROM in the firmware is implemented correctly, and you are using a video card for testing, then there should be no display to the attached monitor.","pos":[28040,28200]},{"content":"However, if you are using incorrect firmware, the video card should have output on the display.","pos":[28206,28301]},{"pos":[28339,28353],"content":"Related topics"},{"content":"Windows Secure Boot Key Creation and Management Guidance","pos":[28357,28413]},{"content":"Secure Boot Overview","pos":[28478,28498]},{"content":"Validating Windows UEFI Firmware Update Platform Functionality","pos":[28527,28589]}],"content":"---\nauthor: Justinha\nDescription: UEFI Validation Option ROM Guidance\nms.assetid: 357f9a94-98dc-4f78-9f4c-25935912edd6\nMSHAttr: 'PreferredLib:/library/windows/hardware'\ntitle: UEFI Validation Option ROM Guidance\n---\n\n# UEFI Validation Option ROM Guidance\n\n\nVishal Manan, Architect, OEM Consulting, <vmanan@microsoft.com>\n\nJeremiah Cox, Sr. SDET, Windows Security & Identity Team, [jerecox@microsoft.com](mailto:%20jerecox@microsoft.com)\n\nTony Lin, Engineering Service Engineer, TW-WIN Plan Ecosystem, [tolin@microsoft.com](mailto:%20tolin@microsoft.com)\n\nVersion 1.3\n\nThis document helps OEMs and ODMs validate that their firmware checks the signatures of its option ROM as part of the Secure Boot chain of trust.\n\nThis guide assumes you know the fundamentals of UEFI, basic understanding of Secure Boot (Chapters 1, 2, 13, 20 and 27 of the UEFI specification), and PKI security model.\n\nOn this page:\n\n-   [Introduction](#introduction)\n\n-   [1. UEFI and Option ROMs](#uefiandoptionroms)\n\n-   [2. Problem statement](#problemstatement)\n\n-   [3. Who is affected?](#whoisaffected)\n\n-   [4. How to test for it?](#howtotestforit)\n\n-   [5. How to fix it](#howtofixit)\n\n-   [6. Resources](#resources)\n\n-   [Appendix A: Alternate approach to testing using unsigned option ROM drivers](#alternateapproachtotestingusingunsignedoptionromdrivers)\n\n-   [Appendix B: Scripts for enabling Secure Boot with NULL db](#scriptsforenablingsecurebootwithnulldb)\n\n## <span id=\"Introduction\"></span><span id=\"introduction\"></span><span id=\"INTRODUCTION\"></span>Introduction\n\n\nOption ROMs (or OpROMs) are firmware run by the PC BIOS during platform initialization. They are usually stored on a plug-in card, though they can reside on the system board.\n\nDevices that typically require option ROMs are video cards, network adapters, and storage drivers for RAID modules. These option ROMs also typically provide firmware drivers to the PC.\n\nThey include a variety of types of firmware drivers, including legacy PC-AT, Open Firmware, and EFI option ROMs. Examples of firmware drivers include Video BIOS on video cards, PXE boot drivers for Ethernet adapters, and storage drivers on RAID controllers. These devices typically have Option ROMs that provide firmware drivers.\n\nThe Unified Extensible Firmware Interface (UEFI) has support for Legacy mode option ROMs.\n\nAs per latest UEFI specification (currently at 2.3.1 Errata C – section 2.5.1.2), ISA (legacy) option ROMs are not a part of the UEFI Specification. For the purposes of this discussion, only PCI-based UEFI-compatible option ROMs will be considered.\n\nOption ROMs can be used when it's not be possible to embed a device's firmware in the PC firmware. When the option ROM carries the driver, the IHV can leverage that driver, and keep the driver and device in one place.\n\nThis document talks about why you need to validate option ROMs and shows some techniques of doing it.\n\n### <span id=\"Supporting_both_UEFI_BIOS_and_Legacy_BIOS\"></span><span id=\"supporting_both_uefi_bios_and_legacy_bios\"></span><span id=\"SUPPORTING_BOTH_UEFI_BIOS_AND_LEGACY_BIOS\"></span>Supporting both UEFI BIOS and Legacy BIOS\n\nMany manufacturers create devices that include option ROMs and firmware for many types of PCs. Common combos include:\n\n-   Legacy ROM Only\n\n-   UEFI Native OpROM\n\n-   Legacy ROM + UEFI EBC OpROM\n\n-   Legacy ROM + UEFI x64 OpROM\n\n-   Legacy ROM + UEFI x64 + UEFI IA32\n\n-   Legacy ROM + UEFI x64 + UEFI IA32 + UEFI EBC OpROM\n\nUEFI BIOS can load and execute legacy firmware drivers when a Compatibility Support Module (CSM) is enabled. Note that when Secure Boot is enabled, execution of the Compatibility Support Module and legacy ROMs is prohibited because legacy firmware drivers do not support authentication.If the Option ROM format in the BIOS configuration is set to legacy ROM, it will always use the legacy ROM on the device.\n\nIf the Option ROM format is set to **UEFI Compatible**, it will use the newer EFI ROM if one is present and the legacy ROM if one is not.\n\nUEFI drivers are necessary for many of the new firmware level security features as well as to enable UEFI boot sequences. For example, installing Windows from an optical disk which is attached to a non-UEFI compatible storage controller is not possible when a system is booting in UEFI mode when Secure Boot is enabled.\n\n## <span id=\"UEFIandOptionROMs\"></span><span id=\"uefiandoptionroms\"></span><span id=\"UEFIANDOPTIONROMS\"></span>1. UEFI and Option ROMs\n\n\n![diagram of uefi driver considerations](images/dep-8-secureboot-uefidriversecurityconsideration.png)\n\n*Figure 2: UEFI Driver Security Consideration, Source: UEFI 2.3.1 Errata C*\n\n**From Section 31.1.4 from the UEFI 2.3.1 Errata C:**\n\nSince the UEFI user profile details a number of security-related privileges, it is important that the User Identity Manager and User Credential Providers and the environment in which they execute are trusted.\n\nThis includes:\n\n-   Protecting the storage area where these drivers are stored.\n\n-   Protecting the means by which these drivers are selected.\n\n-   Protecting the execution environment of these drivers from unverified drivers.\n\n-   The data structures used by these drivers should not be corrupted by unauthorized drivers while they are still being used.\n\nComponents like User Identity Manager, the User Credential drivers and on board drivers maybe located in a secure location like write-protected flash drive which is trusted by platform policy.\n\nSome other drivers may reside on an unprotected storage locations like option ROMs or a hard drive partition and may be easily replaced. These drivers must be verified.\n\nFor example, either the default platform policy must successfully be able to verify drivers listed in the Driver\\#\\#\\#\\# load options, or else the user must be identified prior to processing these drivers. Otherwise, the driver execution should be deferred. If the user profile is changed through a subsequent call to Identify () or through dynamic authentication, the Driver\\#\\#\\#\\# options may not be processed again.\n\nThe user profile database is closed using different UEFI signal events based on whether it can be protected.\n\nUEFI Drivers & UEFI option ROMs will only be executed for devices in the boot path.\n\nPCI spec allows multiple option ROM images on the same device. These option ROMS could be Legacy x86 & UEFI. UEFI firmware sets platform policy for picking the option ROM. That can make the optional adapter's ROM execute as its own control device.\n\nThe firmware verifies signatures during BDS and DXE phases. The sequence of events is as follows:\n\n1.  Initialize PCI and derivative Buses\n\n2.  Probe PCI Devices for option ROMs\n\n3.  Found option ROMs are mapped in memory\n\n4.  DXE phase loads any UEFI drivers in ROMs\n\nUEFI option ROMs can be anywhere in memory. The default is to let the ROM on the card manage the device. UEFI allows platform to control policy around what option ROM controls what device using EFI\\_PLATFORM\\_DRIVER\\_OVERRIDE. UEFI supports option ROMs to register a configuration interface.\n\nOn a PC with Secure Boot enabled, option ROM drivers pose a security threat if they are not signed or not validated. Signature validation for option ROMs is a WHCK requirement. The same is true while servicing option ROMs to make sure that the update is validated prior to installation.\n\nFrom the UEFI 2.3.1 Eratta C specification:\n\n9. Mandatory. **Signed Firmware Code Integrity Check**. Firmware that is installed by the OEM and is either read-only or protected by a secure firmware update process, as defined above, may be considered protected. **Systems shall verify that all unprotected firmware components, UEFI drivers, and UEFI applications are sigend using minimum RSA-2048 with SHA-256 (MD5 and SHA-1 are prohibited)**, and verify that UEFI applications and drivers that are not signed as per these requirements will fail to run (this is the default policy for acceptable signature algorithms). If an images signature is not found in the authorized database, or is found in the forbidden database, the image must not be started, and instead, information about it shall be placed in the Image Execution Information Table.11. Mandatory. **Verify Signature of all Boot Apps and Boot Loaders.** Upon power-on, the platform shall start executing boot firmware and use public key cryptography as per algorithm policy to verify the signatures of all images in the boot sequence up-to and including the Windows Boot Manager.\n\n## <span id=\"ProblemStatement\"></span><span id=\"problemstatement\"></span><span id=\"PROBLEMSTATEMENT\"></span>2. Problem statement\n\n\nSome builds of Secure Boot-enabled UEFI BIOS, including Tiano Core, did not by default authenticate UEFI option ROMs because signed UEFI option ROMs were not available during Secure Boot development. This exposes an attack surface/vulnerability in UEFI Secure Boot.\n\n### <span id=\"2.1._Vulnerability\"></span><span id=\"2.1._vulnerability\"></span><span id=\"2.1._VULNERABILITY\"></span>2.1. Vulnerability\n\nThis vulnerability was still present in EDK II and UDK2010 as of August 2013. The source maintainers are aware of the issue and a bug is filed. Any firmware derived from EDK II and UDK2010 should verify how Option ROM verification is managed. Option ROM verification behavior is controlled by a PCD value `PcdOptionRomImageVerificationPolicy` in the EDK II SecurityPkg package.\n\nThe source code for the TianoCore vulnerability is SecurityPkg\\\\SecurityPkg.dec file:\n\n``` syntax\n## Pcd for OptionRom.\n  #  Image verification policy settings:\n  #  ALWAYS_EXECUTE                         0x00000000\n  #  NEVER_EXECUTE                          0x00000001\n  #  ALLOW_EXECUTE_ON_SECURITY_VIOLATION    0x00000002\n  #  DEFER_EXECUTE_ON_SECURITY_VIOLATION    0x00000003\n  #  DENY_EXECUTE_ON_SECURITY_VIOLATION     0x00000004\n  #  QUERY_USER_ON_SECURITY_VIOLATION       0x00000005\ngEfiSecurityPkgTokenSpaceGuid.PcdOptionRomImageVerificationPolicy|0x00|UINT32|0x00000001\n```\n\nThe default value (0x00) is ALWAYS\\_EXECUTE, which does not properly perform verification of signed drivers in Option ROMs for add-in peripherals. This is not an ideal value for any system implementing UEFI Secure Boot functionality.\n\nRecommended Value (Best Security): `DENY_EXECUTE_ON_SECURITY_VIOLATION (0x04)`\n\nRecommended Value (Best Flexibility): `QUERY_USER_ON_SECURITY_VIOLATION (0x05)`\n\nIn EDK II & UDK2010, proper coding practice uses an override mechanism to modify PCD values for platform firmware. Therefore, the value for `PcdOptionRomImageVerificationPolicy` should not be changed in `SecurityPkg\\SecurityPkg.dec`. The override value should be set in the platform’s DSC file. An example is shown below using Nt32Pkg\\\\Nt32Pkg.dsc:\n\n``` syntax\n[PcdsFixedAtBuild]\ngEfiSecurityPkgTokenSpaceGuid.PcdOptionRomImageVerificationPolicy|0x04\n```\n\nThe PCD override should be placed under the `[PcdsFixedAtBuild]` section of the DSC file. The exact mechanism for overriding parameters may differ depending on BIOS vendor tools.\n\n**Note**  \nThis vulnerability may exist in early implementations of UEFI Secure Boot BIOS from independent BIOS vendors. Contact your BIOS vendor to determine if your version may be impacted.\n\n \n\n## <span id=\"WhoIsAffected\"></span><span id=\"whoisaffected\"></span><span id=\"WHOISAFFECTED\"></span>3. Who is affected?\n\n\nA UEFI PC which implements Secure Boot and has a UEFI option ROM driver which is not signed. Furthermore, the firmware for compatibility to get the existing cards working may have a security vulnerability which doesn’t verify option ROMs.\n\n**Laptops, netbooks, ultrabooks, & tablets: most are not affected**. Option ROMs are typically present on backplane buses such as PCI/e, ISA, and their derivatives (ExpressCard, miniPCI, CardBus, PCCard, LPC, ThunderBolt etc). If a laptop has none of these exposed, then its attack surface is greatly reduced. Moreover, it is likely UEFI drivers for onboard laptop components are integrated into the core BIOS firmware volume, not located on a separate option ROM. Thus most laptops are not at risk. Also, when Legacy option ROMs are disabled, it looks like UEFI only supports PCI-based option ROMs.\n\nHowever, if you have a desktop, motherboard or a server which has a UEFI BIOS and implement Secure Boot, you may be affected. On a server’s dedicated RAID controller, or add-in storage controller for SATA, FC etc. or Ethernet PCIe network cards may have option ROMs. Add-in controllers supporting a wide array of functionality on servers are common so this especially applies to the server space.\n\nThis can potentially affect 32-bit and 64-bit PCs, both class 2 and class 3.\n\nIf a Secure Boot platform supports option ROMs from devices not permanently attached to the platform and it supports the ability to authenticate those option ROMs, then it must support the option ROM validation methods described in Network Protocols — UDP and MTFTP and the authenticated EFI variables described in UEFI specification 2.3.1 Errata C Section 7.2.\n\n## <span id=\"HowToTestForIt\"></span><span id=\"howtotestforit\"></span><span id=\"HOWTOTESTFORIT\"></span>4. How to test for it?\n\n\nIf you are developing the firmware and it is based on Tiano Core please check for vulnerability mentioned in the section 2.1. If you are using another IBV’s firmware please check with them. Or you could do the test it yourself as mentioned below.\n\nYou will need the following:\n\n-   PC under test with UEFI firmware\n\n-   PCI device with Option ROM on the PC under test (like a video card)\n\n-   Make sure Secure Boot is enabled\n\nSteps for testing:\n\n1.  Insert a UEFI add on PCI card with UEFI Option ROM to the PC under test.\n\n    If you are using a PCI video card for testing, hookup an external monitor.\n\n2.  Enable Secure Boot with the settings below:\n\n    -   PK: Your PK or self-signed Test PK\n\n    -   KEK: MS KEK, PK-signed Fabrikam test KEK or another KEK\n\n    -   DB: NULL. (This must be NULL.)\n\n    -   DBX: NULL.\n\n    -   SecureBoot: The UEFI variable should be set to true\n\n3.  Reboot the PC\n\n4.  Expect the following result:\n\n    -   If the UEFI firmware is implemented correctly, the UEFI option ROM driver wouldn’t load since the presence of an option ROM will make the firmware check the “Db” for a certificate. Since the “Db” is NULL the UEFI driver will fail to load. For example, if you are using the video card to test, you will see that nothing shows up on display.\n\n    -   If the firmware isn’t implemented correctly, UEFI driver will load from the option ROM since the firmware doesn’t check for signatures in “Db”. For example, if you are using the video card for test, you will see that the monitor hooked to the option ROM card will have display.\n\n**Note**  \nIt doesn’t matter if the UEFI option ROM driver is signed or not, the option ROM will not load when DB is null and SB is enabled (PK and KEK are enrolled).\n\n \n\nPlease refer to sample scripts available in the WHCK for generating the PK and KEK. You can download the scripts from here: <http://go.microsoft.com/fwlink/?LinkId=321292> . Appendix B has sample scripts and more details.\n\nYou can also reference Appendix A for another approach to performing the above test. This approach doesn’t require setting the DB to Null but needs an unsigned UEFI option ROM driver from the IHV.\n\n## <span id=\"HowToFixIt\"></span><span id=\"howtofixit\"></span><span id=\"HOWTOFIXIT\"></span>5. How to fix it\n\n\nIf the above test fails, work with your IBV to acquire the necessary versions and configure them to validate option ROMs. Make sure that the firmware passes the test. For PCs which have shipped you will need to do a secure firmware update. Please refer to [NIST publication 800-147](http://go.microsoft.com/fwlink/p/?linkid=321186) and/or see [Windows 8.1 Secure Boot Key Creation and Management Guidance](windows-secure-boot-key-creation-and-management-guidance.md).\n\nYou can test the PC and leverage Windows HCK as a test tool (not a certification tool) for testing the secure firmware update.\n\n### <span id=\"5.1._Signing_the_driver\"></span><span id=\"5.1._signing_the_driver\"></span><span id=\"5.1._SIGNING_THE_DRIVER\"></span>5.1. Signing the driver\n\nIn case you find that you may have unsigned drivers on UEFI option ROMs please read below on how to fix that.\n\nSign each option ROM driver individually. That will break the format of the PCI Option ROM. You only need to sign the UEFI driver before creating the combined Option ROM.\n\nBefore inserting the UEFI driver in the OpROM, sign the UEFI image and test it with Secure Boot ON & OFF at the UEFI Shell (load/unload the driver file). Then put the signed driver into the combined option ROM.\n\nYou can direct your IHV to Microsoft SysDev center to get their UEFI option ROMs signed through a service available through SysDev center.\n\n### <span id=\"5.2._Validation_of_update\"></span><span id=\"5.2._validation_of_update\"></span><span id=\"5.2._VALIDATION_OF_UPDATE\"></span>5.2. Validation of update\n\nRun the test you mentioned above to verify that the vulnerability does not exist. Use the HCK tests to ensure that there are no functional regressions.\n\n## <span id=\"Resources\"></span><span id=\"resources\"></span><span id=\"RESOURCES\"></span>6. Resources\n\n\n-   UEFI Platform Initialization Specification, Volume 5 Standards, 1.2.1 Errata A: <http://go.microsoft.com/fwlink/p/?linkid=220187>\n\n-   Relevant info from UEFI 2.3.1 spec:\n\n    -   2.5.1: Legacy Option ROM Issues\n\n    -   10: Protocols –UEFI Driver Model\n\n    -   13.4.2: PCI Option ROMs\n\n    -   20: EFI Byte Code Virtual Machine\n\n    -   28: HII Overview\n\n    -   29: HII Protocols\n\n    -   30: HII Configuration Processing and Browser Protocol\n\n-   [UEFI Forum Learning Center](http://go.microsoft.com/fwlink/p/?LinkId=321289)\n\n-   [UEFI IHV resources @ intel.com](http://go.microsoft.com/fwlink/?LinkId=321290)\n\n-   Use the [TianoCore edk2-devel mailing list](http://go.microsoft.com/fwlink/?LinkId=398276) for support from other UEFI developers\n\n-   TechNet: [Best Practices for Enterprise Security: Security strategies](http://go.microsoft.com/fwlink/p/?linkid=321288)\n\n-   [UEFI specification](http://go.microsoft.com/fwlink/p/?LinkID=220187) errata C\n\n-   [Trusted Computing Group](http://go.microsoft.com/fwlink/p/?LinkID=78378)\n\n-   [Tianocore UEFI Development Kit](http://go.microsoft.com/fwlink/?LinkId=398277)\n\n-   [UEFI Firmware](uefi-firmware.md)\n\n-   [Intel Press: Beyond BIOS 2nd Edition](http://go.microsoft.com/fwlink/?LinkId=398278)\n\n-   [Windows 8.1 Secure Boot Key Creation and Management Guidance](windows-secure-boot-key-creation-and-management-guidance.md)\n\n-   [Validating Windows UEFI Firmware Update Platform Functionality](http://go.microsoft.com/fwlink/?LinkId=321291)\n\n## <span id=\"AlternateApproachToTestingUsingUnsignedOptionROMDrivers\"></span><span id=\"alternateapproachtotestingusingunsignedoptionromdrivers\"></span><span id=\"ALTERNATEAPPROACHTOTESTINGUSINGUNSIGNEDOPTIONROMDRIVERS\"></span>Appendix A: Alternate approach to testing using unsigned option ROM drivers\n\n\nThis approach relies on getting tools from IHV to make sure that the UEFI option ROM driver is signed.\n\nYou will need the following:\n\n-   PC under test with UEFI firmware\n\n-   PCI device with an unsigned Option ROM driver attached to the PC under test (like a Video card)\n\n-   Make sure Secure Boot is enabled\n\n-   Option IHV tools to detect signature on option ROM driver if it isn’t apparent that the option ROM driver is signed or not\n\nIf the firmware is implemented correctly, and the option ROM is unsigned the card should fail the check by firmware and not load the driver on the card. The PC should report an error code such as **EFI\\_IMAGE\\_EXECUTION\\_AUTH\\_SIG\\_FOUND**. In case you are using a video card, you may see that the PC shows just a black screen since the option ROM driver didn’t load.\n\nIf the firmware is implemented incorrectly, this test would work.\n\n## <span id=\"ScriptsForEnablingSecureBootWithNULLdb\"></span><span id=\"scriptsforenablingsecurebootwithnulldb\"></span><span id=\"SCRIPTSFORENABLINGSECUREBOOTWITHNULLDB\"></span>Appendix B: Scripts for enabling Secure Boot with NULL db\n\n\nYou can either use your current set of Secure Boot variables (PK and KEK) or generate test ones for testing this.\n\nBelow are steps used to generate the test PK, KEK and setting Db to NULL. Make sure that Secure Boot is not enabled; otherwise these steps would require signed UEFI bin files.\n\n**Note**  \nWe set the Secure Boot variable – Db, KEK and PK in reverse order so we don’t have to sign the UEFI bin files.\n\n \n\nPrior to this step the PC should be in setup mode.\n\n1.  **Create KEK and PK certificates**\n\n    This step requires the makecert.exe tool available in the [Windows SDK](http://go.microsoft.com/fwlink/?LinkId=271979).\n\n    ``` syntax\n    MakeCert.exe -cy authority -len 2048 -m 60 -a sha256  -pe -ss my -n \"CN=DO NOT SHIP - Fabrikam Test KEK CA\" Fabrikam_Test_KEK_CA.cer\n    MakeCert.exe -cy authority -len 2048 -m 60 -a sha256  -pe -ss my -n \"CN=DO NOT SHIP - Fabrikam Test PK\" TestPK.cer\n    ```\n\n2.  **Script to generate test PK**\n\n    You can either use your own PK or leverage the scripts from the WHCK for this <http://go.microsoft.com/fwlink/?LinkId=321292>\n\n    A sample is provided below.\n\n        # this scripts demonstrates how to format the Platform key \n        # NOTE The PK is actually set in the Enable_OEM_SecureBoot.ps1 script \n        Import-Module secureboot\n        $d = (pwd).Path\n\n        ###############################################################################\n        # Complete the following parameters\n        ###############################################################################\n\n        $certname = \"TestPK\"\n        # TODO change this path to where you have the PK.cer file \n        # This is where you plugin the certificate generated by the HSM \n        $certpath = $d + \"\\\" + $certname + \".cer\"\n\n        # Each signature has an owner SignatureOwner, which is a GUID identifying the agent which inserted the signature in the database. \n        # Agents might include the operating PC or an OEM-supplied driver or application. \n        # Agents may examine this field to understand whether they should manage the signature or not.\n        # TODO replace with OEM SignatureOwner GUID.\n        # You can use tools like Guidgen.exe tool in SDK or a similar tool to generate a GUID\n        $sigowner = \"55555555-5555-5555-5555-555555555555\"\n\n        $var = \"PK\"\n        $efi_guid = \"{8BE4DF61-93CA-11d2-AA0D-00E098032B8C}\"\n        $append = $false\n\n        ###############################################################################\n        # Everything else is calculated\n        ###############################################################################\n\n        # Workaround relative path bug\n        # TODO substitute OEM with your OEM name \n        $siglist =  $certname + \"_SigList.bin\"\n        $serialization = $certname + \"_SigList_Serialization_for_\" + $var + \".bin\"\n        $signature = $serialization + \".p7\"\n\n        $appendstring = \"set_\" \n        $attribute = \"0x27\"\n        $example = \"Example_SetVariable_Data-\" + $certname + \"_\" + $appendstring + $var + \".bin\" \n\n        Format-SecureBootUEFI -Name $var -SignatureOwner $sigowner -ContentFilePath $siglist -FormatWithCert -Certificate $certpath -SignableFilePath $serialization -Time 2011-05-21T13:30:00Z  -AppendWrite:$append\n\n        # OutputFilePath - Specifies the name of the file created that contains the contents of what is set. \n        # If this parameter is specified, then the content are not actually set, just stored into this file.\n        # Please note if -OutputFilePath is provided the PK is not set like in this case. The master script sets it at the end.\n\n        # Time - you can change the time below as long as it isn't in the future. Nothing wrong with keeping it as is.\n        \n        Set-SecureBootUEFI -Name $var -Time 2011-05-21T13:30:00Z -ContentFilePath $siglist  -OutputFilePath $example -AppendWrite:$append\n    \n\n3.  **Generate test KEK or use your own OEM KEK**\n\n    You can leverage your own OEM KEK or scripts from the WHCK for this. You can also use the Fabrikam\\_PK\\_SigList.bin from <http://go.microsoft.com/fwlink/?LinkId=321292> instead of generating your own test KEK.\n\n    A sample is provided below.\n\n        # script to add option OEM KEK\n        Import-Module secureboot\n        $d = (pwd).Path\n\n        ###############################################################################\n        # Complete the following parameters\n        ###############################################################################\n\n        $certname = \"Fabrikam_Test_KEK_CA\"\n        # TODO change this path to where you have the PK.cer file \n        # This is where you plugin the certificate generated by the HSM \n        $certpath = $d + \"\\\" + $certname + \".cer\"\n\n        # TODO change this path to where you have the OEM_KEK.cer file \n        # Each signature has an owner SignatureOwner, which is a GUID identifying the agent which inserted the signature in the database. \n        # Agents might include the operating system or an OEM-supplied driver or application. \n        # Agents may examine this field to understand whether they should manage the signature or not.\n        # TODO replace with OEM SignatureOwner GUID.\n        # You can use tools like Guidgen.exe tool in SDK or a similar tool to generate a GUID\n        \n        $sigowner = \"00000000-0000-0000-0000-000000000000\"\n\n        $var = \"KEK\"\n        $efi_guid = \"{8BE4DF61-93CA-11d2-AA0D-00E098032B8C}\"\n        $append = $false\n\n        ###############################################################################\n        # Everything else is calculated\n        ###############################################################################\n\n        $siglist = $certname + \"_SigList.bin\"\n        $serialization = $certname + \"_SigList_Serialization_for_\" + $var + \".bin\"\n        $signature = $serialization + \".p7\"\n        if ($append -eq $false) \n        { \n            $appendstring = \"set_\" \n            $attribute = \"0x27\"\n        } else \n        {   \n            $appendstring = \"append_\" \n            $attribute = \"0x67\"\n        }\n        $example = \"Example_SetVariable_Data-\" + $certname + \"_\" + $appendstring + $var + \".bin\" \n\n        Format-SecureBootUEFI -Name $var -SignatureOwner $sigowner -ContentFilePath $siglist -FormatWithCert -CertificateFilePath $certpath -SignableFilePath $serialization -Time 2011-05-21T13:30:00Z -AppendWrite:$append \n\n        # -Time You can change the time below as long as it isn't in the future. Nothing wrong with keeping it as is.\n        \n        Set-SecureBootUEFI -Name $var -Time 2011-05-21T13:30:00Z -ContentFilePath $siglist -OutputFilePath $example -AppendWrite:$append\n    \n\n4.  **Set Db to Null and set KEK and PK**\n\n    The first thing this script does is set the Db to Null.\n\n    **Note**  \n    Please keep in mind if the Fabrikam Test KEK CA is the only KEK CA present (meaning there is no Windows KEK CA), the PC may boot into Windows RE.\n    \n        # Prior to script execution, run \"Set-ExecutionPolicy Bypass -Force\"\n        \n        Import-Module secureboot\n        try \n        {\n            Write-Host \"Deleting db...\"\n            Set-SecureBootUEFI -Name db -Time \"2011-06-06T13:30:00Z\" -Content $null\n        }\n        catch\n        {\n        }\n        Write-Host \"Setting Fabrikam KEK...\"\n        Set-SecureBootUEFI -Time 2011-05-21T13:30:00Z  -ContentFilePath Fabrikam_Test_KEK_CA_SigList.bin  -Name KEK\n\n        Write-Host \"Setting self-signed Test PK...\"\n        Set-SecureBootUEFI -Time 2011-05-21T13:30:00Z -ContentFilePath TestPK_SigList.bin  -Name PK\n\n        Write-Host \"`n... operation complete.  `nSetupMode should now be 0 and SecureBoot should also be 0. Reboot and verify that Windows is correctly authenticated, and that SecureBoot changes to 1.\"\n\n5.  **Plug in the option ROM card and test**\n\n    The test should either pass or fail based on firmware correctness. For example:\n\n    If the option ROM in the firmware is implemented correctly, and you are using a video card for testing, then there should be no display to the attached monitor.\n\n    However, if you are using incorrect firmware, the video card should have output on the display.\n\n## <span id=\"related_topics\"></span>Related topics\n\n\n[Windows Secure Boot Key Creation and Management Guidance](windows-secure-boot-key-creation-and-management-guidance.md)\n\n[Secure Boot Overview](secure-boot-overview.md)\n\n[Validating Windows UEFI Firmware Update Platform Functionality](validating-windows-uefi-firmware-update-platform-functionality.md)\n\n \n\n \n\n\n\n\n\n\n"}